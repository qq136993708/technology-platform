<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcitc.mapper.patent.PatentInfoBIMapper">

    <resultMap id="calResultMap" type="com.pcitc.base.indexHome.calResult">
        <result column="dicValue" jdbcType="VARCHAR" property="dicValue" />
        <result column="dicValueSub" jdbcType="VARCHAR" property="dicValueSub" />
        <result column="dicValueTitle" jdbcType="VARCHAR" property="dicValueTitle" />
        <result column="text" jdbcType="VARCHAR" property="text" />
        <result column="textSub" jdbcType="VARCHAR" property="textSub" />
        <result column="textTitle" jdbcType="VARCHAR" property="textTitle" />
        <result column="calValue" jdbcType="INTEGER" property="calValue" />
        <result column="calValueSub" jdbcType="INTEGER" property="calValueSub" />
   </resultMap>

  <sql id="selectByParam">
    <if test="unitName != null and unitName != '' " >
      and unit_name like CONCAT('%',#{unitName},'%')
    </if>
    <if test="applicationType != null and applicationType != '' " >
      and application_type = #{applicationType}
    </if>
    <if test="patentType != null and patentType != '' " >
      and patent_type = #{patentType}
    </if>
    <if test="applicationNumber != null and applicationNumber != '' " >
      and application_number like CONCAT('%',#{applicationNumber},'%')
    </if>
    <if test="patentName != null and patentName != '' " >
      and patent_name like CONCAT('%',#{patentName},'%')
    </if>
    <if test="applicant != null and applicant != '' " >
      and applicant = #{applicant}
    </if>
    <if test="inventor != null and inventor != '' " >
      and inventor = #{inventor}
    </if>
    <if test="legalStatus != null and legalStatus != '' " >
      and legal_status = #{legalStatus}
    </if>
    <if test="projectBackground != null and projectBackground != '' " >
      and project_background = #{projectBackground}
    </if>
    <if test="applicationDateStart != null and applicationDateStart != '' " >
      and application_date &gt;= #{applicationDateStart}
    </if>
    <if test="applicationDateEnd != null and applicationDateEnd != '' " >
      and application_date &lt;= #{applicationDateEnd}
    </if>
    <if test="technicalFieldIndex != null and technicalFieldIndex != '' " >
      AND technical_field_index like CONCAT(#{technicalFieldIndex},'%')
    </if>
    <if test="childUnitIds != null          and childUnitIds !=''  ">
      AND create_unit_id in
      <foreach item="item"  collection="childUnitIds.split(',')"  open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
    <if test="secretLevel != null and secretLevel != ''" >
      and secret_level = #{secretLevel}
    </if>
    <if test="userSecretLevel != null and userSecretLevel !=''  ">
      AND secret_level &lt;= #{userSecretLevel}
    </if>
    <if test="type != null and type != ''" >
      and type = #{type}
    </if>

  </sql>

  <select id="getPatentCountByYear" parameterType="java.util.Map" resultMap="calResultMap">
    select dic.name as text,temp.calValue,temp.dicValue,temp.textSub
    from (
          select * from sys_dictionary where parent_code = 'ROOT_KJPT_ZLZL'
    ) dic left join (
          select count(1) as calValue, '授权专利' as textSub , patent_type as dicValue
          from patent_info a
          where deleted != '1'
              and a.legal_status = '04'
              <include refid="selectByParam" />
          group by patent_type
            union
          select count(1) as calValue, '申请专利' as textSub , patent_type as dicValue
          from patent_info a
          where deleted != '1'
              and a.legal_status = '03'
              <include refid="selectByParam" />
          group by patent_type
    )temp on temp.dicValue = dic.num_value
  </select>


  <select id="getPatentCountByLegelStatus" parameterType="java.util.Map" resultMap="calResultMap">
    SELECT
        count( a.id ) AS calValue,
        a.legal_status AS dicValue,
        dic.NAME AS text
    FROM
        patent_info a
        LEFT JOIN sys_dictionary dic ON dic.parent_code = 'ROOT_KJPT_FLZT(ZL)'
        AND a.legal_status = dic.num_value
    where a.deleted != '1'
        <include refid="selectByParam" />
    GROUP BY
        a.legal_status
  </select>


  <select id="getPatentCountByOffice" parameterType="java.util.Map" resultMap="calResultMap">
    select b.name,count(1) num from patent_info a left join sys_dictionary b on a.patent_type = b.num_value and b.parent_code = 'ROOT_KJPT_ZLZL'
    where deleted != '1'
    <include refid="selectByParam" />
    GROUP BY a.patent_type,b.name
  </select>


</mapper>