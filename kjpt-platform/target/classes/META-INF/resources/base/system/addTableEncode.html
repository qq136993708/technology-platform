<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>表单模块 - layui</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/layuiadmin/style/common.css">
  <style>
  	.layui-form-selectup dl{bottom:auto;top:42px;}
  </style>
</head>
<body style="overflow: hidden;">
<div class="formBox">
	<form class="layui-form" action="" lay-filter="component-form-group layui-container">
			
    	<div class="tableBox">
    		<div class="tableToolBox">
        		<div class="tableBtns">
          			<div class="tableTitle">基本信息<span class="red">（标*号为必填项）</span></div>
        		</div>
      		</div>
	      	<div class="rowForm twoForm" style="height:55px;overflow:hidden;">
        		<div class="box-body">
      				<div class="layui-row">
     		    		<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
          					<div class="layui-form-item">
            					<label class="layui-form-label">编码名称:<span class="must-fill">*</span></label>
            					<div class="layui-input-block">
		              				<input class="layui-input" name="tableEncodeName" id="tableEncodeName" lay-verify="title" lay-verify="required" placeholder="请输入编码名称" autocomplete="off" type="text">
									<input type="hidden" id="tableEncodeGroupSum" name="tableEncodeGroupSum" type="text" value="1"/>
									<input type="hidden" id="tableEncodeItemValue0" name="tableEncodeItemValue0" type="text" value="-"/>
									<input type="hidden" id="tableEncodeProjectId" name="tableEncodeProjectId" value="${functionId}"/>
									<input type="hidden" id="tableEncodeProjectCode" name="tableEncodeProjectCode" value="${functionId}"/>
		            			</div>
          					</div>
        				</div>
		        		<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
		          			<div class="layui-form-item">
		            			<label class="layui-form-label">状态:</label>
		           				<div class="layui-input-block">
	           						<label class="col-sm-12">
	             						<input id="ra1" type="radio" checked="checked" value="1" name="tableEncodeValid" title="启用"/>
	             						<input id="ra2" type="radio" value="0" name="tableEncodeValid" title="停用"/>
	           						</label>
          						</div>
          					</div>
        				</div>
      				</div>
      			</div>
      		</div>
      	</div>
      	<div class="tableBox">
	      	<div class="tableToolBox">
	        	<div class="tableBtns">
	          		<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg" data-type="tableEncodeListDivAddTr">新增</a>
	          		<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg" data-type="tableEncodeListDivRemoveTr">移除</a>
	          		<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg" data-type="tableEncodeView">预览</a>
	        	</div>
	      	</div>
	      	<div class="rowForm" style="height:206px;" id="tableEncodeListDiv">
		        <div class="layui-row">
		        	<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
		            	<div class="layui-form-item">
			         		<label class="layui-form-label">连接符:<span class="must-fill">*</span></label>
			         		<div class="layui-input-block">
				     			<select id="tableEncodeItemType0" name="tableEncodeItemType0" lay-filter="select_filter" lay-search></select>
			         		</div>
		         		</div>
					</div>
					<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
	            		<div class="layui-form-item">
	            			<label class="layui-form-label">预览:</label>
			    			<div class="layui-input-block">
			            		<input class="layui-input" name="tableEncodeDemo" id="tableEncodeDemo" type="text" autocomplete="off">
			           		</div>
			    		</div>
					</div>
      			</div>
      			<div class="layui-row">
		        	<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
				    	<div class="layui-form-item">
			    			<label class="layui-form-label">数据类型:<span class="must-fill">*</span></label>
			         		<div class="layui-input-block">
				     			<select id="tableEncodeItemType1" name="tableEncodeItemType1" lay-filter="select_filter" lay-search></select>
			         		</div>
				        </div>
					</div>
					<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
			    		<div class="layui-form-item">
			    			<label class="layui-form-label">数据值:<span class="must-fill">*</span></label>
			    			<div class="layui-input-block">
			            		<input class="layui-input" name="tableEncodeItemValue1" id="tableEncodeItemValue1" type="text" lay-verify="required">
			           		</div>
			         	</div>
					</div>
      			</div>
      		</div>
    		<div class="form-bottom">
        		<div class="form-bottom-btns">
          			<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="save">保存</button>
          			<button type="button"class="layui-btn layui-btn-sm fontColor-default border-default layui-btn-mini layui-btn-white" id="closeBtn">取消</button>
        		</div>
      		</div>
      		
		</div>
	</form>
</div>
<script src="/layuiadmin/layui/layui.js"></script>
<script >

	var i=1;
	var functionId = '${functionId}';
	var demo = "";
    layui.use([ 'form', 'laydate','table','jquery','layer'], function(){
    	var status = true;
        var $ = layui.jquery,
	        admin = layui.admin,
	        element = layui.element,
	        layer = layui.layer,
	        laydate = layui.laydate,
	        form = layui.form;
        
        form.on('select()', function(data){
			var typeNb = data.elem.id+'';
			typeNb = typeNb.substr(typeNb.length-1,1);
			var mydate = new Date();
			var month = mydate.getMonth()+1;
			if(month<11){
				month = "0"+month;
			}
			var day = mydate.getDate();
			if(day<11){
				day = "0"+day;
			}
			if(typeNb == 0){
				$("#tableEncodeItemValue"+typeNb).val(data.elem[data.elem.selectedIndex].text);
			}
			if(data.value == 'ROOT_XTGL_BMGL_LSH'){
				$("#tableEncodeItemValue"+typeNb).unbind(); 
				$("#tableEncodeItemValue"+typeNb).val('00001');
				$("#tableEncodeItemValue"+typeNb).keyup(function(){  
			        var c=$(this);  
			        if(/[^\d]/.test(c.val())){  
			            var temp=c.val().replace(/[^\d]/g,'');  
			            $(this).val(temp);  
			        } 
				});
				$("#tableEncodeItemValue"+typeNb).attr("readonly",false);
			}else{
				$("#tableEncodeItemValue"+typeNb).unbind(); 
				//日期
				if(data.value == 'ROOT_XTGL_BMGL_DQRQ'){
					$("#tableEncodeItemValue"+typeNb).val(mydate.getFullYear()+''+month+''+day);
					$("#tableEncodeItemValue"+typeNb).attr("readonly","readonly");
				//固定值
				}else if(data.value == 'ROOT_XTGL_BMGL_GDZ'){
					$("#tableEncodeItemValue"+typeNb).val('请输入固定值！');
					$("#tableEncodeItemValue"+typeNb).attr("readonly",false);
				//年份
				}else if(data.value == 'ROOT_XTGL_BMGL_DQNF'){
					$("#tableEncodeItemValue"+typeNb).val(mydate.getFullYear());
					$("#tableEncodeItemValue"+typeNb).attr("readonly","readonly");
				//日号			
				}else if(data.value == 'ROOT_XTGL_BMGL_DQRH'){
					$("#tableEncodeItemValue"+typeNb).val(day+'');
					$("#tableEncodeItemValue"+typeNb).attr("readonly","readonly");
				//月份
				}else if(data.value == 'ROOT_XTGL_BMGL_DQYF'){
					$("#tableEncodeItemValue"+typeNb).val(month+'');
					$("#tableEncodeItemValue"+typeNb).attr("readonly","readonly");
				//无序码
				}else if(data.value == 'ROOT_XTGL_BMGL_WXM'){
					$("#tableEncodeItemValue"+typeNb).val('无序码');
				//流水号
				}
			}
		});      
        /* 自定义验证规则  title 要验证的input的 lay-verify=""*/
        form.verify({
            title: function(value){
                if(value.length < 1){
                    return '标题至少得1个字符啊';
                }
            },pass: [/(.+){6,12}$/, '密码必须6到12位'],
            content: function(value){
                layedit.sync(editIndex);
            }
        });
        //开始日期
        var insStart = laydate.render({
            elem: '#test-laydate-start',
            min: 0,
            done: function(value, date){
                //更新结束日期的最小日期
                insEnd.config.min = lay.extend({}, date, {
                    month: date.month - 1
                });

                //自动弹出结束日期的选择器
                insEnd.config.elem[0].focus();
            }
        });

        //结束日期
        var insEnd = laydate.render({
            elem: '#test-laydate-end'
            ,min: 0
            ,done: function(value, date){
                //更新开始日期的最大日期
                insStart.config.max = lay.extend({}, date, {
                    month: date.month - 1
                });
            }
        });
        //日期范围
        laydate.render({
            elem: '#test-laydate-range-date'
            ,range: true
        });

        //请选择日期1
        laydate.render({
            elem: '#test-laydate-format-date1'
            ,format: 'yyyy年MM月dd日'
        });
        //请选择日期2
        laydate.render({
            elem: '#test-laydate-format-date2'
            ,format: 'dd/MM/yyyy'
        });
        //日期时间选择器
        laydate.render({
            elem: '#test-laydate-type-datetime'
            ,type: 'datetime'
        });
        /* 监听指定开关 */
        form.on('switch(component-form-switchTest)', function(data){
            layer.msg('开关checked：'+ (this.checked ? 'true' : 'false'), {
                offset: '6px'
            });
            layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
        });

        /* 监听提交 */
        form.on('submit(save)', function(data){
        	JSON.stringify(data.field);
        	tableEncodeView();
        	$.ajax({
    			type : 'post',
    			dataType : 'json',
    			async: false,
                data : {'param':JSON.stringify(data.field)},
                url : '/tableEncode/saveTableEncode',
                success : function(data) {
                	if(data==200){
                		var index = parent.layer.getFrameIndex(window.name);
                		parent.layer.close(index);
                		parent.layer.msg("保存成功");
   		        		parent.layui.table.reload('tableList', {where:{functionId:functionId}});
                	}	            	
                },
                error : function(e) {
                	layer.msg("出错了");
                    console.log(e);
                }
            });
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
            return false;
        });
        $.ajax({
            url:'/pageCommon/dic/ROOT_XTGL_BMLJF',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#tableEncodeItemType0').append(new Option(item.name,item.code));//往下拉菜单里添加元素
                })
                form.render();
            }
        });
        $.ajax({
            url:'/pageCommon/dic/ROOT_XTGL_BMGL',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#tableEncodeItemType1').append(new Option(item.name,item.code));//往下拉菜单里添加元素
                })
                form.render();
            }
        });
        //关闭事件
        $("#closeBtn").click(function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        })
        
  
        var $ = layui.$, active = {
        	tableEncodeListDivAddTr: function () {
        		tableEncodeListDivAddTr();
        	},
        	tableEncodeListDivRemoveTr: function () {
        		tableEncodeListDivRemoveTr();
        	},
        	tableEncodeView: function () {
        		tableEncodeView();
        	}
        	
        }
      //区别按钮属性
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
       	function tableEncodeListDivAddTr(){
        	if(i<9 && status == true){
			i++;
			var div = '<div class="layui-row" id="div' + i + '">'
	        			+'<div class="layui-col-xs5 layui-col-sm5 layui-col-md5">'
        				+'<div class="layui-form-item">'
         				+'<label class="layui-form-label">数据类型:<span class="must-fill">*</span></label>'
         				+'<div class="layui-input-block">'
         				+'<select id="tableEncodeItemType'+i+'" name="tableEncodeItemType'+i+'" lay-filter="select_filter" lay-search ></select>'
         				+'</div></div></div><div class="layui-col-xs5 layui-col-sm5 layui-col-md5">'
         				+'<div class="layui-form-item">'
         				+'<label class="layui-form-label">数据值:<span class="must-fill">*</span></label>'
         				+'<div class="layui-input-block">'
         				+'<input class="layui-input" lay-verify="required" name="tableEncodeItemValue'+i+'" id="tableEncodeItemValue'+i+'" type="text">'
         				+'</div></div></div></div>';
			$("#tableEncodeListDiv").append(div);
			status = false;
			runAjax();
			$("#tableEncodeGroupSum").val(i+"");
			}
    	}
       	function tableEncodeListDivRemoveTr(){
       		if(i > 1){
       			$("#div"+i).remove();
          		 i--;
       		}
   	 	}
   	 	function tableEncodeView(){
   			var itemText;
   			var itemValue;
   			var value = "";
   			for(var o=1;o<(i+1);o++){
   				if(o != i){
   					value += $("#tableEncodeItemValue"+o).val() + $("#tableEncodeItemType0").find("option:selected").text();
   				}else{
   					value += $("#tableEncodeItemValue"+o).val();
   				}
   				
   			}
   			$("#tableEncodeDemo").val(value);
   			demo = value;
   		}
        function runAjax(){
        	 $.ajax({
        		 url:'/pageCommon/dic/ROOT_XTGL_BMGL',
                 dataType:'json',
                 type:'post',
                 success:function(data){
                     $.each(data,function(index,item){
                         $('#tableEncodeItemType'+i).append(new Option(item.name,item.code));
                     })
                     form.render();
                     status = true;
                 }
             });
        }
    });
    
</script>
</body>
</html>
