<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>奖项新增/编辑</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
<link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css">
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.all.js"></script>
<script type="text/javascript" src="/layuiadmin/modules/selectTree.js"></script>
<script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<style>
	.tree-content {
	  position: absolute;
	  z-index: 998;
	  background: #ffffff;
	  max-height: 800px;
	  width: 100%;
	  border: 1px solid #ccc;
	  overflow-y: scroll;
	}
</style>
</head>
<body>
<div class="formBox">
	<form id="user-form" name="user-form" lay-filter="user-form" class="form-horizontal layui-form">
	<div class="box-body">
		<input type="hidden" name="userId" id="userId">
		<input type="hidden" name="userExtend" id="userExtend">
		<div class="layui-row">
			<div class="layui-col-xs10 layui-col-sm10 layui-col-md10">
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<input type="hidden"  class="layui-input readOnlyBox" id="dataId" name="dataId" autocomplete="off">
							<label for="" class="layui-form-label">项目编码<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<input type="text"  class="layui-input readOnlyBox" id="xmbh" name="xmbh" lay-verify="required" placeholder="请输入项目编码" autocomplete="off">
							</div>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">年度<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" readonly="readonly" id="nd" name="nd" lay-verify="required" placeholder="请输入年度" autocomplete="off">
							</div>
						</div>
					</div>
				</div>
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">项目名称<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" id="xmmc" name="xmmc" lay-verify="required" placeholder="请输入项目名称" autocomplete="off">
							</div>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">上报单位<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" id="sbdw" name="sbdw" lay-verify="required" placeholder="请输入上报单位" autocomplete="off">
							</div>
						</div>
					</div>
				</div>
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						 <div class="layui-form-item">
							  <label class="layui-form-label">上报奖项<span class="must-fill">*</span></label>
							  <div class="layui-input-block">
								  <div class="selectTreeBox">
									<!-- <div id="userUnit" class="layui-form-select select-tree"></div> -->
									<input type="text" class="layui-input" lay-verify="required" placeholder="请输入上报奖项" id="sbjz" name="sbjz">
								  </div>
							  </div>
						 </div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							  <label class="layui-form-label">申报等级<span class="must-fill">*</span></label>
							  <div class="layui-input-block">
								  <div class="selectTreeBox">
									<!-- <div id="userPost" class="layui-form-select select-tree"></div> -->
									<input type="text" class="layui-input" lay-verify="required" placeholder="请输入申报等级" id="sbdj" name="sbdj">
								  </div>
							  </div>
						</div>
					</div>
				</div>
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">申报日期<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" readonly="readonly" lay-verify="required" placeholder="请输入申报日期" id="sbrq" name="sbrq">
							</div>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label class="layui-form-label">合同号<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<div class="selectTreeBox">
									<input type="text" class="layui-input" lay-verify="required" placeholder="请输入合同号" id="hth" name="hth">
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">开始时间<span class="must-fill"></span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" readonly="readonly" lay-verify="required" id="kssj" name="kssj" placeholder="请输入开始时间">
							</div>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">结束时间<span class="must-fill"></span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" readonly="readonly" id="jssj" lay-verify="required" name="jssj" placeholder="请输入结束时间">
							</div>
						</div>
					</div>
				</div>
				<!-- <div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">上报状态<span class="must-fill">*</span></label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" lay-verify="required" id="sbzt" name="sbzt" placeholder="请输入上报状态">
							</div>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">用户签章</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" id="userSign" name="userSign">
							</div>
						</div>
					</div> 
				</div> -->
				<input type="hidden" class="layui-input" lay-verify="required" value="已上报" id="sbzt" name="sbzt" placeholder="请输入上报状态">
			</div>
		</div>

		<div class="layui-form-item">
	      	 <label class="layui-form-label">备注</label>
	         <div class="layui-input-block">
	         	   <textarea class="layui-textarea" id="remarks" name="remarks" placeholder="备注"></textarea>
	         </div>
       </div>
	</div>
	<div class="form-bottom">
      <div class="form-bottom-btns">
      	<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="submitBtn">保存</button>
      	<!-- <button type="reset" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white">重置</button> -->
      	<button type="button" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white"  id="cancel">取消</button>
      </div>
    </div>
</form>
	
</div>
<script type="text/javascript">
	var zNodes,form,roleMap={},unitMap={},postMap={},unitListNodes=[],roleListNodes=[],unitSelectTree,postSelectTree,roleSelectTree;
	var unitList = [],postList = [];
	var dataId = "${dataId?default(0)}";
	$(document).on("click",".photo_box", function(event) {
		$("#file").click();
    });
	$(document).on("change", "#file", function(event){
		$.ajax({  
	        type : "POST",  
	        url : "/sysfile/uploadSignMultipleFile",  
	        data : new FormData($("#fileUploadForm")[0]),
	        async: false,  
	        cache: false,  
	        contentType: false,  
	        processData: false,
	        success : function(msg) {
	        	$("#userExtend").val(msg.filePath);
	        	$(".photo_box").html('<img src="'+msg.filePath+'" style="width: 140px;height: 173px" />');
	        }  
		}); 			
	});
	//根据机构列表初始化岗位树（岗位树是一棵两级结构的树）
	function inintPostSelectTree(unitList)
	{
		//移除岗位下拉树元素
		$("#userPost").unbind();
		$("div[id='userPost'] .layui-select-title").remove();
		$("div[id='userPost']").parent().find(".tree-content").remove();
		
		//init unitListTree
		zNodes = unitList;//显示机构下拉树(list)
		//参数： 参数1：div的id，参数2：isMultiple 是否多选(true或false), 参数3：不用动,参数4：setting
		postSelectTree = initSelectTree("userPost",true, true, false,{ "Y": "", "N": "" }) 
		initHideMenu();  //不加此方法则默认打开下拉树
		//禁用机构可选框（本身构建的是一棵复选框的树，因为只能选择岗位，所以要禁用机构选择框）
		var nodes = postSelectTree.getNodes();
		for(var i=0;i<nodes.length;i++){
			nodes[i].nocheck = true;
		}
		//把岗位添加到所有已加载的机构下
		for(var postId in postMap)
		{
			var pnode = postSelectTree.getNodeByParam("id",postMap[postId].postUnit);
			if(pnode){
				var node = new zTreeNode(postMap[postId].postId,postMap[postId].postUnit,postMap[postId].postName,true,false);
				postSelectTree.addNodes(pnode, node, true);
			}
		}
		//展开树型结构
		postSelectTree.expandAll(true);
		//刷新树
		postSelectTree.refresh();
	}
	$(document).ready(function() {
		//编辑页面隐藏密码框
		if(userId != 0){
			$('#userPassword').attr("lay-verify","");
			$('#password').attr("disabled",true);
			$('#password').hide();
		}
		
		//用户类别
		ajaxPost('/dictionary/list/ROOT_XTGL_YHLX', null, function (data, status) { 
	    	$.each(data,function(i,dt){
	    		$("#userKind").append("<option value='"+data[i].code+"'>"+data[i].name+"</option>");
	    	});
	    });
		//域用户
		ajaxPost('/dictionary/list/ROOT_XTGL_YYH', null, function (data, status) { 
	    	$.each(data,function(i,dt){
	    		$("#isDomain").append("<option value='"+data[i].numValue+"'>"+data[i].name+"</option>");
	    	});
	    });
		//填充角色下拉复选框
		ajaxPost('/role/role-list-all', null, function (data, status) { 
	    	$.each(data,function(i,dt){
	    		roleMap[data[i].roleId] = data[i];
	    		roleListNodes.push(new zTreeNode(data[i].roleId,0,data[i].roleName));
	    	});
	    	zNodes = roleListNodes;//显示角色下拉树
			//参数： 参数1：div的id，参数2：isMultiple 是否多选(true或false), 参数3：不用动,参数4：setting
			roleSelectTree = initSelectTree("userRole",true, true, false,{ "Y": "", "N": "" }) 
			initHideMenu();  //不加此方法则默认打开下拉树
	   	});
		//获得机构信息
		ajaxPost('/unit/list-data', null, function (data, status) { 
	    	$.each(data,function(i,dt){
	    		unitMap[data[i].unitId]=data[i];
	    	});
	   	});
		//获取岗位信息
		ajaxPost('/post/list-data', null, function (data, status) { 
	    	$.each(data,function(i,dt){
	    		postMap[data[i].postId]=data[i];
	    	});
	   	});
		//加载机构下拉树数据
		/* ajaxPost('/unit/ztree-unit-list', null, function(data,status) {
			zNodes = data;//机构下拉树的数据
			//参数： 参数1：div的id，参数2：isMultiple 是否多选(true或false), 参数3：不用动,参数4：setting
			//unitSelectTree = initSelectTree("userUnit",true, true, false,{ "Y": "ps", "N": "p" }) 
			//应需求20190320调整为，之父节点互不影响
			unitSelectTree = initSelectTree("userUnit",true, true, false,{ "Y": "", "N": "" }) 
			initHideMenu();  //不加此方法则默认打开下拉树
			
			//处理机构数据，将机构数据中的父级关系去掉，树是一颗一级树
			$.each(data,function(i,dt){
				data[i].pId = 0;//指定一个不存在的父ID，把所有节点都变成根节点
				
				unitListNodes.push(data[i]);
			});
			//初始化岗位树
			inintPostSelectTree(unitListNodes);
		}); */
	});
	
	layui.use([ 'jquery', 'form', 'laydate', 'table', 'layer', 'element' ,'publicMethods'],
		function() {
			var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate,publicMethods=layui.publicMethods,
			form = layui.form;
			
			
			form.render();
			//初始赋值 component-form-group 当前form的lay-filter
			 if(dataId != 0)
		     {
				//加载用户信息
				publicMethods.ajaxGet('/more-dimension/outReward/reward-get', {"dataId":dataId}, function (data, status) {
					//回显
					$("#xmbh").attr("value",data.xmbh);
					$("#nd").attr("value",data.nd);
					$("#xmmc").attr("value",data.xmmc);
					$("#sbjz").attr("value",data.sbjz);
					$("#sbdw").attr("value",data.sbdw);
					$("#sbdj").attr("value",data.sbdj);
					$("#sbrq").attr("value",data.sbrq);
					$("#sbzt").attr("value",data.sbzt);
					$("#hth").attr("value",data.hth);
					$("#kssj").attr("value",data.kssj);
					$("#jssj").attr("value",data.jssj);
					$("#dataId").attr("value",data.dataId);
					$("#remarks").val(data.remarks);
					
					laydate.render({elem: '#nd',type: 'year',value: data.nd});
			    	laydate.render({elem: '#sbrq',type: 'date',format:'yyyyMMdd',value: data.sbrq});
			    	laydate.render({elem: '#kssj',type: 'date',format:'yyyyMMdd',value:	data.kssj});
			    	laydate.render({elem: '#jssj',type: 'date',format:'yyyyMMdd',value: data.jssj});
	            });    	
		     }else{
		    	 laydate.render({elem: '#nd',type: 'year',value: new Date()});
		    	 laydate.render({elem: '#sbrq',type: 'date',format:'yyyyMMdd',value: new Date()});
		    	 laydate.render({elem: '#kssj',type: 'date',format:'yyyyMMdd',value: new Date()});
		    	 laydate.render({elem: '#jssj',type: 'date',format:'yyyyMMdd',value: new Date()});
		     }
				/* 监听提交 */
				form.on('submit(submitBtn)', function(data) {
					//编辑时设置机构、岗位、角色值
					var unitText = "";
					$.each(unitList,function(index,dt){
						unitText += ","+unitList[index];
					});
					data.field.userUnit = unitText.length>0?unitText.substring(1):"";
					data.field.userPost = $("#userPostValue").val();
					data.field.userRole = $("#userRoleValue").val();
					console.log(unitText);
					console.log(data.field);
					ajaxPost("/more-dimension/outReward/reward-saveorupdate", data.field, function(dt, status) {
						if(dt.success){
					       	parent.layui.table.reload('processdef-table',null);
					       	//parent.renderfunc();//隐藏全选按钮
					       	var index = parent.layer.getFrameIndex(window.name);
					       	parent.layer.close(index);
						}else{
							parent.layer.alert(dt.message, {
								title : '信息'
							});
							return;
						}
					});
					return false;
				});
				$("#cancel").click(function() {
					layer.close();
				})
	});
	function initPostData(unitNodes) 
	{
		var unitList = [];
		$.each(unitNodes,function(i,dt){
			unitList.push(new zTreeNode(unitNodes[i].id,0,unitNodes[i].name));
		});
		//构建新的UnitTree下拉树
		inintPostSelectTree(unitList);
	}
	//机构检索页面初始化数据
	window.initUnitTreeChoose = function(){
		return unitList;
	}
	//机构页面选择后回调函数
	window.callbackUnitTreeChoose = function(unitIds, unitNames){
		unitList = unitIds;
		var unitText = "";
		var unitListNodes = [];
		$.each(unitIds,function(i,dt){
			if(unitMap[unitIds[i]]){
				unitText += ","+unitMap[unitIds[i]].unitName;
				unitListNodes.push(new zTreeNode(unitIds[i],0,unitMap[unitIds[i]].unitName));
			}
		});
		$("#userUnit").val(unitText.length>0?unitText.substring(1):"");
		inintPostSelectTree(unitListNodes);
	}
	$("#userUnit").on("click", function() {
		layer.open({
			title : "机构选择",
			skin : 'layui-layer-lan',
			shadeClose : true,
			type : 2,
			fixed : false,
			//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
			maxmin : false,
			//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
			area : [ '80%', '70%' ],
			content : "/unit/chooseUnitMultiV2"
		});
	});
	
	$("#cancel").click(function () {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    })
</script>
</body>
</html>