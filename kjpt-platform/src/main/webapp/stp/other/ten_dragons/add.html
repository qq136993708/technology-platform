<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
    <link rel="stylesheet" href="/layuiadmin/style/common.css">
</head>
<body>
<div class="layer-box">
    <div class="formBox">
        <div class="tableToolBox">
            <div class="tableBtns">
                <div class="tableTitle">基本信息<span class="red">（标*号为必填项）</span>
                </div>
            </div>
        </div>
        <div class="box-body">
            <form class="layui-form" name="form1"        id="form1"  action="" method="POST" lay-filter="component-form-group layui-container">
                <input type="hidden" name="dataId"       id="dataId"           value="${outProjectInfo.dataId}">
                <input type="hidden" name="define18"     id="define18"         value="${define18}">
                <input type="hidden" name="zycmc"        id="zycmc"            value="${outProjectInfo.zycmc}">
                <input type="hidden" name="fzdwStr"       id="fzdwStr"           value="${fzdwStr}">
                
                
                
                
                
                
                 <div class="layui-row">
	                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	                    <div class="layui-form-item">
	                        <label for="" class="layui-form-label">立项年度<span class="must-fill">*</span></label>
	                        <div class="layui-input-block">
	                            <input class="layui-input " name="nd" placeholder="yyyy"  style="cursor:pointer"  id="nd"    readonly="readonly" 
	                                   value="${nd}"    lay-verify="required" autocomplete="off" type="text">
	                        </div>
	                    </div>
	                </div>
	                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	                    <div class="layui-form-item">
	                        <label for="" class="layui-form-label">预算年度<span class="must-fill">*</span></label>
	                        <div class="layui-input-block">
	                            <input class="layui-input " name="ysnd" id="ysnd" placeholder="yyyy"   style="cursor:pointer"  readonly="readonly"
	                                   value="${outProjectInfo.ysnd}"  lay-verify="required" autocomplete="off" type="text">
	                        </div>
	                    </div>
	                </div>
	            </div>
	            
                <div class="layui-form-item">
                    <label class="layui-form-label">项目名称<span class="must-fill">*</span></label>
                    <div class="layui-input-block">
                        <input class="layui-input" id="xmmc" name="xmmc" lay-verify="required"
                               value="${outProjectInfo.xmmc}" type="text">
                    </div>
                </div>
	            
	            
	             <div class="layui-row">
	                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	                    <div class="layui-form-item">
	                        <label for="" class="layui-form-label">专业处<span class="must-fill">*</span></label>
	                        <div class="layui-input-block">
	                           <select name="zycbm" id="zycbm"    style="width:200px" >
                                      <option value="" >--请选择--</option>
						              <#list zycmcList as vo> 
								          <option value="${vo.numValue}" <#if vo.numValue == outProjectInfo.zycbm> selected="selected"  </#if>>${vo.name}</option>
								      </#list>
                              </select>
	                        </div>
	                    </div>
	                </div>
	                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	                    <div class="layui-form-item">
	                       <label class="layui-form-label">合同号</label>
			                      <div class="layui-input-block">
			                        <input class="layui-input" id="hth" name="hth" 
			                               value="${outProjectInfo.hth}" type="text">
			                    </div>
	                        
	                    </div>
	                </div>
	              </div>
	              
	              
	              
	              
	              <div class="layui-form-item">
                <label class="layui-form-label">单位</label>
                <div class="layui-input-block">
                    <div class="tableBox" id="fzdw_str">
                        <div class="tableToolBox">
                            <div class="tableBtns">
                                <a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg"
                                   id="gysAddEvent">添加</a>
                            </div>
                        </div>
                        <table class="layui-table">
                            <thead>
	                            <tr>
	                                <td width="40%">单位名称</td>
	                                <td width="40%">单位类别</td>
	                                <td width="20%" align="center">删除</td>
	                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                    </div>
                </div>
            </div>
            
            
	              
	            

                <div class="layui-form-item">
                    <label class="layui-form-label">附件</label>
                    <div id="file_div" class="layui-input-block"></div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <textarea name="define19" id="define19" class="layui-textarea">${outProjectInfo.define19}</textarea>
                    </div>
                </div>


                <!--行结束-->
                <div class="form-bottom">
                    <div class="form-bottom-btns">
                        <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"
                                lay-submit="" lay-filter="sub">保存
                        </button>
                        <button type="button"
                                class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white"
                                id="closeBtn">关闭
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/common/js/jquery-1.11.3.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript">
    var v_date = (new Date()).getTime();
    var dataId =$("#dataId").val();
    var nd = "${nd?default('')}";
    var file_ids = "define18";
    //detail:详情，edit：编辑
    file_edit_detail = "edit";
    //统管理-附件管理-附件配置：页面标识
    file_opt_flag = "9ac8125f912e4d79be71d27b1abdc26b";

    
    var admin;
    var form;
    layui.config({
        base: 'layuicommon/module/modules/' //静态资源所在路径
    }).extend({
        index: 'layui/tableDemo' //主入口模块
    }).use(['form', 'laydate', 'table', 'layer'], function () {
    	admin = layui.admin
            , element = layui.element
            , layer = layui.layer
            , laydate = layui.laydate;
            form = layui.form;
        form.render(null, 'component-form-group');
        laydate.render({
            elem: '#LAY-component-form-group-date'
        });

        //日期时间选择器
        laydate.render({
            elem: '#nd',min:nd , type: 'year'
        });
        
        laydate.render({
            elem: '#ysnd',min:nd , type: 'year'
        });
        

        //添加到form.render()之后
        $("#file_div").load('/common/public/uploadlayuiload.html');

        /* 自定义验证规则  title 要验证的input的 lay-verify=""*/
        form.verify({
        	xmmc: function (value) {
                if (value.length < 5) {
                    return '至少得5个字符啊';
                }
            }
        });

        //关闭事件
        $("#closeBtn").click(function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        })
        
        
        
          //意向供应商事件
        $("#gysAddEvent").click(function () {
            var n = $("#fzdw_str table tbody tr").length + 1;
            var tr = "<tr>"+
                         "<td><input class='layui-input' type='text' id='fzdw"+n+"' name='fzdw"+n+"' style='width:90%' /></td>"+
                         "<td>" +
                            "<select name='define6' id='define6"+n+"' style='width:95%;display:block'>"+
	                            "<option value='' >--请选择--</option>"+
			                    "<option value='1'>组长单位</option>"+
			                    "<option value='2'>副组长单位</option>"+
			                    "<option value='3'>协作单位</option>"+
			                    "<option value='4'>组员单位</option>"+
		                    "</select>"+
                         "</td>" +
                         "<td align='center'><a href='javascript:;' class='dele'>删除</a></td>"+
                      "</tr>";
            addTr("fzdw_str", tr);
            dele();
           // formVerify();
        })
        
        
        
        

        /* 监听提交 */
        form.on('submit(sub)', function (data) {
            //JSON.stringify(data.field)  提交信息json格式
            /*parent.layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            })*/
            
            
            var zycmc=$("#zycbm").find("option:selected").text();
            var zycbm=$("#zycbm").val();
            if(zycbm==null || zycbm=='')
            {
            	  layer.alert("请选择专业处");
            	  return false;
            }else
            {
            	$("#zycmc").val(zycmc);
            }
            var fzdwStr = getData("fzdw_str", 2);
            if(fzdwStr==null || fzdwStr=='')
           	{
            	 layer.alert("请选择单位");
           	     return false;
           	}
            $("#fzdwStr").val(fzdwStr);
            console.log("zycmc :"+zycmc);
            console.log("fzdwStr单位 :"+fzdwStr);
            var url = '/ten_dragons/save?v_date=' + v_date + "&dataId=" + dataId;
            var backurl = "/ten_dragons/list?v_date=" + v_date;
            ajaxOpt(url, "form1", "POST", backurl, "保存成功", "保存失败");
            return false;
        });
    });


    function ajaxOpt(url, formName, type, backurl, successMsg, failMsg) {
        $.ajax({
            type: type,
            url: url,
            dataType: "json",
            data: $("#" + formName).serialize(),
            async: false,
            cache: false,
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success: function (data, status) {

                if (data.success == true || data.success == 'true') {


                    layer.alert(
                        successMsg,
                        {icon: 1, closeBtn: 0},
                        function () {
                            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                            parent.layer.close(index);  // 关闭layer
                            parent.location.href = backurl;
                        });

                } else {
                    layer.alert(failMsg);
                }

            },
            error: function () {
                layer.alert("网络访问错误");
            }

        });
    }

    
    
    
    /*删除行*/
    function dele() {
        $(".dele").click(function () {
            if ($(this).parents(".layui-row").attr("id") == "fzdw_str") {
                $(this).parents("tr").remove();
                $("#fzdw_str table tbody tr").each(function (i, val) {
                    $(val).find("td:first").text(i + 1)
                });
                return;
            }
            $(this).parents("tr").remove();
        });
    }
    
    function formVerify() {
        form.verify({
            validateNumber: function (value, item) {
                if (value <= 0 || value > 2000) {
                    return '请填写正确的值';
                }
            },
            specialCharacters: function (value, item) {

                if (value.indexOf("#") >= 0 || value.indexOf("|") >= 0) {
                    return "不能填写#与|两个字符。";
                }
            }
        });
    }
    
    
    /*添加行*/
    function addTr(id, tr) {
        $("#" + id + " table tbody").append(tr);
    }
    
    
    
    
    /*获取值*/
    function getData(id, number) {
        /*获取值*/
        var columnTrL = $("#" + id + " table tbody tr").length;
        var columnSC = '';
        $("#" + id + " table tbody tr").each(function (i) {
            var columnS = '';
            for (var k = 0; k < number; k++) {
                var tdElement = $("#" + id + " table tbody tr:eq(" + i + ") td").eq(k);
                if ($(tdElement).find("input").length > 0) 
                {
                    if ($(tdElement).find("input").val() == '') 
                    {
                        columnS += " " + "#";
                    } else 
                    {
                        columnS += $(tdElement).find("input").val() + "#";
                    }
                }else  if ($(tdElement).find("select").length > 0) 
                {
                    if ($(tdElement).find("select").val() == '') 
                    {
                        columnS += " " + "#";
                    } else 
                    {
                        columnS += $(tdElement).find("select").val() + "#";
                    }
                }
                	
                	
                else if ($(tdElement).find("textarea").length > 0) 
                {
                    if ($(tdElement).find("textarea").val() == '')
                    {
                        columnS += " " + "#";
                    } else {
                        columnS += $(tdElement).find("textarea").val() + "#";
                    }
                } else 
                {
                    columnS += $(tdElement).html() + "#";
                }
            }
            columnSC += columnS.substring(0, columnS.length - 1) + "|"
        });
        columnSC = columnSC.substring(0, columnSC.length - 1);
        return columnSC;
    }
    
    
    
    function clearNoNum(obj) {
        obj.value = obj.value.replace(/[^\d.]/g, "");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3');//只能输入两个小数
        if (obj.value.indexOf(".") < 0 && obj.value != "") {//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value = parseFloat(obj.value);
        }
    }

</script>
</body>
</html>