<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>中核科技管理平台</title>
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
  <!-- 多选下拉框样式，根据需求添加 -->
  <link rel="stylesheet" href="/layuiadmin/layui/css/modules/formSelects-v4.css" />
  <link rel="stylesheet" href="/css/layui-common.css">
  <link rel="stylesheet" href="/css/common.css">

  <style>
    .more-item:not(:first-child) {
      margin-top: 20px;
    }

    .more-item button {
      width: 30px;
      height: 30px;
      background: none;
      border: 1px solid rgba(10,161,255,1);
      border-radius: 50%;
      color: #0AA1FF;
    }

    .more-item button.more-item-del-btn {
      background: rgb(194, 200, 203);
      color: #ffffff;
      border: none;
    }

    #knownImagesView img{
      margin-right: 10px;
      width: 78px;
      height: 81px;
      display: inline-block;
      border: 1px solid #dddddd;
    }

    #knownImagesView{
      display: flex;
      justify-content: flex-start;
    }

    #knownImagesView .img-div {
      margin-right: 20px;
      width: 90px;
      height: 90px;
      position: relative;
    }

    #knownImagesView .sb-img {
      position: absolute;
      right: 0;
      top: -8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #8D8D8D;
      padding: 2px;
      color: #ffffff;
    }

  </style>
  <!-- 更多样式在此引入 -->
</head>

<body class="">
  <div class="layout-view-content dialog">
    <form class="layui-form" action="" id="formPlatform" lay-filter="formPlatform">
        <div class="layui-row layui-col-space20">
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                <div class="layui-form-item">
                  <label class="layui-form-label label-required"><span class="text">密级：</span></label>
                  <div class="layui-input-block">
                    <select id="secretLevel" lay-filter="secretLevel" name="secretLevel" dic-base-data="ROOT_KJPT_XXMJ" lay-verify="required" placeholder="请选择..."> 
                    </select>
                  </div>
                </div>
            </div>  
          
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                <div class="layui-form-item">
                    <i class="layui-icon layui-icon-vercode secret-level-helper"></i>
                    <label class="secret-level-helper">通过设置密级给信息加密，不同密级的用户有不同信息权限</label>  
                </div>
            </div>
                 
        </div>
        <!-- 知悉范围 -->
        <div id="scope_list_layout"></div>
      <div class="secret-level-line"></div>
      
      <div class="layui-row layui-col-space20">
        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
            <div class="layui-form-item">
                <label class="layui-form-label label-required"><span class="text">单位名称:</span></label>
                <div class="layui-input-block">
                    <select name="unitName"
                        xm-select="supportingInstitutions"
                        xm-select-skin="normal"
                        lay-verify="required"
                        xm-select-radio=""
                        dic-base-data="ROOT_KJPT_YTDW" 
                        placeholder="请选择"></select>
                </div>
            </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">商标名称：</span></label>
            <div class="layui-input-block">
              <input type="text" name="trademarkName" lay-verify="required" placeholder="" autocomplete="off"
                     class="layui-input">
            </div>
          </div>
        </div>

        <div id="applicant">
          <div class="more-item">
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
              <div class="layui-form-item">
                <label class="layui-form-label label-required"><span class="text">申请人：</span></label>
                <div class="layui-input-block">
                  <input type="text" name="applicant" lay-verify="required" placeholder="" autocomplete="off"
                         class="layui-input applicantlist">
                </div>
              </div>
            </div>
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
              <div class="layui-form-item" style="padding-left: 20px;">
                <label class="layui-form-label label-required" style="text-align: left">
                  <button class="add-more-item-btn" type="button">
                    <i class="layui-icon">&#xe654;</i>
                  </button>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">国际分类号：</span></label>
            <div class="layui-input-block">
              <input type="text" name="countryType" placeholder="" autocomplete="off"
                     class="layui-input">
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">注册单位：</span></label>
            <div class="layui-input-block">
              <input type="text" name="registerOrg" lay-verify="required" placeholder="" autocomplete="off"
                     class="layui-input">
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">注册日期：</span></label>
            <div class="layui-input-block">
              <input type="text" name="registerDate" id="registerDate" lay-verify="required" placeholder="" autocomplete="off"
                     class="laydate-input">
            </div>
          </div>
        </div>

        <!--<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">核定使用商品大类：</span></label>
            <div class="layui-input-block">
              <select name="commodityCategory" xm-select="commodityCategory" dic-base-data="ROOT_KJPT_HDSYSPDL">
                <option value=""></option>
              </select>
            </div>
          </div>
        </div>-->

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">有效期：</span></label>
            <div class="layui-input-block">
              <input type="text" name="effectiveDate" id="effectiveDate" lay-verify="required" placeholder="" autocomplete="off"
                     class="laydate-input">
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">延展有效期：</span></label>
            <div class="layui-input-block">
              <input type="text" name="extensionPeriod" id="extensionPeriod" placeholder="" autocomplete="off"
                     class="laydate-input">
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">商标类型：</span></label>
            <div class="layui-input-block">
              <!-- <input type="text" name="tradeMarkType" placeholder="" autocomplete="off" class="layui-input"> -->
              <select name="tradeMarkType" dic-base-data="ROOT_KJPT_SBLX"  placeholder="请选择...">
              </select>
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">法律状态：</span></label>
            <div class="layui-input-block">
              <select name="lawStatus" dic-base-data="ROOT_KJPT_FLZT(SB)" lay-verify="required" placeholder="请选择...">
              </select>
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">驰名商标：</span></label>
            <div class="layui-input-block">
              <select name="isWellKnown" lay-filter="isWellKnown" select="isWellKnown"  select-skin="normal"  dic-base-data="ROOT_UNIVERSAL_WEHTHER"></select>
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
        </div>
        <div id="wellKnownDateBox" class="">
          <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
            <div class="layui-form-item">
              <label class="layui-form-label"><span class="text">驰名商标认定日期：</span></label>
              <div class="layui-input-block">
                <input type="text" name="wellKnownDate" id="wellKnownDate" placeholder="" autocomplete="off" class="laydate-input">
              </div>
            </div>
          </div>
          <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
            <div class="layui-form-item">
              <label class="layui-form-label"><span class="text">驰名商标认定机构：</span></label>
              <div class="layui-input-block">
                <input type="text" name="wellKnownOrg" placeholder="" autocomplete="off" class="layui-input">
              </div>
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label label-required"><span class="text">著名商标：</span></label>
            <div class="layui-input-block">
              <select name="isRegistered" select="isRegistered" lay-filter="isRegistered"  select-skin="normal"  dic-base-data="ROOT_UNIVERSAL_WEHTHER"></select>
            </div>
          </div>
        </div>
        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
        </div>
        <div id="isRegisteredBox" class="">
        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">著名商标认定日期：</span></label>
            <div class="layui-input-block">
              <input type="text" name="famousDate" id="famousDate" placeholder="" autocomplete="off" class="laydate-input">
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">著名商标认定机构：</span></label>
            <div class="layui-input-block">
              <input type="text" name="famousOrg" placeholder="" autocomplete="off" class="layui-input">
            </div>
          </div>
        </div>
      </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">商标图片：</span></label>
            <div class="layui-input-block" id="knownImages">
              <input type="text" value="上&nbsp;&nbsp;&nbsp;&nbsp;传" class="layui-input"
                     style="text-align: center; border: 1px dashed #0AA1FF;color: #0AA1FF; cursor: pointer;">
<!--              <div label="imgUpload"></div>-->
<!--              <span class="file-img-del middle-block"><span class="del" label="imgDelete">删除</span></span>-->
              <!--<div class="img-view-block middle-block" id="imgFileUpload">
                <img src="" alt="请选择图片上传" />
                <div class="file-img-btn" label="imgUpload" >
                  <span class="btn-icon"></span>
                  <span class="btn-text">点击此区域上传照片，请上传.jpg, .jpeg, .bmp, .gif格式</span>
                </div>
              </div>-->
            </div>
          </div>
        </div>

        <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
        </div>

        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
          <label class="layui-form-label"><span class="text"></span></label>
          <div class="layui-input-block">
            <div class="layui-upload-list" id="knownImagesView">
            </div>
          </div>
        </div>

        <!--<div id="file-filter-options">
          <div class="view-title-layout disabled-box view-pt0">
            <div class="right">
              <label type="button" class="layui-btn border-blue" filter="addFile">添加附件</label>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label"><span class="text">附件：</span></label>
            <div class="layui-input-block">
              <table></table>
            </div>
          </div>
        </div>-->

        <div class="dialog-footer-btn">
          <button class="layui-btn layui-btn-normal" type="button" lay-submit="" lay-filter="newSubmit">提交</button>
          <button class="layui-btn layui-btn-primary close-all-dialog" type="button">取消</button>
        </div>
      </div>
      <input type="hidden" name="id">
      <input type="hidden" name="creator">
      <input type="hidden" name="createDate">
      <input type="hidden" name="updateDate">
      <input type="hidden" name="updator">
      <input type="hidden" name="deleted">
      <input type="hidden" name="level">
      <input type="hidden" name="files" id="files">
    </form>
  </div>
  <script type="text/javascript" src="/plugins/jQuery/jquery-1.10.1.min.js"></script>
  <script src="/layuiadmin/layui/layui.js"></script>
  <script src="/layuiadmin/js/common.js"></script>
  <script src="/layuiadmin/js/fileUpload.js"></script>
</body>

</html>

<script>
  layui.use(['form', 'jquery', 'laydate','formSelects', 'upload'], function () {
    var $ = layui.jquery;
    var form = layui.form;
    var laydate = layui.laydate;
    var formSelects = layui.formSelects;

    // formSelects.btns('unitName', ['remove']); // 只显示清除按钮
    function upLoadFile(billDataID) {
      setFileUpload({
        id: 'file-filter-options', // 附件上传作用域ID值 必传
        dataID: billDataID, // 用来查找当前单据下绑定的附件，没有则不查找
        secretLevel : function() {
              return $("#secretLevel").val();
            },
        callback: function (tableData, type) {
          /* callback 表格数据每次变更时的回调，返回表格数据与操作类型
            * type 触发变更的类型 目前只有 delete | upload
          */
          var fileString = "";
          var fileArray = [];
          if (tableData.length) {
            for (var i = 0; i < tableData.length; i++) {
              // fileString = fileString + "," + tableData[i].id;
              if(tableData[i].id){
                fileArray.push(tableData[i].id);
              }
            }
          }
          fileString = fileArray.join(",");
          $("[name=files]").val(fileString);
        }
      })
    }


    function getItemInitData(item) {
      var httpUrl = '/trademarkController/newInit';
      if (item && item.id) {
        httpUrl = '/trademarkController/load/' + item.id;
      }
      httpModule({
        url: httpUrl,
        type: 'GET',
        success: function (relData) {
          console.log(relData)
          if (relData.code === '0') {
            // 给form表单赋初始值
            var data = relData.data;
            var applicant = data.applicant;
            var applicantArray = applicant && applicant.indexOf(',')?applicant.split(','):[];
            if (applicantArray.length > 0) {
              $.each(applicantArray, function (k, v) {
                if (k == 0) {
                  data.applicant = v;
                } else {
                  addItem(v, 'edit');
                }
              });
            }
            transToData(data, ['registerDate','effectiveDate','extensionPeriod','wellKnownDate', 'famousDate']);
            form.val('formPlatform', data);
            if (item && item.id) {
              data.isWellKnown == '0'? $('#wellKnownDateBox').attr("class",'') : $('#wellKnownDateBox').attr('class','layui-hide');
              data.isRegistered == '0'? $('#isRegisteredBox').attr("class",'') : $('#isRegisteredBox').attr('class','layui-hide');
            }
            // 更新表单数据
            form.render();
            formSelects.value('supportingInstitutions', [data.unitName]);

            //images
            var files = relData.data.files;
            var filesArray = files?files.split(','):[];
            if (filesArray.length > 0) {
              $.each(filesArray, function (k, v) {
                var src = '/file/imgFile/' + v;
                $('#knownImagesView').append('<div class="img-div">\n' +
                        '                <img src="' + src + '" data-field="' + v + '">\n' +
                        '                <span class="sb-img" data-field="' + v + '"><i class="layui-icon">&#x1006;</i></span>\n' +
                        '              </div>');
              });
            }

            // 添加知悉范围
            setJurisdictionScope({
              elem: 'scope_list_layout',
              knowledgeScope: data.knowledgeScope,
              knowledgePerson: data.knowledgePerson,
              secretLevel: data.secretLevel,
              disabled: false
            });
          }
        }
      });
    }

    function transToData(data, fields) { //转换时间戳
        $.each(fields, function(index, f){
           
          if(data[f]) {
            try {
              data[f] = (new Date(data[f])).format('yyyy-MM-dd');
            }
            catch (e) {
              
            }
          }  
        });
      }

    // 获取地址栏传递过来的参数
    var variable = getQueryVariable();
    getItemInitData(variable);

    form.on('submit(newSubmit)', function (data) {
      //处理多个申请人的情况，逗号分隔
      var els = $(data.form).find('.applicantlist');
      var applicat = '';
      els.each(function () {
        var value = $(this).val();
        applicat = value ? applicat + value + ',' : applicat;
      });
      applicat = applicat.endsWith(',')?applicat.substring(0, applicat.length-1):applicat;
      var params = data.field;
      params.applicant = applicat;

      //var val = formSelects.value('applicationType2');
      httpModule({
        url: '/trademarkController/save',
        data: params,
        type: "POST",
        success: function (e) {
          setDialogData(e); // 通知上层页面状态 - 弹窗中使用
          top.layer.closeAll(); // 关闭弹窗
        }
      });
      return false;
    })

    laydate.render({ //渲染时间表单
      elem: '#validDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#bulletinDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#registerDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#importDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#registerDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#extensionPeriod',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#effectiveDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#famousDate',
      trigger: 'click',
    });
    laydate.render({ //渲染时间表单
      elem: '#wellKnownDate',
      trigger: 'click',
    });
    form.on('select(isWellKnown)', function(data){
        data.value == '0'? $('#wellKnownDateBox').attr("class",'') : $('#wellKnownDateBox').attr('class','layui-hide');
      });
    form.on('select(isRegistered)', function(data){
        data.value == '0'? $('#isRegisteredBox').attr("class",'')  : $('#isRegisteredBox').attr('class','layui-hide');
      });
    //新增多个申请人
    $("body").on("click",".add-more-item-btn", addItem);
    function addItem (value, type) {
      var delHtml = '<button class="more-item-del-btn" type="button">\n' +
              '                    <i class="layui-icon">&#x1006;</i>\n' +
              '                  </button>';
      var el = '';
      if (type && type == 'edit') {
        el = $('.more-item .add-more-item-btn');
      } else {
        el = $(this);
      }
      var parent = el.parent();
      var htmlsel = parent.parent().parent().parent('.more-item');
      var appendparent = htmlsel.parent();
      var html = htmlsel.prop("outerHTML");
      html = html.indexOf('申请人：')>=0?html.replace('申请人：', '&nbsp;'):html;
      html = html.indexOf('label-required')>=0?html.replace('label-required', ''):html;
      appendparent.append(html);
      el.remove();
      setTimeout(function () {
        parent.append(delHtml);
      }, 1);

      //赋值
      setTimeout(function () {
        if (typeof value == 'string') {
          var nextMoreItem = htmlsel.next();
          nextMoreItem.find('.layui-input-block input').val(value);
          form.render();
        }
      }, 10);
    }

    $("body").on("click",".more-item-del-btn", delItem);
    function delItem() {
      var parent = $(this).parent().parent().parent().parent('.more-item');
      var html = parent.html();
      var firstParent = parent.parent();
      parent.remove();
      if (html.indexOf('申请人：') >= 0) {
        firstParent.children(".more-item:first-child").find('.layui-form-label span').text('申请人：');
      }
    }

    //上传商标图片
    /*setImagesUpload({
      id: 'knownImages',
      accept: 'images'
    });*/

    layui.upload.render({
      elem: '#knownImages',
      url: '/file/upload',
      before: function(obj){
      }
      ,done: function(res){
        if (res.code !== '0') {
          top.layer.msg('图片上传失败 => ' + res.message,  {icon: 2});
        } else {
          top.layer.msg('图片上传成功！',  {icon: 1});
          var src = '/file/imgFile/' + res.data.id;
          var fileValue = $("#files").val();
          var newFiles = fileValue ? fileValue + ',' + res.data.id : res.data.id;
          $("#files").val(newFiles);
          $('#knownImagesView').append('<div class="img-div">\n' +
                  '                <img src="' + src + '" data-field="' + res.data.id + '">\n' +
                  '                <span class="sb-img" data-field="' + res.data.id + '"><i class="layui-icon">&#x1006;</i></span>\n' +
                  '              </div>');
        }
      }
      ,error: function(error){
        //请求异常回调
        top.layer.msg('图片上传失败，请重新尝试',  {icon: 2});
      }
    });

    $("body").on("click",".sb-img", function () {
      var datafield = $(this).attr('data-field');
      var files = $("#files").val();
      var newFiles = files ? files.split(',') : [];
      var result = newFiles.filter(function (value, index) {
        return value != datafield;
      });
      $("#files").val(result?result.join(','):'');
      $(this).parent().remove();
    });
  });
</script>