<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>灵活分析</title>
    <link rel="Shortcut Icon" href="/layuiadmin/layui/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
    <link rel="stylesheet" href="/layuiadmin/style/common.css">
    <link rel="stylesheet" href="/layuiadmin/style/tab.css">
    <script type="text/javascript" src="/plugins/jQuery/jquery-1.11.3.min.js"></script>
</head>
<body>
<div class="analysis">
    <div class="layui-col-sm12">
        <div class="layui-card">
            <div class="layui-card-header">
                灵活分析
                <div class="layui-btn-group layuiadmin-btn-group layuiadmin-right">
                    <ul class="layui-nav">
                        <li class="layui-nav-item"><a href="javascript:;" class="layui-btn layui-btn-primary layui-btn-xs">设置</a></li>
                        <li class="layui-nav-item"><a href="javascript:;" class="layui-btn layui-btn-primary layui-btn-xs">收藏</a></li>
                        <li class="layui-nav-item"><a data-type="clickHeight" class="header-stop layui-btn layui-btn-primary layui-btn-xs" href="javascript:;">收起</a></li>
                        <li class="layui-nav-item">
                            <a href="javascript:;" class="layui-btn layui-btn-primary layui-btn-xs">模型</a>
                            <dl class="layui-nav-child layui-anim layui-anim-upbit" id="mxlit">
                            </dl>
                        </li>
                    </ul>

                </div>
            </div>
            <div class="layui-card-body">
                <div class="layui-row">
                    <div class="plus-tag tagbtn clearfix layui-show" id="myTags">
                        <div id="tj" class="tj parent-box">
                            <ul class="layui-nav  list-one" id="barU">
                                <li><span>已选维度:</span></li>
                            </ul>
                        </div>

                        <div id="zb" class="zb parent-box">
                            <ul class="layui-nav  list-two" id="barD">
                                <li><span>已选指标:</span></li>
                            </ul>
                        </div>
                    </div>
                    <div id="mycard-plus">
                        <div class="default-tag tagbtn">
                            <div class="clearfix">
                                <div class="hotspot">
                                    <ul class="layui-nav">
                                        <li id="wd_show_obj_array"><span>选择维度:</span></li>
                                        <li class="layui-nav-item" style="float:right; "><a class="hotspot-mr-a" href="javascript:;">展开更多</a></li>
                                    </ul>
                                </div>
                                <div class="hotspot-mr layui-hide" id="wd_hide_obj_array">
                                </div>
                            </div>
                            <div class="clearfix">
                                <div class="hotspot-target">

                                    <ul class="layui-nav">
                                        <li id="zb_show_obj_array"><span>选择指标:</span></li>
                                        <li class="layui-nav-item" style="float:right; "><a class="hotspot-target-a" href="javascript:;">展开更多</a></li>
                                    </ul>
                                </div>
                                <div class="hotspot-target-mr layui-hide" id="zb_hide_obj_array">
                                </div>
                            </div>
                            <div class="clearfix" style="display:none;">
                                <!--<a value="-1" title="网络营销" href="javascript:void(0);">-->
                                <!--<span>网络营销</span><em></em></a>-->
                            </div>
                        </div>
                        <div align="right"><a href="javascript:void(0);" id="change-tips" style="color:#3366cc;"></a></div>
                    </div>
                    <div class="time">
                        <label>
                            <span>查询日期:</span>
                            <div class="layui-form">
                                <input type="radio" name="time" value="按年份" title="按年份">
                                <input type="radio" name="time" value="按月份" title="按月份" checked>
                                <input type="text" class="layui-input layui-input-timeY layui-hide" id="test-laydate-type-year" placeholder="yyyy">
                                <input type="text" class="layui-input layui-input-timeM" id="test-laydate-type-month" placeholder="yyyy-MM">
                                <input type="hidden" name="dateRadio" id="dateRadio" value="">
                                <div class="btnGroup">
                                    <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" id="search" data-type="reload">查询
                                    </button>
                                    <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" id="clear" onclick="pcitcReport.clearChecked();">清除
                                    </button>
                                    <button class="layui-btn layui-btn-sm fontColor-default border-default btn_reset btnMyBgImg"
                                            data-type="reset">重置
                                    </button>
                                </div>
                            </div>

                        </label>
                    </div>
                </div>
                <div class="layui-col-xs3 layui-hide">
                    <!--查询条件-->
                    <div class="grid-demo grid-demo-bg1">
                        <div class="layui-form-item" style="width: auto;">
                            <!--<label class="layui-form-label">查询条件</label>-->
                            <div class="layui-input-block">
                                <input type="hidden" name="modelName" title="查询条件" autocomplete="off" class="layui-input" id="modelName">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="layui-col-sm12 layui-col-sm12-tab ">
        <div class="layui-tab layui-tab-brief" lay-filter="component-tabs-brief">
            <ul class="layui-tab-title">
                <li class="layui-this">图表</li>
                <!--<li>列表</li>-->
                <li style="display: none;">列表</li>
                <li>数据列表</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
                    <script type="text/javascript" src="/plugins/echarts/walden.js"></script>
                    <div class="choice-x">
                        <label>请选择业务分析维度:</label>
                        <select name="xData" id="xData">
                        </select>
                        <div class="btnGroup">
                            <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" id="ok" data-type="reloadPic">确定
                            </button>
                        </div>
                    </div>
                    <div id="main"></div>
                    <!--<script src="example/www2/js/dist/echarts-all.js"></script>-->

                </div>
                <!--<div class="layui-tab-item">-->
                <!--<div id="toolbarDemo" style="display: none;">-->
                <!--单位:万元-->
                <!--<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btnMyBgImg btn_export" onclick="exportTableToExcel();">导出</button>-->
                <!--</div>-->
                <!--<div class="tableBox">-->
                <!--<table id="testReload" class="layui-hide" lay-even></table>-->
                <!--</div>-->
                <!--</div>-->
                <div class="layui-tab-item">

                    <div class="tableBox">
                        <table id="testReload2" class="layui-hide" lay-filter="demoEvent" lay-even></table>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <!--<div id="toolbarDemo2" style="display: block;">-->
                    <!--单位:万元-->
                    <!--<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btnMyBgImg btn_export" onclick="exportTableToExcel();">导出</button>-->
                    <!--</div>-->
                    <table class="layui-hidden" id="treeTable" lay-filter="treeTable"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layui/report_lhfx.js"></script>
<script>
    //维度
    pcitcReport.createVar(JSON.parse('${wd_obj_array}'));
    //指标
    pcitcReport.createVar(JSON.parse('${zb_obj_array}'));
    //维度展示
    pcitcReport.show_wd(JSON.parse('${wd_show_obj_array}'));
    //维度隐藏
    pcitcReport.hide_wd(JSON.parse('${wd_hide_obj_array}'));
    //指标展示
    pcitcReport.show_zb(JSON.parse('${zb_show_obj_array}'));
    //指标隐藏
    pcitcReport.hide_zb(JSON.parse('${zb_hide_obj_array}'));
    //图表默认X轴
    pcitcReport.x_default(JSON.parse('${default_x_obj_array}'));
    //列表默认展示
    pcitcReport.list_default(JSON.parse('${default_wd_zb_obj_array}'));
    //字段默认值设置
    pcitcReport.field_default(JSON.parse('${default_column_obj_array}'));
    //模型类型
    pcitcReport.strNameType = "${name}";
    //设置日期
    $("#dateRadio").val(pcitcReport.getNowDateMonth());
    //初始化模型
    pcitcReport.getMxList();
</script>

<script>
    layui.use(['element', 'layer', 'form', 'treeGrid', 'element'], function () {
        var treeGrid = layui.treeGrid; //很重要
        var element = layui.element;
        var treeTable = treeGrid.render({
            elem: '#treeTable'
            , id: "treeTable"
            , url: '/report/getTableReportTree'
            , method: "post"
            , treeId: 'id'//树形id字段名称
            , treeUpId: 'pid'//树形父id字段名称
            , height: commonDislodgeTable()
            , treeShowName: pcitcReport.arrayColumns_tab[0].field//以树形式显示的字段
            , cols: [pcitcReport.arrayColumns_tab]
            , page: false
            , where: {
                "column": pcitcReport.strcolumns
                , "columnko": pcitcReport.strcolumnsko
                , "strall": pcitcReport.strall
                , "group": pcitcReport.strgroup
                , "where": pcitcReport.strwhere
                , "date": pcitcReport.date.replace("至", "`")
                , "gsdm": pcitcReport.gsdm
                , "xfield": pcitcReport.arrayColumns_tab[0].field
                , "name": pcitcReport.strNameType

            }
            , done: function (res, curr, count) {
                pcitcReport.changeTableId(res.data);
            }
        });
        var $ = layui.jquery, active = {
            reload: function () {
                pcitcReport.getCheck();
                var len = pcitcReport.arrayColumns_tab.length;
                var width = (100) / (len + 1);
                var cha = 0;
                for (var i = 0; i < len; i++) {
                    if (i == 0) {
                        pcitcReport.arrayColumns_tab[0].width = width * 2 + "%";
                    } else {
                        pcitcReport.arrayColumns_tab[i].width = width + "%";
                    }
                }

                //转换静态表格
                treeGrid.init('filter', opt);
                var opt = {
                    elem: '#treeTable'
                    , id: "treeTable"
                    , url: '/report/getTableReportTree'
                    , method: "post"
                    , treeId: 'id'//树形id字段名称
                    , treeUpId: 'pid'//树形父id字段名称
                    , treeShowName: pcitcReport.arrayColumns_tab[0].field//以树形式显示的字段
                    , cols: [pcitcReport.arrayColumns_tab]
                    , page: false
                    , height: commonDislodgeTable()
                    , where: {
                        "column": pcitcReport.strcolumns
                        , "columnko": pcitcReport.strcolumnsko
                        , "strall": pcitcReport.strall
                        , "group": pcitcReport.strgroup
                        , "where": pcitcReport.strwhere
                        , "date": pcitcReport.date.replace("至", "`")
                        , "gsdm": pcitcReport.gsdm
                        , "xfield": pcitcReport.arrayColumns_tab[0].field
                        , "name": pcitcReport.strNameType

                    }
                    , done: function (res, curr, count) {
                        pcitcReport.changeTableId(res.data);
                    }
                };
                var tableObj = treeGrid.render({});
                tableObj.reload(opt);
            },
            reset: function () {
                location.reload();
            }
        };
        $('i').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
<script>
    $.fn.rowspan = function (combined) {
        return this.each(function () {
            var that;
            $('tr', this).each(function (row) {
                $('td:eq(' + combined + ')', this).filter(':hidden').each(function (col) {
                    // $('td:eq('+combined+')', this).filter(':visible').each(function(col) {
                    if (that != null && $(this).html() == $(that).html()) {
                        rowspan = $(that).attr("rowSpan");
                        if (rowspan == undefined) {
                            $(that).attr("rowSpan", 1);
                            rowspan = $(that).attr("rowSpan");
                        }
                        rowspan = Number(rowspan) + 1;
                        $(that).attr("rowSpan", rowspan);
                        $(this).hide();
                    } else {
                        that = this;
                    }
                });
                $('td:eq(' + combined + ')', this).filter(':visible').each(function (col) {
                    // $('td:eq('+combined+')', this).filter(':visible').each(function(col) {
                    if (that != null && $(this).html() == $(that).html()) {
                        rowspan = $(that).attr("rowSpan");
                        if (rowspan == undefined) {
                            $(that).attr("rowSpan", 1);
                            rowspan = $(that).attr("rowSpan");
                        }
                        rowspan = Number(rowspan) + 1;
                        $(that).attr("rowSpan", rowspan);
                        $(this).hide();
                    } else {
                        that = this;
                    }
                });
            });
        });
    };
    layui.use(['jquery', 'table', 'element', 'form', 'laydate'], function () {
        //     var table = layui.table;
        var form = layui.form;
        var element = layui.element;
        var $ = layui.jquery;
        var laydate = layui.laydate;
        //年选择器
        laydate.render({
            elem: '#test-laydate-type-year'
            , type: 'year'
            , value: new Date().getFullYear() + " 至 " + new Date().getFullYear()
            , range: '至'
            , done: function (value, data) {
                $("#dateRadio").val(value);
            }
        });

        //年月选择器
        laydate.render({
            elem: '#test-laydate-type-month'
            , type: 'month'
            , value: new Date().getFullYear() + "-" + (new Date().getMonth() + 1) + " 至 " + new Date().getFullYear() + "-" + (new Date().getMonth() + 1)
            , format: 'yyyy-MM'
            , range: '至'
            , done: function (value, data) {
                $("#dateRadio").val(value);
            }
        });

        $(".layui-unselect").click(function () {
            if ($(this).find("div").html() == "按年份") {
                $(".layui-input-timeY").removeClass("layui-hide");
                $(".layui-input-timeM").addClass("layui-hide");
                $("#dateRadio").val($(".layui-input-timeY").val());
            } else if ($(this).find("div").html() == "按月份") {
                $(".layui-input-timeM").removeClass("layui-hide");
                $(".layui-input-timeY").addClass("layui-hide");
                $("#dateRadio").val($(".layui-input-timeM").val());

            }
        });
        var $ = layui.jquery, active = {};
        form.render('select', 'xData')
        $('i').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        $(".hotspot a:last").on("click", function () {
            if ($(".hotspot-mr").hasClass("layui-hide")) {
                $(".hotspot a:last").html("收起更多")
                $(".hotspot-mr").removeClass("layui-hide");
            } else {
                $(".hotspot a:last").html("展开更多")
                $(".hotspot-mr").addClass("layui-hide")
            }
        });
        $(".hotspot-target a:last").on("click", function () {
            if ($(".hotspot-target-mr").hasClass("layui-hide")) {
                $(".hotspot-target a:last").html("收起更多")
                $(".hotspot-target-mr").removeClass("layui-hide")
            } else {

                $(".hotspot-target a:last").html("展开更多")
                $(".hotspot-target-mr").addClass("layui-hide")
            }
        });
        var layuiCDHeight = parseInt($(window).height()) - parseInt($(".layui-card").height() + 20)
        $(".layui-col-sm12-tab").css("height", layuiCDHeight)
        $("#main").css('height', $(".layui-table-main").height())
        $(".header-stop").on("click", function () {
            if ($(".layui-card-body").hasClass("layui-hide")) {
                $(".header-stop").html("收起")
                $(".layui-card-body").removeClass("layui-hide");
            } else {
                $(".header-stop").html("展开")
                $(".layui-card-body").addClass("layui-hide")
            }
            var layuiCDHeight = parseInt($(window).height()) - parseInt($(".layui-card").height() + 20);
            console.log("table高度:" + layuiCDHeight);
            $(".layui-col-sm12-tab").css("height", layuiCDHeight)
        })
        $(".tagbtn a").on("click", function () {
            var layuiCDHeight = parseInt($(window).height()) - parseInt($(".layui-card").height() + 20)
            $(".layui-col-sm12-tab").css("height", layuiCDHeight)
        })
        /*hover效果*/
        $(".layui-collapse").mouseover(function () {
            if ($(this).find("div").hasClass("layui-hide")) {
                console.log("1111")
                $(this).find("div").removeClass("layui-hide")
            }
        })
    });
    //设置默认X轴
pcitcReport.setDefaultX();
</script>
<!--图表2-->
<script>
    layui.use(['jquery', 'table', 'element'], function () {
        var table = layui.table;
        var form = layui.form;
        var element = layui.element;
        var $ = layui.jquery;
        var fullHeight = 350;
        $(".header-stop").click(function () {
            if ($(".layui-card-body").hasClass("layui-hide")) {
                fullHeight = 260;
            } else {
                fullHeight = 350;
            }

        })
        //渲染
        table.render({
            id: 'model2'
            , elem: '#testReload2'
            , limit: 5
            , height: commonDislodgeTable()
            , method: 'POST'
            , cache: false
            , where: {
                "column": pcitcReport.xfield+","
                , "columnko": pcitcReport.strcolumnsko
                , "strall": pcitcReport.strall
                , "group": pcitcReport.xfield
                , "where": pcitcReport.strwhere
                , "date": pcitcReport.date.replace("至", "`"),
                "gsdm": pcitcReport.gsdm
                , "name": pcitcReport.strNameType

            }
            , url: '/report/getTableReport'
            , toolbar: '#toolbarDemo2'
            , page: false
            , cols: [pcitcReport.arrayColumns_pic]
            , loading: true
            , done: function (res, curr, count) {
                console.log("为什么显示不出来");
                console.log(res.data);
                pcitcReport.initTable(res.data);
            }
        });

        //监听单元格事件
        table.on('tool(demoEvent)', function (obj) {
            var data = obj.data;
        });

        var $ = layui.jquery, active = {
            reload: function () {
                pcitcReport.arrayColumns_pic = pcitcReport.arrayColumns_pic.slice(0, 0);
                pcitcReport.getCheck2();
                //转换静态表格
                table.init('filter', {});
                var opt = {
                    id: 'model2'
                    , elem: '#testReload2'
                    , limit: 5
                    , height: 'full-' - fullHeight
                    , method: 'POST'
                    , cache: false
                    , where: {
                        "column": pcitcReport.xfield+","
                        , "columnko": pcitcReport.strcolumnsko
                        , "strall": pcitcReport.strall
                        , "group": pcitcReport.xfield
                        , "where": pcitcReport.strwhere
                        , "date": pcitcReport.date.replace("至", "`"),
                        "gsdm": pcitcReport.gsdm
                        , "name": pcitcReport.strNameType
                    }
                    , url: '/report/getTableReport'
                    , toolbar: '#toolbarDemo2'
                    , page: false
                    , loading: true
                    , cols: [pcitcReport.arrayColumns_pic]
                    , done: function (res, curr, count) {
                        pcitcReport.initTable(res.data);
                    }
                };
                var tableObj = table.render({});
                tableObj.reload(opt);
            },
            reloadPic: function () {
                pcitcReport.arrayColumns_pic = pcitcReport.arrayColumns_pic.slice(0, 0);
                pcitcReport.getCheck2();
                //转换静态表格
                table.init('filter', {});
                var opt = {
                    id: 'model2'
                    , elem: '#testReload2'
                    , limit: 5
                    , height: 'full-' - fullHeight
                    , method: 'POST'
                    , cache: false
                    , where: {
                        "column": pcitcReport.xfield+","
                        , "columnko": pcitcReport.strcolumnsko
                        , "strall": pcitcReport.strall
                        , "group": pcitcReport.xfield
                        , "where": pcitcReport.strwhere
                        , "date": pcitcReport.date.replace("至", "`"),
                        "gsdm": pcitcReport.gsdm
                        , "name": pcitcReport.strNameType
                    }
                    , url: '/report/getTableReport'
                    , toolbar: '#toolbarDemo2'
                    , page: false
                    , loading: true
                    , cols: [pcitcReport.arrayColumns_pic]
                    , done: function (res, curr, count) {
                        console.log("------------done---------------");
                        pcitcReport.initTable(res.data);
                    }
                };
                var tableObj = table.render({});
                tableObj.reload(opt);
            },
            reset: function () {
                location.reload();
            }
        };
        $('i').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
<!--<script src="http://www.jq22.com/jquery/jquery-migrate-1.2.1.min.js"></script>-->
<script type="text/javascript" src="/plugins/jQuery/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="/layuiadmin/lib/extend/tab.js"></script>
<script type="text/javascript" src="/layuiadmin/lib/extend/Sortable.min.js"></script>
<script>
    pcitcReport.drag();
</script>
<script type="text/javascript" language="javascript">
    var idTmr;
    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,',
            template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>' +
                '<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->' +
                '</head><body><table>{table}</table></body></html>',
            base64 = function (s) {
                return window.btoa(unescape(encodeURIComponent(s)))
            },
            // 下面这段函数作用是：将template中的变量替换为页面内容ctx获取到的值
            format = function (s, c) {
                return s.replace(/{(\w+)}/g,
                    function (m, p) {
                        return c[p];
                    }
                )
            };
        return function (table, name) {
            console.log("table.nodeType:" + table.nodeType);

            if (!table.nodeType) {
                table = document.getElementById(table);
                console.log("table:" + table);
            }
            // 获取表单的名字和表单查询的内容
            var ctx = {worksheet: name || 'Worksheet', table: table.innerHTML};
        }
    });
    </script>