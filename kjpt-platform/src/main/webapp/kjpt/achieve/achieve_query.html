<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>中核科技管理平台</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
    <!-- 多选下拉框样式，根据需求添加 -->
    <link rel="stylesheet" href="/layuiadmin/layui/css/modules/formSelects-v4.css" />
    <link rel="stylesheet" href="/css/layui-common.css">
    <link rel="stylesheet" href="/css/common.css">

    <!-- 更多样式在此引入 -->
</head>

<body>
    <div class="layout-view-content min-label">
        <form class="layui-form layui-form-screen" action="" lay-filter="achTransfrom">
            <div class="layui-row layui-col-space20">
                <!-- 移动：6/12 | 平板：6/12 | 桌面：4/12 -->
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span class="text">年份：</span></label>
                        <div class="layui-input-block font0">
                            <div class="layui-input-inline margin0" style="width: calc(50% - 15px)">
                                <input type="text" name="startDate" id="inputStart" placeholder="请选择" autocomplete="off"
                                    class="laydate-input">
                            </div>
                            <span class="ib-block font14 text-center" style="width: 30px;">-</span>
                            <div class="layui-input-inline margin0" style="width: calc(50% - 15px)">
                                <input type="text" name="endDate" id="inputEnd" placeholder="请选择" autocomplete="off"
                                    class="laydate-input">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span class="text">成果名称：</span></label>
                        <div class="layui-input-block">
                            <input type="text" name="achieveName" placeholder="请输入" autocomplete="off"
                                class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span class="text">备案状态：</span></label>
                        <div class="layui-input-block">
                            <select class="auditStatus" name="auditStatus" placeholder="请选择" lay-filter="auditStatus"
                                dic-base-data="ROOT_KJPT_KJCG_SFWCQK"></select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span class="text">拟转化方式：</span></label>
                        <div class="layui-input-block">
                            <select class="achieveTransType" name="achieveTransType" placeholder="请选择"
                                lay-filter="achieveTransType" dic-base-data="ROOT_KJPT_KJCG_NZHFS"></select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label label-required"><span
                                class="text">所属单位（专业化公司/直属单位)：</span></label>
                        <div class="layui-input-block">
                            <select name="affiliatedUnit" xm-select="affiliatedUnit" xm-select-skin="normal"
                                dic-base-data="ROOT_KJPT_CGSSDW_ZYHGSZSDW"></select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label label-required"><span class="text">成果持有单位：</span></label>
                        <div class="layui-input-block">
                            <select name="finishUnitName" xm-select="finishUnitName" xm-select-skin="normal"
                                dic-base-data="ROOT_KJPT_YTDW"></select>
                        </div>
                    </div>
                </div>

                <!-- <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="text">拟受让单位：</span></label>
                    <div class="layui-input-block">
                        <input type="text" name="grantUnitName" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div> -->
                <!-- <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="text">完成情况：</span></label>
                    <div class="layui-input-block">
                        <select class="aboutCompleteInfo" name="aboutCompleteInfo" placeholder="请选择" lay-filter="aboutCompleteInfo" dic-base-data="ROOT_KJPT_KJCG_SFWCQK"></select>
                    </div>
                </div>
            </div> -->
                <!-- <div class="layui-col-xs12 layui-col-sm6 layui-col-md8">
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="text">录入时间：</span></label>
                    <div class="layui-input-block font0">
                        <div class="layui-input-inline margin0" style="width: calc(50% - 15px)">
                            <input type="text" readonly="readonly" name="startDate"
                                id="inputStart" placeholder="请选择" autocomplete="off" class="laydate-input">
                        </div>
                        <span class="ib-block font14 text-center" style="width: 30px;">-</span>
                        <div class="layui-input-inline margin0" style="width: calc(50% - 15px)">
                            <input type="text" name="endDate" readonly="readonly"
                                id="inputEnd" placeholder="请选择" autocomplete="off" class="laydate-input">
                        </div>
                    </div>
                </div> -->
                <!-- </div> -->

                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4 layui-col-btn">
                    <div class="layui-form-item">
                        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="formSubmit">查询</button>
                        <button type="reset" class="layui-btn layui-btn-primary" id="reset">重置</button>
                        <!-- <span class="layui-fold-btn"></span> -->
                        <span class="layui-btn layui-btn-normal layui-fold-btn-custom">自定义查询</span>
                    </div>
                </div>

            </div>
            <div class="layui-colla-content layui-hide">
                <div class="layui-row">
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md1 layui-col-btn"></div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md2 layui-col-btn">自定义条件查询设置</div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md2 layui-col-btn">数据项</div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md2 layui-col-btn">条件</div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md2 layui-col-btn">值</div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md2 layui-col-btn">
                        <span class="layui-btn layui-btn-normal" id="custormAdd">增加</span>
                    </div>
                </div>
                <div id="custromFrom"></div>
            </div>
        </form>
        <div class="view-title-layout" id="opations-btn">
            <div class="right">
                <button class="layui-btn border-blue openLayerPage" id="exportData" button-role="export">导出</button>
            </div>
        </div>
        <table id="tableDemo" lay-filter="tableDemo"></table>

    </div>
    <script type="text/javascript" src="/plugins/jQuery/jquery-1.10.1.min.js"></script>
    <script src="/layuiadmin/layui/layui.js"></script>
    <script src="/layuiadmin/js/common.js"></script>
    <script>
        layui.use(['table', 'form', 'laydate'], function () {
            var table = layui.table;
            var form = layui.form;
            var laydate = layui.laydate;
            var tableRender = false;

            function queryTable(searchData) {
                if (!tableRender) {
                    tableRender = true;
                    table.render({
                        elem: '#tableDemo',
                        url: '/achieveRecord-api/query' //数据接口
                            ,
                        cols: [
                            [ //表头
                                {
                                    type: 'numbers',
                                    title: '序号',
                                    width: 80
                                }, {
                                    field: 'auditStatusText',
                                    title: '备案状态'
                                }, {
                                    field: 'achieveName',
                                    title: '成果名称',
                                    templet: function (d) {
                                        var templet =
                                            '<div class="options-list middle-block"><div class="ib-block">';
                                        templet +=
                                            '<span class="link-text recordDetails" data-auditstatus="' +
                                            d.auditStatus + '" data-type="view" data-id="' + d
                                            .id + '">' + d.achieveName + '</span>';
                                        return templet;
                                    }
                                }, {
                                    field: 'finishUnitNameText',
                                    title: '成果持有单位'
                                }, {
                                    field: 'affiliatedUnitText',
                                    title: '所属单位（专业化公司/直属单位)'
                                }, {
                                    field: 'achieveInfo',
                                    title: '成果基本情况',
                                    sort: true
                                }, {
                                    field: 'grantUnitName',
                                    title: '拟受让单位'
                                }, {
                                    field: 'achieveTypeText',
                                    title: '是否核心技术成果',
                                    sort: true
                                }, {
                                    field: 'achieveTransTypeText',
                                    title: '拟转让方式'
                                }
                                // ,{field: 'aboutCompleteInfoText', title: '完成情况', sort: true}
                                // ,{field: 'aboutCompleteTime', title: '未完成项目预计完成时间', sort: true, templet: function(d) {
                                //     if (d.aboutCompleteTime) {
                                //         return new Date(d.aboutCompleteTime).format('yyyy-MM-dd');
                                //     } else {
                                //         return '-';
                                //     }
                                // }}

                                , {
                                    field: 'secretLevelText',
                                    title: '密级',
                                    sort: true,
                                    hide: _hideSecrecylevel()
                                }
                            ]
                        ],
                        parseData: function (res) {
                            return layuiParseData(res);
                        },
                        request: {
                            pageName: 'pageNum', // 重置默认分页请求请求参数 page => pageIndex
                            limitName: 'pageSize' // 重置默认分页请求请求参数 limit => pageSize
                        },
                        page: true, //开启分页
                        limit: 10, // 每页数据条数,
                        limits: [5, 10, 15, 20], // 配置分页数据条数
                        where: searchData
                    });
                } else {
                    table.reload('tableDemo', {
                        where: searchData
                    });
                }
            }
            $("#reset").click(function () {
                queryTable('')
            })
            window.returnTableName = function(){ //返回自定义查询需要的表格字段
            return 'achieve_record'
        }
            //开始日期
            laydate.render({
                elem: '#inputStart',
                trigger: 'click',
                type: 'year',
                change: function (value, date) { //监听日期被切换
                    $('#inputStart').val(value);
                    $('#inputEnd').val(value);
                }
            });

            //结束日期
            laydate.render({
                elem: '#inputEnd',
                trigger: 'click',
                type: 'year'
            });
            // 监控表单提交事件
            form.on('submit(formSubmit)', function (data) {
                var json=setVal(data);
                queryTable(json);
                return false;
            });
            $('[lay-filter="formSubmit"]').click();

            // 备案详情，查看，录入，转化
            $('#record_list_table').on('click', '.recordDetails', function (e) {
                var index = parent.$("#LAY_app_body div.layui-show").index() - 1;
                var optionType = $(this).data('type'),
                    dialogTitle = $(this).text().trim(),
                    id = $(this).data('id'),
                    auditStatus = $(this).data('auditstatus');
                url = '/kjpt/achieve/record_input.html?type=' + optionType + '&id=' + id + "&index=" +
                    index;
                url += '&functionId=' + functionId;
                parent.layui.index.openTabsPage(url, dialogTitle + '申请');
            })

            // 导出 /achieveRecord-api/exportExcel
            $('#exportData').on('click', function (e) {
                var formValue = form.val('achTransfrom'),
                    searchData = {
                        achieveName: formValue.achieveName, // 成果名称
                        finishUnitName: formValue.finishUnitName, // 完成单位、持有单位
                        auditStatus: formValue.auditStatus, // 备案状态
                        startDate: formValue.startDate, // 录入开始时间
                        endDate: formValue.endDate, // 录入结束时间
                        achieveType: "", // 成果类型、是否为核心成果
                        aboutCompleteInfo: formValue.aboutCompleteInfo, // 完成情况
                        grantUnitName: formValue.grantUnitName, // 成果受让单位
                        achieveTransType: '', // 转化方式
                        secretLevel: '' // 密级
                    },
                    exportUrl = '';

                for (var key in searchData) {
                    exportUrl += '&' + key + '=' + searchData[key];
                }
                exportUrl = '/achieveRecord-api/exportExcel?' + exportUrl.substring(1);
                console.log(formValue);
                // 附件下载
                window.open(exportUrl, '_blank');
            })
        })
    </script>
</body>

</html>