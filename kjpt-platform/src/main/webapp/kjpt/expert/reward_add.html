<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>中核科技管理平台</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
    <!-- 多选下拉框样式，根据需求添加 -->
    <!-- <link rel="stylesheet" href="/layuiadmin/layui/css/modules/formSelects-v4.css" /> -->
    <link rel="stylesheet" href="/css/layui-common.css">
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .item{margin-bottom: 10px !important;}
        .add-item{width: 100%;background: #fff;border: 1px solid #aaa;border-radius: 3px;
            height: 30px;line-height: 30px;color: #1890FF;cursor: pointer;}
    </style>
</head>
<body class="">
<div class="layout-view-content dialog">
    <div class="layui-tab" lay-filter="tab-demo">
        <ul class="layui-tab-title tab-btn-layout">
            <li class="layui-this">关联添加</li>
            <li>手动录入</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div class="layui-hide" id="item">
                    <div class="layui-row layui-col-space20">
                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                            <div class="layui-form-item item">
                                <label class="layui-form-label label-required"><span class="text">奖励级别:</span></label>
                                <div class="layui-input-block">
                                    <input type="text" name="rewarkLevel" lay-verify="required"
                                           placeholder="" autocomplete="off" class="layui-input rewarkLevel">
                                </div>
                            </div>
                            <div class="layui-form-item item">
                                <label class="layui-form-label label-required"><span class="text">获奖日期:</span></label>
                                <div class="layui-input-block">
                                    <input type="text" name="awardingTimeStr"
                                           autocomplete="off" placeholder="请选择获奖日期!" class="layui-input laydate-input awardingTimeStr">
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                            <div class="layui-form-item item">
                                <label class="layui-form-label label-required"><span class="text">奖励描述:</span></label>
                                <div class="layui-input-block">
                                    <input type="text" name="notes"
                                           placeholder="" autocomplete="off" class="layui-input notes">
                                </div>
                            </div>
                            <div class="layui-form-item item">
                                <label class="layui-form-label label-required"><span class="text">授奖单位:</span></label>
                                <div class="layui-input-block">
                                    <input type="text" name="awardingUnit"
                                           placeholder="" autocomplete="off" class="layui-input awardingUnit">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <form class="layui-form" action="" id="formPlatform" lay-filter="formPlatform">

                </form>
                <button data-type="add" class="add-item layui-btn">添加</button>
            </div>
            <div class="layui-tab-item">

            </div>
        </div>
    </div>
    <div class="dialog-footer-btn">
        <a class="layui-btn layui-btn-normal" data-type="save">提交</a>
        <a class="layui-btn layui-btn-primary" data-type="close">关闭</a>
    </div>
</div>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/layuiadmin/js/common.js"></script>
<script>
    layui.use(['form', 'jquery','element','laydate'], function(){
        var $ = layui.jquery,form = layui.form,element=layui.element,laydate=layui.laydate;
        function awardingTimeStr() {
            lay('.awardingTimeStr').each(function(){
                laydate.render({
                    elem: this
                    ,trigger: 'click'
                });
            });
        }
        awardingTimeStr();
        // 获取地址栏传递过来的参数
        var variable = getQueryVariable();
        if(variable!=null){
            httpModule({
                url: '/expert-api/get/'+variable.id,
                type: 'GET',
                success: function(relData) {
                    if (relData.success === true) {
                        // 给form表单赋初始值
                        var rewardName=JSON.parse(relData.data.zjkRewardJsonList)
                        if(rewardName.length>0){
                            rewardName.map(function (item, index) {
                                var html=$("#item").html()
                                $("#formPlatform").append(html)
                                awardingTimeStr();
                                $("#formPlatform>div").eq(index).find(".rewarkLevel").val(item.rewarkLevel)
                                $("#formPlatform>div").eq(index).find(".awardingTimeStr").val(item.awardingTimeStr)
                                $("#formPlatform>div").eq(index).find(".notes").val(item.notes)
                                $("#formPlatform>div").eq(index).find(".awardingUnit").val(item.awardingUnit)
                            })
                        }else {
                            var html=$("#item").html()
                            $("#formPlatform").append(html)
                            awardingTimeStr();
                        }

                    }
                }
            });
        }
        var $ = layui.$, active = {
            add:function(){
                var html=$("#item").html()
                $("#formPlatform").append(html)
                awardingTimeStr();
            },
            save:function () {
                var arr=[]
                $("#formPlatform>div").each(function (index,item) {
                    var rewarkLevel=$("#formPlatform>div").eq(index).find(".rewarkLevel").val()
                    var awardingTimeStr=$("#formPlatform>div").eq(index).find(".awardingTimeStr").val()
                    var notes=$("#formPlatform>div").eq(index).find(".notes").val()
                    var awardingUnit=$("#formPlatform>div").eq(index).find(".awardingUnit").val()
                    if(rewarkLevel=='' || notes=='' || awardingUnit=='' || awardingTimeStr==''){
                        layer.msg("为填项不能为空！", {icon: 2});
                        return
                    }else {
                        var data={
                            rewarkLevel:rewarkLevel,
                            awardingTimeStr:awardingTimeStr,
                            notes:notes,
                            awardingUnit:awardingUnit,
                            outSystemId:''
                        }
                        arr.push(data)
                    }
                })
                if(arr.length==$("#formPlatform>div").length){
                    setDialogData(arr); // 通知上层页面状态 - 弹窗中使用
                    top.layer.closeAll(); // 关闭弹窗
                }

            },
            close:function () {
                /*模拟关闭标签页事件*/
                setDialogData('');
                top.layer.closeAll(); // 关闭弹窗
            }
        }
        $('.layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
</body>
</html>