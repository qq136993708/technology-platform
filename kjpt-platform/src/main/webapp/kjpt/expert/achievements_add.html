<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>中核科技管理平台</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
    <!-- 多选下拉框样式，根据需求添加 -->
     <link rel="stylesheet" href="/layuiadmin/layui/css/modules/formSelects-v4.css" />
    <link rel="stylesheet" href="/css/layui-common.css">
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .item{margin-bottom: 10px !important;}
        .input-layout-box .layui-btn{width: 100px;background: url(/layuiadmin/layui/images/operation_78.png) no-repeat left center;border: 1px solid #fff;border-radius: 3px;
            height: 30px;font-size: 14px;line-height: 30px;color: #1890FF;cursor: pointer;float: left;margin-top: 10px}
        .input-layout-box .layui-btn:hover{border: 1px solid #fff !important;box-shadow: none !important;}
        .layout-view-content.dialog .layui-form-label{width: 90px;max-width: 90px;}
        .layout-view-content.dialog .layui-input-block{margin-left: 90px}
        .input-layout-box{text-align: center}
        .layui-anim.layui-icon{display: none}
        .layui-form-radio{background: #ECF0F4;color: #46484B;padding-left: 10px;float: left;margin-right: 0;}
        .layui-form-radioed{background: #0AA1FF;color: white}
        .deleteItem{color: red;float: left}
        .deleteItem:hover{color: red}
        .delete{border-bottom: 1px #ccc dashed;}
        .deleteItem span{font-weight: 500;position: relative;top: -2px;padding-right: 5px;}
        .layui-form .layui-row:last-child .delete a{display: none}
        .radio-tab-box{height: auto;overflow: hidden}
        .layui-row{margin-top: 20px}
    </style>
</head>
<body>
<div class="layout-view-content dialog">
    <div class="layui-form radio-tab-box" lay-filter="formRadio">
        <input type="radio" name="optionType"  disabled value="unInput" title="关联添加" lay-filter="optionType" />
        <input type="radio" name="optionType" value="input" title="手动录入" lay-filter="optionType" />
    </div>
    <!-- 关联添加 -->
    <div class="unInput-layout-box">
        <div class="layui-form-item">
            <label class="layui-form-label label-required auto"><span class="text">项目名称：</span></label>
            <div class="layui-input-inline">
                <input type="text" id="projectName" autocomplete="off" class="layui-input">
            </div>
            <button class="layui-btn layui-btn-normal" id="getProjectData">查询</button>
            <button class="layui-btn layui-btn-primary" id="restProjectNameValue">重置</button>
        </div>
        <table id="unInputTable" lay-filter="unInputTable"></table>
    </div>
    <!-- 手动录入 -->
    <div class="input-layout-box">
        <div id="item" class="layui-hide">
            <div class="layui-row layui-col-space20">
                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item item">
                        <label class="layui-form-label label-required"><span class="text">成果名称:</span></label>
                        <div class="layui-input-block">
                            <input type="text" name="achieveName" lay-verify="required"
                                   placeholder="" autocomplete="off" class="layui-input achieveName">
                        </div>
                    </div>
                    <div class="layui-form-item item">
                        <label class="layui-form-label"><span class="text">申请年度:</span></label>
                        <div class="layui-input-block">
                            <input type="text" name="applyYear"
                                   autocomplete="off" placeholder="请选择申请年度!" class="layui-input laydate-input">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item item">
                        <label class="layui-form-label label-required"><span class="text">申请单位:</span></label>
                        <div class="layui-input-block">
                            <select class="applyUnit" name="applyUnit" xm-select="applyUnit" xm-select-skin="normal" xm-select-radio></select>
                            <!--<input type="text" name="applyUnit"
                                   placeholder="" autocomplete="off" class="layui-input applyUnit">-->
                        </div>
                    </div>
                    <div class="layui-form-item item">
                        <label class="layui-form-label label-required"><span class="text">成果类型:</span></label>
                        <div class="layui-input-block">
                            <select class="achieveType" name="achieveType" xm-select="achieveType" xm-select-skin="normal" xm-select-radio></select>
                            <!--<input type="text" name="achieveType"
                                   placeholder="" autocomplete="off" class="layui-input achieveType">-->
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 delete">
                    <a href="#" class="deleteItem"><span>—</span>删除</a>
                </div>
            </div>
        </div>
        <form class="layui-form" action="" id="formPlatform" lay-filter="formPlatform">

        </form>
        <button data-type="add" class="add-item layui-btn">添加成果</button>
    </div>
    <div class="dialog-footer-btn">
        <a class="layui-btn layui-btn-normal" data-type="save">提交</a>
        <a class="layui-btn layui-btn-primary" data-type="close">关闭</a>
    </div>
</div>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/layuiadmin/js/common.js"></script>
<script>
    layui.use(['form', 'jquery','element','laydate','formSelects'], function(){
        var $ = layui.jquery,form = layui.form,element=layui.element,laydate=layui.laydate,formSelects=layui.formSelects;
        var submitType = 'input';
        function switchItem(type) {
            submitType = type;
            if (type === 'unInput') {
                $('.unInput-layout-box').show();
                $('.input-layout-box').hide();
            } else if (type === 'input') {
                $('.unInput-layout-box').hide();
                $('.input-layout-box').show();
            }
        }
        // 监听录入方式变化
        form.on('radio(optionType)', function(data) {
            switchItem(data.value);
        })
        switchItem(submitType);
        form.val('formRadio', {optionType: submitType});
        /*申请单位*/
        function getUnit(index){
            $("#formPlatform>div").eq(index).find(".applyUnit").attr("xm-select","applyUnit"+index)
            httpModule({
                url: "/unit-api/getTreeList",
                type: 'GET',
                async:false,
                success: function(relData) {
                    formSelects.data('applyUnit'+index, 'local', { arr: relData.children });
                    formSelects.btns('applyUnit'+index, ['remove']);
                }
            });
        }
        function achieveType(index) {
            /*成果类别*/
            $("#formPlatform>div").eq(index).find(".achieveType").attr("xm-select","achieveType"+index)
            httpModule({
                url: "/sysDictionary-api/getChildsListByCode/ROOT_KJPT_CGLB",
                type: 'GET',
                async:false,
                success: function(relData) {
                    if (relData.success === true) {
                        relData.data.map(function (item) {
                            item.value=item.code
                        })
                        formSelects.data('achieveType'+index, 'local', { arr: relData.data });
                        formSelects.btns('achieveType'+index, ['remove']);
                    }
                }
            });
        }
        /*申请年度*/
        function applyYear() {
            lay('.applyYear').each(function(){
                laydate.render({
                    elem: this
                    ,trigger: 'click'
                    ,type:"year"
                });
            });
        }
        function itemHtml(index) {
            var html=$("#item").html()
            $("#formPlatform").append(html)
            $("#formPlatform>div").eq(index).find(".laydate-input").addClass("applyYear")
            applyYear();
            $(".deleteItem").click(function () {
                $(this).parents(".layui-row").remove()
            })
        }
        // 获取地址栏传递过来的参数
        var variable = getQueryVariable();
        if(variable!=null){
            httpModule({
                url: '/expert-api/get/'+variable.id,
                type: 'GET',
                success: function(relData) {
                    if (relData.success === true) {
                        // 给form表单赋初始值
                        var achieveName = JSON.parse(relData.data.zjkAchievementJsonList)
                        if(achieveName.length>0){
                            achieveName.map(function (item, index) {
                                if(item.flag){
                                    itemHtml(index)
                                    getUnit(index)
                                    achieveType(index)
                                    formSelects.value('achieveType'+index, [item.achieveType]);
                                    $("#formPlatform>div").eq(index).find(".achieveName").val(item.achieveName)
                                    $("#formPlatform>div").eq(index).find(".applyYear").val(item.applyYear)
                                    $("#formPlatform>div").eq(index).find(".applyUnit").val(item.applyUnit)
                                    formSelects.value('applyUnit'+index,[item.applyUnit])
                                    $("#formPlatform>div").eq(index).find(".achieveType").val(item.achieveType)
                                }
                            })
                        }else {
                            var index=$("#formPlatform>div").length
                            itemHtml(index)
                            getUnit(index)
                            achieveType(index)
                        }

                    }
                }
            });
        }else {
            var index=$("#formPlatform>div").length
            itemHtml(index)
            getUnit(index)
            achieveType(index)
        }
        var $ = layui.$, active = {
            add:function(){
                var index=$("#formPlatform>div").length
                itemHtml(index)
                getUnit(index)
                achieveType(index)
            },
            save:function () {
                var arr=[]
                $("#formPlatform>div").each(function (index,item) {
                    var achieveType=formSelects.value('achieveType'+index)[0].code
                    var achieveTypeStr=formSelects.value('achieveType'+index)[0].name
                    var achieveName=$("#formPlatform>div").eq(index).find(".achieveName").val()
                    var applyYear=$("#formPlatform>div").eq(index).find(".applyYear").val()
                    var applyUnit=formSelects.value('applyUnit'+index)[0].value
                    var achieveType=$("#formPlatform>div").eq(index).find(".achieveType").val()
                    var flag = true;
                    if(achieveName=='' || applyUnit=='' || achieveType==''){
                        layer.msg("为填项不能为空！", {icon: 2});
                        return
                    }else {
                        var data={
                            achieveName:achieveName,
                            applyYear:applyYear,
                            applyUnit:applyUnit,
                            achieveType:'',
                            outSystemId:'',
                            achieveTypeStr:achieveTypeStr,
                            flag:flag
                        }
                        arr.push(data)
                    }
                })
                if(arr.length==$("#formPlatform>div").length){
                    setDialogData(arr); // 通知上层页面状态 - 弹窗中使用
                    top.layer.closeAll(); // 关闭弹窗
                }

            },
            close:function () {
                /*模拟关闭标签页事件*/
                setDialogData('');
                top.layer.closeAll(); // 关闭弹窗
            }
        }
        $('.layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
</body>
</html>