<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>科技管理平台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=0" />
    <link rel="stylesheet" href="/kjptmobile/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/kjptmobile/css/mobileNew.css">
    <style>
        .layui-tab-content:nth-child(1){    background: url(/kjptmobile/images/mobile-line.png) no-repeat center bottom;height: auto;overflow: hidden;padding-bottom: .1rem;background-size: 100%;padding-top: .1rem;}
    </style>
</head>
<body>
<header>
    <div class="m_return child">
        <a href="/kjptmobile/temIndex"><img src="/kjptmobile/images/icon-back.png"/> </a>
        <h4>科研项目</h4>
        <input id="date" type="text" value="" placeholder="">
    </div>
    <div class="search">
        <input type="text" name="key" id="key" value="" placeholder="请输入合同号或项目名" />
        <img src="/kjptmobile/images/icon-search.png" alt="" id="search">
    </div>
</header>
<form action="" name="form1" id="form1" >
<input type="hidden" name="nd" id="nd" value="${nd}">
<input type="hidden" name="limit" id="limit" value="${limit}">
<input type="hidden" name="page"  id="page"  value="${page}">
<input type="hidden" name="qdbz"  id="qdbz"  value="${qdbz}">
<input type="hidden" name="fzdwflag"  id="fzdwflag"  value="参与单位">
<input type="hidden" name="groupFlag"  id="groupFlag"  value="xmid">


<input type="hidden" name="functionId"  id="functionId"  value="984b64b13cf54222bf57bd840759fabe">
</form>
<main class="main contract project">
    <div class="layui-row">
        <div class="layui-tab-content">
            <div class="layui-col-xs4">
                <span id="finished_id"><img height="20" width="20" src="/kjptmobile/images/loading_mobile2.gif">个</span>
                <span>已签约</span>
                <span></span>
            </div>
            <div class="layui-col-xs4">
                <span  id="not_finished_id"><img height="20" width="20" src="/kjptmobile/images/loading_mobile2.gif">个</span>
                <span>未签约</span>
                <span></span>
            </div>
            <div class="layui-col-xs4">
                <button id="more">更多条件</button>
            </div>
        </div>
    </div>
    <div class="more-condition">
        <div class="more-bg">
            <div class="item">
                <p><span>& </span>专业处</p>
                <ul id="zycbmFlag">
                   <#list zycList as vo>
                      <li>${vo.name}</li>
                    </#list>
                </ul>
            </div>
            <div class="item">
                <p><span>& </span>研究院</p>
                <ul id="define2">
                  <#list yjyList as vo>
                      <li>${vo.name}</li>
                    </#list>
                </ul>
            </div>
            <div class="item">
                <p><span>& </span>部门</p>
                <ul id="gsbmbmFlag">
                    <#list gsbmbmList as vo>
                      <li>${vo.name}</li>
                    </#list>
                </ul>
            </div>
        </div>
        <div class="button-g">
            <button id="search_ok">确定</button>
            <button id="reset">重置</button>
        </div>
    </div>
    <div id="chart"></div>
    <div class="layui-tab">
        <div>
            <ul class="layui-tab-title">
                <li class="layui-this">已签<label id="finished_count" ></label> </li>
                <li>未签<label id="not_finished_count"></label></li>
                <li>全部<label id="all_count"></label></li>
            </ul>
        </div>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <ul id="qdbz_ed_id"></ul>
            </div>
            <div class="layui-tab-item">
               <ul id="qdbz_not_id"></ul>
            </div>
            <div class="layui-tab-item">
                <ul id="qdbz_all_id"></ul>
            </div>
        </div>
    </div>
</main>
<script type="text/javascript" src="/kjptmobile/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/kjptmobile/layuiadmin/layui/layui.js"></script>
<script src="/kjptmobile/js/rolldate.min.js"></script>
<script src="/kjptmobile/js/mobile.js"></script>
<script>
    var layer;
    (function(doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function() {
                var clientWidth = docEl.clientWidth;
                if (!clientWidth) return;
                docEl.style.fontSize = 100 * (clientWidth / 414) + 'px';
            };
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
    layui.use(['jquery','layer','element','laydate'], function(){
        var $=layui.jquery;layer=layui.layer,element=layui.element,laydate = layui.laydate;
        new Rolldate({
            el: '#date',
            format: 'YYYY',
            beginYear: 2017,
            endYear: $("#nd").val(),
            value: $("#nd").val(),
            confirm: function (date) {
                /* if (date > $("#nd").val()+1) {
                    layer.alert('不能大于当前的日期',{title:"提示"});
                    return false;
                } */
                $("#nd").val(date);
                search_Event();
            }
        })
        $(".more-condition").css("height",document.body.clientHeight/100+"rem");
        $(".more-bg>div:nth-child(1) ul li").click(function () {
            $(".more-bg>div:nth-child(1) ul li").each(function () {
               $(this).removeClass("layui-this")
            });
            if($(this).attr("class")==undefined || $(this).attr("class")==''){
                $(this).addClass("layui-this")
            }else {
                $(this).removeClass("layui-this")
            }
        });
        $(".more-bg>div:nth-child(2) ul li").click(function () {
            $(".more-bg>div:nth-child(2) ul li").each(function () {
                $(this).removeClass("layui-this")
            });
            if($(this).attr("class")==undefined || $(this).attr("class")==''){
                $(this).addClass("layui-this")
            }else {
                $(this).removeClass("layui-this")
            }
        });
        $(".more-bg>div:nth-child(3) ul li").click(function () {
            $(".more-bg>div:nth-child(3) ul li").each(function () {
                $(this).removeClass("layui-this")
            });
            if($(this).attr("class")==undefined || $(this).attr("class")==''){
                $(this).addClass("layui-this")
            }else {
                $(this).removeClass("layui-this")
            }
        });
        $("#reset").click(function () {
            $(".more-bg ul li").removeClass("layui-this");
        });
        $("#more").click(function () {
            $(".more-condition").slideToggle("slow");
        });
        $("#search").click(function () {
        	search_Event();
        });
        $("#search_ok").click(function () {
        	$(".more-condition").slideToggle("slow");
        	search_Event();
        });
        
    });
    
    
    
    //通用三合一 
    /* function queryCommonTabel(url,id,type)
    {
    	
    	var content_all_str="";
		var content_not_str="";
		var content_finished_str="";
		
		
		var content_all_count=0;
		var content_not_count=0;
		var content_finished_count=0;
		
    	var v_date = (new Date()).getTime();
    	$.ajax({
    		type : type,
    		url : url,
    		timeout : 9000,
    		dataType:'json', 
    		cache : false,
    		success : function(data, status) 
    		{
    			console.log("通用三合一 \n"+JSON.stringify(data.data));
    			$("#all_count").html((data.count)+"个");
    			if(data.data.length>0)
   			    {
   				  for(var i=0;i<data.data.length;i++)
       			  {
   					 var xmmc= data.data[i].xmmc;
   					 var ysje= data.data[i].ysje;//预算金额
   					 var xmid= data.data[i].xmid;
   					 var jf= data.data[i].jf;
   					 var fzdw= data.data[i].fzdw;
   					 var define10= data.data[i].define10;
   					 var define12= data.data[i].define12;
   					 var hth= data.data[i].hth;
   					 var qdbz= data.data[i].qdbz;
   					
   					 if(xmmc==null || xmmc=='')
   					 {
   						xmmc="总计";
   					 }	 
   					 
   					 if(xmmc!=null && xmmc!='')
  					 {
  						 if(xmmc.length>15)
  						 {
  							xmmc=xmmc.substring(0,15);
  						 }
  					 }
   					
   					if (typeof(hth) == "undefined")
   					{
   						hth="";
   					}
   					if (typeof(define12) == "undefined")
   					{
   						define12="";
   					}
   					if (typeof(fzdw) == "undefined")
   					{
   						fzdw="";
   					}
   					var ysjestr=setNumStr(ysje);
   					
   						
   						var temp="<li onclick=\"view('"+xmid+"','"+xmmc+"')\">"+
			    				"<p>"+
			                        "<span style='font-weight:bold'>"+xmmc+"</span>"+
			                        "<span>"+setNumStr(ysje)+"</span>"+
			                    "</p>"+
			                    "<dl>"+
			                        "<dd>"+hth+"</dd>"+
			                        "<dd>"+define10+"</dd>"+
			                        "<dd>"+fzdw+"</dd>"+
			                    "</dl>"+
			                   "</li>";
			          content_all_str=content_all_str+temp;          
			          if(qdbz=='未签订')
			          {
			        	  content_not_str=content_not_str+temp;     
			        	  content_not_count++;
			          }
			          if(qdbz=='已签订')
			          {
			        	  content_finished_str=content_finished_str+temp;     
			        	  content_finished_count++;
			          }
  					}
   					 
   			   }
    			
    			
                 
                 
    			
    			$("#not_finished_count").html(content_not_count+"个");
				$("#finished_count").html(content_finished_count+"个");
				
				
				$("#qdbz_ed_id").html(content_finished_str);
				$("#qdbz_not_id").html(content_not_str);
				$("#qdbz_all_id").html(content_all_str);
				
				

                $('html , body').animate({scrollTop: 0},'slow');
    		},
    		error : function() {
    		},
    		complete : function(XMLHttpRequest, status) {
    		}
    	});
    } */
    
    
    
    function queryTabel(url,id,type)
    {
    	var v_date = (new Date()).getTime();
    	$.ajax({
    		type : type,
    		url : url,
    		timeout : 9000,
    		//data: $("#form1").serialize(),
    		dataType:'json', 
    		cache : false,
    		success : function(data, status) 
    		{
    			//console.log(id+"\n"+JSON.stringify(data.data));
    			if(id=='qdbz_ed_id')
    			{
    				$("#finished_count").html((data.count-1)+"个");
    				$("#finished_id").html((data.count-1)+"个");
    			}
    			if(id=='qdbz_not_id')
    			{
    				$("#not_finished_count").html((data.count-1)+"个");
    				$("#not_finished_id").html((data.count-1)+"个");
    			}
    			if(id=='qdbz_all_id')
    			{
    				$("#all_count").html((data.count-1)+"个");
    			}
    			var count="";
    			if(data.data.length>0)
   			    {
   				  for(var i=0;i<data.data.length;i++)
       			  {
   					 var xmmc= data.data[i].xmmc;
   					 var ysje= data.data[i].ysje;//预算金额
   					 var xmid= data.data[i].xmid;
   					 var jf= data.data[i].jf;
   					 var fzdw= data.data[i].fzdw;
   					 var define10= data.data[i].define10;
   					 var define12= data.data[i].define12;
   					 var hth= data.data[i].hth;
   					 if(xmmc==null || xmmc=='')
   					 {
   						xmmc="总计";
   					 }	 
   					 
   					if(xmmc!=null && xmmc!='')
  					 {
  						 if(xmmc.length>15)
  						 {
  							xmmc=xmmc.substring(0,15);
  						 }
  					 }
   					
   					if (typeof(hth) == "undefined")
   					{
   						hth="";
   					}
   					if (typeof(define12) == "undefined")
   					{
   						define12="";
   					}
   					if (typeof(fzdw) == "undefined")
   					{
   						fzdw="";
   					}
   					var ysjestr=setNumStr(ysje);
   					if(xmmc=='总计' && ysjestr=='NaN万')
   					{
   						
   					}else
  					{
   						var temp="<li onclick=\"view('"+xmid+"','"+xmmc+"')\">"+
	    				"<p>"+
	                        "<span style='font-weight:bold'>"+xmmc+"</span>"+
	                        "<span>"+setNumStr(ysje)+"</span>"+
	                    "</p>"+
	                    "<dl>"+
	                        "<dd>"+hth+"</dd>"+
	                        "<dd>"+define10+"</dd>"+
	                        "<dd>"+fzdw+"</dd>"+
	                    "</dl>"+
	                   "</li>";
			         count=count+temp;
  					}
   					
   					 
       			  }
   			   }
    		    $("#"+id).html(count);

                $('html , body').animate({scrollTop: 0},'slow');
    		},
    		error : function() {
    		},
    		complete : function(XMLHttpRequest, status) {
    		}
    	});
    }
    
    

    function search_Event()
    {
    	var v_date = (new Date()).getTime();
    	var nd = $('#nd').val();
    	var fzdwflag = $('#fzdwflag').val();
    	var groupFlag = $('#groupFlag').val();
    	var functionId = $('#functionId').val();
    	
    	var define2=$("#define2").find(".layui-this").html();
    	var gsbmbmFlag=$("#gsbmbmFlag").find(".layui-this").html();
    	var zycbmFlag=$("#zycbmFlag").find(".layui-this").html(); 
    	console.log("研究院="+define2+" 部门="+gsbmbmFlag+" 处室="+zycbmFlag);
    	
    	if(typeof(define2) == "undefined")
    	{
    		define2="";
    	}
    	if(typeof(gsbmbmFlag) == "undefined")
    	{
    		gsbmbmFlag="";
    	}
    	if(typeof(zycbmFlag) == "undefined")
    	{
    		zycbmFlag="";
    	}
    	 var url="/kjptmobile/common_table_data_mobile?functionId=984b64b13cf54222bf57bd840759fabe&key="+$("#key").val()+"&v_date="+v_date+"&nd="+nd+"&define2="+define2+"&gsbmbmFlag="+gsbmbmFlag+"&zycbmFlag="+zycbmFlag+"&fzdwflag="+fzdwflag+"&groupFlag="+groupFlag+"&functionId="+functionId;
    	
    	 queryTabel(url+"&qdbz=已签订","qdbz_ed_id","POST");
    	 queryTabel(url+"&qdbz=未签订","qdbz_not_id","POST");
    	 queryTabel(url+"&qdbz=",    "qdbz_all_id","POST");
    	 
    	 page("qdbz_ed_id", url+"&qdbz=已签订","POST","queryTabel");
    	 page("qdbz_not_id",url+"&qdbz=未签订","POST","queryTabel");
    	 page("qdbz_all_id",url+"&qdbz=","POST","queryTabel"); 
    	 
    	 
    	 

    }
    search_Event();
    
    
    
    
    
    
    
    
    
    
    
    
    
    function  view(xmid,xmmc)
    {
    	
    	//console.log(xmid+"\n"+JSON.stringify(xmid));
    	if(xmmc!='总计')
   		{
    		layer.open({
                title : '详情',
                skin : 'layui-layer-mobile',
                shadeClose : false,
                type : 2,
                fixed : false,
                maxmin : true,
                area : [ '95%', '72.5%' ],
                content : '/kjptmobile/project_details?xmid='+xmid
            });
   		}
    	
    }
    
    
    
    
    
    
    function setNumStr(num)
    {
    	
    	var result="";
    	
    	if(num=='0.00')
		{
    		num=0;
		}
		if(parseFloat(num)>10000)//亿
		{
			var  temp=parseFloat(num/10000).toFixed(2);
			var  endstr=temp.substring(temp.length-3);
			//alert(temp);
			if(endstr=='.00')
			{
				temp= temp.substring(0,temp.length-3);
			}
			result=temp+"亿";
		}else//万
		{
			
			var  temp=parseFloat(num).toFixed(2);
			var  endstr=temp.substring(temp.length-3);
			if(endstr=='.00')
			{
				//temp= temp.replace(".00","")
				temp= temp.substring(0,temp.length-3);
			}
			result=temp+"万";
		}
		
		if(result=='NaN万')
		{
			result="0万";
		}
		
		return result;
    }
    
    
</script>
</body>
</html>