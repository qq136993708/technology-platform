<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>科技管理平台</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
<link rel="Shortcut Icon" href="/layuiadmin/layui/images/favicon.ico" />
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/liMarquee.css">
<link rel="stylesheet" href="/layuiadmin/style/adminStp_.css?+Math.random()" media="all">

<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>

</head>
<body class="layui-layout-body">

	<div id="LAY_app">
		<div class="layui-layout layui-layout-admin">
			<!--top-->
			<div class="layui-header">
				<!--logo-->
				<div class="layui-header-logo inline-block">
					<img src="/layuiadmin/layui/images/header-logo.png"/> </div>
				<!--首页-->
				<div class="layui-header-index inline-block">
					<div class="layui-tab index-fixed-tab">
						<ul class="layui-tab-title index-fixed">
							<li lay-id="" lay-attr="" class="layui-this">
								<img src="/layuiadmin/layui/images/header-index.png"/>
							</li>
						</ul>
					</div>
				</div>
				<!--导航-->
				<div class="layui-header-nav inline-block">
					<ul class="layui-nav layui-layout-left">
						<#if upList?exists> <#list upList as p>
						<li class="layui-nav-item ${p_index}" id="up${p.id}">
							<a href="javascript:;" id="${p.id}">${p.name}</a>
						</li>
						</#list> </#if>
					</ul>
					<div class="layui-icon layadmin-tabs-control layui-icon-prev layui-hide" id="navPrev">
						<ul class="layui-nav layui-layout-left layui-hide"></ul>
					</div>
				</div>
				<!--搜索-->
				<div class="layui-header-search inline-block">
					<div class="seacrhBox">
						<input type="text" placeholder="搜索">
						<img src="/layuiadmin/layui/images/icon-s.png" alt="">
					</div>
				</div>
				<!--右侧-->
				<ul class="layui-nav layui-layout-right" lay-filter="layadmin-layout-right">
					<li class="layui-nav-item layui-nav-itemnew chat" title="消息">
						<a id="numberChat" lay-href="/message/sys_message_list" lay-text="消息"><span id="nc" style="visibility: hidden"></span></a>
						<div class="chat-content layui-hide">
							<dl id="message_box" class="layui-nav-child-dl">
							</dl>
						</div>
					</li>
					<li class="layui-nav-item layui-nav-itemnew deal" title="待办任务">
						<a id="numberDeal" lay-href="/task/pending/list/ini" lay-text="待办任务"><span id="pendingCount" style="visibility: hidden"></span></a>
					</li>
					<!-- <li class="layui-nav-item layui-nav-itemnew notify">
						<a id="numberNotify" lay-href="/task/pending/list/ini" lay-text="通知" title="通知"></a>
					</li> -->
					<li class="layui-nav-item layui-nav-itemnew " title="二维码">
						<span class="QRCode"></span>
						<div class="QRCode-content layui-hide">
							<img src="/layuiadmin/layui/images/weixin.png" />
						</div>
					</li>
					<li class="layui-nav-item">
						<a href="javascript:;" style="color: #fff;" class="layui-nav-item-a">
							${userInfo.userDisp!}
							<span class="layui-nav-more"></span>
						</a>
						<div class="layui-hide information">
							<dl class="layui-nav-child-dl">
								<dd>
									<a id="toUserInfo" href="javascript:void(0)">基本资料</a>
								</dd>
								<!-- 
								<dd>
									<a id="toUpdPass" href="javascript:void(0)">修改密码</a>
								</dd>
								<dd>
									<a id="changeIndex" href="javascript:void(0)">切换</a>
								</dd> -->
								<dd>
									<a id="selfConfig" href="javascript:void(0)">个人设置</a>
								</dd>
								<dd>
									<a id="logout" href="javascript:void(0)">退出登录</a>
								</dd>
							</dl>
						</div>
					</li>
				</ul>
			</div>

			<!-- 侧边菜单 -->
			<div class="layui-side layui-side-menu layui-side-menu-div" style="background: #fff !important; box-shadow: 0 10px 10px rgba(0, 0, 0, 0.6) !important;">
				<div class="layui-side-scroll">
					<!--左侧导航-->
					<ul class="layui-nav layui-nav-tree" lay-shrink="all" lay-filter="layadmin-system-side-menu" id="nav${p.id}">
						<li class="layadmin-flexible">
							<div></div>
						</li>
						
						<#assign gztFlag="0">
						<#if grgztList?exists>
							<#list grgztList as grgzt>
								<#if grgzt.url=='#'>
									<#if gztFlag=="0">
										<li class="layui-nav-item layui-nav-itemed">
									</#if>
									<#if gztFlag=="1">
										<li class="layui-nav-item">
									</#if>
									<a href="#" title="${grgzt.name}">
										<span>${grgzt.name}</span>
										<span class="arrow"></span>
										<i class="fa fa-angle-left pull-right"></i>
									</a>
									<#assign gztFlag="1">
								</#if>
								<dl class="layui-nav-child">
									<#list grgztList as threeLevel>
										<#if threeLevel.parentId == grgzt.id>
											<dd>
												<a lay-href="${threeLevel.url}" lay-text="${threeLevel.name}" data-id="${threeLevel.id}" data-code="${threeLevel.code}" data-functionbuttons="ALL">${threeLevel.name}</a>
											</dd>
										</#if>
									</#list>
								</dl>
							</#list>
						</#if>
						
						<#if scList?exists>
							<li class="layui-nav-item">
								<a href="#" title="我的收藏">
									<span>我的收藏</span>
									<span class="arrow"></span>
									<i class="fa fa-angle-left pull-right"></i>
								</a>
								<dl class="layui-nav-child" id="dlCollect">
									<#list scList as sc>
										<dd id="${sc.dataId}">
											<a lay-href="${sc.collectUrl}" lay-text="${sc.collectName}" data-id="${sc.functionId}" data-code="${sc.functionCode}" data-functionbuttons="ALL">${sc.collectName}
												<img title="取消收藏"  src="/layuiadmin/layui/images/icon_collection.png" class="layui-hide"/></a>
										</dd>
									</#list>
								</dl>
							</li>
						</#if>

					</ul>

					<#if upList?exists>
						<#list upList as p>
							<ul class="layui-nav layui-nav-tree layui-hide" lay-shrink="all" lay-filter="layadmin-system-side-menu" id="nav${p.id}">
								<li class="layadmin-flexible">
									<div></div>
								</li>
								<#assign openFlag="0">
								<#list funList as s>
									<#if s.parentId == p.id && s.url=='#'>
										<#if openFlag=="0">
											<li class="layui-nav-item layui-nav-itemed">
												<a href="#" title="${s.name}">
													<span>${s.name}</span>
													<span class="arrow"></span>
													<i class="fa fa-angle-left pull-right"></i>
												</a>
												<dl class="layui-nav-child">
													<#list funList as t>
														<#if t.parentId == s.id>
															<dd>
																<#if t.url != '#'>
																	<a lay-href="${t.url}" lay-text="${t.name}" data-id="${t.id}" data-code="${t.code}" data-functionbuttons="${t.functionButtons}">${t.name}</a>
																</#if>
																<#if t.url == '#'>
																	<a href="${t.url}" title="${t.name}">${t.name}</a>
																	<dl class="layui-nav-child">
																		<#list funList as k>
																			<#if k.parentId == t.id>
																				<dd>
																					<a class="thirdChild" lay-href="${k.url}" lay-text="${k.name}" data-id="${k.id}" data-code="${k.code}" data-functionbuttons="${k.functionButtons}" title="${k.name}">${k.name}</a>
																				</dd>
																			</#if>
																		</#list>
																	</dl>
																</#if>
															</dd>
														</#if>
													</#list>
												</dl>
											</li>
										</#if>
										<#if openFlag!="0">
											<li class="layui-nav-item">
												<a href="#" title="${s.name}">
													<span>${s.name}</span>
													<span class="arrow"></span>
													<i class="fa fa-angle-left pull-right"></i>
												</a>
												<dl class="layui-nav-child">
													<#list funList as t>
														<#if t.parentId == s.id>
															<dd>
																<#if t.url != '#'>
																	<a lay-href="${t.url}" lay-text="${t.name}" data-id="${t.id}" data-code="${t.code}" data-functionbuttons="${t.functionButtons}">${t.name}</a>
																</#if>
																<#if t.url == '#'>
																	<a href="${t.url}" title="${t.name}">${t.name}</a>
																	<dl class="layui-nav-child">
																		<#list funList as k>
																			<#if k.parentId == t.id>
																				<dd>
																					<a class="thirdChild" lay-href="${k.url}" lay-text="${k.name}" data-id="${k.id}" data-code="${k.code}" data-functionbuttons="${k.functionButtons}" title="${k.name}">${k.name}</a>
																				</dd>
																			</#if>
																		</#list>
																	</dl>
																</#if>
															</dd>
														</#if>
													</#list>
												</dl>
											</li>
										</#if>
										<#assign openFlag="1">
									</#if>
									<#if s.parentId == p.id && s.url!='#'>
										<li class="layui-nav-item">
											<a lay-href="${s.url}" lay-text="${s.name}"  data-id="${s.id}" data-code="${s.code}" data-functionbuttons="${s.functionButtons}">
												<span>${s.name}</span>
											</a>
										</li>
									</#if>
								</#list>
							</ul>
						</#list>
					</#if>
				</div>
			</div>

			<!-- 页面标签 -->
			<!--<div class="dowebok news">
				<a href="javascript:;"><span>最新消息:</span>国家主席习近平发表二零一九年新年贺词。</a>
				<a href="javascript:;"><span>最新消息:</span>马永生会见国外公司客人。</a>
				<a href="javascript:;"><span>最新消息:</span>扬子石化乙烯产量创历史新记录。</a>
				<a href="javascript:;"><span>最新消息:</span>马永生会见国外公司客人。</a>
			</div>-->
			<div class="layadmin-pagetabs" id="LAY_app_tabs">
				<div class="layui-icon layadmin-tabs-control layui-icon-prev" layadmin-event="leftPage"></div>
				<div class="layui-icon layadmin-tabs-control layui-icon-next" layadmin-event="rightPage"></div>
				<div class="layui-icon layadmin-tabs-control layui-icon-down">
					<ul class="layui-nav layadmin-tabs-select" lay-filter="layadmin-pagetabs-nav">
						<li class="layui-nav-item" lay-unselect>
							<a href="javascript:;"></a>
							<dl class="layui-nav-child layui-anim-fadein">
								<dd layadmin-event="closeThisTabs">
									<a href="javascript:;">关闭当前页</a>
								</dd>
								<dd layadmin-event="closeOtherTabs">
									<a href="javascript:;">关闭其它页</a>
								</dd>
								<dd layadmin-event="closeAllTabs">
									<a href="javascript:;">关闭全部页</a>
								</dd>
								<dd layadmin-event="collection" id="collection">
									<a id="collectFunction" href="javascript:void(0)">收藏/取消</a>
								</dd>
							</dl>
						</li>
					</ul>
				</div>
				<div class="layui-tab" lay-unauto lay-allowClose="true" lay-filter="layadmin-layout-tabs">
					<ul class="layui-tab-title" id="LAY_app_tabsheader">
						<!--<li lay-id="home/console.html" lay-attr="home/console.html" class="layui-this"><i class="layui-icon layui-icon-home"></i></li>-->
					</ul>
				</div>
			</div>
			<input type="text" class="selfRownum layui-hide" id="userConfig1" value="${userInfo.userConfig1?default(15)}">

			<!-- 主体内容 -->
			<div class="layui-body" id="LAY_app_body">
				<div class="layadmin-tabsbody-item layui-show">
					<iframe id="mainIframe" frameborder="0" class="layadmin-iframe"></iframe>
				</div>
			</div>
			<div class="layui-footer">
				<div>
					<p>版权所有：石化盈科信息技术有限责任公司</p>
				</div>
			</div>
			<!-- 辅助元素，一般用于移动设备下遮罩 -->
			<div class="layadmin-body-shade" layadmin-event="shade"></div>
		</div>
	</div>

	<script src="/layuiadmin/javascript/jquery.liMarquee.js"></script>
	<script src="/layuiadmin/layui/layui.js"></script>
	<script>
		layui.config({
			base : '../layuiadmin/' //静态资源所在路径
		}).extend({
			index : 'lib/index' //主入口模块
		}).use([ 'index', 'jquery' ,"publicMethods"], function() {
			var $ = layui.jquery,publicMethods=layui.publicMethods;
            $('.dowebok').liMarquee();
			var headerNav= $(".layui-header-nav ul").html();
			var navLeft=36;
            $(".layui-header-nav ul li").each(function (i, val) {
				if(i>3){
                    $(".layui-header .layui-icon-prev").removeClass("layui-hide");
                    $(val).remove();
				}else {
                    navLeft+=$(val).width()+24;
				}
            });
           

            $(".layui-header .layui-icon-prev").css("left",navLeft+"px");
            if(!$(".layui-header .layui-icon-prev").hasClass("layui-hide")){
                $("#navPrev ul").append(headerNav);
                $("#navPrev ul span").remove();
                $("#navPrev ul li").each(function (i, val) {
                    if(i<4){
                        $(".layui-header .layui-icon-prev").removeClass("layui-hide");
                        $(val).remove();
                    }
                });
                $(".layui-header .layui-icon-prev").on({
                    mouseover : function() {
                        $(".layui-layout-left").eq(1).removeClass("layui-hide");
                    },
                    mouseout : function() {
                        $(".layui-layout-left").eq(1).toggleClass("layui-hide");
                    }

                });
            }
			$(".layui-header .layui-layout-left li a").on("click", function() {
				var id = $(this).attr("id")
				$(".layui-nav-tree").addClass("layui-hide");
				$("#nav" + id).removeClass("layui-hide");
                $(".layui-header .layui-layout-left li").removeClass("layui-this");
				if(!$(this).parent().hasClass("layui-this")){
                    $(this).parent().addClass("layui-this");
				}
			});
			function initMessageSocket() {
				//初始化websocket
				var websocket = null;
				if ('WebSocket' in window) {
					websocket = new WebSocket("ws://" + document.location.host + "/messageIndex/${userId?default(0)}");
					websocket.onerror = function() {
					};
					websocket.onopen = function(event) {
						console.log("onopen.............");
					}
					websocket.onclose = function() {
						console.log("onclose.............");
					}
					window.onbeforeunload = function() {
						websocket.close();
					}
					websocket.onmessage = function(event) {
						getNotReadMessageList();
					}
				} else {
					console.log('Not support websocket');
				}
			}
			function initTaskSocket() {
				//初始化websocket
				var websocket = null;
				if ('WebSocket' in window) {
					websocket = new WebSocket("ws://" + document.location.host + "/taskIndex/${userId?default(0)}");
					websocket.onerror = function() {
					};
					websocket.onopen = function(event) {
						console.log("onopen.............");
					}
					websocket.onclose = function() {
						console.log("onclose.............");
					}
					window.onbeforeunload = function() {
						websocket.close();
					}
					websocket.onmessage = function(event) {
						getNotReadTaskList();
					}
				} else {
					console.log('Not support websocket');
				}
			}
			$("#toUserInfo").on("click", function() {
				layer.open({
					title : "用户详情",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
					maxmin : false,
					//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
					area : [ '80%', '70%' ],
					content : "/user/user-dispaly?userId=${userInfo.userId}"
				});
			});
			$("#logout").on("click", function() {
				layer.confirm('确定要退出登录吗？', {
					title : "退出登录"
				}, function(index) {
					layer.close(index);
					$.ajax({
						type : 'post',
						dataType : 'json',
						async : false,
						url : '/logout',
						success : function(data) {
							window.location.href = "/login";
						},
						error : function(e) {
							console.log(e);
						}
					});
				});
			});
			$("#toUpdPass").on("click", function() {
				layer.open({
					title : "修改密码",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
					maxmin : false,
					//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
					area : [ '500px', '300px' ],
					content : "/user/upd-pass?userId=${userInfo.userId}"
				});
			});

			$("#selfConfig").on("click", function() {
				layer.open({
					title : "个人设置",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
					maxmin : false,
					//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
					area : [ '500px', '300px' ],
					content : "/user/ini-self-config"
				});
			});

			$("#changeIndex").on("click", function() {
				var host = window.location.host;
	        	window.location.href="http://"+host+"/work";
			});
			$("#moreInfo").on("click",function () {
                window.open("/instituteIndex?url="+"/one_level_main/dragon","_target");
            });
			
			
            $("#nav li dl dd a").hover(function (){
                $(this).find("img").removeClass("layui-hide");
                $(this).find("img").off("click").on("click",function () {
                    $.ajax({
                        type : 'post',
                        dataType : 'json',
                        async : false,
                        url : '/admin/collect?functionCode='+$(this).parent().attr("data-code")+"&functionName="+$(this).parent().attr("lay-text")+"&functionId="+$(this).parent().attr("data-id"),
                        success : function(data) {
                            layer.msg(data.message);
                            if (data.success) {
                                // 动态修改当前我的收藏
                                var obj = eval('(' + data.data + ')');
                                if (obj.status == '1') {
                                    var collectMenu = document.getElementById("dlCollect").innerHTML;
                                    collectMenu = collectMenu + "<dd id='"+obj.dataId+"'><a lay-href='"+obj.collectUrl+"' lay-text='"+obj.collectName+"' data-id='"+obj.functionId+"' data-code='"+obj.functionCode+"' data-functionbuttons='ALL'>"+obj.collectName+"<img title=\"取消收藏\"  src=\"/layuiadmin/layui/images/icon_collection.png\" class=\"layui-hide\"/></a></dd>"
                                    document.getElementById("dlCollect").innerHTML = collectMenu;

                                } else if (obj.status == '0') {
                                    var dl = document.getElementById("dlCollect");
                                    // 查找dl里的所有dd
                                    var dds = document.getElementsByTagName('dd');
                                    for (var i = dds.length - 1; i >= 0; i--) {
                                        if (dds[i].id == obj.dataId) {
                                            dl.removeChild(dds[i]);
                                        }
                                    }
                                }

                            }

                        },
                        error : function(e) {
                            console.log(e);
                        }
                    });
					return false;
                });
            },function (){
                $(this).find("img").addClass("layui-hide");
            });
			// 菜单收藏
			$("#collectFunction").on("click", function() {
				var param = JSON.parse(window.localStorage.getItem("param"));
				$.ajax({
					type : 'post',
					dataType : 'json',
					async : false,
					url : '/admin/collect?functionCode='+param.code+"&functionName="+param.name+"&functionId="+param.id,
					success : function(data) {
						layer.msg(data.message);

						if (data.success) {
							// 动态修改当前我的收藏
							var obj = eval('(' + data.data + ')');
							if (obj.status == '1') {
								var collectMenu = document.getElementById("dlCollect").innerHTML;
								collectMenu = collectMenu + "<dd id='"+obj.dataId+"'><a lay-href='"+obj.collectUrl+"' lay-text='"+obj.collectName+"' data-id='"+obj.functionId+"' data-code='"+obj.functionCode+"' data-functionbuttons='ALL'>"+obj.collectName+"</a></dd>"
								document.getElementById("dlCollect").innerHTML = collectMenu;
							} else if (obj.status == '0') {
								var dl = document.getElementById("dlCollect");
								// 查找dl里的所有dd
								var dds = document.getElementsByTagName('dd');
								for (var i = dds.length - 1; i >= 0; i--) {
								    if (dds[i].id == obj.dataId) {
								    	dl.removeChild(dds[i]);
								    }
								}
							}

						}

					},
					error : function(e) {
						console.log(e);
					}
				});
			});
			//获取未读消息
			window.getNotReadMessageList = function() {
				publicMethods.ajaxAsyncPost('/message/get-newest-messages', {page:1,limit:100,param: {"isRead":"0"}}, function (data, status) {
					$(".message_more").unbind();
					$(".message_info").unbind();
					var content = "";
					if(data.length <=0){
	        			$("#nc").css("visibility", "hidden");
	        		}else{
	        			/* $.each(data,function(index,dt){
		        			if(index < 3){//最新消息(取前三条未读)
		        				content += '<dd class="message_info" dataId="'+dt.dataId+'"><span class="layui-name">'+dt.userName+'</span><span class="layui-text">'+dt.messageTitle+'</span><span class="layui-time"><i class="fa fa-clock-o mr-1"></i>'+dt.ago+'</span></dd>';
		        			}
		        		}); */
	        			$("#nc").text(data.length);
						$("#nc").css("visibility", "visible");
	        		}
	        		content += '<dd class="message_more"><a href="javascript:void(0)">查看更多</a></dd>';
	        		$("#message_box").html(content);
				    $('.message_more').on('click', function() { 
				    	parent.layui.index.openTabsPage("/message/sys_message_list", "消息列表");
				    });
	            });
			}
			//待办任务
			window.getNotReadTaskList = function() {
				//admin/pending-task-count
				publicMethods.ajaxAsyncPost('/task/index-pending-list', {page:1,limit:100,param: {"isRead":"0"}}, function (data, status) {
					$(".task_more").unbind();
					$(".task_info").unbind();
					var pendingCount = data.length;
					var content = "";
					if (pendingCount <= 0) {
						$("#pendingCount").css("visibility", "hidden");
					} else {
						$("#pendingCount").text(pendingCount);
						$("#pendingCount").css("visibility", "visible");
						/* $.each(data,function(index,dt){
		        			if(index < 3){//最新消息(取前三条未读)
		        				content +='<dd class="task_info" dataId="'+dt.id+'"><p><span class="layui-icon-span"><img src="/layuiadmin/layui/images/icon-information.png"/></span><span class="layui-text-span">'+dt.name+'</span>	<span class="layui-date">'+dt.ago+'</span></p></dd>';
		        			}
		        		}); */
					}
					content += '<dd><a class="task_more"  href="javascript:void(0)">查看更多</a></dd>';
					$("#task_box").html(content);
					$(".task_more").on("click", function(){ 
				     	parent.layui.index.openTabsPage("/task/pending/list/ini", "待办任务");
				    });
	            });
			}
			$(document).ready(function() {				
				 $("#mainIframe", parent.document.body).attr("src", "/mainStp");
				 initMessageSocket();
			     initTaskSocket();
				 getNotReadMessageList();
				 getNotReadTaskList();
			});
		});

	</script>
</body>
</html>