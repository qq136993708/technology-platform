<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>科技管理平台</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
<link rel="Shortcut Icon" href="/layuiadmin/layui/images/favicon.ico" />
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css?+Math.random()" media="all">
</head>
<body class="layui-layout-body">

	<div id="LAY_app">
		<div class="layui-layout layui-layout-admin layui-leader">
			<div class="layui-header">
				<!--搜索框-->
				<div class="stpSearchBox">
					<div class="logo"><img src="/layuiadmin/layui/images/logo-stp.png"></div>
					<div class="seacrhBox">
						<input type="text" placeholder="搜索">
						<img src="/layuiadmin/layui/images/stpicon_06.png" alt="">
					</div>
				</div>
				<!--通知-->
				<ul class="layui-nav layui-layout-right" lay-filter="layadmin-layout-right">
					<li class="layui-index layui-nav-item layui-nav-itemnew">
						<a href="/index"><img src="/layuiadmin/layui/images/icon-index.png"/> </a>
					</li>
					<li class="layui-nav-item layui-nav-itemnew chat" title="通知">
						<a id="numberChat" lay-href="/task/pending/list/ini" lay-text="会话"><span id="pendingCount" style="visibility: hidden"></span></a>
						<div class="chat-content layui-hide">
							<dl class="layui-nav-child-dl">
								<dd>
									<span class="layui-name">张三</span>
									<span class="layui-text">请查看邮件请查看邮件请查看邮件请查看邮件</span>
									<span class="layui-time">
										<i class="fa fa-clock-o mr-1"></i>
										4小时之前
									</span>
								</dd>
								<dd>
									<span class="layui-name">张三</span>
									<span class="layui-text">请查看邮件请查看邮件请查看邮件请查看邮件</span>
									<span class="layui-time">
										<i class="fa fa-clock-o mr-1"></i>
										4小时之前
									</span>
								</dd>
								<dd>
									<span class="layui-name">张三</span>
									<span class="layui-text">请查看邮件请查看邮件请查看邮件请查看邮件</span>
									<span class="layui-time">
										<i class="fa fa-clock-o mr-1"></i>
										4小时之前
									</span>
								</dd>
								<dd>
									<a href="javascript:void(0)">查看更多</a>
								</dd>
							</dl>
						</div>
					</li>
					<li class="layui-nav-item layui-nav-itemnew deal" title="待办任务">
						<a id="numberDeal" lay-href="/sysNotice/index_notice" lay-text="待办任务"><span id="nc" style="visibility: hidden"></span></a>
						<div class="deal-content layui-hide">
							<dl class="layui-nav-child-dl">
								<dd>
									<p>
										<span class="layui-icon-span"><img src="/layuiadmin/layui/images/icon-information.png"/></span>
										<span class="layui-text-span">OA待办（3条）</span>
										<span class="layui-date">3小时之前</span>
									</p>
								</dd>
								<dd>
									<p>
										<span class="layui-icon-span"><img src="/layuiadmin/layui/images/icon-information.png"/></span>
										<span class="layui-text-span">知识产权管理系统待办（3条）</span>
										<span class="layui-date">3小时之前</span>
									</p>
								</dd>
								<dd>
									<a href="javascript:void(0)">查看更多</a>
								</dd>
							</dl>
						</div>
					</li>
					<li class="layui-nav-item layui-nav-itemnew notify">
						<a id="numberNotify" lay-href="/task/pending/list/ini" lay-text="通知" title="通知"></a>
					</li>
					<li class="layui-nav-item layui-nav-itemnew " title="二维码">
						<span class="QRCode"></span>
						<div class="QRCode-content layui-hide">
							<img src="/layuiadmin/layui/images/weixin.png" />
						</div>
					</li>
					<li class="layui-nav-item">
						<a href="javascript:;" style="color: #fff;" class="layui-nav-item-a">
							<img src="${userInfo.userExtend!'http://t.cn/RCzsdCq'}" class="layui-nav-img">
							<!--${userInfo.userDisp!}-->管理员
							<span class="layui-nav-more"></span>
						</a>
						<div class="layui-hide information">
							<dl class="layui-nav-child-dl">
								<dd>
									<a id="toUserInfo" href="javascript:void(0)">基本资料</a>
								</dd>
								<dd>
									<a id="toUpdPass" href="javascript:void(0)">修改密码</a>
								</dd>
								<dd>
									<a id="selfConfig" href="javascript:void(0)">个人设置</a>
								</dd>
								<dd>
									<a id="changeIndex" href="javascript:void(0)">切换</a>
								</dd>
								<dd>
									<a id="logout" href="javascript:void(0)">退出登录</a>
								</dd>
							</dl>
						</div>
					</li>
					<li class="layui-nav-item layui-nav-itemnew collection" title="收藏">
						<a id="collection"></a>
					</li>
				</ul>
			</div>

			<input type="text" class="selfRownum layui-hide" id="userConfig1" value="${userInfo.userConfig1?default(15)}">

			<!-- 主体内容 -->
			<div class="layui-body" id="LAY_app_body">
				<div class="layadmin-tabsbody-item layui-show">
					<iframe id="mainIframe" frameborder="0" class="layadmin-iframe"></iframe>
				</div>
			</div>
			<!-- 辅助元素，一般用于移动设备下遮罩 -->
			<div class="layadmin-body-shade" layadmin-event="shade"></div>
		</div>
		<#include "/common/public/bottomTips.html"/>
	</div>

	<script src="/layuiadmin/layui/layui.js"></script>
	<script>
		layui.config({
			base : '../layuiadmin/' //静态资源所在路径
		}).extend({
			index : 'lib/index' //主入口模块
		}).use(['index' ,'jquery' ], function() {
			var $ = layui.jquery;
			var windowHref=window.location.href.split("=");
            document.getElementById("mainIframe").src=windowHref[1];
            
			/*导航宽度*/
			var layuiHeaderWidth = parseInt($(".layui-header").width());
			var layuiHeaderUlActualWidth = 0, DValue = 0, ulLiNumber = 0;
			var layuiHeaderUlMustWidth = layuiHeaderWidth - 250;
			$(".layui-header-div .layui-layout-left li a").each(function() {
                layuiHeaderUlActualWidth += parseInt($(this).html().length *14+40);
				DValue = layuiHeaderUlActualWidth - layuiHeaderUlMustWidth;
				if (DValue > 0) {
					ulLiNumber = $(this).parent().index();
					return false;
				}
			});
			$(".layui-header-div").css("width", layuiHeaderUlMustWidth + "px");
			if (DValue > 0) {
				$(".layui-layout-left").css("left", "0px");
				$(".layui-header .layui-icon-prev").removeClass("layui-hide");
				var html = $(".layui-header-div").html();
				$(".layui-header .layui-icon-prev").append(html);
				$(".layui-layout-left").eq(1).addClass("layui-hide layui-layout-left-over");
				$(".layui-layout-left:eq(1) li:lt(" + (ulLiNumber) + ")").remove();
				$(".layui-header .layui-icon-prev").on({
					mouseover : function() {
						$(".layui-layout-left").eq(1).removeClass("layui-hide");
					},
					mouseout : function() {
						$(".layui-layout-left").eq(1).toggleClass("layui-hide");
					}

				});
			}
			$(".layui-header .layui-layout-left li a").on("click", function() {
				var id = $(this).attr("id")
				$(".layui-nav-tree").addClass("layui-hide");
				$("#nav" + id).removeClass("layui-hide");
			});
			function initNoticeSocket() {
				//初始化websocket
				var websocket = null;
				if ('WebSocket' in window) {
					websocket = new WebSocket("ws://" + document.location.host + "/pushNotice");
					websocket.onerror = function() {
					};
					websocket.onopen = function(event) {
					}
					websocket.onclose = function() {
					}
					window.onbeforeunload = function() {
						websocket.close();
					}
					websocket.onmessage = function(event) {
						// getUserNoticeCount();
						var currentCount = 0;
						if ($("#nc").text() && parseInt($("#nc").text())) {
							currentCount = parseInt($("#nc").text());
						}
						currentCount += 1;
						$("#nc").text(currentCount);
						var notice = $.parseJSON(event.data);
						//使用参数：1.标题，2.链接地址，3.内容简介，4.标签名称
						var pop = new Pop(notice.noticeTitle, "/sysNotice/readNotice?id=" + notice.noticeId, notice.noticeSummary, "");
					}
				} else {
					console.log('Not support websocket');
				}
			}
			window.getUserNoticeCount = function() {
				$.ajax({
					type : 'post',
					dataType : 'json',
					async : false,
					headers : {
						'Content-Type' : 'application/json',
					},
					url : '/sysNotice/getUserNoticeCount',
					success : function(data) {
						if (data <= 0) {
							$("#nc").css("visibility", "hidden");
						} else {
							$("#nc").text(data);
							$("#nc").css("visibility", "visible");
						}
					},
					error : function(e) {
						console.log(e);
					}
				});
			}
			$("#toUserInfo").on("click", function() {
				layer.open({
					title : "用户详情",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
					maxmin : false,
					//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
					area : [ '80%', '70%' ],
					content : "/user/user-dispaly?userId=${userInfo.userId}"
				});
			});
			$("#logout").on("click", function() {
				layer.confirm('确定要退出登录吗？', {
					title : "退出登录"
				}, function(index) {
					layer.close(index);
					$.ajax({
						type : 'post',
						dataType : 'json',
						async : false,
						url : '/logout',
						success : function(data) {
							window.location.href = "/login";
						},
						error : function(e) {
							console.log(e);
						}
					});
				});
			});
			$("#toUpdPass").on("click", function() {
				layer.open({
					title : "修改密码",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
					maxmin : false,
					//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
					area : [ '500px', '300px' ],
					content : "/user/upd-pass?userId=${userInfo.userId}"
				});
			});
			
			$("#selfConfig").on("click", function() {
				layer.open({
					title : "个人设置",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
					maxmin : false,
					//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
					area : [ '500px', '300px' ],
					content : "/user/ini-self-config"
				});
			});
			
			$("#changeIndex").on("click", function() {
	        	var temUrl = window.location.href;
	        	temUrl = temUrl.replace('#','');
	        	var arr = temUrl.split('?');
	        	window.location.href=arr[0];
			});
            $("#nav li dl dd a").hover(function (){
                $(this).find("img").removeClass("layui-hide");
                $(this).find("img").off("click").on("click",function () {
                    $.ajax({
                        type : 'post',
                        dataType : 'json',
                        async : false,
                        url : '/admin/collect?functionCode='+$(this).parent().attr("data-code")+"&functionName="+$(this).parent().attr("lay-text")+"&functionId="+$(this).parent().attr("data-id"),
                        success : function(data) {
                            layer.msg(data.message);
                            if (data.success) {
                                // 动态修改当前我的收藏
                                var obj = eval('(' + data.data + ')');
                                if (obj.status == '1') {
                                    var collectMenu = document.getElementById("dlCollect").innerHTML;
                                    collectMenu = collectMenu + "<dd id='"+obj.dataId+"'><a lay-href='"+obj.collectUrl+"' lay-text='"+obj.collectName+"' data-id='"+obj.functionId+"' data-code='"+obj.functionCode+"' data-functionbuttons='ALL'>"+obj.collectName+"<img title=\"取消收藏\"  src=\"/layuiadmin/layui/images/icon_collection.png\" class=\"layui-hide\"/></a></dd>"
                                    document.getElementById("dlCollect").innerHTML = collectMenu;
                                    
                                } else if (obj.status == '0') {
                                    var dl = document.getElementById("dlCollect");
                                    // 查找dl里的所有dd
                                    var dds = document.getElementsByTagName('dd');
                                    for (var i = dds.length - 1; i >= 0; i--) {
                                        if (dds[i].id == obj.dataId) {
                                            dl.removeChild(dds[i]);
                                        }
                                    }
                                }

                            }

                        },
                        error : function(e) {
                            console.log(e);
                        }
                    });
					return false;
                });
            },function (){
                $(this).find("img").addClass("layui-hide");
            });
            /*$(".layui-side-scroll .layui-nav a").on("click",function(){
            	if($(this).attr("lay-href")!=undefined){
            		$(".layadmin-tabsbody-item").eq(0).siblings().remove()
            		document.getElementById("mainIframe").src=$(this).attr("lay-href");
                	console.log($(this).attr("lay-href"))
            	}
            });*/
			// 菜单收藏
			$("#collectFunction").on("click", function() {
				var param = JSON.parse(window.localStorage.getItem("param"));
				$.ajax({
					type : 'post',
					dataType : 'json',
					async : false,
					url : '/admin/collect?functionCode='+param.code+"&functionName="+param.name+"&functionId="+param.id,
					success : function(data) {
						layer.msg(data.message);
						
						if (data.success) {
							// 动态修改当前我的收藏
							var obj = eval('(' + data.data + ')');
							if (obj.status == '1') {
								var collectMenu = document.getElementById("dlCollect").innerHTML;
								collectMenu = collectMenu + "<dd id='"+obj.dataId+"'><a lay-href='"+obj.collectUrl+"' lay-text='"+obj.collectName+"' data-id='"+obj.functionId+"' data-code='"+obj.functionCode+"' data-functionbuttons='ALL'>"+obj.collectName+"</a></dd>"
								document.getElementById("dlCollect").innerHTML = collectMenu;
							} else if (obj.status == '0') {
								var dl = document.getElementById("dlCollect");
								// 查找dl里的所有dd
								var dds = document.getElementsByTagName('dd');
								for (var i = dds.length - 1; i >= 0; i--) {
								    if (dds[i].id == obj.dataId) {
								    	dl.removeChild(dds[i]);
								    }
								}
							}
							
						}
						
					},
					error : function(e) {
						console.log(e);
					}
				});
			});

			//待办任务
			$.ajax({
				type : 'POST',
				url : "/admin/pending-task-count",
				dataType : 'json',
				headers : {
					'Content-Type' : 'application/json'
				},
				timeout : 3000, //超时时间设置，单位毫秒
				error : function(XMLHttpRequest, status) {
				},
				success : function(data) { //请求成功后处理函数。
					var pendingCount = data.pendingTaskCount;
					if (pendingCount <= 0) {
						$("#pendingCount").css("visibility", "hidden");
					} else {
						$("#pendingCount").text(pendingCount);
						$("#pendingCount").css("visibility", "visible");
					}
				}
			});

			$(function() {
				initNoticeSocket();
				getUserNoticeCount();
			});
		});
		
	</script>
</body>
</html>