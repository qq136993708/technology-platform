<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">
<script type="text/javascript" src="/plugins/ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.all.js"></script>
<script type="text/javascript" src="/layuiadmin/modules/selectTree.js?v=9"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
<style>
.layui-form-selectup dl {
	top: 20px !important;
	height: 180px;
}

.layui-table-body {
	overflow: visible !important;
}

.layui-table-none {
	padding: 0 !important;
}

.layui-table {
	width: 100% !important;
}

.form_tableAdd_container .tableBox input {
	width: 69.3% !important;
}

.form_tableAdd_container .tableBox .layui-table-cell input {
	width: 100% !important;
	margin-left: 15px;
}

.form_tableAdd_container .tableBox .layui-table-cell .layui-select-title input
	{
	margin-left: 3px;
	margin-top: 3px;
}

.layui-form-select dl {
	top: 26px !important;
	left: 3px !important;
}

.tdSelect .layui-unselect input {
	width: 100% !important;;
}

.tdSelect .layui-unselect {
	width: 70.5%;
	margin-left: 3px;
}

.tdSelect .layui-form-select dl {
	left: 8px !important;
	max-height: 140px;
}

.tdSelect .layui-form-select .layui-edge {
	right: 5px;
}

.layui-table-box, .layui-table-cell, .layui-table-tool-panel li {
	overflow: visible !important;
}
</style>
</head>
<body>
	<div class="form_tableAdd_container">
		<form id="workOrderForm" action="" lay-filter="functiongroup-form" class="form-horizontal layui-form">
			<div class="formBox">
				<div class="tableToolBox">
					<div class="tableBtns">
						<div class="tableTitle">
							基本信息
							<span class="red">（标*号为必填项）</span>
						</div>
					</div>
				</div>
				<div class="box-body">
					<input type="hidden" id="dataId" name="dataId" value="${dataId}" />
					<input type="hidden" id="workOrderAllotUserId" name="workOrderAllotUserId" />
					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									工作任务名称
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input" name="workOrderName" id="workOrderName" lay-verify="title" placeholder="请输入工作任务名称" autocomplete="off" type="text">
								</div>
							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">任务编码</label>
								<div class="layui-input-block">
									<input type="text" class="layui-input readOnlyBox" readonly="readonly" id="dataCode" name="dataCode" placeholder="任务编码">
								</div>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									工作发起人
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" id="createUserName" name="createUserName" type="text" disabled>
								</div>
							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									创建时间
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" id="createDate" name="createDate" lay-verify="required" type="text" disabled>
								</div>
							</div>
						</div>
					</div>

					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label for="" class="layui-form-label">
									当前处理人
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input" name="workOrderAllotUserName" id="workOrderAllotUserName" placeholder="请选择当前处理人" readOnly="true" autocomplete="off" type="text">
								</div>
							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									紧急程度
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<select id="workOrderType" name="workOrderType" lay-filter="select_filter" lay-search></select>
								</div>
							</div>
						</div>
					</div>
					
					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									固定种类工作
								</label>
								<div class="layui-input-block">
									<select id="scheduleType" name="scheduleType" lay-filter="select_filter" lay-search></select>
								</div>
							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									定时安排时间
								</label>
								<div class="layui-input-block">
									<input class="layui-input" id="scheduleDate" name="scheduleDate" type="text">
								</div>
							</div>
						</div>
					</div>

					<div class="layui-form-item layui-form-text">
						<label class="layui-form-label">任务描述</label>
						<div class="layui-input-block">
							<textarea placeholder="请输入任务描述" class="layui-textarea" name="remarks" id="remarks" style="min-height: 50px;"></textarea>
						</div>
					</div>
				</div>
			</div>
			<div class="tableBox">
				<div class="tableToolBox">
					<div class="tableTitle">
						工作安排列表
						<span class="red">（请输入至少一项）</span>
					</div>
					<div class="tableBtns">
						<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg" data-type="addMatter" id="addMatter">新建 </a>
						<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg" data-type="deleteMatter" id="deleteMatter">删除 </a>
						<span class="pullBtn active"></span>
					</div>
				</div>
				<div style="display: block;" class="panel" id="matterTableDiv">
					<table id="matterTalbe" class="layui-table" lay-filter="tableData">
					</table>
				</div>
			</div>
			<div class="tableBox">
				<span class="file-span">任务附件</span>
				<div class="tableToolBox" style="border: 0;">
					<div class="layui-form-item" style="margin-bottom: 55px;">
						<input type="hidden" name="attachId" id="attachId" value="${dataId}">
						<div id="file_upload"></div>
					</div>
				</div>
			</div>
			<div class="form-bottom">
				<div class="form-bottom-btns">
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue btn_save" lay-submit="" lay-filter="save">保存草稿</button>
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue btn_save" lay-submit="" lay-filter="component-form-submit" id="btn_submit_xf">提交任务</button>
					<button type="button" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn">关闭</button>
				</div>
			</div>
		</form>
	</div>

	<script>
		function setWelder(selectData) {
			selectData = eval(selectData);
			var userId = "";
			var userDisp = "";
			for (var j = 0; j < selectData.length; j++) {
				userDisp = userDisp + ((j == 0) ? "" : ",") + selectData[j].userDisp;
				userId = userId + ((j == 0) ? "" : ",") + selectData[j].userId;
			}
			$('#workOrderAllotUserId').val(userId);
			$('#workOrderAllotUserName').val(userDisp);
		}

		var param = JSON.parse(window.localStorage.getItem("param"));
		var file_opt_flag = param.id;
		var i = 1;
		var file_ids = "dataId";
		var file_edit_detail = "edit";
		var selectData = "";
		var $;
		var publicMethods;
		layui.config({
			base : '/layuiadmin/lib/extend/' //静态资源所在路径
		}).extend({
			enhanceform : 'enhanceform'
		}).use([ 'form', 'laydate', 'table', 'jquery', 'layer', 'element', 'enhanceform', 'publicMethods' ], function() {
			$ = layui.jquery;
			var admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate, table = layui.table, form = layui.form, enhanceForm = layui.enhanceform;
			var enhance = new enhanceForm({
				elem : '#workOrderForm' //表单选择器
			});
			publicMethods = layui.publicMethods, form.render(null, 'component-form-group');
			
			laydate.render({
				elem : '#scheduleDate',
				type : 'datetime'
			});

			$(document).on("click", ".layui-select-title", function() {
				if ($(this).next().css("display") == "none") {
					$(".layui-table-body").css("overflow-y", "auto")
				} else {
					$(".layui-table-body").css("overflow-y", "scroll")
				}
			});

			var dataStatus = 0;
			//显示文件上传部分
			$("#file_upload").load('/common/public/uploadlayuiload.html');
			form.verify({
				title : function(value) {
					if (value.length < 4) {
						return '工作任务名称至少得4个字符啊';
					}
				}
			});

			/* 监听保存 */
			var url = '/plan/saveBotWorkOrder';
			if ('${flag}' == "edit") {
				url = "/plan/editBotWorkOrder";
				dataStatus = 1;
			}
			form.on('submit(save)', function(data) {
				var sthTrArr = [];
				var matterLength = $("#matterTableDiv .layui-table-main  table tbody tr");
				if (!$(matterLength).find("td").attr("data-off") == 1) {
					$(matterLength).each(function() {
						var sthTrObj = {};
						sthTrObj.dataId = $(this).find("td").eq(2).text();
						sthTrObj.workOrderName = $(this).find("td").eq(3).find("input").val();
						sthTrObj.workOrderAllotUserName = $(this).find(" dl dd.layui-this").html();
						sthTrObj.workOrderAllotUserId = $(this).find(" dl dd.layui-this").attr("lay-value");
						sthTrObj.announcements = $(this).find("td").eq(5).find("input").val();
						sthTrArr.push(sthTrObj);
					});
				}
				if (sthTrArr.length < 1) {
					layer.msg('请至少输入一项工作安排');
					return false;
				}
				var jsonData = data.field;
				jsonData.matterList = sthTrArr;
				$.ajax({
					type : 'post',
					dataType : 'json',
					data : {
						'param' : JSON.stringify(jsonData)
					},
					url : url,
					success : function(data) {
						if (data == 200) {
							url = '/plan/editBotWorkOrder';
							dataStatus = 1;
							var index = parent.layer.getFrameIndex(window.name);
							parent.selectRowData = "";
							parent.layer.close(index);
							parent.layer.msg("保存成功");
							parent.layui.table.reload('tableList', {});
						}
					},
					error : function(e) {
						modals.info("出错了");
					}
				});
				return false;
			});

			$('#workOrderAllotUserName').click(function() {
				layer.open({
					title : "<span>选择处理人</span>",
					skin : 'layui-layer-lan',
					shadeClose : true,
					type : 2,
					fixed : false,
					maxmin : true,
					area : [ '90%', '90%' ],
					content : '/plan/pageSelectUser'
				});
			});

			form.on('submit(component-form-submit)', function(data) {
				var sthTrArr = [];
				JSON.stringify(data.field);
				var matterLength = $("#matterTableDiv  .layui-table-main table tbody tr");
				var matterFlag = "1";
				if (!$(matterLength).find("td").attr("data-off") == 1) {
					$(matterLength).each(function() {
						var sthTrObj = {};
						sthTrObj.dataId = $(this).find("td").eq(2).text();
						sthTrObj.workOrderName = $(this).find("td").eq(3).find("input").val();
						if (sthTrObj.workOrderName == '') {
							matterFlag = "0";
						}
						sthTrObj.workOrderAllotUserName = $(this).find(" dl dd.layui-this").html();
						sthTrObj.workOrderAllotUserId = $(this).find(" dl dd.layui-this").attr("lay-value");
						sthTrObj.announcements = $(this).find("td").eq(5).find("input").val();
						sthTrArr.push(sthTrObj);
					});
				}
				if (matterFlag == '0') {
					layer.msg('工作事项内容必须要有内容！');
					return false;
				}
				if (sthTrArr.length < 1) {
					layer.msg('请至少输入一项工作安排');
					return false;
				}
				layer.confirm('确认提交吗？提交后不能修改！', {
					icon : 3,
					btn : [ '确定', '取消' ]
				}, function(index) {
					var jsonData = data.field;
					jsonData.matterList = sthTrArr;
					$.ajax({
						type : 'post',
						dataType : 'json',
						data : {
							'param' : JSON.stringify(jsonData)
						},
						url : '/plan/submitBotWorkOrder?workOrderStatus=' + dataStatus,
						success : function(data) {
							if (data == 200) {
								var index = parent.layer.getFrameIndex(window.name);
								parent.layer.close(index);
								parent.layer.msg("提交成功");
								parent.layui.table.reload('tableList', {});
							}
						},
						error : function(e) {
							modals.info("出错了");
							console.log(e);
						}
					});
				});
				return false;
			});
			//关闭事件
			$("#closeBtn").click(function() {
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			});

			//添加修改取值
			var dataId = '${dataId}';
			$.ajax({
				type : 'post',
				dataType : 'json',
				async : false,
				url : '/plan/viewBotWorkOrder?dataId=' + dataId,
				success : function(data) {
					dataJson = JSON.parse(JSON.stringify(data));
					enhance.filling(dataJson);
					$("#remarks").val(dataJson.remarks);
					selectData = data;
					if (dataJson.workOrderStatus == "1") {
						document.getElementById("btn_submit_xf").style.display = "none";
					}
					console.log(JSON.stringify(data));

					// 工作类型的初始化
					$.ajax({
						url : '/pageCommon/dic/ROOT_RWGL_RWLX',
						dataType : 'json',
						type : 'post',
						success : function(data) {
							$.each(data, function(index, item) {
								if (dataJson.workOrderType == item.code) {
									$('#workOrderType').append("<option value='"+item.code+"' selected=''>" + item.name + "</option>");
								} else {
									$('#workOrderType').append("<option value='"+item.code+"'>" + item.name + "</option>");
								}
							})
							form.render();
						}
					});
					
					// 固定种类工作的初始化
					$.ajax({
						url : '/pageCommon/dic/ROOT_XTGL_GZRWDSZL',
						dataType : 'json',
						type : 'post',
						success : function(data) {
							$('#scheduleType').append(new Option('--可设置定时工作任务--', ''));
							$.each(data, function(index, item) {
								if (dataJson.scheduleType == item.code) {
									$('#scheduleType').append("<option value='"+item.code+"' selected=''>" + item.name + "</option>");
								} else {
									$('#scheduleType').append("<option value='"+item.code+"'>" + item.name + "</option>");
								}
							})
							form.render();
						}
					});

				},
				error : function(e) {
				}
			});

			//定义事项表头
			table.render({
				elem : '#matterTalbe',
				url : '/plan/queryBotWorkOrderMatterList',
				limit : 15,
				method : "POST",
				where : {
					param : {
						"workOrderId" : dataId
					}
				},
				cols : [ [ {
					type : 'checkbox',
					event : 'changeEvents',
					width : 45
				}, {
					title : '序号',
					type : 'numbers',
					width : 45
				}, {
					field : 'dataId',
					title : '主键',
					event : 'setActive',
					style : 'cursor: pointer;',
				}, {
					field : 'workOrderName',
					title : '工作事项内容',
					event : 'setActive',
					style : 'cursor: pointer;',
					templet : function(d) {
						var t = "<input type='text' value='" + d.workOrderName + "' >";
						return t;
					}
				}, {
					field : 'workOrderAllotUserName',
					title : '当前处理人',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 100,
					templet : function(d) {

						var certTypeStr;
						var columnValue = $("#workOrderAllotUserName").val();
						var columnValueId = $("#workOrderAllotUserId").val();
						if (columnValue.length > 0) {
							var columnValueArr = columnValue.split(",");
							var columnValueIdArr = columnValueId.split(",");
							certTypeStr = "<select>";
							$.each(columnValueArr, function(index, val) {
								if (d.workOrderAllotUserName == val) {
									certTypeStr += "<option value='"+columnValueIdArr[index]+"' selected>" + columnValueArr[index] + "</option>";
								} else {
									certTypeStr += "<option value='"+columnValueIdArr[index]+"'>" + columnValueArr[index] + "</option>";
								}
							});
						} else {
							certTypeStr = "<select>";
						}
						certTypeStr += "</select>";
						return certTypeStr
					}
				}, {
					field : 'announcements',
					title : '权重(%)',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 90,
					templet : function(d) {
						var t = "<input type='text' value='" + d.announcements + "' >";
						return t;
					}
				} ] ],
				done : function(res, curr, count) {
					$(".layui-table").css("width", "100%");
					$("[data-field='dataId']").hide();
					$("[data-field='workOrderAllotUserId']").hide();
				}

			});
			//动态添加事项
			$('#addMatter').click(function() {
				if ($("#workOrderAllotUserName").val() == "") {
					layer.msg("请选择当前处理人");
					return;
				}
				var trParam = {
					"id" : "matterTableDiv",
					"number" : 6,
					"specialElement" : [ {
						hide : true,
						"column" : 2,
						"element" : "input"
					}, {
						"column" : 4,
						"element" : "select",
						"value" : $("#workOrderAllotUserName").val(),
						"valueId" : $("#workOrderAllotUserId").val()
					}, {
						hide : true,
						"column" : 6,
						"element" : "input"
					} ]
				};
				publicMethods.addTableTr(trParam);
				calTableQz();
			});

			//监听行工具事件
			table.on('tool(tableData)', function(obj) {
				var data = obj.data;
			});

			function calTableQz() {
				var sthTrArr = [];
				var sthTrArrAll = [];
				var matterLength = $("#matterTableDiv .layui-table-main  table tbody tr");
				var qzTrue = 0;
				$(matterLength).each(function() {
					var sthTrObj = {};
					if ($(this).find("td").eq(3).find("input").length > 0) {
						sthTrObj.workOrderName = $(this).find("td").eq(3).find("input").val();
						sthTrObj.announcements = $(this).find("td").eq(5).find("input").val();
						console.log(sthTrObj);
					} else {
						sthTrObj.workOrderName = $(this).find("td").eq(3).text();
						sthTrObj.announcements = $(this).find("td").eq(5).text();
					}
					sthTrArrAll.push(sthTrObj)
					if (sthTrObj.workOrderName == "") {
						sthTrArr.push(sthTrObj)
					} else {
						qzTrue = qzTrue + (sthTrObj.announcements == "" ? 0 : sthTrObj.announcements) * 1;
					}
				});
				var qz = ((100 - qzTrue) / (sthTrArr.length == 0 ? 1 : sthTrArr.length)).toFixed(2);
				console.log("qz:" + qz);
				$(matterLength).each(function() {
					var sthTrObj = {};
					console.log("qz:" + $(this).find("td").eq(3).find("input").length);
					if ($(this).find("td").eq(3).find("input").length > 0) {
						sthTrObj.workOrderName = $(this).find("td").eq(3).find("input").val();
						console.log("sthTrObj.workOrderName:" + sthTrObj.workOrderName);
						if (sthTrObj.workOrderName == "") {
							$(this).find("td").eq(5).find("input").val(qz + "");
						}
					} else {
						sthTrObj.workOrderName = $(this).find("td").eq(3).text();
						if (sthTrObj.workOrderName == "") {
							$(this).find("td").eq(5).find("input").val(qz);
						}
					}
				});
			}

			//动态移除事项
			$("#deleteMatter").click(function() {
				var index = $("#matterTableDiv table tbody tr.layui-table-click").index();
				if (index >= 0) {
					$("#matterTableDiv table tbody tr").eq(index).remove();
					if ($("#matterTableDiv table tbody tr").length <= 0) {
						$(".layui-none").show();
					}
				} else {
					layer.msg('请选择行号!');
				}
				form.render();
			});
			$(".layui-table-header table thead th input").remove();
			// 展开-折叠
			$(document).ready(function() {
				$('.pullBtn').on('click', function() {
					$(this).parent().parent().parent().find('.panel').slideToggle("normal");
					$(this).toggleClass("active");
					return false;
				})
			})
		});
	</script>
</body>
</html>

