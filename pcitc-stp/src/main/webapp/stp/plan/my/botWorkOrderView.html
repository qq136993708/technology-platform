<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">
    <script src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/jQuery/jquery-1.9.1.min.js"></script>
</head>
<body>
<div class="form_tableAdd_container">
	<form id="workOrderForm"  action="" lay-filter="functiongroup-form" class="form-horizontal layui-form">
		<div class="formBox">
			<div class="tableToolBox">
				<div class="tableBtns">
					<div class="tableTitle">基本信息
					</div>
				</div>
			</div>
			<div class="box-body">
				<input type="hidden" id="dataId" name="dataId" value="${dataId}"/>
				<input type="hidden" id="workOrderAllotUserId" name="workOrderAllotUserId"/>
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	          			<div class="layui-form-item">
	            			<label class="layui-form-label">工单标题</label>
	           				<div class="layui-input-block">
	              				<input readonly="readonly" class="layui-input readOnlyBox" name="workOrderName" id="workOrderName" lay-verify="title" placeholder="请输入工单标题" autocomplete="off" type="text">
	            			</div>
         					</div>
       				</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">创建单位</label>
							<div class="layui-input-block">
								<input readonly="readonly" class="layui-input readOnlyBox" name="redactUnitName" id="redactUnitName" lay-verify="required" value="${unitName}" autocomplete="off" type="text">
							</div>
						</div>  
					</div>
				</div>
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	          			<div class="layui-form-item">
	            			<label class="layui-form-label">工单类型</label>
	           				<div class="layui-input-block">
	           					<input class="layui-input readOnlyBox" type="text" id="workOrderType" name="workOrderType" readonly="readonly">
	            			</div>
         				</div>
       				</div>
       				<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">处理人</label>
							<div class="layui-input-block">
	              				<input class="layui-input readOnlyBox" class="layui-input" name="workOrderAllotUserName" id="workOrderAllotUserName" lay-verify="title" placeholder="请选择处理人" readOnly="true" autocomplete="off" type="text">
	            			</div>
						</div>  
					</div>
					<!-- <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	          			<div class="layui-form-item">
	            			<label class="layui-form-label">工单状态:<span class="must-fill">*</span></label>
	           				<div class="layui-input-block">
	           					<input class="layui-input readOnlyBox" type="text" id="workOrderStatus" name="workOrderStatus" readonly="readonly">
	            			</div>
         				</div>
       				</div> -->
				</div>
			</div>
		</div>
		<div class="tableBox">
	        <div class="tableToolBox">
	            <div class="tableTitle">事项列表
	            </div>
	        </div>
        	<div style="display: block;" class="panel" id="matterTableDiv">
	        	<table id="matterTalbe" class="layui-table" lay-filter="tableData">
	        	</table>
        	</div>
    	</div>
    	<div class="tableBox">
	        <div class="tableToolBox">
	            <div class="tableTitle">事项反馈列表
	            </div>
	        </div>
        	<div style="display: block;" class="panel" id="matterFeedBackTalbeDiv">
	        	<table id="matterFeedBackTalbe" class="layui-table" lay-filter="tableData">
	        	</table>
        	</div>
    	</div>
		<div class="tableBox">
			<div class="tableToolBox">
				<div class="layui-form-item">
					<input type="hidden" name="attachId" id="attachId" value="${dataId}">
	                <div id="file_upload">
	                </div>
            	</div>
        	</div>
  		</div>
	  	<div class="form-bottom">
	  		<div class="form-bottom-btns">
          		<button type="button"class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn">关闭</button>
	  		</div>
		</div>
	</form>
</div>
<script>
var param = JSON.parse(window.localStorage.getItem("param"));
var file_opt_flag = param.id;
var i=1;
var file_ids = "dataId";
var file_edit_detail = "detail";
var selectData; 
var dataId = '${dataId}';
var $;
var publicMethods;
layui.config({
   	base: '/layuiadmin/lib/extend/' //静态资源所在路径
}).extend({
   	enhanceform: 'enhanceform'
}).use([ 'form', 'laydate','table','jquery','layer','element','enhanceform','publicMethods'], function(){
    $ = layui.jquery;
    var admin = layui.admin,
        element = layui.element,
        layer = layui.layer,
        laydate = layui.laydate,
        table = layui.table,
        form = layui.form;
    publicMethods = layui.publicMethods;
    enhanceForm = layui.enhanceform;
    var enhance = new enhanceForm({
        elem: '#workOrderForm' //表单选择器
    });
    form.render(null, 'component-form-group');
	//显示文件上传部分
	$("#file_upload").load('/common/public/uploadlayuiload.html');
    form.verify({
        title: function(value){
            if(value.length < 1){
                return '标题至少得1个字符啊';
            }
        }
    });
    var dataJson;
    var dataId = '${dataId}';
    $.ajax({
		type : 'post',
		dataType : 'json',
		async : false,
		url : '/engin/workOrder/viewBotWorkOrder?dataId='+dataId,
		success : function(data) {
			dataJson = JSON.parse(JSON.stringify(data));
			enhance.filling(dataJson);
			selectData = data;
		},
		error : function(e) {
			alertError("出错了！", e);
		}
	});
    var workOrderTypeParam={
		id:"workOrderType",
		field:"workOrderType",
		data:dataJson,
		url:"/pageCommon/dic/ROOT_SGGL_GDGL_GDLX"
	};
    publicMethods.dataDictionary(workOrderTypeParam);
    /* 监听保存 */
    form.on('submit(save)', function(data){
    	var sthTrArr=[];
    	JSON.stringify(data.field);
    	var dataCode = 0;
    	var matterLength=$("#matterFeedBackTalbeDiv table tbody tr");
        $(matterLength).each(function () {
            var sthTrObj={};
            if($(this).find("td").eq(2).find("input").length>0){
                sthTrObj.matter=$(this).find("td").eq(2).find("input").val();
            }else {
                sthTrObj.matter=$(this).find("td").eq(2).text();
            }
            sthTrObj.dataCode = (dataCode++);
            sthTrArr.push(sthTrObj)
        });
        var jsonData = data.field;
        jsonData.matterList = sthTrArr;
    	$.ajax({
			type : 'post',
			dataType : 'json',
            data : {'param':JSON.stringify(jsonData)},
            url : '/engin/workOrder/saveMyBotWorkOrderMatterFeedBack',
            success : function(data) {
            	if(data==200){
            		var index = parent.layer.getFrameIndex(window.name);
        				dataStatus = 2;
		        		parent.layer.msg("保存成功");
		        		parent.layui.table.reload('tableList', {});
            	}	
            },
            error : function(e) {
            	modals.info("出错了");
                console.log(e);
            }
        });
        return false;
    });
    form.on('submit(component-form-submit)', function(data){
    	var sthTrArr=[];
    	JSON.stringify(data.field);
    	var dataCode = 0;
    	var matterLength=$("#matterFeedBackTalbeDiv table tbody tr");
        $(matterLength).each(function () {
            var sthTrObj={};
            if($(this).find("td").eq(2).find("input").length>0){
                sthTrObj.matter=$(this).find("td").eq(2).find("input").val();
            }else {
                sthTrObj.matter=$(this).find("td").eq(2).text();
            }
            sthTrObj.dataCode = (dataCode++);
            sthTrArr.push(sthTrObj)
        });
        var jsonData = data.field;
        jsonData.matterList = sthTrArr;
    	$.ajax({
			type : 'post',
			dataType : 'json',
            data : {'param':JSON.stringify(jsonData)},
            url : '/engin/workOrder/submitMyBotWorkOrder?workOrderStatus=2',
            success : function(data) {
            	if(data==200){
            		var index = parent.layer.getFrameIndex(window.name);
		             	parent.layer.close(index);
		        		parent.layer.msg("提交成功");
		        		parent.layui.table.reload('tableList', {});
            	}	
            },
            error : function(e) {
            	modals.info("出错了");
                console.log(e);
            }
        });
        return false;
    });
    //关闭事件
    $("#closeBtn").click(function () {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    })
  	//定义事项表头
	table.render({
	    elem: '#matterTalbe',
	    url: '/engin/workOrder/queryBotWorkOrderMatterList',
	    limit: 15,
	    method:"POST",
	    where: {param: {"workOrderId":dataId}},
	    cols: [[
	        {title:'序号', type:'numbers'},
	        {field:'remarks', title:'事项内容', event: 'setActive',style:'cursor: pointer;'}
	    ]]
	});
    var date = new Date();
    var seperator1 = "-";
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    var currentdate = year + seperator1 + month + seperator1 + strDate;
    table.render({
	    elem: '#matterFeedBackTalbe',
	    url: '/engin/workOrder/queryMyBotWorkOrderMatterList',
	    limit: 15,
	    method:"POST",
	    where: {param: {"workOrderId":dataId}},
	    cols: [[
	        {title:'序号', type:'numbers'},
	        {field:'remarks', title:'事项反馈内容', event: 'setActive',style:'cursor: pointer;'},
	        {field:'workOrderEndDatatime', title:'反馈日期', event: 'setActive',style:'cursor: pointer;',width:'18%'}
	    ]],
	});
    $(".layui-table-header table thead th input").remove(); 
  //动态添加事项    
    $('#addMatter').click(function(){
    	var trParam={
            "id" : "matterFeedBackTalbeDiv",
            "number" : 4,
            "specialElement" : [
            ]
        };
    	console.log(trParam);
        publicMethods.addTableTr(trParam);
    });
    //动态移除事项    
    $("#deleteMatter").click(function () {
        var index=$("#matterFeedBackTalbeDiv table tbody tr.layui-table-click").index();
        if(index>=0){
            $("#matterFeedBackTalbeDiv table tbody tr").eq(index).remove();
            if($("#matterFeedBackTalbeDiv table tbody tr").length<=0){
                $(".layui-none").show();
            }
        }else {
            layer.msg('请选择行号!');
        }
        form.render();
    });
 	// 展开-折叠
    $(document).ready(function(){ 
        $('.pullBtn').on('click',function() {
            $(this).parent().parent().parent().find('.panel').slideToggle("normal");
            $(this).toggleClass("active"); return false;
        })
    })
});

</script>
</body>
</html>

