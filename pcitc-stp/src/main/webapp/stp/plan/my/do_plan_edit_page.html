<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">
<script src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<style>
.layui-table-body {
	overflow: hidden !important;
}

.layui-table-none {
	padding: 0 !important;
}
.form_tableAdd_container .tableBox{position: relative;}
.file-span{position: absolute;top: 8px;left: 19px;font-size: 14px;color: #666;}
</style>
</head>
<body>
	<div class="form_tableAdd_container">
		<form id="workOrderForm" action="" lay-filter="functiongroup-form" class="form-horizontal layui-form">
			<div class="formBox">
				<div class="tableToolBox">
					<div class="tableBtns">
						<div class="tableTitle">
							基本信息
							<span class="red">（标*号为必填项）</span>
						</div>
					</div>
				</div>
				<div class="box-body">
					<input type="hidden" id="dataId" name="dataId" value="${dataId}" /> <input type="hidden" id="workOrderAllotUserId" name="workOrderAllotUserId" />
					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									工作任务名称
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" name="workOrderName" id="workOrderName" type="text" disabled>
								</div>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									安排人
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" id="createUserName" name="createUserName" type="text" disabled>
								</div>
							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									安排时间
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" id="createDate" name="createDate" type="text" disabled>
								</div>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label for="" class="layui-form-label">
									被安排人
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" name="workOrderAllotUserName" id="workOrderAllotUserName" readOnly="true" type="text" disabled>
								</div>
							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label class="layui-form-label">
									类型
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" name="workOrderType" id="workOrderType" readOnly="true" type="text" disabled>
								</div>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label for="" class="layui-form-label">
									权重
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input readOnlyBox" name="announcements" id="announcements" autocomplete="off" type="text" disabled>
								</div>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
							<div class="layui-form-item">
								<label for="" class="layui-form-label">
									已完成比例(%)
									<span class="must-fill">*</span>
								</label>
								<div class="layui-input-block">
									<input class="layui-input" name="bl" id="bl" lay-verify="number" placeholder="已完成比例" autocomplete="off" type="text">
								</div>
							</div>
						</div>
					</div>
					<div class="layui-form-item layui-form-text">
						<label class="layui-form-label">任务描述</label>
						<div class="layui-input-block">
							<textarea class="layui-textarea" name="remarks" id="remarks" style="min-height: 50px;"></textarea>
						</div>
					</div>
				</div>

			</div>


			<div class="tableBox">
				<input type="hidden" name="parentId" id="parentId" value="">
				<span  class="file-span">任务类附件</span>
				<div id="file_upload_parent"></div>
			</div>


			<div class="tableBox" id="matterTableDivParent">
				<div class="tableToolBox">
					<div class="tableTitle">工作下发列表</div>
				</div>
				<div style="display: block;" class="panel" id="matterTableDiv">
					<table id="matterTalbe" class="layui-table" lay-filter="tableData">
					</table>
				</div>
			</div>
			<div class="tableBox">
				<div class="tableToolBox">
					<div class="tableTitle">
						工作处理列表
						<span class="red">*</span>
					</div>
					<div class="tableBtns">
						<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg" data-type="addMatter" id="addMatter">新建 </a>
						<a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg" data-type="deleteMatter" id="deleteMatter">删除 </a>
						<span class="pullBtn active"></span>
					</div>
				</div>
				<div style="display: block;" class="panel" id="matterFeedBackTalbeDiv">
					<table id="matterFeedBackTalbe" class="layui-table" lay-filter="tableData">
					</table>
				</div>
			</div>


			<div class="tableBox" style="margin-bottom: 55px;">
				<input type="hidden" name="attachId" id="attachId" value="${dataId}">
				<span class="file-span">处理类附件</span>
				<div id="file_upload"></div>
			</div>



			<div class="form-bottom">
				<div class="form-bottom-btns">
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="save">保存</button>
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="component-form-submit">完成</button>
					<button type="button" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn">关闭</button>
				</div>
			</div>
		</form>
	</div>
	<script>
		var param = JSON.parse(window.localStorage.getItem("param"));
		var file_opt_flag = param.id;
		var i = 1;
		var file_ids = "dataId";
		var file_edit_detail = "edit";
		var selectData;
		var dataId = '${dataId}';
		var $;
		var publicMethods;
		var submitArr = [];
		var submitStr = "";

		//文件上传配置
		var file_edit_detail2 = "detail";
		var file_opt_flag2 = param.id;
		var file_ids2 = "parentId";

		layui.config({
			base : '/layuiadmin/lib/extend/' //静态资源所在路径
		}).extend({
			enhanceform : 'enhanceform'
		}).use([ 'form', 'laydate', 'table', 'jquery', 'layer', 'element', 'enhanceform', 'publicMethods' ], function() {
			$ = layui.jquery;
			var admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate, table = layui.table, form = layui.form;
			publicMethods = layui.publicMethods;
			enhanceForm = layui.enhanceform;
			var enhance = new enhanceForm({
				elem : '#workOrderForm' //表单选择器
			});
			form.render(null, 'component-form-group');
			//显示文件上传部分
			$("#file_upload").load('/common/public/uploadlayuiload.html');
			form.verify({
				bl : function(value) {
					if (value > 4) {
						return '工作任务名称至少得4个字符啊';
					}
				}
			});
			var dataJson;
			var dataId = '${dataId}';
			$.ajax({
				type : 'post',
				dataType : 'json',
				async : false,
				url : '/plan/viewBotWorkOrder?dataId=' + dataId,
				success : function(data) {
					dataJson = JSON.parse(JSON.stringify(data));
					enhance.filling(dataJson);
					$("#remarks").val(dataJson.remarks);
					selectData = data;
					$("#file_upload_parent").load('/common/public/uploadlayuiload2.html');

					// 工作类型的初始化
					$.ajax({
						url : '/pageCommon/dic/ROOT_RWGL_RWLX',
						dataType : 'json',
						type : 'post',
						success : function(data) {
							$.each(data, function(index, item) {
								if (dataJson.workOrderType == item.code) {
									$("#workOrderType").val(item.name);
								}
							})
							form.render();
						}
					});
				},
				error : function(e) {
					alertError("出错了！", e);
				}
			});

			/* 监听保存 */
			form.on('submit(save)', function(data) {
				var sthTrArr = [];
				JSON.stringify(data.field);
				var dataCode = 0;
				var matterLength = $("#matterFeedBackTalbeDiv table tbody tr");
				$(matterLength).each(function() {
					var sthTrObj = {};
                    sthTrObj.remarks = $(this).find("td").eq(2).find("input").val();
                    sthTrObj.workOrderEndDatatime = $(this).find("td").eq(3).find("input").val();
					sthTrObj.dataCode = (dataCode++);
					sthTrArr.push(sthTrObj);
				});
				var jsonData = data.field;
				jsonData.matterList = sthTrArr;
				$.ajax({
					type : 'post',
					dataType : 'json',
					data : {
						'param' : JSON.stringify(jsonData)
					},
					url : '/plan/saveMyBotWorkOrderMatterFeedBack',
					success : function(data) {
						dataStatus = 2;
						var index = parent.layer.getFrameIndex(window.name);
						parent.layer.close(index);
						parent.layer.msg("保存成功");
						parent.layui.table.reload('tableList', {});
					},
					error : function(e) {
						modals.info("出错了");
						console.log(e);
					}
				});
				return false;
			});
			
			form.on('submit(component-form-submit)', function(data) {
				if ($("#bl").val() < 100) {
					layer.confirm('确认要提交未完成的任务吗？',{icon:3,btn:['确定','取消']},function(index){
						var sthTrArr = [];
						JSON.stringify(data.field);
						var dataCode = 0;
						var matterLength = $("#matterFeedBackTalbeDiv table tbody tr");
						$(matterLength).each(function() {
							var sthTrObj = {};
                            sthTrObj.remarks = $(this).find("td").eq(2).find("input").val();
                            sthTrObj.workOrderEndDatatime = $(this).find("td").eq(3).find("input").val();
                            alert($(this).find("td").eq(2).find("input").val())
                            alert($(this).find("td").eq(3).find("input").val())
							sthTrObj.dataCode = (dataCode++);
							sthTrArr.push(sthTrObj)
						});
						var jsonData = data.field;
						jsonData.matterList = sthTrArr;
						$.ajax({
							type : 'post',
							dataType : 'json',
							data : {
								'param' : JSON.stringify(jsonData)
							},
							url : '/plan/submitMyBotWorkOrder?workOrderStatus=2',
							success : function(data) {
								var index = parent.layer.getFrameIndex(window.name);
								parent.layer.close(index);
								parent.layer.msg("提交成功");
								parent.layui.table.reload('tableList', {});
							},
							error : function(e) {
								modals.info("出错了");
								console.log(e);
							}
						});
                    });
				}
				return false;
			});
			//关闭事件
			$("#closeBtn").click(function() {
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			})
			
			//任务接收后，再次下发列表
			table.render({
				elem : '#matterTalbe',
				url : '/plan/queryBotWorkOrderMatterList',
				limit : 15,
				method : "POST",
				where : {
					param : {
						"workOrderId" : dataId
					}
				},
				cols : [ [ {
					title : '序号',
					type : 'numbers',
					width : 45
				}, {
					field : 'workOrderName',
					title : '工作事项内容',
					event : 'setActive',
					style : 'cursor: pointer;',
				}, {
					field : 'workOrderAllotUserName',
					title : '被安排人',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 120
				}, {
					field : 'jsId',
					title : '实际处理人',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 120
				}, {
					field : 'announcements',
					title : '任务总占比(%)',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 100
				}, {
					field : 'bl',
					title : '已完成比例',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 80
				}, {
					title : '操作',
					toolbar : '#showDetail',
					width : 80
				} ] ],
				done : function(res, curr, count) {
					$(".layui-table").css("width", "100%");
					if (res.data.length == 0) {
						document.getElementById("matterTableDivParent").style.display = "none";
					}
				}
			});
			
			table.render({
				elem : '#matterFeedBackTalbe',
				url : '/plan/queryMyBotWorkOrderMatterList',
				limit : 15,
				method : "POST",
				where : {
					param : {
						"workOrderId" : dataId
					}
				},
				cols : [ [ {
					type : 'checkbox',
					event : 'changeEvents',
					width : 45
				}, {
					title : '序号',
					type : 'numbers',
					width : 45
				}, {
					field : 'remarks',
					title : '处理内容',
					event : 'setActive',
					style : 'cursor: pointer;',
                    templet : function(d) {
                        var t = "<input type='text' value='" + d.remarks + "' >";
                        return t;
                    }
				}, {
					field : 'workOrderEndDatatime',
					title : '处理日期',
					event : 'setActive',
					style : 'cursor: pointer;',
					width : 140,
					templet : function(d) {
						var t = "<input style='margin-left: 1px;margin-top: 3px;' type='text' value='" + d.workOrderEndDatatime + "' class='layui-input datetime inputVal' >";
						return t;
					}
				}, {
					field : 'dataId',
					title : 'id'
				} ] ],
				done : function(res, curr, count) {
					$("[data-field='dataId']").hide();
					$(".layui-table").css("width", "100%");
					$('#matterFeedBackTalbeDiv .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
						var tr = $('#matterFeedBackTalbeDiv .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr");
						var index = parseInt($(this).index());
						$(tr).removeClass('layui-table-click');
						$(this).addClass('layui-table-click');
						$(tr).find("td").find(".layui-unselect").removeClass("layui-form-checked")
						$(tr).eq(index).find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
						selectRowData = res.data[index - 1];
					});
					lay('.datetime').each(function() {
						laydate.render({
							elem : this,
							trigger : 'click'
						});
					});
				}
			});
			$(".layui-table-header table thead th input").remove();
			
			//动态添加事项
			$('#addMatter').click(function() {
				var trParam = {
					"id" : "matterFeedBackTalbeDiv",
					"number" : 4,
					"specialElement" : [ {
						"column" : 3,
						"element" : "laydate"
					} ]
				};
				publicMethods.addTableTr(trParam);
				publicMethods.timeAdd();
			});
			
			//动态移除事项, 暂时可以随便删除，保存后的也可以删除，不控制
			$("#deleteMatter").click(function() {
				var index = $("#matterFeedBackTalbeDiv table tbody tr.layui-table-click").index();
				if (index >= 0) {
					$("#matterFeedBackTalbeDiv table tbody tr").eq(index).remove();
					
					if ($("#matterFeedBackTalbeDiv table tbody tr").length <= 0) {
						$(".layui-none").show();
					}
					form.render();
				} else {
					layer.msg('请选择处理内容!');
				}
			});

			// 展开-折叠
			$(document).ready(function() {
				$('.pullBtn').on('click', function() {
					$(this).parent().parent().parent().find('.panel').slideToggle("normal");
					$(this).toggleClass("active");
					return false;
				})
			})
		});
	</script>
</body>
</html>

