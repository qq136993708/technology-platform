<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">
    <script src="/layuiadmin/layui/layui.js"></script>
    <script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
    <style>
        .layui-table-body {
            overflow: hidden !important;
        }

        .layui-table-none {
            padding: 0 !important;
        }

        .form_tableAdd_container .tableBox {
            position: relative;
        }

        .file-span {
            position: absolute;
            top: 8px;
            left: 19px;
            font-size: 14px;
            color: #666;
        }

        .tableToolBox {
            height: 34px !important;
            line-height: 34px !important;;
            background: rgba(150, 206, 251, .3) !important;;
            font-size: 14px !important;;
            color: #1890FF !important;;
            border-top: 1px solid #2495ff !important;;
            text-indent: 16px !important;;
        }

        .top {
            margin-left: 10px;
            margin-top: 10px;
        }

        .top button {
            padding: 1px 10px !important;
        }

        .top button {
            background: url("/layuiadmin/layui/images/layui-h.png") no-repeat;
            width: 144px;
            height: 28px;
            margin-left: 0 !important;
            line-height: 28px;
            color: #646464;
            text-align: left;
            text-indent: 1.5em;
        }

        .top button:hover {
            background: url("/layuiadmin/layui/images/layui-h.png") no-repeat;
            color: #646464;
        }

        .top .layui-this {
            background: url("/layuiadmin/layui/images/layui-l.png") no-repeat;
            color: white;
        }

        .top .layui-this:hover {
            background: url("/layuiadmin/layui/images/layui-l.png") no-repeat;
            color: white;
        }

        .top button:nth-child(2) {
            margin-left: 18px !important;
        }

        .layui-input-block {
            margin-left: 116px !important;
        }

        .layui-form-item {
            margin-bottom: 0px !important;
        }

        .layui-input-block span, .layui-form-label {
            line-height: 38px !important;
            font-size: 16px !important;
        }

        .formBox .layui-row {
            background-color: #F7F8FC;
            padding: 10px 0;
        }

        .formBox .layui-row:nth-child(2n) {
            background-color: #fff;
        }

        .tableBtns a {
            padding: 0 10px;
        }
    </style>
</head>
<body>
<div class="top">
    <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-this" onclick="index_page('/plan/my/goEditPlanDetailIndex_cl?dataId=${dataId}')">任务处理</button>
    <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg" onclick="index_page('/plan/my/goEditPlanDetailIndex_xf?dataId=${dataId}')">任务下发</button>
    <!--<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg" onclick="index_page('/plan/my/goEditPlanDetailIndex_zf?dataId=${dataId}')">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;转发&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button>-->
    <script>

    </script>
</div>

<div class="form_tableAdd_container">
    <form id="workOrderForm" action="" lay-filter="functiongroup-form" class="form-horizontal layui-form">
        <div class="formBox">
            <div class="tableToolBox">
                <div class="tableBtns">
                    <div class="tableTitle">
                        任务基本信息
                    </div>
                </div>
            </div>
            <div class="">
                <input type="hidden" id="dataId" name="dataId" value="${dataId}"/>
                <input type="hidden" id="workOrderAllotUserId" name="workOrderAllotUserId"/>
                <div class="layui-row">
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                任务名称:
                            </label>
                            <div class="layui-input-block">
                                <span id="workOrderName"></span>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                任务发起日期:
                            </label>
                            <div class="layui-input-block">
                                <span id="createDate"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                发起人:
                            </label>
                            <div class="layui-input-block">
                                <span id="createUserName"></span>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                重要程度:
                            </label>
                            <div class="layui-input-block">
                                <span id="workOrderType"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                完成比例:
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="bl" id="bl" class="layui-input" style="width: 30%;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-form-item layui-form-text">
                    <label class="layui-form-label">任务描述:</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="remarks" id="remarks" style="min-height: 50px;"></textarea>
                    </div>
                </div>
            </div>

        </div>

        <div class="tableBox" id="matterTableDivParent">
            <div class="tableToolBox">
                <div class="tableTitle">任务下发列表</div>
            </div>
            <div style="display: block;" class="panel" id="matterTableDiv">
                <table id="matterTalbe" class="layui-table" lay-filter="tableData">
                </table>
            </div>
        </div>
        <div class="tableBox">
            <div class="tableToolBox">
                <div class="tableTitle">
                    任务处理列表
                    <span class="red">*</span>
                </div>
                <div class="tableBtns">
                    <a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg" data-type="addMatter" id="addMatter">新建 </a>
                    <a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg" data-type="deleteMatter" id="deleteMatter">删除 </a>
                    <span class="pullBtn active"></span>
                </div>
            </div>
            <div style="display: block;" class="panel" id="matterFeedBackTalbeDiv">
                <table id="matterFeedBackTalbe" class="layui-table" lay-filter="tableData">
                </table>
            </div>
        </div>


        <div class="tableBox" style="margin-bottom: 55px;">
            <input type="hidden" name="attachId" id="attachId" value="${dataId}">
            <span class="file-span">任务处理类附件</span>
            <div id="file_upload"></div>
        </div>


        <div class="form-bottom">
            <div class="form-bottom-btns">
                <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="save">保存草稿</button>
                <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="component-form-submit">最终完成</button>
                <button type="button" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn">关闭</button>
            </div>
        </div>
    </form>
</div>
<script type="text/html" id="showDetail">
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看反馈</a>
</script>
<script>
    var param = JSON.parse(window.localStorage.getItem("param"));
    var file_opt_flag = param.id;
    var i = 1;
    var file_ids = "dataId";
    var file_edit_detail = "edit";
    var selectData;
    var dataId = '${dataId}';
    var $;
    var publicMethods;
    var submitArr = [];
    var submitStr = "";

    //文件上传配置
    var file_edit_detail2 = "detail";
    var file_opt_flag2 = param.id;
    var file_ids2 = "parentId";

    layui.config({
        base: '/layuiadmin/lib/extend/' //静态资源所在路径
    }).extend({
        enhanceform: 'enhanceform'
    }).use(['form', 'laydate', 'table', 'jquery', 'layer', 'element', 'enhanceform', 'publicMethods'], function () {
        $ = layui.jquery;
        var admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate, table = layui.table, form = layui.form;
        publicMethods = layui.publicMethods;
        enhanceForm = layui.enhanceform;
        var enhance = new enhanceForm({
            elem: '#workOrderForm' //表单选择器
        });
        form.render(null, 'component-form-group');
        //显示文件上传部分
        $("#file_upload").load('/common/public/uploadlayuiload.html');
        form.verify({
            bl: function (value) {
                if (value > 4) {
                    return '工作任务名称至少得4个字符啊';
                }
            }
        });
        var dataJson;
        var dataId = '${dataId}';
        var bak7 = "1";
        $.ajax({
            type: 'post',
            dataType: 'json',
            async: false,
            url: '/plan/viewBotWorkOrder?dataId=' + dataId,
            success: function (data) {
                dataJson = JSON.parse(JSON.stringify(data));
                enhance.filling(dataJson);
                $("#remarks").val(dataJson.remarks);
                selectData = data;
                $("#file_upload_parent").load('/common/public/uploadlayuiload2.html');
                $("#workOrderName").html(dataJson.workOrderName);
                $("#createDate").html(dataJson.createDate);
                $("#createUserName").html(dataJson.createUserName);
                    // $("#workOrderType").html(dataJson.workOrderType);
                // 工作类型的初始化
                $.ajax({
                    url: '/pageCommon/dic/ROOT_RWGL_RWLX',
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        $.each(data, function (index, item) {
                            console.log(dataJson.workOrderType + "---" + item.code);
                            if (dataJson.workOrderType == item.code) {
                                $("#workOrderType").html(item.name);
                            }
                        })
                        form.render();
                    }
                });
            },
            error: function (e) {
                alertError("出错了！", e);
            }
        });

        /* 监听保存 */
        form.on('submit(save)', function (data) {
            var sthTrArr = [];
            var matterLength = $("#matterFeedBackTalbeDiv table tbody tr");
            if (!$(matterLength).find("td").attr("data-off") == 1) {
                $(matterLength).each(function () {
                    var sthTrObj = {};
                    sthTrObj.remarks = $(this).find("td").eq(2).find("input").val();
                    sthTrObj.workOrderEndDatatime = $(this).find("td").eq(3).find("input").val();
                    sthTrArr.push(sthTrObj);
                });
            }
            if (sthTrArr.length < 1) {
                layer.msg('请至少输入一项工作处理内容');
                return false;
            }
            var jsonData = data.field;
            if (jsonData.bl > 100) {
                jsonData.bl = 100;
            }
            jsonData.matterList = sthTrArr;

            $.ajax({
                type: 'post',
                dataType: 'json',
                data: {
                    'param': JSON.stringify(jsonData)
                },
                url: '/plan/saveMyBotWorkOrderMatterFeedBack',
                success: function (data) {
                    // dataStatus = 2;
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                    parent.layer.msg("保存成功");
                    parent.selectRowData = "";
                    parent.layui.table.reload('tableList', {});
                },
                error: function (e) {
                    modals.info("出错了");
                    console.log(e);
                }
            });
            return false;
        });

        form.on('submit(component-form-submit)', function (data) {
            var sthTrArr = [];
            var matterLength = $("#matterFeedBackTalbeDiv table tbody tr");
            var matterFlag = "1";
            if ($("#bl").val() == '') {
                layer.msg('请录入完成比例！');
                return false;
            }
            if (!$(matterLength).find("td").attr("data-off") == 1) {
                $(matterLength).each(function () {
                    var sthTrObj = {};
                    sthTrObj.remarks = $(this).find("td").eq(2).find("input").val();
                    if (sthTrObj.remarks == '') {
                        matterFlag = "0";
                    }
                    sthTrObj.workOrderEndDatatime = $(this).find("td").eq(3).find("input").val();
                    sthTrArr.push(sthTrObj)
                });
            }
            if (matterFlag == '0') {
                layer.msg('工作处理必须要有内容！');
                return false;
            }
            if (sthTrArr.length < 1) {
                layer.msg('请至少输入一项工作处理');
                return false;
            }

            layer.confirm('确认提交任务吗？提交后不能修改！', {
                icon: 3,
                btn: ['确定', '取消']
            }, function (index) {
                var jsonData = data.field;
                if (jsonData.bl > 100) {
                    jsonData.bl = 100;
                }
                jsonData.matterList = sthTrArr;

                $.ajax({
                    type: 'post',
                    dataType: 'json',
                    data: {
                        'param': JSON.stringify(jsonData)
                    },
                    url: '/plan/submitMyBotWorkOrder?workOrderStatus=2',
                    success: function (data) {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                        parent.layer.msg("提交成功");
                        parent.selectRowData = "";
                        parent.layui.table.reload('tableList', {});
                    },
                    error: function (e) {
                        modals.info("出错了");
                        console.log(e);
                    }
                });
            });
            return false;
        });
        //关闭事件
        $("#closeBtn").click(function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        })

        //监听行工具事件
        table.on('tool(tableData)', function(obj) {
            var data = obj.data;
            if (obj.event === 'showDetail') {
                layer.open({
                    title : "任务详情",
                    skin : 'layui-layer-lan',
                    shadeClose : false,
                    type : 2,
                    fixed : false,
                    //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                    maxmin : true,
                    //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                    area : [ '100%', '100%' ],
                    content : '/plan/my/viewPlanDetail?dataId=' + data.dataId
                });
            }
        });

        //任务接收后，再次下发列表
        var xf_flag = "";
        table.render({
            elem: '#matterTalbe',
            url: '/plan/queryBotWorkOrderMatterList',
            limit: 15,
            method: "POST",
            where: {
                param: {
                    "workOrderId": dataId
                }
            },
            cols: [[{
                title: '序号',
                type: 'numbers',
                width: 45
            }, {
                field: 'workOrderName',
                title: '工作事项内容',
                event: 'setActive',
                style: 'cursor: pointer;',
            }, {
                field: 'workOrderAllotUserName',
                title: '当前处理人',
                event: 'setActive',
                style: 'cursor: pointer;',
                width: 120
            }, {
                field: 'jsId',
                title: '实际处理人',
                event: 'setActive',
                style: 'cursor: pointer;',
                width: 120
            },
                //    {
                // 	field : 'announcements',
                // 	title : '任务总占比(%)',
                // 	event : 'setActive',
                // 	style : 'cursor: pointer;',
                // 	width : 100
                // },
                {
                    field: 'bl',
                    title: '已完成比例',
                    event: 'setActive',
                    style: 'cursor: pointer;',
                    width: 80
                }, {
                    title: '操作',
                    toolbar: '#showDetail',
                    width: 80
                }]],
            done: function (res, curr, count) {
                for (let j = 0; j < res.data.length; j++) {
                     bak7 =res.data[j].bak7;
                }
                xf_flag = res.data.length;
                $(".layui-table").css("width", "100%");
                if (res.data.length == 0) {
                    document.getElementById("matterTableDivParent").style.display = "none";
                }
            }
        });

        function index_page(url) {
            if (xf_flag>0&&bak7==0){
                layer.msg("任务不能重复下发");
            } else {
                window.location.href = url;
            }
        }

        window.index_page = index_page;
        // 工作的处理内容
        table.render({
            elem: '#matterFeedBackTalbe',
            url: '/plan/queryMyBotWorkOrderMatterList',
            limit: 15,
            method: "POST",
            where: {
                param: {
                    "workOrderId": dataId
                }
            },
            cols: [[{
                type: 'checkbox',
                event: 'changeEvents',
                width: 45
            }, {
                title: '序号',
                type: 'numbers',
                width: 45
            }, {
                field: 'remarks',
                title: '工作内容',
                event: 'setActive',
                style: 'cursor: pointer;',
                templet: function (d) {
                    var t = "<input type='text' value='" + d.remarks + "' >";
                    return t;
                }
            }, {
                field: 'workOrderEndDatatime',
                title: '日期',
                event: 'setActive',
                style: 'cursor: pointer;',
                width: 140,
                templet: function (d) {
                    var t = "<input style='margin-left: 1px;margin-top: 3px;' type='text' value='" + d.workOrderEndDatatime + "' class='layui-input datetime inputVal' >";
                    return t;
                }
            }, {
                field: 'dataId',
                title: 'id'
            }]],
            done: function (res, curr, count) {
                $("[data-field='dataId']").hide();
                $(".layui-table").css("width", "100%");
                $('#matterFeedBackTalbeDiv .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function () {
                    var tr = $('#matterFeedBackTalbeDiv .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr");
                    var index = parseInt($(this).index());
                    $(tr).removeClass('layui-table-click');
                    $(this).addClass('layui-table-click');
                    $(tr).find("td").find(".layui-unselect").removeClass("layui-form-checked")
                    $(tr).eq(index).find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
                    selectRowData = res.data[index - 1];
                });
                lay('.datetime').each(function () {
                    laydate.render({
                        elem: this,
                        trigger: 'click'
                    });
                });
            }
        });
        $(".layui-table-header table thead th input").remove();

        //动态添加事项
        $('#addMatter').click(function () {
            var trParam = {
                "id": "matterFeedBackTalbeDiv",
                "number": 4,
                "specialElement": [{
                    "column": 3,
                    "element": "laydate"
                }]
            };
            publicMethods.addTableTr(trParam);
            publicMethods.timeAdd();
        });

        //动态移除事项, 暂时可以随便删除，保存后的也可以删除，不控制
        $("#deleteMatter").click(function () {
            var index = $("#matterFeedBackTalbeDiv table tbody tr.layui-table-click").index();
            if (index >= 0) {
                $("#matterFeedBackTalbeDiv table tbody tr").eq(index).remove();

                if ($("#matterFeedBackTalbeDiv table tbody tr").length <= 0) {
                    $(".layui-none").show();
                }
                form.render();
            } else {
                layer.msg('请选择处理内容!');
            }
        });

        // 展开-折叠
        $(document).ready(function () {
            $('.pullBtn').on('click', function () {
                $(this).parent().parent().parent().find('.panel').slideToggle("normal");
                $(this).toggleClass("active");
                return false;
            })
        })
    });
</script>
</body>
</html>

