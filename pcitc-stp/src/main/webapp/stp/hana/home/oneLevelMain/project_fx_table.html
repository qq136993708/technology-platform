<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css">
<link rel="stylesheet" href="/layuiadmin/style/admin.css">
<script src="/layuiadmin/layui/layui.js"></script>
<style>
.dateInput {
	font-size: 12px;
}

.layui-btn {
	height: 30px;
	line-height: 30px;
	padding: 0 15px;
}

.layuiadmin-card-header-auto i.layuiadmin-button-btn {
	font-size: 14px;
}

.layui-laydate-hint {
	display: none;
}
</style>
</head>
<body>

	<!-- 国家项目、重大专项、重点项目、其他项目   -->
	<input type="hidden" name="project_property" value="${project_property}" id="project_property">
	<!-- 新开项目、续建项目、完工项目  -->
	<input type="hidden" name="project_scope" value="${project_scope}" id="project_scope">
	<input type="hidden" name="projectId" value="${projectId}" id="projectId">
	<!-- 直属研究院、分子公司、集团等9种类型 -->
	<input type="hidden" name="type_flag" value="${type_flag}" id="type_flag">
	<input type="hidden" name="leaderFlag" value="${leaderFlag}" id="leaderFlag">
	<input type="hidden" name="ktlx" value="${ktlx}" id="ktlx">
	<div class="layui-fluid">
		<div class="layui-card">

			<div class="layui-form layui-card-header layuiadmin-card-header-auto" style="padding: 0px">
				<div class="layui-form-item">
					<div class="layui-inline">
						<label class="layui-form-label">项目名称：</label>
						<div class="layui-input-inline">
							<input type="text" name="xmmc" title="项目名称" placeholder="请输入项目名称" autocomplete="off" class="layui-input" id="xmmc">
						</div>
					</div>

					<div class="layui-inline">
						<label class="layui-form-label">合同号：</label>
						<div class="layui-input-inline">
							<input type="text" name="hth" title="合同号" placeholder="请输入合同号" autocomplete="off" class="layui-input" id="hth">
						</div>
					</div>


					<div class="layui-inline">
						<label class="layui-form-label">立项年度：</label>
						<div class="layui-input-inline">
							<input type="text" name="nd" readonly="readonly" style="cursor: pointer" placeholder="请选择立项年度" title="立项年度" value="${nd}" autocomplete="off" class="layui-input" id="nd" width="100px">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label">预算年度：</label>
						<div class="layui-input-inline">
							<input type="text" name="ysnd" readonly="readonly" style="cursor: pointer" placeholder="请选择预算年度" title="预算年度" value="${ysnd}" autocomplete="off" class="layui-input" id="ysnd" width="100px">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label">费用类别：</label>
						<div class="layui-input-inline">
							<select name="define1" id="define1">
								<option value="">--请选择--</option> <#list fylbList as vo>
								<option value="${vo.numValue}"<#if define1==vo.numValue>selected="selected"</#if> >${vo.name}</option> </#list>
							</select>
						</div>
					</div>

					<!-- 三级级联 begin-->
					<div class="layui-inline">
						<label class="layui-form-label">经费来源：</label>
						<div class="layui-input-inline">
							<select name="define11" id="define11" lay-filter="select_define11">
								<option value="">--请选择--</option> <#list jflyList as vo>
								<option value="${vo.code}"<#if define11=vo.name>selected="selected"</#if>>${vo.name}</option> </#list>
							</select>
						</div>
					</div>

					<div class="layui-inline">
						<label class="layui-form-label">单位性质：</label>
						<div class="layui-input-inline">
							<select name="define12" id="define12" lay-filter="select_define12">
							</select>
						</div>
					</div>

					<div class="layui-inline">
						<label class="layui-form-label">研究院：</label>
						<div class="layui-input-inline">
							<select name="define2" id="define2">
							</select>
						</div>
					</div>
					<!-- 三级级联 end -->


					<!-- 三级级联 begin -->
					<div class="layui-inline">
						<label class="layui-form-label">部门：</label>
						<div class="layui-input-inline">
							<select name="gsbmbmFlag" id="gsbmbmFlag" lay-filter="select_gsbmbmFlag">
								<option value="">--请选择--</option> <#list gsbmbmList as vo>
								<option value="${vo.code}"<#if gsbmbmFlag=vo.name>selected="selected"</#if>>${vo.name}</option> </#list>
							</select>
						</div>
					</div>


					<div class="layui-inline">
						<label class="layui-form-label">处室：</label>
						<div class="layui-input-inline">
							<select name="zycbmFlag" id="zycbmFlag" lay-filter="select_zycbmFlag">
							</select>
						</div>
					</div>


					<div class="layui-inline">
						<label class="layui-form-label">专业类别：</label>
						<div class="layui-input-inline">
							<select name="zylbbmFlag" id="zylbbmFlag">
							</select>
						</div>
					</div>
					<!-- 二级级联 end -->




					<div class="layui-inline">
						<label class="layui-form-label">技术分类：</label>
						<div class="layui-input-inline">
							<select name="define5" id="define5">
								<option value="">--请选择--</option> <#list jsflList as vo>
								<option value="${vo.name}"<#if define5==vo.name>selected="selected"</#if>>${vo.name}</option> </#list>
							</select>
						</div>
					</div>



					<div class="layui-inline">
						<label class="layui-form-label">承担单位：</label>
						<div class="layui-input-inline">
							<select name="fzdwflag" id="fzdwflag">
								<option value="">--请选择--</option> <#list fzdwList as vo>
								<option value="${vo.numValue}">${vo.name}</option> </#list>
							</select>
						</div>
					</div>


					<div class="layui-inline">
						<label class="layui-form-label">单位名称：</label>
						<div class="layui-input-inline">
							<input type="text" name="unitName" id="unitName" title="单位名称" placeholder="请输入单位名称" autocomplete="off" class="layui-input">
						</div>
					</div>



					<div class="layui-inline">
						<label class="layui-form-label">分组类型：</label>
						<div class="layui-input-inline">
							<select name="groupFlag" id="groupFlag">
								<option value="">--请选择--</option> <#list fzlxList as vo>
								<option value="${vo.numValue}"<#if groupFlag==vo.numValue>selected="selected"</#if>>${vo.name}</option> </#list>
							</select>
						</div>
					</div>

					<div class="layui-inline">
						<button class="layui-btn layuiadmin-btn-list" data-type="searchEvent">
							<i class="layui-icon layui-icon-search layuiadmin-button-btn">查询</i>
						</button>
					</div>


					<div class="layui-inline">
						<button class="layui-btn layuiadmin-btn-list" data-type="resetEvent">
							<i class="layui-icon  layuiadmin-button-btn">重置</i>
						</button>
					</div>


				</div>
			</div>
			<div class="layui-card-body">
				<table id="processdef-table" class="layui-hide" lay-filter="processdef-table"></table>
			</div>
		</div>
	</div>
	<!--表格数据操作js-->
	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script id="view_taskVersion" type="text/html"> {{purchase_money_jf(d.jf)}} </script>
	<script id="view_taskVersion2" type="text/html"> {{purchase_money(d.ysje)}} </script>
	<script id="view_taskVersion3" type="text/html"> {{purchase_money(d.yszbxje)}} </script>
	<script id="view_taskVersion4" type="text/html"> {{purchase_money(d.ysfyxje)}} </script>

	<script>
		var table, selectRowData, laydate;
		var xmmc = $('#xmmc').val();
		var form;
		layui.use([ 'jquery', 'form', 'laydate', 'table', 'laypage' ], function() {
			$ = layui.jquery;
			table = layui.table;
			laydate = layui.laydate;
			form = layui.form;
			form.render();
			laydate.render({
				elem : '#nd',
				type : 'year',
				done : function(value, date, endDate) {
					$("#nd").val(date.year);
				}
			});
			laydate.render({
				elem : '#ysnd',
				type : 'year',
				done : function(value, date, endDate) {
					$("#ysnd").val(date.year);
				}
			});
			//加载表格      

			//移除表头的复选框,去掉全选
			$(".layui-table-header table thead th input").remove();

			// 触发不同的按钮事件
			var $ = layui.$, active = {
				searchEvent : function() { //点击查询按钮
					renderTable();
				},
				resetEvent : function() {
					$('#nd').val("");
					$('#ysnd').val("");
					$('#xmmc').val("");
					$('#define11').val("");
					$("#define11").trigger("change");
					$('#define2').val("");
					$('#define1').val("");
					$('#define5').val("");
					$('#define12').val("");
					$('#hth').val("");
					$('#zylb').val("");
					$('#ktlx').val("");
					$('#project_property').val("");
					$('#groupFlag').val("");
					$('#gsbmbmFlag').val("");
					$('#zycbmFlag').val("");
					$('#zylbbmFlag').val("");
					form.render();
				}

			};
			//区别按钮属性
			$('.layui-btn').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});

			//监听经费来源
			form.on('select(select_define11)', function(data) {
				//alert(data.value);
				var parentCode = data.value;
				getDicByParentCode(parentCode, 'define12');
				console.log("监听经费来源:" + data);
			});
			//监听单位性质
			form.on('select(select_define12)', function(data) {
				var parentCode = data.value;
				getDicByParentCode(parentCode, 'define2');
				console.log("监听单位性质:" + data);
			});

			//监听部门
			form.on('select(select_gsbmbmFlag)', function(data) {
				//alert(data.value);
				var parentCode = data.value;
				getDicByParentCode(parentCode, 'zycbmFlag');
				console.log("监听部门:" + data);
			});

			//监听处室
			form.on('select(select_zycbmFlag)', function(data) {
				var parentCode = data.value;

				getDicByParentCode(parentCode, 'zylbbmFlag');
				console.log("监听处室:" + data);
			});

			//初始化经费来源
			var define11 = $("#define11").val();
			getDicByParentCode(define11, 'define12');

			//初始部门
			var gsbmbmFlag = $("#gsbmbmFlag").val();
			getDicByParentCode(gsbmbmFlag, 'zycbmFlag');

			renderTable();
		});

		function renderTable() {
			//alert("dd");
			//获取选中的option的文本值
			var define2 = $("#define2 option:selected").text();
			var define12 = $("#define12 option:selected").text();
			var define1 = $("#define1 option:selected").text();
			var define5 = $("#define5 option:selected").text();
			var define11 = $("#define11 option:selected").text();
			var fzdwflag = $("#fzdwflag option:selected").text();
			var zylb = $("#zylb option:selected").text();

			var groupFlag = $("#groupFlag").val();
			var gsbmbmFlag = $("#gsbmbmFlag").val();
			var zycbmFlag = $("#zycbmFlag").val();
			var zylbbmFlag = $("#zylbbmFlag").val();

			//是否是：结转课题
			var isCarry = "0";
			if (define1 == '--请选择--') {
				define1 = ''
			}
			if (define2 == '--请选择--') {
				define2 = ''
			}
			if (define5 == '--请选择--') {
				define5 = ''
			}
			if (define12 == '--请选择--') {
				define12 = ''
			}
			if (define11 == '--请选择--') {
				define11 = ''
			}
			if (zycbmFlag == '--请选择--') {
				zycbmFlag = ''
			}
			if (fzdwflag == '--请选择--') {
				fzdwflag = ''
			}
			if (zylb == '--请选择--') {
				zylb = ''
			}
			if (groupFlag == '--请选择--') {
				groupFlag = ''
			}
			if (ktlx == '结转课题') {
				isCarry = '1'
			}

			var v_date = (new Date()).getTime();

			//渲染
			table.render({
				elem : '#processdef-table',
				url : '/one_level_main/project_fx_table_data?v_date=' + v_date,
				method : "POST",
				where : {
					param : {
						"functionId" : '984b64b13cf54222bf57bd840759fabe', //数据控制标示
						"nd" : $("#nd").val(),
						"ysnd" : $("#ysnd").val(),
						"xmmc" : $("#xmmc").val(),
						"define1" : define1,
						"define11" : define11,
						"define2" : define2,
						"define5" : define5,
						"define12" : define12,
						"isCarry" : isCarry,
						"hth" : $("#hth").val(),
						"zylb" : zylb,
						"ktlx" : $("#ktlx").val(),
						"project_scope" : $("#project_scope").val(),
						"project_property" : $("#project_property").val(),
						"leaderFlag" : $("#leaderFlag").val(),
						"projectId" : $("#projectId").val(),
						"unitName" : $("#unitName").val(),
						"fzdwflag" : fzdwflag,
						"groupFlag" : groupFlag,
						"gsbmbmFlag" : gsbmbmFlag,
						"zycbmFlag" : zycbmFlag,
						"zylbbmFlag" : zylbbmFlag

					}
				},
				limit : 15,
				id : 'processdef-table',
				height : commonDislodgeTable() - 150,
				page : {
					groups : 5,
					limits : [ 15, 30, 45, 60 ],
					layout : [ 'count', 'limit', 'prev', 'page', 'next', 'skip' ], //自定义分页布局
					first : '首页', //不显示首页
					last : '尾页', //不显示尾页
					theme : '#0F9EE0'
				},
				cols : [ [ {
					title : '序号',
					type : 'numbers',
					width : '45'
				}, {
					field : 'hth',
					title : '合同号',
					style : 'cursor: pointer;',
					align : 'center',
					width : '80',
					sort : true
				}, {
					field : 'nd',
					title : '立项年度',
					style : 'cursor: pointer;',
					align : 'center',
					width : '80',
					sort : true
				}, {
					field : 'ysnd',
					title : '预算年度',
					style : 'cursor: pointer;',
					align : 'center',
					width : '80',
					sort : true
				}, {
					field : 'define10',
					title : '专业处',
					style : 'cursor: pointer;',
					align : 'left',
					width : '80',
					sort : true
				}, {
					field : 'xmmc',
					title : '项目名称',
					templet : function(d) {
						return '<span   onclick="view_pro(\'' + d.xmmc + '\',\'' + d.project_property + '\',\'' + d.xmid + '\')" style="color: #1890ff">' + d.xmmc + '</span>'
					},
					style : 'cursor: pointer;',
					align : 'left',
					width : '350',
					sort : true
				}, {
					field : 'jf',
					title : '总额（万元）',
					style : 'cursor: pointer;',
					align : 'center',
					width : '100',
					templet : '#view_taskVersion',
					sort : true
				}, {
					field : 'ysje',
					title : '年度预算（万元）',
					style : 'cursor: pointer;',
					align : 'center',
					width : '130',
					templet : '#view_taskVersion2',
					sort : true
				}, {
					field : 'yszbxje',
					title : '资本性预算',
					style : 'cursor: pointer;',
					align : 'center',
					templet : '#view_taskVersion3',
					width : '100',
					sort : true
				}, {
					field : 'ysfyxje',
					title : '费用性预算',
					style : 'cursor: pointer;',
					align : 'center',
					templet : '#view_taskVersion4',
					width : '100',
					sort : true
				}, {
					field : 'fzdw',
					title : '牵头单位',
					style : 'cursor: pointer;',
					align : 'left',
					width : '150',
					sort : true
				}, {
					field : 'define8',
					title : '参与单位',
					style : 'cursor: pointer;',
					align : 'left',
					width : '150',
					sort : true
				}, {
					field : 'define11',
					title : '经费来源',
					style : 'cursor: pointer;',
					align : 'center',
					width : '100',
					sort : true
				}, {
					field : 'define1',
					title : '资本/费用',
					style : 'cursor: pointer;',
					align : 'center',
					width : '120',
					sort : true
				}, {
					field : 'define12',
					title : '单位性质',
					style : 'cursor: pointer;',
					align : 'left',
					width : '150',
					sort : true
				}, {
					field : 'project_property',
					title : '项目类型',
					style : 'cursor: pointer;',
					align : 'left',
					width : '100',
					sort : true
				}, {
					field : 'zylb',
					title : '专业类别',
					style : 'cursor: pointer;',
					align : 'left',
					width : '130',
					sort : true
				}, {
					field : 'jdh',
					title : '鉴定号',
					style : 'cursor: pointer;',
					align : 'left',
					width : '130',
					sort : true
				}, {
					field : 'cgmc',
					title : '成果名称',
					style : 'cursor: pointer;',
					align : 'left',
					width : '130',
					sort : true
				}, {
					field : 'jdjg',
					title : '鉴定结果',
					style : 'cursor: pointer;',
					align : 'left',
					width : '130',
					sort : true
				}, {
					field : 'psdj',
					title : '奖励等级',
					style : 'cursor: pointer;',
					align : 'left',
					width : '130',
					sort : true
				}, {
					field : 'xkfl',
					title : '奖励学科分类',
					style : 'cursor: pointer;',
					align : 'left',
					width : '130',
					sort : true
				}

				] ],
				done : function(res, curr, count) {
					// 点击行联动选择框--单选
					$('.layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
						var index = parseInt($(this).index() + 1);
						$('tr').removeClass('layui-table-click');
						$(this).addClass('layui-table-click');
						$('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
						$('tr:eq(' + index + ')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
						selectRowData = res.data[index - 1];
					});
					
					merge(res);
				}
			});
			
			function merge(res) {

				var data = res.data;
				var mergeIndex = 0;//定位需要添加合并属性的行数
				var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
				var columsName = [ 'hth', 'nd', 'ysnd', 'zycmc', 'xmmc' ];//需要合并的列名称
				var columsIndex = [ 1, 2, 3, 4, 5 ];//需要合并的列索引值
				
				// hth 合同号
				for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
					var trArr = $(".layui-table-body>.layui-table").find("tr");//所有行
					for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
						var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
						var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列
						var hth = trArr.eq(mergeIndex).find("td").eq("hth");						
						if (data[i][columsName[k]] === data[i - 1][columsName[k]]) { //后一行的值与前一行的值做比较，相同就需要合并
							mark += 1;
							tdPreArr.each(function() {//相同列的第一列增加rowspan属性
								$(this).attr("rowspan", mark);
							});
							tdCurArr.each(function() {//当前行隐藏
								$(this).css("display", "none");
							});
						} else {
							mergeIndex = i;
							mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
						}
					}
					mergeIndex = 0;
					mark = 1;
				}
			}

			//监听排序
			table.on('sort(processdef-table)', function(obj) {
				console.log(this, obj.field, obj.type)
				//return;
				//服务端排序
				table.reload('processdef-table', {
					initSort : obj,
					page : {
						curr : 1
					}, //重新从第一页开始
					where : { //重新请求服务端
						orderKey : obj.field, //排序字段
						orderType : obj.type
					//排序方式
					}
				});
			});

		}

		function view_pro(xmmc, projectProperty, id) {

			layer.open({
				title : '项目进展详情',
				skin : 'layui-layer-lan',
				shadeClose : false,
				type : 2,
				id : "cycle",
				fixed : false,
				//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
				maxmin : true,
				//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
				area : [ '70%', '90%' ],
				content : "/whole-process/science/details?xmid=" + id,
				success : function(layero, index) {
					// var iframe = window['layui-layer-iframe' + index];
					// var iframeH=$(layero).find("iframe");
					//$(iframeH).contents().find(".cycle-img").css("height",$(iframe).height()+"px");
				}
			});

			/* alert(xmid);
			var temUrl="";
			if(xmlbbm=='KYZB')
			{
				temUrl="/whole-process/equipment-science/ini?xmmc="+xmmc;//装备项目
			}else
			{
				if(projectProperty=='重大专项')
				{
					temUrl="/whole-process/major-science/ini?xmmc="+xmmc;
				}
				if(projectProperty=='重点项目')
				{
					temUrl="/whole-process/science/ini?xmmc="+xmmc;
				}
			}
			
			if(temUrl!='')
			{
				
				
				 layer.open({
			         title: projectProperty+"->"+xmmc+'->详情',
			         skin: 'layui-layer-lan',
			         shadeClose: true,
			         type: 2,
			         fixed: false,
			         maxmin: true,
			         area: ['70%', '90%'],
			         content:  temUrl
			     });
			}
			 */

		}
		/**======================================联动=====================================*/
		var define11 = "${define11?default('')}";//单位性质
		var define12 = "${define12?default('')}";//单位性质
		var define2 = "${define2?default('')}";//研究院
		var zycbmFlag = "${zycbmFlag?default('')}";
		var zylbbmFlag = "${zylbbmFlag?default('')}";

		//alert(define11);

		//获取单位性质
		function getDicByParentCode(parentCode, downId) {
			//alert(parentCode+"--"+downId);
			$("#" + downId).empty();
			if (parentCode == null || parentCode == '') {
				parentCode = '-1';
			}
			console.log("级联：\n parentCode=" + parentCode + " downId=" + downId);
			var v_date = (new Date()).getTime();
			if (parentCode != null && parentCode != '') {

				$.ajax({
					url : "/sre-project-basic/getDicListByParentCode?v_date=" + v_date + "&parentCode=" + parentCode,
					type : "post",
					async : false,
					dataType : "json",
					success : function(data) {
						$("#" + downId).append("<option value=''>--请选择--</option>");
						$.each(data, function(i, el) {
							$("#" + downId).append('<option value="'+ el.code +'">' + el.name + '</option>');
							if (define12 == el.name) {
								$("#" + downId).val(el.code);
							}
							if (define2 == el.name) {
								$("#" + downId).val(el.code);
							}
							if (zycbmFlag == el.name) {
								$("#" + downId).val(el.code);
							}
							if (zycbmFlag == el.name) {
								$("#" + downId).val(el.code);
							}

						});
						form.render();
					},
					error : function() {
						alert("发生未知错误 ,请重新操作.");
					}
				});

			}
			var code_temp = $("#" + downId).val();
			//如果ID=单位性质 ,再调用一次，形成第三级
			if (downId == 'define12') {
				getDicByParentCode(code_temp, 'define2');
			}
			if (downId == 'zycbmFlag') {
				getDicByParentCode(code_temp, 'zylbbmFlag');
			}
			form.render();
		}

		function purchase_money(jf) {
			return '<span style="color:red">' + jf + '</span>';
		}

		function purchase_money_jf(jf) {

			if (jf != null) {
				var h_strs = jf.substring(jf.lastIndexOf("."), jf.length);
				if (h_strs == '.0') {
					jf = jf.replace(".0", "");
				}
				return '<span style="color:green">' + jf + '</span>';
			} else {
				return "<span></span>";
			}
		}
	</script>
</body>

</html>
