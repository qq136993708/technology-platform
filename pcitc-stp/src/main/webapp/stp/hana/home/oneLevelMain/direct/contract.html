<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/adminStp.css"  media="all">
    <link rel="stylesheet" href="/layuiadmin/style/mainStp.css"   media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css"    media="all">
    <link rel="stylesheet" href="/layuiadmin/style/second.css"    media="all">
    <style>
        .btn_details{background:url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff no-repeat;}
        .btnMyBgImg:hover{background-size:inherit;background-position: 2px;}
        .searchBox{background:none;}
    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="">
        <div class="searchBox">
            <label class="dateInput">
                <span>月份</span>
                <input type="text" name="year" placeholder="请选择月份" title="月份" value="${year}"  autocomplete="off" class="form-control" id="year">
            </label>
            <!--按钮组-->
            <div class="btnGroup">
                <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg"
                        onclick="search_Event()">查询</button>
            </div>
            <div class="btnGroup" style="float:right">
                <button id="knowledge_table" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue  btnMyBgImg btn_details"
                >详情</button>
            </div>
        </div>

        <div class="layui-row layui-col-space15">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年直属研究院合同签定率
                    </div>
                    <div class="layui-row-main">
                       <div class="text-total">
                            <span>总计:<span class="text-total-blue"    id="contract_chart1_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>已签合同:<span class="text-total-blue" id="contract_chart1_02"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>未签合同:<span class="text-total-blue" id="contract_chart1_03"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                       </div>
                       <div class="layui-row">
                           <div class="layui-col-md6" id="contract_chart1_02_02" style="height:280px;"></div>
                           <div class="layui-col-md6" id="contract_chart1"    style="height:280px;"></div>
                       </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年直属研究院科研课题数量占比
                    </div>
                    <div class="layui-card-body btn-function" >
                         <table id="processdef_table" class="layui-hide" lay-filter="processdef_table"></table>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年科研课题合同签订率
                    </div>
                    <div class="layui-row-main">
                    
                    <div class="text-total">
                            <span>计划签订合同数:<span class="text-total-blue" id="contract_chart4_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>实际签订合同数:<span class="text-total-blue" id="contract_chart4_02"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>签订率:<span class="text-total-blue" id="contract_chart4_03"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                        </div>
                        
                        <div class="main-chart" id="contract_chart4" style="height:280px;width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年直属研究院科研课题数量占比
                        <div class="layui-tool">
                            <button type="button" class="btn btn-tool collapse"></button>
                            <button type="button" class="btn btn-tool remove"></button>
                        </div>
                    </div>
                    <div class="layui-card-body btn-function" >
                        <table id="processdef_table_02" class="layui-hide" lay-filter="processdef_table"></table>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script src="/common/js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
<script type="text/javascript" src="/plugins/echarts/walden.js"></script>	
<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>

<script type="text/javascript">
var table,treeGridCom;
layui.config({
	base: '/layuiadmin/lib/extend/'
}).extend({
	treeGridCom:'treeGridCom'
}).use(['jquery','form','treeGridCom', 'laydate','table','laypage'], function(){
	table = layui.table;
	treeGridCom = layui.treeGridCom;
	 var $ = layui.jquery
      ,form = layui.form
      ,laydate = layui.laydate
	  form.render(null, 'component-form-group');
        laydate.render({
        	 elem: '#year'
         	      ,type: 'year'
        });
        $(".layui-time").html($("#year").val());
        $("#knowledge_table").click(function () {
        	window.open("/reportNew/reportPageStp?name=1673442773d_74f124ab&jsonparam=g0_type_flag,g0_project_scope");
        });
       
        renderTable2();
        renderTable();
});

//圆圈初始化
var labelTop = {
	    normal : {
	        label : {
	            show : true,
	            position : 'center',
	            formatter : '{b}',
	            textStyle: {
	                baseline : 'bottom'
	            }
	        },
	        labelLine : {
	            show : false
	        }
	    }
	};
	var labelFromatter = {
	    normal : {
	        label : {
	            formatter : function (params){
	                return 100 - params.value + '%'
	            },
	            textStyle: {
	                baseline : 'top'
	            }
	        }
	    },
	}
	var radius = [80, 110];
	var option_cicle = {
	    legend: {
	        x : 'center',
	        y : 'center',
	        data:[
	            '已签合同'
	        ]
	    },
	    series : [
	        {
	            type : 'pie',
	            center : ['50%', '45%'],
                silent: true,
                labelLine : {
                    show : false
                },

                color:"#02c2ad",
	            radius : radius,
	            data : [
	                
	            ]
	        }
	    ]
	};
	
	

function initEchart()
{
	
	var v_date=(new Date()).getTime();
	var nd=$('#year').val();
	var ndstr=nd+"年";
	var yAxis= [
        {
            type: 'value',
            name: '数量（个）',
            min: 0,
            max:'dataMax',
            position: 'left',
            axisLabel: {
                formatter: '{value}'
            }
        }
    ];
	
	
	
	//直属研究院合同签定率
    $("#contract_chart1_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
    $("#contract_chart1_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
    $("#contract_chart1_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
    //科研课题合同签订率
    $("#contract_chart4_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
    $("#contract_chart4_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
    $("#contract_chart4_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
    
    
    
	
    $(".layui-time").html($("#year").val());
	var chart1_url="/direct/contract_01?type=1&nd="+nd+"&v_date="+v_date;
	var color=["#43c5ff","#ffa70f"];
	var echart1=load_single_bar_down(chart1_url,"contract_chart1","","",yAxis,color);
	echart1.on('click', function (params) {
		var xName=params.name;
		var legentName=params.seriesName;
		window.open("/reportNew/reportPageStp?name=1673442773d_74f124ab&jsonparam=g0_type_flag,g0_project_scope");
          
    });
	//圆圈
    var url="/direct/contract_01?type=2&nd="+nd+"&v_date="+v_date;
	var echart2=loadCicle(url,"contract_chart1_02_02");
	echart2.on('click', function (params) {
		var xName=params.name;
		var legentName=params.seriesName;
		window.open("/reportNew/reportPageStp?name=1673442773d_74f124ab&jsonparam=g0_type_flag,g0_project_scope");
          
    });
	
	
	 
	var chart4_url="/direct/contract_03?type=1&nd="+nd+"&v_date="+v_date;
    var colorTr=["#17a2b9","#43c5ff","#f9c16d"];
	var echart4=load_mutl_bar_down_r(chart4_url,"contract_chart4","","",yAxis,1,25,colorTr);
	echart4.on('click', function (params) {
		var xName=params.name;
		var legentName=params.seriesName;
		window.open("/reportNew/reportPageStp?name=1673442773d_74f124ab&jsonparam=g0_type_flag,g0_project_scope");
          
    });
	
	
	
}


//初始化图形
initEchart();
//查询
function search_Event()
{
	initEchart();
	renderTable();
	renderTable2();
}



function renderTable()
{  
	
	 var month=$("#year").val();
	 var ptable=treeGridCom.render({
	        id:'processdef_table'
	        ,elem: '#processdef_table'
	        ,url:'/direct/contract_02?nd='+month
	        ,cellMinWidth: 200
	        ,idField:'id'//必須字段
	        ,treeId:'id'//树形id字段名称
	        ,treeUpId:'pId'//树形父id字段名称
	        ,treeShowName:'name'//以树形式显示的字段
	        ,height:'309'
	        ,isFilter:false
	        ,iconOpen:false//是否显示图标【默认显示】
	        ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
	        ,loading: false
	        ,method:'get'
	        ,cols: [[
	            {field:'name',      title:'类型',            style:'cursor: pointer;',align: 'left', width: '25%'},
	            {field:'extend01',  title:'计划签订数（个）',    style:'cursor: pointer;',align: 'right', width: '25%'},
	            {field:'extend02',  title:'实际签订数（个）',    style:'cursor: pointer;',align: 'right', width: '25%'},
	            {field:'extend03',  title:'签订率（%）',       style:'cursor: pointer;',align: 'right', width: '25%',templet:function(d){return d.extend03+"%"}}
	            
	        ]]
	        ,isPage:false
	        ,parseData:function (res) {
	            return res;
	        }
	        ,onClickRow:function (index, o) {
	            console.log(index,o,"单击！");
	        }
	        ,onDblClickRow:function (index, o) {
	            console.log(index,o,"双击");
	        }
	    });
}






//集团重大项目
function renderTable2()
{
	
	  var month=$("#month").val();
	  var tableOne=table.render({
	  elem: '#processdef_table_02',
	  url:'/direct/contract_03?month='+month+"&type=2",
	  method:"GET",
      height:309,
	  where: {param: {"month":$("#month").val()}},
	  limit: 15,
	  id: 'processdef_table_02',
	  
	  cols: [[
	  	   {field:'define2',        title: '类型',    edit:'text', width: '40%',align: 'center'},
	       {field:'zsl',            title:'计划签订数',style:'cursor: pointer;',align: 'right', width: '20%'},
	       {field:'yqhtzj',         title:'实际签订数',style:'cursor: pointer;',align: 'right', width: '20%'},
	       {field:'qdlzj',          title:'签订率(%)',   style:'cursor: pointer;',align: 'right', width: '20%',templet:function(d){return d.qdlzj+"%"}
	       }
	       
	       
	  ]],
	  done: function (res, curr, count) {
	  	layer.closeAll('loading');
	      // 点击行联动选择框--单选
	      $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
	      	var index=parseInt($(this).index()+1);
	          $('tr').removeClass('layui-table-click');
	          $(this).addClass('layui-table-click');
	          $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
	          $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
	          selectRowData=res.data[index-1];
	          window.open("/reportNew/reportPageStp?name=1673442773d_74f124ab&jsonparam=g0_type_flag,g0_project_scope");
	      });
	  }
	});

}




	//圆圈                    
	function setCicle(url,echartsobj,option)
	{
	    var values=[];
	    $.ajax({
	        type:"get",
	        url: url,
	        dataType:"json",
	        timeout : 11000,
	        cache: false,
	        contentType: "application/x-www-form-urlencoded; charset=utf-8",
	        success:function(data,status)
	        {
	            if(data.success==true ||data.success=='true')
	            {
	                echartsobj.hideLoading();
	                var chartList=data.data.dataList;
	                for(var i=0;i<chartList.length;i++)
	                {
                        console.log(chartList[i])
                        if(chartList[i].name=="已签合同"){
                            values.push({
                                value: chartList[i].value,
                                name: "签订率",
                                label:{normal: {formatter:'{b}\n{d}%', position: 'center',
                                        color:"#02c2ad",textStyle : {fontSize : 20}}}
                            });
                        }else {
                            values.push({
                                value: chartList[i].value,
                                name: chartList[i].name,
                                itemStyle:{
                                    normal : {
                                        color: '#cccccc',
                                        label : {
                                            show : false,
                                            position : 'center'
                                        },
                                        labelLine : {
                                            show : false
                                        }
                                    }
                                },
                                label:{show : false},
                                labelLine : {show : false}
                            });
                        }
	                	//alert(chartList[i].name+"="+chartList[i].value);

	                }
	                echartsobj.setOption({
	                    series: [{
	                        data: values
	                    }]
	                });
	            }
	        },
	        error:function()
	        {
	        },
	        complete: function (XMLHttpRequest, status) {
	        }
	    });
	    
	    return echartsobj;
	} 
	
	function loadCicle(url,id)
	{
		
		var echartsobj = echarts.init(document.getElementById(id));
		echartsobj.setOption(option_cicle);
		echartsobj.showLoading();
		echartsobj=setCicle(url,echartsobj,option_cicle);
		return echartsobj;
	}
	
	
</script>

</body>
</html>