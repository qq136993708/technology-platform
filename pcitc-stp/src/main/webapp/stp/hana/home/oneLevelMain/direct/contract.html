<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
<style>
.btn_details {
	background: url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff
		no-repeat;
}

.btnMyBgImg:hover {
	background-size: inherit;
	background-position: 2px;
}

.searchBox {
	background: none;
}
</style>
</head>
<body>
	<div class="layui-fluid">
		<div class="">
			<div class="fluid-top">
				<div class="breadcrumb">
					<a href="/stpHome" target="_parent">首页 > </a>
					<a href="/instituteIndex?url=/home_ld/direct_depart" target="_parent">直属研究院概况 > </a>
					<span>合同签订率</span>
				</div>
				<div class="searchBox">
					<label class="dateInput">
						<span>年份</span>
						<input type="text" name="year" placeholder="请选择年份" title="年份" value="${year}" autocomplete="off" class="form-control" id="year">
						<i class="layui-icon layui-icon-date" style="margin-left: -35px"></i>
					</label>
					<!--按钮组-->
					<!--<div class="btnGroup">
                    <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg"
                            onclick="search_Event()">查询</button>
                </div>-->
					<div class="btnGroup" style="margin-left: 10px">
						<button id="table_detail_id" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue  btnMyBgImg btn_details">详情</button>
					</div>
				</div>
			</div>


			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院课题合同（任务书）签定率
						</div>
						<div class="layui-row-main">
							<div class="text-total">
								<span>
									总计:
									<span class="text-total-blue" id="contract_chart1_01" onclick="nzsyjyktht('')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									已签合同:
									<span class="text-total-blue" id="contract_chart1_02" onclick="nzsyjyktht('已签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									未签合同:
									<span class="text-total-blue" id="contract_chart1_03" onclick="nzsyjyktht('未签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>
							<div class="layui-row">
								<div class="layui-col-md6" id="contract_chart1_02_02" style="height: 280px;"></div>
								<div class="layui-col-md6" id="contract_chart1" style="height: 280px;"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院课题合同（任务书）数量占比
						</div>
						<div class="layui-card-body btn-function">
							<div class="processdef_table">
								<table id="processdef_table" class="layui-hide" lay-filter="processdef_table"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年课题合同（任务书）签订率
						</div>
						<div class="layui-row-main">

							<div class="text-total">
								<span>
									计划签同数:
									<span class="text-total-blue" id="contract_chart4_01" onclick="nkthtrwsqdl('')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									实际签同数:
									<span class="text-total-blue" id="contract_chart4_02" onclick="nkthtrwsqdl('已签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									签订率:
									<span class="text-total-blue" id="contract_chart4_03" onclick="nkthtrwsqdl('已签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>
							<div class="main-chart" id="contract_chart4" style="height: 280px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院课题合同（任务书）数量占比
						</div>
						<div class="layui-card-body btn-function">
							<div id="processdef_tableN">
								<table id="processdef_table_02" class="layui-hide" lay-filter="processdef_table"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
	<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>

	<script type="text/javascript">
		var table, treeGridCom;
		layui.config({
			base : '/layuiadmin/lib/extend/'
		}).extend({
			treeGridCom : 'treeGridCom'
		}).use([ 'jquery', 'form', 'treeGridCom', 'laydate', 'table', 'laypage' ], function() {
			table = layui.table;
			treeGridCom = layui.treeGridCom;
			var $ = layui.jquery, form = layui.form, laydate = layui.laydate
			form.render(null, 'component-form-group');
			laydate.render({
				elem : '#year',
				min : '2018-01-01',
				type : 'year',
				done : function(value, date, endDate) {
					$(".layui-time").html(date.year);
					$("#year").val(date.year);
					search_Event();
				}
			});
			$(".layui-time").html($("#year").val());
			var nd = $("#year").val();
			$("#table_detail_id").click(function() {
				var url = encodeURIComponent("/one_level_main/common_table?nd=" + nd + "&ysnd=" + nd);
				window.open("/instituteIndex?url=" + url);
			});

			renderTable2();
			renderTable();
		});

		//圆圈初始化
		var labelTop = {
			normal : {
				label : {
					show : true,
					position : 'center',
					formatter : '{b}',
					textStyle : {
						baseline : 'bottom'
					}
				},
				labelLine : {
					show : false
				}
			}
		};
		var labelFromatter = {
			normal : {
				label : {
					formatter : function(params) {
						return 100 - params.value + '%'
					},
					textStyle : {
						baseline : 'top'
					}
				}
			},
		}
		var radius = [ 80, 110 ];
		var option_cicle = {
			legend : {
				x : 'center',
				y : 'center',
				data : [ '已签合同' ]
			},
			series : [ {
				type : 'pie',
				center : [ '50%', '45%' ],
				silent : true,
				labelLine : {
					show : false
				},

				color : "#02c2ad",
				radius : radius,
				data : [

				]
			} ]
		};

		var v_date = (new Date()).getTime();
		var nd = $('#year').val();
		function initEchart() {

			var ndstr = nd + "年";
			var yAxis = [ {
				type : 'value',
				name : '数量（个）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			//直属研究院合同签定率
			$("#contract_chart1_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#contract_chart1_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#contract_chart1_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			//科研课题合同签订率
			$("#contract_chart4_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#contract_chart4_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#contract_chart4_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');

			var chart1_url = "/direct/contract_01?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + $('#year').val() + "&v_date=" + v_date;
			var color = [ "#43c5ff", "#ffa70f" ];
			var echart1 = load_single_bar_down(chart1_url, "contract_chart1", "", "", yAxis, color);
			echart1.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;

				var url = encodeURIComponent("/one_level_main/common_table_new?define12=直属研究院&define11=股份公司&qdbz=" + xName + "订&nd=" + nd + "&ysnd=" + nd);
				window.open("/instituteIndex?url=" + url);

			});

			// 直属研究院课题合同（任务书）签定率  ,  饼状圈
			var url = "/direct/contract_01?functionId=984b64b13cf54222bf57bd840759fabe&type=2&nd=" + $('#year').val() + "&v_date=" + v_date;
			var echart2 = loadCicle(url, "contract_chart1_02_02");
			echart2.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				//alert(xName);

			});

			var chart4_url = "/direct/contract_03?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + $('#year').val() + "&v_date=" + v_date;
			var colorTr = [ "#9DD783", "#4FAAEC", "#f9c16d" ];
			var echart4 = load_mutl_bar_down_r(chart4_url, "contract_chart4", "", "", yAxis, 1, 25, colorTr);
			echart4.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				var qdbz = "";
				if (legentName == '实际签订') {
					qdbz = "已签订";
				}

				var url = encodeURIComponent("/one_level_main/common_table_new?define12=直属研究院&define11=股份公司&define2=" + xName + "&qdbz=" + qdbz + "&ysnd=" + $('#year').val() + "&nd=" + nd + "&groupFlag=xmid,define8");
				window.open("/instituteIndex?url=" + url);

			});

		}
		//年直属研究院课题合同
		function nzsyjyktht(qdbz) {
			var url = encodeURIComponent("/one_level_main/common_table_new?define12=直属研究院&define11=股份公司&qdbz=" + qdbz + "&nd=" + $('#year').val() + "&groupFlag=xmid");
			window.open("/instituteIndex?url=" + url);
		}
		//年课题合同任务书签订率
		function nkthtrwsqdl(qdbz) {
			var url = encodeURIComponent("/one_level_main/common_table_new?define12=直属研究院&define11=股份公司&qdbz=" + qdbz + "&nd=" + $('#year').val() + "&groupFlag=xmid,define8");
			window.open("/instituteIndex?url=" + url);
		}

		//初始化图形
		initEchart();
		//查询
		function search_Event() {
			initEchart();
			renderTable();
			renderTable2();
		}

		// 直属研究院课题合同（任务书）数量占比
		function renderTable() {
			var month = $("#year").val();
			var ptable = treeGridCom.render({
				id : 'processdef_table',
				elem : '#processdef_table',
				url : '/direct/contract_02?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + month,
				cellMinWidth : 200,
				idField : 'id',//必須字段
				treeId : 'id',//树形id字段名称
				treeUpId : 'pId',//树形父id字段名称
				treeShowName : 'name',//以树形式显示的字段
				height : '299',
				isFilter : false,
				iconOpen : false,//是否显示图标【默认显示】
				isOpenDefault : true,//节点默认是展开还是折叠【默认展开】
				loading : false,
				method : 'get',
				cols : [ [ {
					field : 'name',
					title : '类型',
					style : 'cursor: pointer;',
					align : 'left',
					width : '25%'
				}, {
					field : 'extend01',
					title : '计划签订数（个）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '25%'
				}, {
					field : 'extend02',
					title : '实际签订数（个）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '25%'
				}, {
					field : 'extend03',
					title : '签订率（%）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '25%',
					templet : function(d) {
						return d.extend03 + "%"
					}
				} ] ],
				isPage : false,
				done : function(res, curr, count) {
					$('.processdef_table .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function(e) {
						var index = parseInt($(this).index() + 1);
						var selectRowData = res.data[index - 1];
						if ($(this).find(".layui-icon").length <= 0) {
							
							var xName = selectRowData.name;
                            if (xName == '油田处') {
								xName = '科技部';
							}
					
							if (xName == '科技部' || xName == '物装部' || xName == '炼油部' || xName == '化工部' || xName == '信息部' || xName == '工程部') {
								var url = encodeURIComponent("/one_level_main/common_table_new?gsbmbmFlag=" + xName + "&define12=直属研究院&define11=股份公司&qdbz=已签订&ysnd=" + $('#year').val() + "&nd=" + $('#year').val() + "&groupFlag=xmid", "合同签订率详情");
								window.open("/instituteIndex?url=" + url);
							} else {
								var url = encodeURIComponent("/one_level_main/common_table_new?zycbmFlag=" + xName + "&define12=直属研究院&define11=股份公司&qdbz=已签订&ysnd=" + $('#year').val() + "&nd=" + $('#year').val() + "&groupFlag=xmid", "合同签订率详情");
								window.open("/instituteIndex?url=" + url);
							}
							
							
						}

					});
				},
				parseData : function(res) {
					return res;
				},
				onClickRow : function(index, o) {
					console.log(index, o, "单击！");
				},
				onDblClickRow : function(index, o) {
					console.log(index, o, "双击");
				}
			});
		}

		//集团重大项目
		function renderTable2() {

			var nd = $('#year').val();
			var tableOne = table.render({
				elem : '#processdef_table_02',
				url : '/direct/contract_03?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&type=2",
				method : "GET",
				height : 299,
				where : {
					param : {
						"nd" : nd
					}
				},
				limit : 15,
				id : 'processdef_table_02',

				cols : [ [ {
					field : 'define2',
					title : '类型',
					edit : 'text',
					width : '40%',
					align : 'center'
				}, {
					field : 'zsl',
					title : '计划签订数',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%'
				}, {
					field : 'yqhtzj',
					title : '实际签订数',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%'
				}, {
					field : 'qdlzj',
					title : '签订率(%)',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%',
					templet : function(d) {
						return d.qdlzj + "%"
					}
				}

				] ],
				done : function(res, curr, count) {
					layer.closeAll('loading');
					// 点击行联动选择框--单选
					$('#processdef_tableN .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
						var index = parseInt($(this).index() + 1);
						$('tr').removeClass('layui-table-click');
						$(this).addClass('layui-table-click');
						$('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
						$('tr:eq(' + index + ')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
						selectRowData = res.data[index - 1];

						var url = encodeURIComponent("/one_level_main/common_table_new?define12=直属研究院&define11=股份公司&define2=" + selectRowData.define2 + "&nd=" + nd + "&ysnd=" + nd + "&groupFlag=xmid,define8");
						window.open("/instituteIndex?url=" + url);
					});
				}
			});

		}

		//圆圈                    
		function setCicle(url, echartsobj, option) {
			var values = [];
			$.ajax({
				type : "get",
				url : url,
				dataType : "json",
				timeout : 11000,
				cache : false,
				contentType : "application/x-www-form-urlencoded; charset=utf-8",
				success : function(data, status) {
					if (data.success == true || data.success == 'true') {
						echartsobj.hideLoading();
						var chartList = data.data.dataList;
						for (var i = 0; i < chartList.length; i++) {
							console.log(chartList[i])
							if (chartList[i].name == "已签") {
								values.push({
									value : chartList[i].value,
									name : "签订率",
									label : {
										normal : {
											formatter : '{b}\n{d}%',
											position : 'center',
											color : "#02c2ad",
											textStyle : {
												fontSize : 20
											}
										}
									}
								});
							} else {
								values.push({
									value : chartList[i].value,
									name : chartList[i].name,
									itemStyle : {
										normal : {
											color : '#cccccc',
											label : {
												show : false,
												position : 'center'
											},
											labelLine : {
												show : false
											}
										}
									},
									label : {
										show : false
									},
									labelLine : {
										show : false
									}
								});
							}
							//alert(chartList[i].name+"="+chartList[i].value);

						}
						echartsobj.setOption({
							series : [ {
								data : values
							} ]
						});
					}
				},
				error : function() {
				},
				complete : function(XMLHttpRequest, status) {
				}
			});

			return echartsobj;
		}

		function loadCicle(url, id) {

			var echartsobj = echarts.init(document.getElementById(id));
			echartsobj.setOption(option_cicle);
			echartsobj.showLoading();
			echartsobj = setCicle(url, echartsobj, option_cicle);
			return echartsobj;
		}
	</script>

</body>
</html>