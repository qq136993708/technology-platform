<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
<style>
.btn_details {
	background: url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff
		no-repeat;
}

.btnMyBgImg:hover {
	background-size: inherit;
	background-position: 2px;
}

.searchBox {
	background: none;
}
</style>
</head>
<body>
	<div class="layui-fluid">
		<div class="">
			<div class="fluid-top">
				<div class="breadcrumb">
					<a href="/stpHome" target="_parent">首页 > </a>
					<span>科研合同</span>
				</div>
				<div class="searchBox">
					<label class="dateInput">
						<span>年份</span>
						<input type="text" name="nd" placeholder="请选择年份" title="年份" value="${nd}" autocomplete="off" class="form-control" id="nd">
					</label>
					<div class="btnGroup">
						<button id="table_detail_id" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue  btnMyBgImg btn_details">详情</button>
					</div>
				</div>
			</div>
			<div class="layui-row layui-col-space15">
				<div class="layui-col-md8">
					<div class="layui-col-md5">
						<div class="layui-card">
							<div class="layui-card-header">
								<span class="layui-time"></span>
								年新开课题合同（任务书）签订率
							</div>
							<div class="layui-row-main">
								<div class="text-total">
									<span>
										计划签订数:
										<span class="text-total-blue" id="vdirect_contract_01_01" onclick="contract_chart_oneLevel('')" style="cursor: pointer">
											<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
										</span>
									</span>
									<span>
										实际签订数:
										<span class="text-total-blue" id="vdirect_contract_01_02" onclick="contract_chart_oneLevel('已签订')" style="cursor: pointer">
											<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
										</span>
									</span>
									<span>
										签订率:
										<span class="text-total-blue" id="vdirect_contract_01_03" onclick="contract_chart_oneLevel('已签订')" style="cursor: pointer">
											<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
										</span>
									</span>
								</div>
								<div class="main-chart" id="direct_contract_01" style="height: 250px; width: 100%;"></div>
							</div>
						</div>
					</div>
					<div class="layui-col-md5" style="padding-left: 15px;">
						<div class="layui-card">
							<div class="layui-card-header">
								<span class="layui-time"></span>
								年新开课题合同（任务书）签订率
							</div>
							<div class="layui-row-main">
								<div class="main-chart" id="direct_contract_01_01" style="height: 270px; width: 100%;"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="layui-col-md4">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年新开课题合同（任务书）签订率清单
						</div>
						<div class="layui-row-main" style="height: 270px;">
							<table id="processdef_table_02" class="layui-hide" lay-filter="processdef_table"></table>
						</div>
					</div>
				</div>
			</div>



			<div class="layui-row layui-col-space15">
				<div class="layui-col-md8">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年新开课题合同（任务书）签订率
						</div>
						<div class="layui-row-main">

							<div class="main-chart" id="direct_contract_04" style="height: 270px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md4">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年新开课题合同（任务书）签订率清单
							<div class="layui-tool">
								<!--  <button type="button" class="btn btn-tool collapse"></button>
                            <button type="button" class="btn btn-tool remove"></button> -->
							</div>
						</div>
						<div class="layui-row-main" id="processdef_table_div">
							<table id="processdef_table" class="layui-hide" lay-filter="processdef_table"></table>
						</div>
					</div>
				</div>
			</div>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md12">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院开课题合同（任务书）签订率
						</div>
						<div class="layui-row-main">
							<div class="text-total">
								<span>
									已签订数:
									<span class="text-total-blue" id="direct_contract_chart_01" onclick="contract_chart1('已签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									未签订数:
									<span class="text-total-blue" id="direct_contract_chart_02" onclick="contract_chart1('未签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									签订率:
									<span class="text-total-blue" id="direct_contract_chart_03" onclick="contract_chart1('已签订')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>
							<div class="main-chart" id="direct_contract_chart" style="height: 270px; width: 100%;"></div>
						</div>
					</div>
				</div>
			</div>




		</div>
	</div>

	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
	<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>
	<script type="text/javascript" src="/stp/hana/home/oneLevelMain/investment.js"></script>

	<script type="text/javascript">
		var table, treeGridCom;
		layui.config({
			base : '/layuiadmin/lib/extend/'
		}).extend({
			treeGridCom : 'treeGridCom'
		}).use([ 'jquery', 'form', 'treeGridCom', 'laydate', 'table', 'laypage' ], function() {
			table = layui.table;
			treeGridCom = layui.treeGridCom;
			var $ = layui.jquery, form = layui.form, laydate = layui.laydate
			form.render(null, 'component-form-group');
			laydate.render({
				elem : '#nd',
				min : '2016-10-14',
				type : 'year',
				done : function(value, date, endDate) {
					$(".layui-time").html(date.year);
					$("#nd").val(date.year);
					search_Event();
				}
			});
			$(".layui-time").html($("#nd").val());
			var nd = $("#nd").val();
			$("#table_detail_id").click(function() {
				var url = encodeURIComponent("/one_level_main/common_table?nd=" + nd + "&groupFlag=xmid");
				window.open("/instituteIndex?url=" + url);
			});
			renderTable2();
			renderTable();
		});
		var v_date = (new Date()).getTime();
		var nd = $('#nd').val();
		function initEchart() {

			var ndstr = nd + "年";
			var yAxis = [ {
				type : 'value',
				name : '数量（个）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var yAxis2 = [ {
				type : 'value',
				name : '数量（个）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			}, {
				type : 'value',
				show : true,
				name : '百分比',
				position : 'right',
				axisLabel : {
					formatter : '{value}%'
				},
				splitLine : {
					show : false
				},//去除网格线

			} ];

			//表盘
			setGauge("direct_contract_01");
			setGauge_count();
			var chart_01_01 = "/one_level_main/contract_01_01?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date + "";
			var colorOne = [ "#2F9CFF", "#36CBCB", "#FAD337" ]
			var echartchart_01_01 = load_mutl_bar_down(chart_01_01, "direct_contract_01_01", "", "", yAxis2, 30, colorOne);
			echartchart_01_01.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				//alert("xName="+xName+" legentName="+legentName);
				var qdbz = "";
				if (legentName == '计划签订数') {
					qdbz = "";
				}
				if (legentName == '实际签订数') {
					qdbz = "已签订";
				}
				var url = encodeURIComponent("/one_level_main/common_table?define1=" + xName + "&qdbz=" + qdbz + "&nd=" + nd + "&groupFlag=xmid");
				window.open("/instituteIndex?url=" + url);

			});

			//
			var chart2_url = "/one_level_main/contract_02?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date + "";
			var echart2 = load_single_line(chart2_url, "direct_contract_04", "", "", yAxis);
			echart2.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				// alert(xName+"------"+projectId);
				var define12 = "";
				var define11 = "";
				if (xName == '资产公司' || xName == '集团公司') {
					define11 = xName;

				} else {
					define12 = xName;
				}
				if (xName == '休斯顿') {
					define12 = '休斯顿研发中心';
				}
				if (xName == '中东') {
					define12 = '中东研发中心';
				}

				var url = encodeURIComponent("/one_level_main/common_table?nd=" + nd + "&define12=" + define12 + "&define11=" + define11 + "&groupFlag=xmid,define8");
				window.open("/instituteIndex?url=" + url);
			});

			//直属研究院签订率
			$("#direct_contract_chart_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#direct_contract_chart_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#direct_contract_chart_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');

			var chart6_url = "/one_level_main/contract_03?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date + "";
			var color2 = [ "#f3655b", "#8ab3cf", "#f19049" ];
			var echart6 = load_mutl_bar_down(chart6_url, "direct_contract_chart", "", "", yAxis, 30, color2);
			echart6.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				var url = encodeURIComponent("/one_level_main/common_table?define2=" + xName + "&nd=" + nd + "&groupFlag=xmid,define8");
				window.open("/instituteIndex?url=" + url);
			});

		}

		function contract_chart1(qdbz) {
			// define12, 后台查询时用的是define2、define3（type_flag）
			var url = encodeURIComponent("/one_level_main/common_table?define12=直属研究院&qdbz=" + qdbz + "&nd=" + nd + "&groupFlag=xmid,define8");
			window.open("/instituteIndex?url=" + url);
		}

		function contract_chart_oneLevel(qdbz) {
			var url = encodeURIComponent("/one_level_main/common_table?qdbz=" + qdbz + "&nd=" + nd + "&groupFlag=xmid");
			window.open("/instituteIndex?url=" + url);
		}

		//初始化图形
		initEchart();
		//查询
		function search_Event() {
			initEchart();
			renderTable();
			renderTable2();
		}

		function setGauge_count() {

			$("#vdirect_contract_01_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#vdirect_contract_01_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#vdirect_contract_01_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');

			var nd = $('#nd').val();
			var series = [];
			$.ajax({
				type : "get",
				url : "/one_level_main/contract_01?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "",
				timeout : 9000,
				dataType : "json",
				cache : false,
				contentType : "application/x-www-form-urlencoded; charset=utf-8",
				success : function(data, status) {
					if (data.success == true || data.success == 'true') {
						$("#vdirect_contract_01_01").html(data.data.zsl + "个");

						if (typeof (data.data.yqht) == "undefined") {
							$("#vdirect_contract_01_02").html("0个");
						} else {
							$("#vdirect_contract_01_02").html(data.data.yqht + "个");
						}

						$("#vdirect_contract_01_03").html(data.data.qdl + "%");
					}
				},
				error : function() {
				},
				complete : function(XMLHttpRequest, status) {
				}
			});

		}

		function setGauge(id) {
			var myChart2 = echarts.init(document.getElementById(id));
			var options = {
				title : {
					text : '',
					x : 'center',
					y : '10px',
					textStyle : {
						fontSize : 15,
						fontWeight : 'normal',
						color : '#000000'
					},
					subtextStyle : {
						color : '#7B7B7B'
					},
					subtext : ''
				},
				tooltip : {
					formatter : "{a} <br/>{b} : {c}%"
				},
				toolbox : {
					feature : {
						restore : {},
						saveAsImage : {}
					}
				},
				series : [ {

					data : []
				} ]
			};
			var nd = $('#nd').val();
			ajax_getGauge("/one_level_main/contract_01?functionId=984b64b13cf54222bf57bd840759fabe&type=2&nd=" + nd + "", myChart2, options);
		}

		function ajax_getGauge(url, echartsobj, options) {
			var series = [];
			$.ajax({
				type : "get",
				url : url,
				timeout : 9000,
				dataType : "json",
				cache : false,
				contentType : "application/x-www-form-urlencoded; charset=utf-8",
				success : function(data, status) {
					if (data.success == true || data.success == 'true') {
						echartsobj.hideLoading();
						var data = data.data;
						echartsobj.setOption({
							series : [ {
								data : [ {
									value : data.value,
									name : '完成率'
								} ],
								name : '签订率',
								type : 'gauge',
								radius : "110%",
								center : [ '50%', '61%' ],
								detail : {
									formatter : '{value}%'
								},
							} ]
						});
					}
				},
				error : function() {
					layer.msg('图表加载失败');
				},
				complete : function(XMLHttpRequest, status) {
					if (status == 'timeout') {
						layer.msg('超时');
					}
				}
			});

		}

		function renderTable() {
			var nd = $("#nd").val();
			var v_date = (new Date()).getTime();
			table.render({
				elem : '#processdef_table' //表格容器
				,
				url : '/one_level_main/contract_05?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&v_date=" + v_date + '',
				id : 'processdef_table',
				limit : 15 //每页默认显示的数量
				,
				height : 270,
				cols : [ [ {
					field : 'define3',
					title : '类别',
					style : 'cursor: pointer;',
					align : 'left'
				}, {
					field : 'define2',
					title : '机构',
					style : 'cursor: pointer;',
					align : 'left',
					width : '20%'
				}, {
					field : 'zsl',
					title : '计划签订数（个）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%'
				}, {
					field : 'yqhtzj',
					title : '实际签订数（个）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%'
				}, {
					field : 'qdlzj',
					title : '签订率（%）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%',
					templet : function(d) {
						return d.qdlzj + "%"
					}
				} ] ],
				done : function(res, curr, count) {

					merge(res);

					$('.layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
						var index = parseInt($(this).index() + 1);
						$('tr').removeClass('layui-table-click');
						$(this).addClass('layui-table-click');
						$('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
						$('tr:eq(' + index + ')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
						selectRowData = res.data[index - 1];
						var url = encodeURIComponent("/one_level_main/common_table?define12=" + selectRowData.define3 + "&nd=" + nd + "&define2=" + selectRowData.define2 + "&groupFlag=xmid,define8");
						window.open("/instituteIndex?url=" + url);
					});

				}
			});
			function merge(res) {

				var data = res.data;
				var mergeIndex = 0;//定位需要添加合并属性的行数
				var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
				var columsName = [ 'define3' ];//需要合并的列名称
				var columsIndex = [ 0 ];//需要合并的列索引值

				for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
					var trArr = $("#processdef_table_div .layui-table-body .layui-table").find("tr");//所有行
					for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
						var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
						var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列

						if (data[i][columsName[k]] === data[i - 1][columsName[k]]) { //后一行的值与前一行的值做比较，相同就需要合并
							mark += 1;
							tdPreArr.each(function() {//相同列的第一列增加rowspan属性
								$(this).attr("rowspan", mark);
							});
							tdCurArr.each(function() {//当前行隐藏
								$(this).css("display", "none");
							});
						} else {
							mergeIndex = i;
							mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
						}
					}
					mergeIndex = 0;
					mark = 1;
				}
			}
			/* var month=$("#nd").val();
			var ptable=treeGridCom.render({
			       id:'processdef_table'
			       ,elem: '#processdef_table'
			       ,url:'/one_level_main/contract_05?nd='+month
			       ,cellMinWidth: 200
			       ,idField:'id'//必須字段
			       ,treeId:'id'//树形id字段名称
			       ,treeUpId:'pId'//树形父id字段名称
			       ,treeShowName:'name'//以树形式显示的字段
			       ,height:'309'
			       ,isFilter:false
			       ,iconOpen:false//是否显示图标【默认显示】
			       ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
			       ,loading: false
			       ,method:'get'
			       ,cols: [[
			           {field:'name',  title:'类型',  style:'cursor: pointer;',align: 'left', width: '25%'},
			           {field:'extend01',  title:'计划签订数（个）',   style:'cursor: pointer;',align: 'left', width: '25%'},
			           {field:'extend02',  title:'实际签订数（个）',   style:'cursor: pointer;',align: 'left', width: '25%'},
			           {field:'extend03',  title:'签订率（%）',       style:'cursor: pointer;',align: 'left', width: '25%',templet:function(d){return d.extend03+"%"}}
			           
			       ]]
			       ,isPage:false
			       ,parseData:function (res) {
			           return res;
			       }
			       ,onClickRow:function (index, o) {
			           console.log(index,o,"单击！");
			       }
			       ,onDblClickRow:function (index, o) {
			           console.log(index,o,"双击");
			       }
			   }); */
		}
		//重大项目
		function renderTable2() {
			var nd = $('#nd').val();
			var tableOne = table.render({
				elem : '#processdef_table_02',
				url : '/one_level_main/contract_01_01?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + '&type=2',
				method : "GET",
				where : {
					param : {
						"month" : $("#month").val()
					}
				},
				limit : 15,
				id : 'processdef_table_02',
				cols : [ [ {
					field : 'define1',
					title : '类型',
					edit : 'text'
				}, {
					field : 'jhqds',
					title : '计划签订数',
					style : 'cursor: pointer;',
					align : 'right'
				}, {
					field : 'sjqds',
					title : '实际签订数',
					style : 'cursor: pointer;',
					align : 'right'
				}, {
					field : 'htqdl',
					title : '签订率(%)',
					style : 'cursor: pointer;',
					align : 'right',
					templet : function(d) {
						return d.htqdl + "%"
					}
				} ] ],
				done : function(res, curr, count) {
					layer.closeAll('loading');
					// 点击行联动选择框--单选
					$('.layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
						var index = parseInt($(this).index() + 1);
						$('tr').removeClass('layui-table-click');
						$(this).addClass('layui-table-click');
						$('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
						$('tr:eq(' + index + ')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
						selectRowData = res.data[index - 1];
						var url = encodeURIComponent("/one_level_main/common_table?define1=" + selectRowData.define1 + "&nd=" + nd + "&groupFlag=xmid");
						window.open("/instituteIndex?url=" + url);

					});
				}
			});
		}
	</script>

</body>
</html>