<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/adminStp.css"  media="all">
    <link rel="stylesheet" href="/layuiadmin/style/mainStp.css"   media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css"    media="all">
    <link rel="stylesheet" href="/layuiadmin/style/second.css"    media="all">
    <style>
        .btn_details{background:url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff no-repeat;}
        .btnMyBgImg:hover{background-size:inherit;background-position: 2px;}
        .searchBox{background:none;}
    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="">
        <div class="searchBox">
            <label class="dateInput">
                <span>年份</span>
                <input type="text" name="year" placeholder="请选择年份" title="年份" value="${year}"  autocomplete="off" class="form-control" id="year">
            </label>
            <!--按钮组-->
            <!--<div class="btnGroup">
                <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg"
                        onclick="search_Event()">查询</button>
            </div>-->
            <div class="btnGroup">
                <button id="knowledge_table" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue  btnMyBgImg btn_details"
                >详情</button>
            </div>
            <div class="breadcrumb">
                <a href="/index" target="_parent">首页 > </a><span>科研合同</span>
            </div>
        </div>

        <div class="layui-row layui-col-space15" >
            <div class="layui-col-md8">
                <div class="layui-col-md5">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            <span class="layui-time"></span>年科研合同签订率
                        </div>
                        <div class="layui-row-main">
                            <div class="text-total">
                                <span>计划合同签:<span class="text-total-blue"      id="vdirect_contract_01_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                                <span>实际合同签订:<span class="text-total-blue"     id="vdirect_contract_01_02"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                                <span>签订率:<span class="text-total-blue"         id="vdirect_contract_01_03"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            </div>
                            <div class="main-chart" id="direct_contract_01" style="height:250px;width: 100%;"></div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md5" style="padding-left: 15px;">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            <span class="layui-time"></span>年费用性/资本性科研合同签订率
                        </div>
                        <div class="layui-row-main">
                            <div class="main-chart" id="direct_contract_01_01" style="height:270px;width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年科研合同签订率清单
                    </div>
                    <div class="layui-row-main" style="height:270px;">
                        <table id="processdef_table_02" class="layui-hide" lay-filter="processdef_table"></table>
                    </div>
                </div>
            </div>
        </div>



        <div class="layui-row layui-col-space15">
            <div class="layui-col-md8">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年科研合同签订率
                    </div>
                    <div class="layui-row-main">

                        <div class="main-chart" id="direct_contract_04" style="height:270px;width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年科研合同签订率清单
                        <div class="layui-tool">
                           <!--  <button type="button" class="btn btn-tool collapse"></button>
                            <button type="button" class="btn btn-tool remove"></button> -->
                        </div>
                    </div>
                    <div class="layui-card-body btn-function" style="height:280px;" id="processdef_table_div">
                        <table id="processdef_table" class="layui-hide" lay-filter="processdef_table"></table>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年直属研究院科研合同签订率
                    </div>
                    <div class="layui-row-main">
                        <div class="text-total">
                            <span>已签订合同数:<span class="text-total-blue"    id="direct_contract_chart_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>未签订合同数:<span class="text-total-blue"    id="direct_contract_chart_02"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>签订率:<span class="text-total-blue"         id="direct_contract_chart_03"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                        </div>
                        <div class="main-chart" id="direct_contract_chart" style="height:270px;width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>




    </div>
</div>

<script src="/common/js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>
<script type="text/javascript" src="/stp/hana/home/oneLevelMain/investment.js"></script>

<script type="text/javascript">
    var table,treeGridCom;
    layui.config({
        base: '/layuiadmin/lib/extend/'
    }).extend({
        treeGridCom:'treeGridCom'
    }).use(['jquery','form','treeGridCom', 'laydate','table','laypage'], function(){
        table = layui.table;
        treeGridCom = layui.treeGridCom;
        var $ = layui.jquery
            ,form = layui.form
            ,laydate = layui.laydate
        form.render(null, 'component-form-group');
        laydate.render({
        	      elem: '#year'
         	      ,type: 'year'
            ,done: function(value, date, endDate){
                $(".layui-time").html(date.year);
                search_Event();
            }
        });
        $(".layui-time").html($("#year").val());
        $("#knowledge_table").click(function () {
            window.open("/reportNew/reportPageStp?name=1673442773d_74f124ab&jsonparam=g0_type_flag,g0_project_scope");
        });

        renderTable2();
        renderTable();

    });

    function initEchart()
    {

        var v_date=(new Date()).getTime();
        var nd=$('#year').val();
        var ndstr=nd+"年";
        var yAxis= [
            {
                type: 'value',
                name: '数量（个）',
               /* min: 0,
                max:'dataMax',*/
                position: 'left',
                axisLabel: {
                    formatter: '{value}'
                }
            }
        ];
        
        
        
        
        
       var  yAxis2= [
            {
            	 type: 'value',
                 name: '数量（个）',
                 //min: 0,
                 //interval: 10,
                 //max:'dataMax',
                 position: 'left',
                 axisLabel: {
                     formatter: '{value}'
                 }
            },
            {
                type: 'value',
                show: true ,
                name: '百分比',
                //min: 0,
                //max: 100,
                //interval: 20,
                position: 'right',
                axisLabel: {
                    formatter: '{value}%'
                }
            }
        ];
        
        //表盘
        setGauge("direct_contract_01");
        setGauge_count();
        var chart_01_01="/one_level_main/contract_01_01?type=1&nd="+nd+"&v_date="+v_date;
        var echartchart_01_01=load_mutl_bar_down(chart_01_01,"direct_contract_01_01","","",yAxis2,30,"");
        echartchart_01_01.on('click', function (params) {
            var xName=params.name;
            var legentName=params.seriesName;
           // alert("xName="+xName+" legentName="+legentName);
            var projectId="";
            if(legentName=='已签合同')
            {
            	 projectId="1";
            }
            if(legentName=='未签合同')
            {
            	 projectId="2";
            }
            if(legentName=='计划合同')
            {
            	 projectId="0";
            }
            window.open("/one_level_main/common_table?define1="+xName+"&projectId="+projectId);

        });

        
        //
        var chart2_url="/one_level_main/contract_02?type=1&nd="+nd+"&v_date="+v_date;
        var echart2=load_single_line(chart2_url,"direct_contract_04","","",yAxis);
        echart2.on('click', function (params) {
            var xName=params.name;
            var legentName=params.seriesName;
           // alert("xName="+xName+" legentName="+legentName);
            var projectId="";
            if(legentName=='已签合同')
            {
            	 projectId="1";
            }
            if(legentName=='未签合同')
            {
            	 projectId="2";
            }
            if(legentName=='计划合同')
            {
            	 projectId="0";
            }
            window.open("/one_level_main/common_table?define3="+xName+"&projectId="+projectId);
        });


        //直属研究院合同签订率
        $("#direct_contract_chart_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
        $("#direct_contract_chart_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
        $("#direct_contract_chart_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
        
        
        var chart6_url="/one_level_main/contract_03?type=1&nd="+nd+"&v_date="+v_date;
        var color2=["#f3655b","#8ab3cf","#f19049"];
        var echart6=load_mutl_bar_down(chart6_url,"direct_contract_chart","","",yAxis,30,color2);
        echart6.on('click', function (params) {
            var xName=params.name;
            var legentName=params.seriesName;
            //alert("xName="+xName+" legentName="+legentName);
            var projectId="";
            if(legentName=='已签合同')
            {
            	 projectId="1";
            }
            if(legentName=='未签合同')
            {
            	 projectId="2";
            }
            if(legentName=='计划合同')
            {
            	 projectId="0";
            }
            window.open("/one_level_main/common_table?define2="+xName+"&projectId="+projectId);
        });


    }

    //初始化图形
    initEchart();
    //查询
    function search_Event()
    {
        initEchart();
        renderTable();
        renderTable2();
    }





    function setGauge_count()
    {
    	
    	$("#vdirect_contract_01_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
        $("#vdirect_contract_01_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
        $("#vdirect_contract_01_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
        
        
        var series=[];
        $.ajax({
            type:"get",
            url: "/one_level_main/contract_01?type=1",
            timeout : 9000,
            dataType:"json",
            cache: false,
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success:function(data,status)
            {
                if(data.success==true ||data.success=='true')
                {
                    $("#vdirect_contract_01_01").html(data.data.zsl+"个");
                    $("#vdirect_contract_01_02").html(data.data.yqht+"个");
                    $("#vdirect_contract_01_03").html(data.data.qdl+"%");
                }
            },
            error:function()
            {
            },
            complete: function (XMLHttpRequest, status) {
            }
        });

    }
    

    function setGauge(id)
    {
        var myChart2 = echarts.init(document.getElementById(id));
        var options = {
            title: {
                text: '',
                x:'center',
                y: '10px',
                textStyle: {
                    fontSize: 15,
                    fontWeight: 'normal',
                    color: '#000000'
                },
                subtextStyle: {
                    color: '#7B7B7B'
                },
                subtext:''
            },
            tooltip : {
                formatter: "{a} <br/>{b} : {c}%"
            },
            toolbox: {
                feature: {
                    restore: {},
                    saveAsImage: {}
                }
            },
            series: [
                {

                    data: []
                }
            ]
        };

        ajax_getGauge("/one_level_main/contract_01?type=2", myChart2, options);
    }

    function ajax_getGauge(url, echartsobj, options)
    {
        var series=[];
        $.ajax({
            type:"get",
            url: url,
            timeout : 9000,
            dataType:"json",
            cache: false,
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success:function(data,status)
            {
                if(data.success==true ||data.success=='true')
                {
                    echartsobj.hideLoading();
                    var data=data.data;
                    echartsobj.setOption({
                        series: [{
                            data: [{value: data.value, name: '完成率'}],
                            name: '签订率',
                            type: 'gauge',
                            radius: "110%",
                            center: ['50%', '61%'],
                            detail: {formatter:'{value}%'},
                        }]
                    });
                }
            },
            error:function()
            {
                layer.msg('图表加载失败');
            },
            complete: function (XMLHttpRequest, status) {
                if(status == 'timeout'){
                    layer.msg('超时');
                }
            }
        });

    }


    function renderTable()
    {  
    	var year=$("#year").val();
    	var v_date=(new Date()).getTime();
    	table.render({
            elem: '#processdef_table' //表格容器
            , url:'/one_level_main/contract_05?nd='+year+"&v_date="+v_date
            , id: 'processdef_table'
            , limit: 15 //每页默认显示的数量
            , height: 270
            , cols: [[
            	{field:'define3',  title:'类别',           style:'cursor: pointer;',align: 'left'},
            	{field:'define2',  title:'机构',           style:'cursor: pointer;',align: 'left', width: '20%'},
 	            {field:'zsl',      title:'计划签订数（个）',   style:'cursor: pointer;',align: 'right', width: '20%'},
 	            {field:'yqhtzj',   title:'实际签订数（个）',   style:'cursor: pointer;',align: 'right', width: '20%'},
 	            {field:'qdlzj',    title:'签订率（%）',      style:'cursor: pointer;',align: 'right', width: '20%',templet:function(d){return d.qdlzj+"%"}}
            ]],
            done: function(res, curr, count){
               
               
            	 merge(res);
               
               $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
                   var index=parseInt($(this).index()+1);
                   $('tr').removeClass('layui-table-click');
                   $(this).addClass('layui-table-click');
                   $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
                   $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
                   selectRowData=res.data[index-1];
                  // alert(selectRowData.define3+"=="+selectRowData.define2);
                   window.open("/one_level_main/common_table?define3="+selectRowData.define3+"&projectId=0&define2="+selectRowData.define2);
                   
               });
               
              
               
            }
        });
    	function merge(res) {

            var data = res.data;
            var mergeIndex = 0;//定位需要添加合并属性的行数
            var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
            var columsName = ['define3'];//需要合并的列名称
            var columsIndex = [0];//需要合并的列索引值

            for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
                var trArr = $("#processdef_table_div .layui-table-body .layui-table").find("tr");//所有行
                for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
                    var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
                    var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列

                    if (data[i][columsName[k]] === data[i-1][columsName[k]]) { //后一行的值与前一行的值做比较，相同就需要合并
                        mark += 1;
                        tdPreArr.each(function () {//相同列的第一列增加rowspan属性
                            $(this).attr("rowspan", mark);
                        });
                        tdCurArr.each(function () {//当前行隐藏
                            $(this).css("display", "none");
                        });
                    }else {
                        mergeIndex = i;
                        mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
                    }
                }
                mergeIndex = 0;
                mark = 1;
            }
        }
    	 /* var month=$("#year").val();
    	 var ptable=treeGridCom.render({
    	        id:'processdef_table'
    	        ,elem: '#processdef_table'
    	        ,url:'/one_level_main/contract_05?nd='+month
    	        ,cellMinWidth: 200
    	        ,idField:'id'//必須字段
    	        ,treeId:'id'//树形id字段名称
    	        ,treeUpId:'pId'//树形父id字段名称
    	        ,treeShowName:'name'//以树形式显示的字段
    	        ,height:'309'
    	        ,isFilter:false
    	        ,iconOpen:false//是否显示图标【默认显示】
    	        ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
    	        ,loading: false
    	        ,method:'get'
    	        ,cols: [[
    	            {field:'name',  title:'类型',  style:'cursor: pointer;',align: 'left', width: '25%'},
    	            {field:'extend01',  title:'计划签订数（个）',   style:'cursor: pointer;',align: 'left', width: '25%'},
    	            {field:'extend02',  title:'实际签订数（个）',   style:'cursor: pointer;',align: 'left', width: '25%'},
    	            {field:'extend03',  title:'签订率（%）',       style:'cursor: pointer;',align: 'left', width: '25%',templet:function(d){return d.extend03+"%"}}
    	            
    	        ]]
    	        ,isPage:false
    	        ,parseData:function (res) {
    	            return res;
    	        }
    	        ,onClickRow:function (index, o) {
    	            console.log(index,o,"单击！");
    	        }
    	        ,onDblClickRow:function (index, o) {
    	            console.log(index,o,"双击");
    	        }
    	    }); */
    }





    //重大项目
    function renderTable2()
    {

        var nd=$('#year').val();
        var tableOne=table.render({
            elem: '#processdef_table_02',
            url:'/one_level_main/contract_01_01?nd='+nd+"&type=2",
            method:"GET",
            where: {param: {"month":$("#month").val()}},
            limit: 15,
            id: 'processdef_table_02',
            cols: [[
                {field:'define1',        title: '合同类型',    edit:'text'},
                {field:'jhqds',            title:'计划签订数',style:'cursor: pointer;',align: 'right'},
                {field:'sjqds',         title:'实际签订数',style:'cursor: pointer;',align: 'right'},
                {field:'htqdl',          title:'签订率(%)',   style:'cursor: pointer;',align: 'right',templet:function(d){return d.htqdl+"%"}
                }
            ]],
            done: function (res, curr, count) {
                layer.closeAll('loading');
                // 点击行联动选择框--单选
                $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
                    var index=parseInt($(this).index()+1);
                    $('tr').removeClass('layui-table-click');
                    $(this).addClass('layui-table-click');
                    $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
                    $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
                    selectRowData=res.data[index-1];
                    window.open("/one_level_main/common_table?define1="+selectRowData.define1+"&projectId=0");
                    
                });
            }
        });

    }



</script>

</body>
</html>