<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
<style>
.btn_details {
	background: url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff
		no-repeat;
}

.btnMyBgImg:hover {
	background-size: inherit;
	background-position: 2px;
}

.searchBox {
	background: none;
}

.layui-row-main td:nth-child(2) .layui-table-cell {
	color: red;
}

.layui-row-main td:nth-child(4) .layui-table-cell {
	color: green;
}

.layui-row-main td:nth-child(6) .layui-table-cell {
	color: orange;
}

.layui-row-mainN td .layui-table-cell {
	color: #666666 !important;
}

.layui-row-mainN td:nth-child(3) .layui-table-cell, .layui-row-mainN td:nth-child(6) .layui-table-cell
	{
	color: red !important;
}

.layui-row-mainN td:nth-child(4) .layui-table-cell, .layui-row-mainN td:nth-child(8) .layui-table-cell span
	{
	color: green !important;
}

.sign th .layui-table-cell {
	height: 62px;
	line-height: 24px;
	padding: 10px;
	box-sizing: border-box;
	overflow: visible;
	text-overflow: unset;
	white-space: normal;
}

.sign th:nth-child(1) .layui-table-cell {
	line-height: 46px;
}

html {
	background-color: white
}

.dateInput {
	font-size: 12px;
}

.layui-btn {
	height: 30px;
	line-height: 30px;
	padding: 0 15px;
}

.layuiadmin-card-header-auto i.layuiadmin-button-btn {
	font-size: 14px;
}

.layui-laydate-hint {
	display: none;
}

.layui-table td, .layui-table th {
	text-align: center;
}

.tdW {
	font-weight: bold !important;
}

.tdR {
	color: red;
}

.layui-table td.tdW0 {
	text-align: left !important;
}

.layui-table td.tdW3 {
	text-align: left !important;
	text-indent: 2em;
}

.layui-table td.tdW5 {
	text-align: left !important;
	text-indent: 4em;
}
.layui-table th.tdW {
	font-size: 13px;
}
</style>
</head>
<body>
	<div class="layui-fluid">
		<div class="">
			<div class="fluid-top">
				<div class="breadcrumb">
					<a href="/stpHome" target="_parent">首页 > </a>
					<span>科研预算</span>
				</div>
				<div class="searchBox">
					<label class="dateInput">
						<span>年份</span>
						<input type="text" name="nd" readonly="readonly" style="cursor: pointer" placeholder="请选择年份" title="年份" value="${nd}" autocomplete="off" class="form-control" id="nd">
					</label>
					<div class="btnGroup">
						<button id="knowledge_table" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue  btnMyBgImg btn_details">明细</button>
					</div>
				</div>
			</div>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md12">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							科研预算执行率（万元）
						</div>
						<table class="layui-table" id="budgetTable">
							<thead>
								<tr>
									<th lay-data="{align : 'center'}" class="tdW">序号</th>
									<th lay-data="{align : 'center',width : '100'}" class="tdW">类别</th>
									<th lay-data="{align : 'center',width : '500'}" class="tdW" colspan="3">科研经费预算</th>
									<th lay-data="{align : 'center',width : '300'}" class="tdW" colspan="3">资本性预算</th>
								</tr>
							</thead>

						</table>
					</div>
				</div>
			</div>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md12">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							专业处科研预算
						</div>
						<div class="layui-row-main layui-row-mainN">
							<table id="zycysTable" class="layui-table" lay-filter="zycysTable">
								<thead>
									<tr>
										<th lay-data="{field:'zycmc', width:'13%'}" rowspan="2">专业处名称</th>
										<th lay-data="{align:'center'}" colspan="3">预算总计（万元）</th>
										<th lay-data="{align:'center'}" colspan="2" id='xkInfo'></th>
										<th lay-data="{align:'center'}" colspan="2" id='jzInfo'></th>
									</tr>
									<tr>
										<th lay-data="{field:'ysje', width:'13%',align:'right'}"></th>
										<th lay-data="{field:'ysxkje', width:'13%',align:'right'}">其中：可新签</th>
										<th lay-data="{field:'ysjzje', width:'13%',align:'right'}">其中：结转</th>

										<th lay-data="{field:'xkMoney', width:'13%',align:'right'}">新签金额</th>
										<th lay-data="{width:'11%',align:'right',templet : '#xkMoneyRate'}">新签预算完成比例</th>

										<th lay-data="{field:'jzMoney', width:'13%',align:'right'}">实际结转金额</th>
										<th lay-data="{width:'11%',align:'right',templet : '#jzMoneyRate'}">占结转预算比例</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院月度合同签订情况
						</div>
						<div class="layui-row-main">
							<div class="main-chart" id="investment_smal_chart2" style="height: 300px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">

					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院月度合同签订情况
						</div>
						<div class="layui-row-main sign">
							<table id="myTable2" class="layui-table" lay-filter="myTable2">
								<thead>
									<th lay-data="{field:'yearMonth', width:'15%',align:'center'}">月份</th>
									<th lay-data="{field:'fyxXqBudget',     width:'17%',align:'right',style:'color: #f67d06'}">新签费用性<br>预算(万元)
									</th>
									<th lay-data="{field:'zbxBudget',     width:'17%',align:'right',style:'color: #f67d06'}">资本性<br>预算(万元)
									</th>
									<th lay-data="{field:'ysfyxje',     width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.ysfyxje) }}</div>'}">费用性<br>签订金额(万元)
									</th>
									<th lay-data="{field:'yszbxje',     width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.yszbxje) }}</div>'}">资本性<br>签订金额(万元)
									</th>
									<th lay-data="{field:'hanaMoney', width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.hanaMoney) }}</div>'}">当月<br>拨款金额(万元)
									</th>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院合同签订情况
						</div>


						<div class="layui-row-main">
							<div class="main-chart" id="investment_smal_chart1" style="height: 300px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">

					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院合同签订情况
						</div>
						<div class="layui-row-main sign">
							<table id="myTable" class="layui-table" lay-filter="myTable">
								<thead>
									<tr>
										<th lay-data="{field:'define2',   width:'15%',align:'center'}">研究院</th>
										<th lay-data="{field:'fyxXqBudget',     width:'17%',align:'right'}">新签费用性预算(万元)</th>
										<th lay-data="{field:'zbxBudget',     width:'17%',align:'right'}">资本性预算(万元)</th>
										<th lay-data="{field:'ysfyxje',     width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.ysfyxje) }}</div>'}">新签费用性金额(万元)</th>
										<th lay-data="{field:'yszbxje',     width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.yszbxje) }}</div>'}">新签资本性金额(万元)</th>
										<th lay-data="{field:'hanaMoney', width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.hanaMoney) }}</div>'}">已拨款总金额(万元)</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_chart.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
	<script type="text/javascript" src="/stp/hana/common/hana_common.js"></script>
	<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>
	<script type="text/javascript" src="/stp/hana/home/oneLevelMain/investment.js"></script>

	<script id="xkMoneyRate" type="text/html"> {{moneyRate(d.ysxkje, d.xkMoney)}} </script>
	<script id="jzMoneyRate" type="text/html"> {{moneyRate(d.ysjzje, d.jzMoney)}} </script>
	<script type="text/javascript">
		var table;
		layui.config({
			base : '/layuiadmin/'
		}).extend({
			index : 'lib/index' //主入口模块
		}).use([ 'index', 'jquery', 'form', 'laydate', 'table', 'laypage' ], function() {
			$ = layui.jquery, table = layui.table, form = layui.form, laydate = layui.laydate
			form.render(null, 'component-form-group');
			laydate.render({
				elem : '#nd',
				min : '2018-01-01',
				type : 'year',
				done : function(value, date, endDate) {
					$(".layui-time").html(date.year);
					$("#nd").val(date.year);
					search_Event();
				}
			});
			$(".layui-time").html($("#nd").val());

			//监听行单击事件
			table.on('row(myTable)', function(obj) {
				console.log(obj.tr) //得到当前行元素对象
				console.log(obj.data) //得到当前行数据
				selectRowData = obj.data;
				var nd = $("#nd").val();
			});

			//监听行单击事件
			table.on('row(myTable2)', function(obj) {
				selectRowData = obj.data;
				var nd = $("#nd").val();
			});

			myTable();
			myTable2();

			table.on('row(zycysTable)', function(obj) {
				selectRowData = obj.data;
				var xName = selectRowData.zycmc;
				var nd = $('#nd').val();

				var qdbz = '已签订';

				if (xName == '油田处') {
					xName = '科技部';
				}
				if (xName.indexOf('炼油事业部') > -1) {
					xName = '炼油部';
				}
				if (xName.indexOf('化工事业部') > -1) {
					xName = '化工部';
				}
				if (xName.indexOf('合计') > -1) {
					xName = '';
				}
				if (xName == '科技部' || xName == '物装部' || xName == '炼油部' || xName == '化工部' || xName == '信息部' || xName == '工程部') {
					parent.layui.index.openTabsPage("/one_level_main/count_table_new?gsbmbmFlag=" + xName + "&ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8", "科研预算详情");
				} else if (xName == '专项' || xName == '机动') {

				} else if (xName == '') {
					parent.layui.index.openTabsPage("/one_level_main/count_table_new?ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8", "科研预算详情");
				} else {
					parent.layui.index.openTabsPage("/one_level_main/count_table_new?zycbmFlag=" + xName + "&ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8", "科研预算详情");
				}

			});

			kyysTableNew();
			zycysTable();

		});

		// 科研预算，老表格形式，暂时作废
		function kyysTable() {

			var nd = $("#nd").val();
			var v_date = (new Date()).getTime();
			var url = '/one_level_main/investment_01_01?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&v_date=" + v_date;
			table.init('kyysTable', {
				url : url,
				where : {}
			});

		}

		function kyysTableNew() {

			var nd = $("#nd").val();
			var v_date = (new Date()).getTime();
			var thisUrl = '/small_leader/budget/info?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&v_date=" + v_date;
			//动态填充预算表格
			$.ajax({
				type : "POST",
				url : thisUrl,
				dataType : "json",
				timeout : 11000,
				cache : false,
				headers : {
					'Content-Type' : 'application/json'
				},
				success : function(data, status) {
					var list = data.data;
					$("#budgetTable tbody").remove();
					for (var i = 0; i < list.length; i++) {
						console.info(list[i]);
						if (parseFloat(list[i].fyxXqRate).toFixed(2) < 50) {
							var htmlO = "<span class='tdR'>" + parseFloat(list[i].fyxXqRate).toFixed(2) + "%</span>"
						} else {
							var htmlO = "<span>" + parseFloat(list[i].fyxXqRate).toFixed(2) + "%</span>"
						}
						if (parseFloat(list[i].zbxRate).toFixed(2) < 50) {
							var htmlT = "<span class='tdR'>" + parseFloat(list[i].zbxRate).toFixed(2) + "%</span>"
						} else {
							var htmlT = "<span>" + parseFloat(list[i].zbxRate).toFixed(2) + "%</span>"
						}
						if (parseFloat(list[i].fyxRate).toFixed(2) < 50) {
							var htmlS = "<span class='tdR'>" + parseFloat(list[i].fyxRate).toFixed(2) + "%</span>"
						} else {
							var htmlS = "<span>" + parseFloat(list[i].fyxRate).toFixed(2) + "%</span>"
						}
						var html = '<tbody m_id="'+list[i].showFlag+'"><tr>' + '<td lay-data="{align : \'center\'}" rowspan="5" class="tdW add">' + list[i].showOrder + ' </td>' + '<td lay-data="{align : \'center\',width : \'100\'}" rowspan="5" class="tdW tdW0">' + list[i].show_ali + '预算执行情况</td>'
								+ '<td lay-data="{align : \'center\',width : \'500\'}" colspan="3">' + list[i].fyxBudget + '</td>' + '<td lay-data="{align : \'center\',width : \'300\'}" colspan="2">' + list[i].zbxBudget + '</td>' + '</tr>' + '<tr>'
								+ '<td lay-data="{align : \'center\',width : \'350\'}" colspan="2" class="tdW">其中:新签预算</td>' + '<td lay-data="{align : \'center\',width : \'150\'}" class="tdW">其中：结转预算</td>' + '<td lay-data="{align : \'center\',width : \'200\'}" class="tdW">实际新签（科研装备+课题资本性支出）</td>'
								+ '<td lay-data="{align : \'center\',width : \'100\'}" class="tdW">执行率</td>' + '</tr>' + '<tr>' + '<td lay-data="{align : \'center\',width : \'350\'}" colspan="2">' + list[i].fyxXqBudget + '</td>' + '<td lay-data="{align : \'center\',width : \'150\'}">'
								+ list[i].fyxJzBudget + '</td>' + '<td lay-data="{align : \'center\',width : \'200\'}">' + list[i].zbxXqMoney + '</td>' + '<td lay-data="{align : \'center\',width : \'100\'}" >' + htmlT + '</td>' + '</tr>' + '<tr>'
								+ '<td lay-data="{align : \'center\',width : \'170\'}" class="tdW">实际新签</td>' + '<td lay-data="{align : \'center\',width : \'180\'}" class="tdW">新签执行率</td>' + '<td lay-data="{align : \'center\',width : \'150\'}" class="tdW">结转+新签总执行率</td>'
								+ '<td lay-data="{align : \'center\',width : \'200\'}"></td>' + '<td lay-data="{align : \'center\',width : \'100\'}"></td>' + '</tr>' + '<tr>' + '<td lay-data="{align : \'center\',width : \'170\'}">' + list[i].fyxXqMoney + '</td>'
								+ '<td lay-data="{align : \'center\',width : \'180\'}">' + htmlO + '</td>' + '<td lay-data="{align : \'center\',width : \'150\'}">' + htmlS + '</td>' + '<td lay-data="{align : \'center\',width : \'200\'}"></td>'
								+ '<td lay-data="{align : \'center\',width : \'100\'}"></td>' + '</tr></tbody>';
						$("#budgetTable ").append(html);
						if (i > 0) {
							if (list[i].showFlag + "-1" == list[i + 1].showFlag) {
								$("#budgetTable tbody").eq(i).find(".add").append("<img src='/layuiadmin/layui/images/icon_add.png' />")
							}
						}
						if (list[i].levelFlag > 1) {
							$("#budgetTable tbody").eq(i).hide()
						}
						$("#budgetTable tbody .add img").off().on("click", function() {
							var m_id = $(this).parents("tbody").attr("m_id");
							var mArrL = m_id.split("-").length + 1;
							if ($(this).attr("src").indexOf("icon_add") != -1) {
								$(this).attr("src", "/layuiadmin/layui/images/icon_minus.png");
								$("#budgetTable tbody").each(function(j, val) {
									var mId = $(this).attr("m_id");
									if (mId.substr(0, m_id.length) == m_id && mId.split("-").length == mArrL) {
										$("#budgetTable tbody").eq(j).show();
										$("#budgetTable tbody").eq(j).find(".tdW0").addClass("tdW" + m_id.length)
									}
								});
							} else {
								$(this).attr("src", "/layuiadmin/layui/images/icon_add.png");
								$("#budgetTable tbody").each(function(j, val) {
									var mId = $(this).attr("m_id");
									if (mId.substr(0, m_id.length) == m_id && mId.split("-").length == mArrL) {
										if ($("#budgetTable tbody").eq(j).find(".add img").length > 0) {
											$("#budgetTable tbody").each(function(k, val) {
												var mIdC = $("#budgetTable tbody").eq(k).attr("m_id");
												if (mIdC.substr(0, $("#budgetTable tbody").eq(j).attr("m_id").length) == $("#budgetTable tbody").eq(j).attr("m_id") && mIdC.split("-").length == $("#budgetTable tbody").eq(j).attr("m_id").split("-").length + 1) {
													$("#budgetTable tbody").eq(k).hide();
												}
											});
										}
										$("#budgetTable tbody").eq(j).hide()
									}
								});
							}
						});
					}
				},
				error : function() {
				}
			});

		}

		// 专业处预算情况
		function zycysTable() {

			var nd = $("#nd").val();
			$("#xkInfo").html($("#nd").val() + "年新签情况（万元）");
			$("#jzInfo").html($("#nd").val() + "年结转情况（万元）");
			var v_date = (new Date()).getTime();
			var url = '/one_level_main/investment_03?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&xmlbbm=fkyzb&v_date=" + v_date;
			table.init('zycysTable', {
				url : url,
				where : {}
			});

		}

		function moneyRate(ysxkje, xkMoney) {
			if (ysxkje == 0 || xkMoney == 0) {
				return '<span style="color:red">--</span>';
			} else {
				return '<span style="color:red">' + (xkMoney * 100 / ysxkje).toFixed(2) + '%</span>';
			}
		}

		function initEchart() {

			var v_date = (new Date()).getTime();
			var nd = $('#nd').val();
			var ndstr = nd + "年";
			var yAxis = [ {
				type : 'value',
				name : '数量（个）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var yAxis2 = [ {
				type : 'value',
				name : '金额（万元）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var chart1_url = "/small_leader/investment_data?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date + "&typeFlag=研究院&xmlbbm=fkyzb";
			var colorOne = [ "#ea886d", "#9799ec", "#5181E6", "#70b1ab", "#87d359" ];
			var echart1 = load_mutl_bar(chart1_url, "investment_smal_chart1", "", "", yAxis2, 10, colorOne, false);
			echart1.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;

			});

			//直属研究院科研课题数量分布
			var yAxis3 = [ {
				type : 'value',
				name : '金额（万元）',
				min : 0,
				max : 'dataMax',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var chart2_url = "/small_leader/investment_data_02?functionId=984b64b13cf54222bf57bd840759fabe&nd=" + nd + "&v_date=" + v_date + "&type=1";
			var colorLine = [ "#ea886d", "#5181E6", "#9799ec" ]
			var echart2 = load_mony_line_down(chart2_url, "investment_smal_chart2", "", "", yAxis3, colorLine);
			echart2.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;

			});
		}

		//初始化图形
		initEchart();
		//查询
		function search_Event() {
			initEchart();
			myTable();
			myTable2();
			kyysTableNew();
			zycysTable();
		}

		function myTable() {
			var v_date = (new Date()).getTime();
			var nd = $('#nd').val();
			var chart1_url = "/small_leader/investment_data?functionId=984b64b13cf54222bf57bd840759fabe&type=2&nd=" + nd + "&v_date=" + v_date + "&typeFlag=研究院&xmlbbm=fkyzb";
			table.init('myTable', {
				url : chart1_url,
				height : "299px",
				where : {}
			});
		}

		function myTable2() {
			var v_date = (new Date()).getTime();
			var nd = $('#nd').val();
			var chart1_url = "/small_leader/investment_data_02?functionId=984b64b13cf54222bf57bd840759fabe&type=2&nd=" + nd + "&v_date=" + v_date;
			table.init('myTable2', {
				url : chart1_url,
				height : "299px",
				where : {}
			});
		}
	</script>
</body>
</html>