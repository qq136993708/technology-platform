<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
    <style>
        .btn_details{background:url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff no-repeat;}
        .btnMyBgImg:hover{background-size:inherit;background-position: 2px;}
        .searchBox{background:none;}
    </style>
</head>
<body>
<div class="layui-fluid">
    <input type="hidden" name="companyCode"  value="${companyCode}"   id="companyCode">

    <div class="">
        <div class="searchBox">
            <label class="dateInput">
                <span>年份</span>
                <input type="text" name="year" placeholder="请选择年份" title="年份" value="${year}"  autocomplete="off" class="form-control" id="year">
            </label>

            <!-- <div class="layui-input-inline">
                <select name="companyCode" id="companyCode"  >
                    <#list companyCodeList as vo>
                    <#if vo.g0GSJC == '全部'>
                    <option value="${vo.g0GSDM}"  selected="selected">${vo.g0GSJC}</option>
                </#if>
                <#if vo.g0GSJC != '全部'>
                <option value="${vo.g0GSDM}">${vo.g0GSJC}</option>
                    </#if>
                </#list>
                </select>
            </div> -->
            <!--按钮组-->
            <div class="btnGroup">
                <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" onclick="search_Event()">查询</button>
            </div>
        </div>


        <div class="layui-row layui-col-space15">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年石化集团十条龙科技攻关项目
                    </div>
                    <div class="layui-row-main">
                        <div class="layui-row">
                            <div class="text-total">
                                <span>总数:<span class="text-total-blue" id="dragon1_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            </div>
                            <div class="layui-col-md6" id="dragon1"    style="height:280px;width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <!--<span class="layui-time"></span>-->石化集团十条龙项目
                    </div>
                    <div class="layui-card-body btn-function" >
                        <div class="text-total">
                            <span>总数:<span class="text-total-blue" id="dragon2_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                        </div>
                        <div class="layui-col-md6" id="dragon2"    style="height:280px;width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>


        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-time"></span>年石化集团直属研究院课题分布情况
                    </div>
                    <div class="layui-row-main">
                        <div class="text-total">
                            <span>总数:<span class="text-total-blue" id="dragon3_01"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>十条龙项目数:<span class="text-total-blue" id="dragon3_02"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                            <span>重大项目数:<span class="text-total-blue" id="dragon3_03"><img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt=""></span></span>
                        </div>

                        <div class="main-chart" id="dragon3" style="height:280px;width: 100%;"></div>
                    </div>
                </div>
            </div>
            <!--<div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">
                        十条龙年度工作报告
                    </div>
                    <div class="layui-row-main">
                        <div class="main-chart">
                            <ul>
                                <li>
                                    <span>2016</span>
                                    <span>工作报告</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>-->
        </div>
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <!--<span class="layui-time"></span>-->石化集团十条龙项目
                    </div>
                    <div class="layui-row-main">

                        <table id="processdef_table_2" lay-filter="tableEvent"></table>
                    </div>
                </div>
                <div class="layui-card">
                    <div class="layui-card-header">
                        <!--<span class="layui-time"></span>-->石化集团重大项目
                    </div>
                    <div class="layui-row-main">
                        <table id="processdef_table"  lay-filter="tableEvent1"></table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="/common/js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_chart.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>

<script type="text/javascript">

    var tableOne=null,tableTwo=null,selectRowData;
    layui.config({
        base: '/layuiadmin/lib/extend/'
    }).extend({
        treeGridCom:'treeGridCom'
    }).use(['jquery','table','form', 'laydate','layer'], function(){
        var $=layui.jquery;
        table = layui.table;
        layer=layui.layer;
        laydate = layui.laydate;
        form = layui.form;
        var year=$("#year").val();
        $(".layui-time").html(year);
        $(".layui-time1").html(year-1);
        form.render(null, 'component-form-group');
        laydate.render({
            elem: '#year'
            ,format: 'yyyy'
        });
        renderTable();
        renderStlTable();

    });

    function initEchart()
    {

        var nd=$("#year").val();
        $(".layui-time").html(nd);
        $(".layui-time1").html(nd-1);
        var companyCode=$("#companyCode").val();
        var v_date=(new Date()).getTime();
        var month=$('#year').val();
        var yAxis= [
            {
                type: 'value',
                name: '数量',
                min: 0,
                position: 'left',
                axisLabel: {
                    formatter: '{value}'
                }
            }
        ];


        var chart1_url="/one_level_main/dragon_01?type=2&nd="+nd+"&v_date="+v_date;
        var echart1=loadPie_02(chart1_url,"dragon1","","",function(data){


            var total_count = 0;
            $.each(data.data.dataList,function(index,dt){
                total_count += dt.value;
            });
            $("#dragon1_01").html(total_count+"个");

        });



        var chart2_url="/one_level_main/dragon_02?nd="+nd+"&v_date="+v_date;
        var colorNew=["#54b6e9","#70b1aa","#87d359"];
        var echart1=load_single_bar(chart2_url,"dragon2","","",yAxis,colorNew,65,"",function(data){
            var total_count = 0;
            $.each(data.data.seriesDataList,function(index,dt){
                total_count += dt;
            });
            $("#dragon2_01").html(total_count+"个");
        });



        var chart7_url="/one_level_main/dragon_03?nd="+year+"&v_date="+v_date+"&companyCode="+companyCode;
        //var color=["#70b1ab","#87d359"];
        var echart7=load_mutl_bar_down(chart7_url,"dragon3","","",yAxis,20);
        echart7.on('click', function (params){
            var xName=params.name;
            var legentName=params.seriesName;
            window.open("/reportNew/reportPageStp?name=167305d0060_d4723a52");
        });

    }

    //初始化图形
    initEchart();
    //查询
    function search_Event()
    {
        initEchart();
        renderTable();
        renderStlTable();
    }

    //集团重大项目
    function renderStlTable()
    {
        var month=$("#year").val();
        var companyCode=$("#companyCode").val();
        var tableOne=table.render({
            elem: '#processdef_table_2',
            url:'/one_level_main/getStlTable?nd='+month+"&companyCode="+companyCode+"&type=重点专项",
            method:"GET",
            where: {param: {"nd":$("#month").val(),"companyCode":$("#companyCode").val()}},
            limit: 100,
            id: 'processdef_table_2',
            height: commonDislodgeTable(),
            cols: [[
                {field:'nd',             title: '年度',style:'cursor: pointer;',align: 'center', width: '5%'},
                {field:'showIndex',      title:'项目编号',style:'cursor: pointer;',align: 'center', width: '5%'},
                {field:'xmmc',           title:'项目名称',style:'cursor: pointer;',align: 'left', width: '20%'},
                {field:'zzdw',           title:'组长单位',style:'cursor: pointer;',align: 'left', width: '15%'},
                {field:'zydw',  		 title:'组员单位',style:'cursor: pointer;',align: 'left', width: '15%'},
                {field:'xzdw',           title:'协作单位',style:'cursor: pointer;',align: 'left'},
                {field:'status',         title:'项目状态',style:'cursor: pointer;',align: 'center'},
                {field:'zycmc',          title:'入龙原因',style:'cursor: pointer;',align: 'left'},
                {field:'xmlbmc',         title:'文档查询',style:'cursor: pointer;',align: 'center', width: '15%',
                	 templet: function(d){
                         return "<a href='#'><img alt='第一次小组会议' src='/common/images/meeting_1.png'></a>&nbsp;&nbsp;&nbsp;&nbsp;"+
                         "<a href='#'><img alt='第二次小组会议' src='/common/images/meeting_2.png'></a>&nbsp;&nbsp;&nbsp;&nbsp;"+
                         "<a href='#'><img alt='会议纪要' src='/common/images/meeting_remark.png'></a>&nbsp;&nbsp;&nbsp;&nbsp;"+
                         "<a href='#'><img alt='工作总结' src='/common/images/work_rs.png'></a>";
                     }
                }
            ]],
            done: function(res, curr, count){
                merge(res);
            }
        });
        function merge(res) {

            var data = res.data;
            var mergeIndex = 0;//定位需要添加合并属性的行数
            var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
            var columsName = ['nd','showIndex','xmmc','zzdw','status'];//需要合并的列名称
            var columsIndex = [0,1,2,3,6];//需要合并的列索引值

            for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
                var trArr = $(".layui-table-body>.layui-table").find("tr");//所有行
                for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
                    var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
                    var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列

                    if (data[i][columsName[k]] === data[i-1][columsName[k]]) { //后一行的值与前一行的值做比较，相同就需要合并
                        mark += 1;
                        tdPreArr.each(function () {//相同列的第一列增加rowspan属性
                            $(this).attr("rowspan", mark);
                        });
                        tdCurArr.each(function () {//当前行隐藏
                            $(this).css("display", "none");
                        });
                    }else {
                        mergeIndex = i;
                        mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
                    }
                }
                mergeIndex = 0;
                mark = 1;
            }
        }
    }
    //集团重大项目
    function renderTable()
    {
        var month=$("#year").val();
        var companyCode=$("#companyCode").val();
        var tableOne=table.render({
            elem: '#processdef_table',
            url:'/one_level_main/getZdstlTable?month='+month+"&companyCode="+companyCode+"&type=重点专项",
            method:"GET",
            where: {param: {"month":$("#month").val(),"companyCode":$("#companyCode").val()}},
            limit: 100,
            id: 'processdef_table',
            height: commonDislodgeTable(),
            cols: [[
                {title:'序号', type:'numbers', width: '5%'},
                {field:'hth',            title: '课题号',edit:'text', width: '8%'},
                {field:'xmmc',           title:'课题名',style:'cursor: pointer;',align: 'left', width: '22%'},
                {field:'jf',             title:'经费（亿）',style:'cursor: pointer;',align: 'right', width: '6%'},
                {field:'fzdw',           title:'负责单位',style:'cursor: pointer;',align: 'left', width: '12%'},
                {field:'project_scope',  title:'课题性质',style:'cursor: pointer;',align: 'center'},
                {field:'zylb',           title:'专业类别',style:'cursor: pointer;',align: 'left', width: '12%'},
                {field:'fzrxm',          title:'负责人',style:'cursor: pointer;',align: 'left'},
                {field:'zycmc',          title:'专业处',style:'cursor: pointer;',align: 'center'},
                {field:'xmlbmc',         title:'课题类别',style:'cursor: pointer;',align: 'center'},
                {field:'define1',        title:'资本/费用',style:'cursor: pointer;',align: 'center'},
                {field:'fwdx',           title:'集团/股份/资产',style:'cursor: pointer;',align: 'center', width: '8%'}
            ]]
        });
    }
</script>
</body>
</html>