<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
<style>
.btn_details {
	background: url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff
		no-repeat;
}

.btnMyBgImg:hover {
	background-size: inherit;
	background-position: 2px;
}

.searchBox {
	background: none;
}
</style>
</head>
<body>
	<div class="layui-fluid">
		<input type="hidden" name="companyCode" value="${companyCode}" id="companyCode">

		<div class="">
			<div class="fluid-top">
				<div class="breadcrumb">
					<a href="/stpHome" target="_parent">首页 > </a>
					<span>重大项目及十条龙科技攻关</span>
				</div>
				<div class="searchBox">
					<label class="dateInput">
						<span>年份</span>
						<input type="text" name="year" placeholder="请选择年份" title="年份" value="${year}" autocomplete="off" class="form-control" id="year">
					</label>
				</div>
			</div>



			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年十条龙科技攻关项目
						</div>
						<div class="layui-row-main">
							<div class="layui-row">
								<div class="text-total">
									<span>
										总数:
										<span class="text-total-blue" id="dragon1_01">
											<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
										</span>
									</span>
								</div>
								<div class="layui-col-md6" id="dragon1" style="height: 275px; width: 100%;"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年十条龙科技攻关项目
						</div>
						<div class="layui-card-body btn-function">
							<div class="text-total">
								<span>
									总数:
									<span class="text-total-blue" id="dragon2_01">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>
							<div class="layui-col-md6" id="dragon2" style="height: 270px; width: 100%;"></div>
						</div>
					</div>
				</div>
			</div>


			<div class="layui-row layui-col-space15">
				<div class="layui-col-md5">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院十条龙科技攻关及重大项目项目分布
						</div>
						<div class="layui-row-main">
							<div class="text-total">
								<span>
									总数:
									<span class="text-total-blue" id="dragon3_01">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									十条龙项目数:
									<span class="text-total-blue" id="dragon3_02">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									重大项目数:
									<span class="text-total-blue" id="dragon3_03">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>

							<div class="main-chart" id="dragon3" style="height: 275px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header" title="">十条龙科技攻关项目领导小组汇报材料</div>
						<div class="layui-row-main work-report-main">
							<p></p>
							<div class="work-report">
								<ul class="work-one" id="report">

								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-row layui-col-space15">
				<div class="layui-col-md12">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年十条龙科技攻关项目
						</div>
						<div class="layui-row-main tableRowspan">

							<table id="processdef_table_2" lay-filter="tableEvent"></table>
						</div>
					</div>
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年重大项目
						</div>
						<div class="layui-row-main">
							<table id="processdef_table" lay-filter="tableEvent1"></table>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_chart.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
	<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>

	<script type="text/javascript">
		var tableOne = null, tableTwo = null, selectRowData, publicMethods;
		layui.config({
			base : '/layuiadmin/lib/extend/'
		}).extend({
			treeGridCom : 'treeGridCom'
		}).use([ 'jquery', 'table', 'form', 'laydate', 'layer', 'publicMethods' ], function() {
			publicMethods = layui.publicMethods;
			var $ = layui.jquery;
			table = layui.table;
			layer = layui.layer;
			laydate = layui.laydate;
			form = layui.form;
			var year = $("#year").val();
			$(".layui-time").html(year);
			$(".layui-time1").html(year - 1);
			laydate.render({
				elem : '#year',
				min : '2018-01-01',
				type : 'year',
				done : function(value, date, endDate) {
					$(".layui-time").html(date.year);
					$("#year").val(date.year);
					search_Event();
				}
			});
			renderTable();
			renderStlTable();
			$("#year").val(${year});
			//初始化图形
			initEchart();
			/*汇报资料*/
            var dateYear=parseInt((new Date()).getFullYear());
            var htmlYear='';
            for(var i=0;i<8;i++){
                htmlYear+='<li><a href="javascript:export_doc('+(dateYear-i)+');" download="w3logo"><span>'+(dateYear-i)+'</span><span>汇报材料</span></a></li>'
			}
			$("#report").append(htmlYear);
		});

		function initEchart() {

			var nd = $("#year").val();
			$(".layui-time").html(nd);
			$(".layui-time1").html(nd - 1);
			var companyCode = $("#companyCode").val();
			var v_date = (new Date()).getTime();
			var month = $('#year').val();
			var yAxis = [ {
				type : 'value',
				name : '数量（个）',
				min : 0,
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];
			$("#dragon1_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#dragon2_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#dragon3_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#dragon3_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#dragon3_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');

			var chart1_url = "/one_level_main/dragon_01?type=2&nd=" + nd + "&v_date=" + v_date;
			var echart1 = loadPie_02(chart1_url, "dragon1", "", "", function(data) {
				var total_count = 0;
				$.each(data.data.dataList, function(index, dt) {
					total_count += dt.value;
				});
				$("#dragon1_01").html(total_count + "个");
			});

			echart1.off();
			echart1.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				window.open("/instituteIndex?url=/one_level_main/ten_dragon_table?xmfl=" + encodeURIComponent(xName) + "&nd=" + nd);
			});

			var chart2_url = "/one_level_main/dragon_02?nd=" + nd + "&v_date=" + v_date;
			var colorNew = [ "#54b6e9", "#70b1aa", "#87d359" ];
			var echart2 = load_single_bar(chart2_url, "dragon2", "", "", yAxis, colorNew, 65, "", function(data) {
				var total_count = 0;
				$.each(data.data.seriesDataList, function(index, dt) {
					total_count += dt;
				});
				$("#dragon2_01").html(total_count + "个");
			});
			echart2.off();
			echart2.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				window.open("/instituteIndex?url=/one_level_main/ten_dragon_table?xmzt=" + encodeURIComponent(xName) + "&nd=" + nd);
			});

			var chart7_url = "/one_level_main/dragon_03?nd=" + nd + "&v_date=" + v_date + "&companyCode=" + companyCode;
			var color=["#F7D453","#9899EC"];//url,id,title,subtext,yAxis,width,color,callback
			var echart7 = load_mutl_bar_down(chart7_url, "dragon3", "", "", yAxis, 20, color, function(data) {
				publicMethods.ajaxPost("/one_level_main/dragon_03_total", {
					"nd" : nd
				}, function(dt) {
					var total = 0;
					var zhongda = parseInt($("#dragon3_03").html());
					$.each(dt, function(index, d) {
						total += d.sl;
					});
					$("#dragon3_01").html((total + zhongda) + "个");
					$("#dragon3_02").html(total + "个");
				});

			});
			echart7.off();
			echart7.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				window.open("/instituteIndex?url=/one_level_main/ten_dragon_table?yjy=" + encodeURIComponent(xName) + "&nd=" + nd);
			});

		}

		//查询
		function search_Event() {
			initEchart();
			renderTable();
			renderStlTable();
		}

		//十条龙项目
		function renderStlTable() {
			var nd = $("#year").val();
			var companyCode = $("#companyCode").val();
			var tableOne = table.render({
				elem : '#processdef_table_2',
				url : '/one_level_main/getStlTable?nd=' + nd + "&companyCode=" + companyCode,
				method : "GET",
				where : {
					param : {
						"nd" : nd,
						"companyCode" : $("#companyCode").val()
					}
				},
				limit : 100,
				id : 'processdef_table_2',
				height : commonDislodgeTable(),
				cols : [ [
						{
							field : 'realIndex',
							title : '序号',
							style : 'cursor: pointer;',
							align : 'center',
							width : '45'
						},
						{
							field : 'xmmc',
							title : '项目名称',
							style : 'cursor: pointer;',
							align : 'left',
							width : '20%'
						},
						{
							field : 'zzdw',
							title : '组长单位',
							style : 'cursor: pointer;',
							align : 'left',
							width : '15%'
						},
						{
							field : 'fzzdw',
							title : '副组长单位',
							style : 'cursor: pointer;',
							align : 'left',
							width : '8%'
						},
						{
							field : 'zydw',
							title : '组员单位',
							style : 'cursor: pointer;',
							align : 'left',
							width : '18%'
						},
						{
							field : 'xzdw',
							title : '协作单位',
							style : 'cursor: pointer;',
							align : 'left',
							width : '12%'
						},
						{
							field : 'status',
							title : '项目状态',
							style : 'cursor: pointer;',
							align : 'center',
							width : '8%'
						},
						{
							field : 'jdap',
							title : '存在问题',
							style : 'cursor: pointer;',
							align : 'left',
							width : '6%'
						},
						{
							field : 'xmlbmc',
							title : '文档查询',
							style : 'cursor: pointer;',
							align : 'center',
							width : '10%',
							templet : function(d) {
								return "<a href='#'><img alt='第一次小组会议' src='/common/images/meeting_1.png'></a>&nbsp;&nbsp;&nbsp;&nbsp;" + "<a href='#'><img alt='第二次小组会议' src='/common/images/meeting_2.png'></a>&nbsp;&nbsp;&nbsp;&nbsp;"
										+ "<a href='#'><img alt='会议纪要' src='/common/images/meeting_remark.png'></a>&nbsp;&nbsp;&nbsp;&nbsp;" + "<a href='#'><img alt='工作总结' src='/common/images/work_rs.png'></a>";
							}
						} ] ],
				done : function(res, curr, count) {
					merge(res);
				}
			});
			function merge(res) {

				var data = res.data;
				var mergeIndex = 0;//定位需要添加合并属性的行数
				var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
				var columsName = [ 'realIndex', 'xmmc', 'status' ];//需要合并的列名称
				var columsIndex = [ 0, 1, 7 ];//需要合并的列索引值

				for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
					var trArr = $(".layui-table-body>.layui-table").find("tr");//所有行
					for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
						var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
						var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列

						if (data[i][columsName[k]] === data[i - 1][columsName[k]]) { //后一行的值与前一行的值做比较，相同就需要合并
							mark += 1;
							tdPreArr.each(function() {//相同列的第一列增加rowspan属性
								$(this).attr("rowspan", mark);
							});
							tdCurArr.each(function() {//当前行隐藏
								$(this).css("display", "none");
							});
						} else {
							mergeIndex = i;
							mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
						}
					}
					mergeIndex = 0;
					mark = 1;
				}
			}
		}
		//重大项目
		function renderTable() {
			var nd = $("#year").val();
			var companyCode = $("#companyCode").val();
			var tableOne = table.render({
				elem : '#processdef_table',
				url : '/one_level_main/getZdstlTable?nd=' + nd + "&companyCode=" + companyCode + "&type=重点专项",
				method : "GET",
				where : {
					param : {
						"nd" : nd,
						"companyCode" : $("#companyCode").val()
					}
				},
				limit : 100,
				id : 'processdef_table',
				height : commonDislodgeTable(),
				cols : [ [ {
					field : 'realIndex',
					title : '序号',
					style : 'cursor: pointer;',
					align : 'center',
					width : '45'
				}, {
					field : 'hth',
					title : '合同号',
					edit : 'text',
					width : '7%'
				}, {
					field : 'xmmc',
					title : '项目名',
					style : 'cursor: pointer;',
					align : 'left',
					width : '25%'
				}, {
					field : 'ysje',
					title : '年度预算（万元）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '9%'
				}, {
					field : 'fzdw',
					title : '负责单位',
					style : 'cursor: pointer;',
					align : 'left',
					width : '15%'
				}, {
					field : 'define8',
					title : '承担单位',
					style : 'cursor: pointer;',
					align : 'left',
					width : '15%'
				}, {
					field : 'zylb',
					title : '专业类别',
					style : 'cursor: pointer;',
					align : 'left',
					width : '10%'
				}, {
					field : 'fzrxm',
					title : '负责人',
					style : 'cursor: pointer;',
					align : 'left'
				}, {
					field : 'zycmc',
					title : '专业处',
					style : 'cursor: pointer;',
					align : 'center'
				}, {
					field : 'xmlbmc',
					title : '项目类别',
					style : 'cursor: pointer;',
					align : 'center',
					width : '6%'
				} ] ],
				done : function(res, curr, count) {
					mergeZDZX(res);
				}
			});
			
			function mergeZDZX(res) {

				var data = res.data;
				var mergeIndex = 0;//定位需要添加合并属性的行数
				var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
				var columsName = [ 'realIndex', 'xmmc'];//需要合并的列名称
				var columsIndex = [ 0, 1];//需要合并的列索引值

				for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
					var trArr = $(".layui-table-body>.layui-table").find("tr");//所有行
					for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
						var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
						var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列

						if (data[i][columsName[k]] === data[i - 1][columsName[k]]) { //后一行的值与前一行的值做比较，相同就需要合并
							mark += 1;
							tdPreArr.each(function() {//相同列的第一列增加rowspan属性
								$(this).attr("rowspan", mark);
							});
							tdCurArr.each(function() {//当前行隐藏
								$(this).css("display", "none");
							});
						} else {
							mergeIndex = i;
							mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
						}
					}
					mergeIndex = 0;
					mark = 1;
				}
			}
		}
		function export_doc(date_year) {
			//window.location.target = "_blank";
			//window.location.href="/one_level_main/report_download/"+date_year;
			window.open("/one_level_main/report_download/" + date_year);
		}
	</script>
</body>
</html>