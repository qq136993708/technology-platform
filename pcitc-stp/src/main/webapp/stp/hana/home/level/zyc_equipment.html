<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
<style>
.btn_details {
	background: url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff
		no-repeat;
}

.btnMyBgImg:hover {
	background-size: inherit;
	background-position: 2px;
}

.searchBox {
	background: none;
}
.myTable .layui-table-cell,.processdef_table_02 .layui-table-cell{cursor: pointer;}
.myTable td:nth-child(2) .layui-table-cell{color: red;}
.myTable td:nth-child(4) .layui-table-cell{color: #1890ff ;}
.myTable td:nth-child(6) .layui-table-cell{color: #9DD783   ;}
.processdef_table_02 td:nth-child(2) .layui-table-cell{color: #FBCD48;}
.processdef_table_02 td:nth-child(3) .layui-table-cell{color: #1890ff ;}
.processdef_table_02 td:nth-child(4) .layui-table-cell{color: red   ;}
.processdef_table_02 td:nth-child(5) .layui-table-cell{color: #9DD783   ;}

</style>
</head>
<body>
	<div class="layui-fluid">
		<input type="hidden" name="companyCode" value="${companyCode}" id="companyCode">
		<div class="">
			<div class="fluid-top">
				<div class="searchBox" style="margin-right: 6px;">
					<label class="dateInput">
						<span>月份</span>
						<input type="text" name="month" placeholder="请选择年份" title="年份" value="${month}" autocomplete="off" class="form-control" id="month">
						<i class="layui-icon layui-icon-date" style="margin-left: -35px"></i>
					</label>
				</div>
			</div>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time1"></span>年直属研究院科研装备课题数量
						</div>
						<div class="layui-row-main">
							<div class="text-total">
								<span>
									总计:
									<span class="text-total-blue" id="equipment_chart1_01" onclick="nzsyjykyzbktsl('')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									新开课题:
									<span class="text-total-blue" id="equipment_chart1_02" onclick="nzsyjykyzbktsl('新开课题')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									结转课题:
									<span class="text-total-blue" id="equipment_chart1_03" onclick="nzsyjykyzbktsl('结转课题')" style="cursor: pointer">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>

							<div class="main-chart" id="equipment_chart1" style="height: 280px; width: 100%;"></div>
						</div>
					</div>
				</div>


				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time1"></span>直属研究院科研课题数量占比
						</div>
						<div class="layui-row-main myTable">
							<table id="myTable" class="layui-table" lay-filter="myTable">
								<thead>
									<tr>
										<th lay-data="{field:'define2', width:'22%',align:'center'}" rowspan="2">项目</th>
										<th lay-data="{align:'center'}" colspan="2">总计</th>
										<th lay-data="{align:'center'}" colspan="2">新开课题</th>
										<th lay-data="{align:'center'}" colspan="2">结转课题</th>
									</tr>
									<tr>
										<th lay-data="{field:'zsl', width:'13%',align:'right'}">数量（个）</th>
										<th lay-data="{field:'zslRate', width:'13%',align:'right',templet:function(d){return d.zslRate.toFixed(2)+'%'}}">占比</th>

										<th lay-data="{field:'xksl', width:'13%',align:'right'}">数量（个）</th>
										<th lay-data="{field:'xkRate', width:'13%',align:'right',templet:function(d){return d.xkRate.toFixed(2)+'%'}}">占比</th>

										<th lay-data="{field:'xjsl', width:'13%',align:'right'}">数量（个）</th>
										<th lay-data="{field:'xjRate', width:'13%',align:'right',templet:function(d){return d.xjRate.toFixed(2)+'%'}}">占比</th>

									</tr>

								</thead>
							</table>

						</div>
					</div>
				</div>
			</div>




			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>直属研究院科研装备数量
						</div>
						<div class="layui-row-main">
							<div class="text-total" style="font-size: 12px;">
								<span>
									大型分析仪器:
									<span class="text-total-blue" id="bar4_1_count">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									中型实验装置:
									<span class="text-total-blue" id="bar4_2_count">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									单台值大于500万:
									<span class="text-total-blue" id="bar4_3_count">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
								<span>
									专业软件（外购）:
									<span class="text-total-blue" id="bar4_4_count">
										<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">
									</span>
								</span>
							</div>
							<div class="main-chart" id="equipment_chart3" style="height: 280px; width: 100%;"></div>
						</div>
					</div>
				</div>


				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>科研课题数量占比
						</div>
						<div class="layui-row-main processdef_table_02">
							<table id="processdef_table_02" class="layui-hide" lay-filter="processdef_table_02"></table>
						</div>
					</div>
				</div>
			</div>





		</div>
	</div>

	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
	<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>

	<script type="text/javascript">
		var companyCode = $('#companyCode').val();
		var layer;
		var table;
		layui.config({
			base : '/layuiadmin/'
		}).extend({
			index : 'lib/index'
		}).use([ 'index', 'layer', 'jquery', 'form', 'laydate', 'table', 'laypage' ], function() {
			layer = layui.layer;
			$ = layui.jquery, table = layui.table, form = layui.form, laydate = layui.laydate;
			if (companyCode == null || companyCode == '') {
				layer.alert("请配置直属院数据权限");
			}

			form.render(null, 'component-form-group');
			laydate.render({
				elem : '#month',
				type : 'month',
				done : function(value, date, endDate) {
					$(".layui-time1").html(date.year);
					$(".layui-time").html(date.year + "年" + date.month + "月");
					$("#month").val(date.year + "-" + PrefixInteger(date.month, 2));
					search_Event();
				}
			});

			var monthValY = $("#month").val().substring(4, 0);
			var monthValM = $("#month").val().substring(5);
			$(".layui-time").html(monthValY + "年" + monthValM + "月");
			$(".layui-time1").html(monthValY);

			renderTable2();
			myTable();
		});

		function PrefixInteger(num, length) {
			return (num / Math.pow(10, length)).toFixed(length).substr(2);
		}

		function initEchart() {

			var month = $('#month').val();
			month = month.replace("-", "");
			var nd = month.substr(0, 4);

			var v_date = (new Date()).getTime();
			var ndstr = nd + "年";
			var yAxis = [ {
				type : 'value',
				name : '数量（个）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			//直属研究院科研装备课题数量
			$("#equipment_chart1_01").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#equipment_chart1_02").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#equipment_chart1_03").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			//直属研究院科研装备数量
			$("#bar4_1_count").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#bar4_2_count").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#bar4_3_count").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');
			$("#bar4_4_count").html('<img class="loadingImg" src="/layuiadmin/layui/images/loadingImg04.gif" alt="">');

			var chart1_url = "/direct/equipment_01?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date + "&xmlbbm=kyzb";
			var echart1 = load_mutl_bar_down_color(chart1_url, "equipment_chart1", "", "", yAxis);
			echart1.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;
				var monthv = $('#month').val();
				var ndv = monthv.substr(0, 4);

				var nd_temp = ndv;
				if (legentName == '结转课题') {
					nd_temp = "";
				}

				parent.layui.index.openTabsPage("/one_level_main/count_table_new?define2=" + xName + "&nd=" + nd_temp + "&ysnd=" + ndv + "&define1=资本性&ktlx=" + legentName + "&define11=股份公司&define12=直属研究院&groupFlag=xmid", "装备课题详情");
			});

			var url_01 = "/direct/equipment_02?type=1&companyCode=" + companyCode + "&month=" + month + "&v_date=" + v_date;
			var data7 = load_bar_zhengfu_callback(url_01, "equipment_chart3", "", "", function(data) {

				var bCount_4 = getDataCountForName_t(data, '大型分析仪器');
				var zCount_4 = getDataCountForName_t(data, '中型实验装置');
				var dCount_4 = getDataCountForName_t(data, '单台值大于500万');
				var zyCount_4 = getDataCountForName_t(data, '专业软件（外购）');
				var allCount_4 = bCount_4 + zCount_4 + dCount_4 + zyCount_4;
				//alert(bCount_4);
				$("#bar4_1_count").html(bCount_4 + "套");
				$("#bar4_2_count").html(zCount_4 + "台");
				$("#bar4_3_count").html(dCount_4 + "台");
				$("#bar4_4_count").html(zyCount_4 + "套");

			});
			data7.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;

				parent.layui.index.openTabsPage("/one_level_main/equipment_03_detail?month=" + $("#month").val() + "&companyName=" + xName, "装备课题详情");
			});


		}

		function getDataCountForName_t(data, strName) {
			var seriesList = data.seriesList;
			//alert(data);
			var xkCount = 0;
			if (typeof (seriesList) == "undefined") {

			} else {
				for (var i = 0; i < seriesList.length; i++) {
					var arr = seriesList[i].data;
					var name = seriesList[i].name;
					if (name == strName) {
						var name_count = 0;
						for (var j = 0; j < arr.length; j++) {
							name_count = name_count + parseInt(arr[j]);
						}
						xkCount = name_count;
					}
				}

			}
			return parseInt(xkCount);

		}
        //直属研究院科研装备课题数量
		function nzsyjykyzbktsl(ktlx) {

			var month = $('#month').val();
			month = month.replace("-", "");
			var nd = month.substr(0, 4);
			var v_date = (new Date()).getTime();

			var nd_temp = "";
			if (ktlx == '新开课题') {
				nd_temp = nd;
			}
			parent.layui.index.openTabsPage("/one_level_main/count_table_new?nd=" + nd_temp + "&ysnd=" + nd + "&define11=股份公司&define12=直属研究院&define1=资本性&v_date=" + v_date + "&ktlx=" + ktlx + "&groupFlag=xmid", "装备课题详情");
		}

		//初始化图形
		initEchart();
		//查询
		function search_Event() {
			initEchart();
			myTable();
			renderTable2();
		}

		//  科研课题数量占比
		function renderTable2() {
			var month = $('#month').val();

			month = month.replace("-", "");
			var v_date = (new Date()).getTime();
			var tableOne = table.render({
				elem : '#processdef_table_02',
				url : '/direct/equipment_02?type=2&companyCode=' + companyCode + '&v_date=' + v_date + '&month=' + month + "&xmlbbm=kyzb",
				method : "GET",
				height : 302,
				where : {
					param : {
						"month" : $("#month").val()
					}
				},
				limit : 15,
				id : 'processdef_table_02',

				cols : [ [ {
					field : 'g0GSJC',
					title : '研究院',
					edit : 'text',
					width : '20%',
					align : 'center'
				}, {
					field : 'g0SBSL1',
					title : '大型分析仪器（套）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%',
					templet : function(d) {
						return parseInt(d.g0SBSL1)
					}
				}, {
					field : 'g0SBSL2',
					title : '中型实验装置（台）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%',
					templet : function(d) {
						return parseInt(d.g0SBSL2)
					}
				}, {
					field : 'g0SBSL3',
					title : '单台值大于500万（台）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%',
					templet : function(d) {
						return parseInt(d.g0SBSL3)
					}
				}, {
					field : 'g0SBSL4',
					title : '外购专业软件（套）',
					style : 'cursor: pointer;',
					align : 'right',
					width : '20%',
					templet : function(d) {
						return parseInt(d.g0SBSL4)
					}
				}

				] ],
				done : function(res, curr, count) {
					layer.closeAll('loading');
					// 点击行联动选择框--单选
					$('.processdef_table_02 .layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
						var index = parseInt($(this).index() + 1);
						$('tr').removeClass('layui-table-click');
						$(this).addClass('layui-table-click');
						$('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
						$('tr:eq(' + index + ')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
						selectRowData = res.data[index - 1];

						var companyName = selectRowData.g0GSJC;
						//var url = encodeURIComponent("/one_level_main/equipment_03_detail?month=" + $("#month").val() + "&companyName=" + companyName);
						//window.open("/instituteIndex?url=" + url);
						parent.layui.index.openTabsPage("/one_level_main/equipment_03_detail?month=" + $("#month").val() + "&companyName=" + companyName, "装备课题详情");
					});
				}
			});

		}

		function myTable() {
			var month = $('#month').val();
			month = month.replace("-", "");
			var nd = month.substr(0, 4);
			var v_date = (new Date()).getTime();
			var url = '/direct/equipment_01?functionId=984b64b13cf54222bf57bd840759fabe&type=2&v_date=' + v_date + "&nd=" + nd + "&xmlbbm=kyzb";
			table.init('myTable', {
				url : url,
				height : "300px",
				where : {}
			});

			//监听行单击事件
			table.on('row(myTable)', function(obj) {
				console.log(obj.tr) //得到当前行元素对象
				console.log(obj.data) //得到当前行数据
				var selectRowData = obj.data;
				parent.layui.index.openTabsPage("/one_level_main/count_table_new?define2=" + selectRowData.define2 + "&nd=&ysnd=" + nd + "&define11=股份公司&define12=直属研究院&define1=资本性&v_date=" + v_date, "装备课题详情");
			});

		}
	</script>

</body>
</html>