<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/adminStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/mainStp.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/second.css" media="all">
<style>
.btn_details {
	background: url(/layuiadmin/layui/images/operation_03.png) 2px 4px #fff
		no-repeat;
}

.btnMyBgImg:hover {
	background-size: inherit;
	background-position: 2px;
}

.searchBox {
	background: none;
}

.layui-row-main td:nth-child(2) .layui-table-cell {
	color: red;
}

.layui-row-main td:nth-child(4) .layui-table-cell {
	color: green;
}

.layui-row-main td:nth-child(6) .layui-table-cell {
	color: orange;
}
</style>
</head>
<body>
	<div class="layui-fluid">
		<div class="">
			<div class="fluid-top">

				<div class="searchBox">
					<label class="dateInput">
						<span>年份</span>
						<input type="text" readonly="readonly" style="cursor: pointer" name="nd" placeholder="请选择年份" title="年份" value="${nd}" autocomplete="off" class="form-control" id="nd">
						<i class="layui-icon layui-icon-date" style="margin-left: -35px"></i>
					</label>
				</div>
			</div>

			<#if userPosition=='处长' || userPosition=='副处长'>
			<div class="layui-row layui-col-space15">
				<div class="layui-col-md12">
					<div class="layui-card">
						<div class="layui-card-header" title="目前预算只是费用性预算">
							<span class="layui-time"></span>
							科研预算执行率（万元）
						</div>
						<div class="layui-row-main">
							<table id="kyysTable" class="layui-table" lay-filter="kyysTable">
								<thead>
									<tr>
										<th lay-data="{field:'budgetItemName', width:'13%'}" rowspan="2">企业类型</th>
										<th lay-data="{align:'center'}" colspan="3">总计</th>
										<th lay-data="{align:'center'}" colspan="3">费用性</th>
										<th lay-data="{align:'center'}" colspan="3">资本性</th>
									</tr>
									<tr>
										<th lay-data="{field:'zysje', width:'10%',align:'right'}">年度预算</th>
										<th lay-data="{field:'zsjje', width:'10%',align:'right'}">实际签订</th>
										<th lay-data="{field:'zRate', width:'9%',align:'right',templet:function(d){return d.zRate+'%'}}">执行率</th>

										<th lay-data="{field:'fyxysje', width:'10%',align:'right'}">年度预算</th>
										<th lay-data="{field:'fyxsjje', width:'10%',align:'right'}">实际签订</th>
										<th lay-data="{field:'fyxRate', width:'9%',align:'right',templet:function(d){return d.fyxRate+'%'}}">执行率</th>

										<th lay-data="{field:'zbxysje', width:'10%',align:'right'}">年度预算</th>
										<th lay-data="{field:'zbxsjje', width:'10%',align:'right'}">实际签订</th>
										<th lay-data="{field:'zbxRate', width:'9%',align:'right',templet:function(d){return d.zbxRate+'%'}}">执行率</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
			
			<div class="layui-row layui-col-space15">
				<div class="layui-col-md12">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							专业处科研预算
						</div>
						<div class="layui-row-main">
							<table id="zycysTable" class="layui-table" lay-filter="zycysTable">
								<thead>
									<tr>
										<th lay-data="{field:'zycmc', width:'13%'}" rowspan="2">专业处名称</th>
										<th lay-data="{align:'center'}" colspan="3">预算总计（万元）</th>
										<th lay-data="{align:'center'}" colspan="2" id = 'xkInfo'></th>
										<th lay-data="{align:'center'}" colspan="2" id = 'jzInfo'></th>
									</tr>
									<tr>
										<th lay-data="{field:'ysje', width:'13%',align:'right'}"> </th>
										<th lay-data="{field:'ysxkje', width:'13%',align:'right'}">其中：可新签</th>
										<th lay-data="{field:'ysjzje', width:'13%',align:'right'}">其中：结转</th>

										<th lay-data="{field:'xkMoney', width:'13%',align:'right'}">新签金额</th>
										<th lay-data="{width:'11%',align:'right',templet : '#xkMoneyRate'}">新签预算完成比例</th>
										
										<th lay-data="{field:'jzMoney', width:'13%',align:'right'}">结转金额</th>
										<th lay-data="{width:'11%',align:'right',templet : '#jzMoneyRate'}">占结转预算比例</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
			
			</#if>

			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院月度合同签订情况
						</div>
						<div class="layui-row-main">
							<div class="main-chart" id="investment_smal_chart2" style="height: 300px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">

					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院月度合同签订情况
						</div>
						<div class="layui-row-main">
							<table id="myTable2" class="layui-table" lay-filter="myTable2">
								<thead>
									<th lay-data="{field:'yearMonth', width:'25%',align:'center'}">月份</th>
									<th lay-data="{field:'zysje',     width:'25%',align:'right',style:'color: #f67d06'}">可新签预算(万元)</th>
									<th lay-data="{field:'zsjje',     width:'25%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.zsjje) }}</div>'}">当月签订金额(万元)</th>
									<th lay-data="{field:'hanaMoney', width:'25%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.hanaMoney) }}</div>'}">当月拨款金额(万元)</th>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>



			<div class="layui-row layui-col-space15">
				<div class="layui-col-md6">
					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院合同签订情况
						</div>


						<div class="layui-row-main">
							<div class="main-chart" id="investment_smal_chart1" style="height: 300px; width: 100%;"></div>
						</div>
					</div>
				</div>
				<div class="layui-col-md6">

					<div class="layui-card">
						<div class="layui-card-header">
							<span class="layui-time"></span>
							年直属研究院合同签订情况
						</div>
						<div class="layui-row-main">
							<table id="myTable" class="layui-table" lay-filter="myTable">
								<thead>
									<tr>
										<th lay-data="{field:'define2',   width:'16%',align:'center'}">研究院</th>
										<th lay-data="{field:'zysje',     width:'16%',align:'right'}">可新签预算(万元)</th>
										<th lay-data="{field:'zsjje',     width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.zsjje) }}</div>'}">已签合同总金额(万元)</th>
										<th lay-data="{field:'wqhtzje',     width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.wqhtzje) }}</div>'}">未签合同总金额(万元)</th>
										<th lay-data="{field:'hanaMoney', width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.hanaMoney) }}</div>'}">已拨款总金额(万元)</th>
										<th lay-data="{field:'wbkzje', width:'17%',align:'right',templet:'<div>{{ layui.laytpl.zero_gang(d.wbkzje) }}</div>'}">未拨款总金额(万元)</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="/plugins/echarts/walden.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_chart.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_line.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_bar.js"></script>
	<script type="text/javascript" src="/stp/hana/common/stp_common_pie.js"></script>
	<script type="text/javascript" src="/stp/hana/common/hana_common.js"></script>
	<script type="text/javascript" src="/stp/hana/home/direct_depart/direct_common.js"></script>
	<script type="text/javascript" src="/stp/hana/home/oneLevelMain/investment.js"></script>

	<script id="xkMoneyRate" type="text/html"> {{moneyRate(d.ysxkje, d.xkMoney)}} </script>
	<script id="jzMoneyRate" type="text/html"> {{moneyRate(d.ysjzje, d.jzMoney)}} </script>
	<script type="text/javascript">
		var table;
		var userPosition = "${userPosition}"; //职务
		
		layui.config({
			base : '/layuiadmin/'
		}).extend({
			index : 'lib/index' //主入口模块
		}).use([ 'index', 'jquery', 'form', 'laydate', 'table', 'laypage' ], function() {
			$ = layui.jquery, table = layui.table, form = layui.form, laydate = layui.laydate
			form.render(null, 'component-form-group');
			laydate.render({
				elem : '#nd',
				min : '2018-01-01',
				type : 'year',
				done : function(value, date, endDate) {
					$(".layui-time").html(date.year);
					$("#nd").val(date.year);
					search_Event();
				}
			});
			$(".layui-time").html($("#nd").val());
			
			//监听行单击事件
			table.on('row(myTable)', function(obj) {
				console.log(obj.tr) //得到当前行元素对象
				console.log(obj.data) //得到当前行数据
				selectRowData = obj.data;
				var nd = $("#nd").val();
			});

			//监听行单击事件
			table.on('row(myTable2)', function(obj) {
				selectRowData = obj.data;
				var nd = $("#nd").val();
			});

			myTable();
			myTable2();

			if (userPosition == '处长' || userPosition == '副处长') {
				//监听行单击事件
				table.on('row(kyysTable)', function(obj) {
					selectRowData = obj.data;
					var xName = selectRowData.budgetItemName;
					var nd = $('#nd').val();

					var qdbz = '已签订';
					var define11 = "";
					var define12 = "";
					if (xName == '资产公司' || xName == '集团公司') {
						define11 = xName;
					} else if (xName == '合计'){
						define11 = "";
					} else {
						define11 = "股份公司";
					}

					define12 = xName;
					if (xName == '休斯顿') {
						define12 = '休斯顿研发中心';
					}
					if (xName == '中东') {
						define12 = '中东研发中心';
					}

					parent.layui.index.openTabsPage("/one_level_main/count_table_new?define12=" + define12 + "&ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8&define11=" + define11, "科研预算详情");
				});
				
				table.on('row(zycysTable)', function(obj) {
					selectRowData = obj.data;
					var xName = selectRowData.zycmc;
					var nd = $('#nd').val();

					var qdbz = '已签订';
					
					if (xName == '油田处') {
						xName = '科技部';
					}
					if (xName.indexOf('炼油事业部')>-1) {
						xName = '炼油部';
					}
					if (xName.indexOf('化工事业部')>-1) {
						xName = '化工部';
					}
					if (xName.indexOf('合计')>-1) {
						xName = '';
					}
					if (xName == '科技部' || xName == '物装部' || xName == '炼油部' || xName == '化工部' || xName == '信息部' || xName == '工程部') {
						parent.layui.index.openTabsPage("/one_level_main/count_table_new?gsbmbmFlag=" + xName + "&ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8", "科研预算详情");
					} else if (xName == '专项' || xName == '机动') {
						
					} else if (xName == '') {
						parent.layui.index.openTabsPage("/one_level_main/count_table_new?ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8", "科研预算详情");
					} else {
						parent.layui.index.openTabsPage("/one_level_main/count_table_new?zycbmFlag=" + xName + "&ysnd=" + nd + "&qdbz=" + qdbz + "&groupFlag=xmid,define8", "科研预算详情");
					}
					
				});

				kyysTable();
				zycysTable();
			}

		});

		function kyysTable() {

			var nd = $("#nd").val();
			var v_date = (new Date()).getTime();
			var url = '/one_level_main/investment_01_01?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&v_date=" + v_date;
			table.init('kyysTable', {
				url : url,
				where : {}
			});

		}
		
		// 专业处预算情况
		function zycysTable() {

			var nd = $("#nd").val();
			$("#xkInfo").html($("#nd").val()+"年新签情况（万元）");
			$("#jzInfo").html($("#nd").val()+"年结转情况（万元）");
			var v_date = (new Date()).getTime();
			var url = '/one_level_main/investment_03?functionId=984b64b13cf54222bf57bd840759fabe&nd=' + nd + "&xmlbbm=fkyzb&v_date=" + v_date;
			table.init('zycysTable', {
				url : url,
				where : {}
			});

		}
		
		function moneyRate(ysxkje, xkMoney) {
			if (ysxkje == 0 || xkMoney == 0) {
				return '<span style="color:red">--</span>';
			} else {
				return '<span style="color:red">' + (xkMoney*100 / ysxkje).toFixed(2) + '%</span>';
			}
		}

		function initEchart() {

			var v_date = (new Date()).getTime();
			var nd = $('#nd').val();
			var ndstr = nd + "年";
			var yAxis = [ {
				type : 'value',
				name : '数量（个）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var yAxis2 = [ {
				type : 'value',
				name : '金额（万元）',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var chart1_url = "/small_leader/investment_data?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date + "&typeFlag=研究院&xmlbbm=fkyzb";
			var colorOne = [ "#ea886d", "#9799ec", "#5181E6", "#70b1ab", "#87d359" ];
			var echart1 = load_mutl_bar(chart1_url, "investment_smal_chart1", "", "", yAxis2, 10, colorOne, false);
			echart1.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;

			});

			//直属研究院科研课题数量分布
			var yAxis3 = [ {
				type : 'value',
				name : '金额（万元）',
				min : 0,
				max : 'dataMax',
				position : 'left',
				axisLabel : {
					formatter : '{value}'
				}
			} ];

			var chart2_url = "/small_leader/investment_data_02?functionId=984b64b13cf54222bf57bd840759fabe&nd=" + nd + "&v_date=" + v_date + "&type=1";
			var colorLine = [ "#ea886d", "#5181E6", "#9799ec" ]
			var echart2 = load_mony_line_down(chart2_url, "investment_smal_chart2", "", "", yAxis3, colorLine);
			echart2.on('click', function(params) {
				var xName = params.name;
				var legentName = params.seriesName;

			});
		}

		//初始化图形
		initEchart();
		//查询
		function search_Event() {
			initEchart();
			myTable();
			myTable2();
			if (userPosition == '处长' || userPosition == '副处长') {
				kyysTable();
				zycysTable();
			}
		}

		function myTable() {
			var v_date = (new Date()).getTime();
			var nd = $('#nd').val();
			var chart1_url = "/small_leader/investment_data?functionId=984b64b13cf54222bf57bd840759fabe&type=2&nd=" + nd + "&v_date=" + v_date + "&typeFlag=研究院&xmlbbm=fkyzb";
			table.init('myTable', {
				url : chart1_url,
				height : "299px",
				where : {}

			});

		}

		function myTable2() {
			var v_date = (new Date()).getTime();
			var nd = $('#nd').val();
			var chart1_url = "/small_leader/investment_data_02?functionId=984b64b13cf54222bf57bd840759fabe&type=2&nd=" + nd + "&v_date=" + v_date;
			table.init('myTable2', {
				url : chart1_url,
				height : "299px",
				where : {}

			});

		}
	</script>
</body>
</html>
