<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
	<link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
	<link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css">
	
	<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.core.js"></script>
	<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.excheck.min.js"></script>
	<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.all.js"></script>
    <script type="text/javascript" src="/layuiadmin/modules/selectTree.js"></script>
    <script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
	
	<style>
	.tree-content {
	  position: absolute;
	  z-index: 998;
	  background: #ffffff;
	  max-height: 400px;
	  width: 100%;
	  border: 1px solid #ccc;
	  overflow-y: scroll;
	}
	.layui-select-title input{display:inline-block}
	.searchBox .layui-input{
		width: 18%;
	  min-width: 160px;
	  display: inline-block !important;
	  font-size: 12px !important;
	  height: 24px !important;
	  line-height: 24px !important;
	  font-weight: normal !important;
	  padding-left: 6px !important;
	  padding-right: 6px !important;
	  border-radius: 2px !important;
	  vertical-align: middle;
	  color: #555;
	  background-color: #fff;
	  background-image: none;
	  border: 1px solid #ccc;
	  padding-top:0px;
	}
	</style>
	<script type="text/javascript">
	var table,selectRowData,renderfunc,resultTypeMap,treeGridCom,tableId;
	layui.config({
        base: '/layuiadmin/lib/extend/'
    }).extend({
        treeGridCom:'treeGridCom'
    }).use([ 'jquery', 'form', 'laydate', 'table', 'laydate','layer', 'element','publicMethods','treeGridCom'], function(){
    	var $ = layui.jquery,  laydate = layui.laydate,element = layui.element, layer = layui.layer,publicMethods=layui.publicMethods,treeGridCom = layui.treeGridCom;
    	table = layui.table;
    	//加载岗位类型字典
		publicMethods.ajaxPost("/dictionary/list/GJXMGL_CGLX", null, function (data) {
			resultTypeMap = {};
			$.each(data,function(i,dt){
				resultTypeMap[data[i].code] = data[i].name;
	    	});
	    });
		var dicVal = {};
		laydate.render({elem: '#reportYear',type: 'year'});
    	publicMethods.ajaxPost("/dictionary/map/getMapListDictionarys",{"parentCodes":JSON.stringify(['ROOT_ZGSHJT_GFGS_ZSYJY'])}, function (data) {
			$.each(data,function(key,val){
				$.each(val,function(i,dt){
					dicVal[dt.code] = dt.name;
					$("#ROOT_ZGSHJT_GFGS_ZSYJY").append('<option value="'+dt.code+'">'+dt.name+'</option>');
				});
			});
	   	});
    	window.renderTable = function(where){
    		var lodingMsg = layer.msg('数据加载中....');
    		var param = JSON.parse(window.localStorage.getItem("param"));
    		tableId = 'resultTable';
    		treeGridCom.render({
    			id:tableId
                ,elem: '#'+tableId
                ,url:'/project/result-list'
                ,where:where
                ,cellMinWidth: 100
                ,idField:'id'//必須字段
                ,treeId:'id'//树形id字段名称
                ,treeUpId:'pId'//树形父id字段名称
                ,treeShowName:'projectId'//以树形式显示的字段
                ,heightRemove:[".dHead",10]//不计算的高度,表格设定的是固定高度，此项不生效
                ,height: commonDislodgeTable()
                ,isFilter:false
                ,iconOpen:true//是否显示图标【默认显示】
                ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
                ,loading:true
                ,method:'POST'
	            ,page: {
	                groups: 5
	                ,limits : [ param.selfRownum, 15, 30, 45, 60 ]
	                ,layout: ['count', 'limit', 'prev', 'page', 'next', 'skip'] //自定义分页布局
	                ,first: '首页' //不显示首页
	                ,last: '尾页' //不显示尾页
	                ,theme: '#0F9EE0'
		        },
	            cols: [[
	            	 {type:'checkbox'}
	            	,{title:'序号', type:'numbers' ,width : 55}
	            	,{field:'projectId',   title:'项目名称',    width: '30%',  style:'cursor: pointer;'}
	            	,{field:'reportYear',   title:'申报年度', width: '8%',  style:'cursor: pointer;',align:"center"}
	            	,{field:'unitId',   title:'所属研究院', width: '8%',  style:'cursor: pointer;',align:"center"}
	            	,{field:'resultTitle',   title:'成果名称',	 style:'cursor: pointer;'}
	                ,{field:'resultType',   title:'成果类型',	width: '10%',  style:'cursor: pointer;'}
	                //,{field:'resultAuthor',title:'负责人',	width: '10%', style:'cursor: pointer;'}
	                //,{field:'authorPhone',title:'负责人联系电话',	style:'cursor: pointer;'}	                
	                
	            ]],
	            done: function (res, curr, count) {
	            	layer.close(lodingMsg);
	                // 点击行联动选择框--单选
	                 $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
	                	var index=parseInt($(this).index()+1);
	                    $('tr').removeClass('layui-table-click');
	                    $(this).addClass('layui-table-click');
	                    $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
	                    $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
	                    selectRowData=res.data[index-1];
	                }); 
		            //显示字典数据
		            $.each(res.data,function(i,dt){
		            	$("tr[data-index='"+i+"'] td[data-field='resultType'] div").html(resultTypeMap[res.data[i].resultType]);
		            	publicMethods.ajaxAsyncPost('/project/get-project', {"projectId":res.data[i].pId}, function (data, status) {
		            		publicMethods.ajaxAsyncPost('/project/get-apply', {"applyId":data.applyId}, function (dt, status) {
		            			//$("tr[data-index='"+i+"'] td[data-field='projectId'] div").html(dt.applyName);
			            		$("tr[data-index='"+i+"'] td[data-field='reportYear'] div").html(dt.reportYear);
			            		$("tr[data-index='"+i+"'] td[data-field='unitId'] div").html(dicVal[dt.unitId]);
		            		});
			            });
			        });
	            },
	            onDblClickRow:function(index, o){
	            	console.log(index);
	            	console.log(o);
	            }
	        });
	        renderfunc = function removeHeaderCheckbox(){
	        	$(".layui-table-header table thead th input").remove();  //移除表头的复选框,去掉全选
	        }
	        renderfunc();
		}
    	
    	renderTable();
    	
        //监听表格复选框选择
        table.on('rowDouble(resultEvent)', function(obj){
        	var temUrl = '/intl_project/result_view?resultId='+obj.data.resultId;
        	openFullWin("详情",temUrl);
        });
        // 触发不同的按钮事件
        var $ = layui.$, active = {
            searchEvent: function() { //点击查询按钮
                //renderTable({param: {"resultName":$("#resultName").val()}});
                renderTable({
            		param: {
            			"remarkTitle":$("#remarkTitle").val(),
            			"reportYear":$("#reportYear").val(),
        				"unitId":$("#ROOT_ZGSHJT_GFGS_ZSYJY").val()
            		}
            	});
            },resetEvent: function() { 
            	//点击重置按钮
                $("#resultName").val("");
                $("#reportYear").val("");
                $("#ROOT_ZGSHJT_GFGS_ZSYJY").val("");
                renderTable({param: {"resultName":$("#resultName").val()}});
            },addEvent: function(){ 
            	//点击新增按钮
            	var temUrl = '/intl_project/result_edit';
            	openFullWin("新增",temUrl);
            },editEvent: function(){  
            	//点击编辑按钮
            	if(!selectRowData){
            		layer.msg('请点击选择一行数据!');
            		return;
            	}
            	var temUrl = '/intl_project/result_edit?resultId='+selectRowData.resultId;
            	openFullWin("编辑",temUrl);
            },detailEvent:function(){
            	if(!selectRowData){
            		layer.msg('请点击选择一行数据!');
            		return;
            	}
            	var temUrl = '/intl_project/result_view?resultId='+selectRowData.resultId;
            	openFullWin("详情",temUrl);
            },closeEvent:function(){
            	if(!selectRowData){
            		layer.msg('请点击选择一行数据!');
            		return;
            	} 
            	layer.confirm('确定要删除吗？',{title:"删除确认"},function(index){
					layer.close(index);
	            	ajaxPost("/project/result-close/" + selectRowData.resultId, null, function (data) {
	                     if (data.success) {
	                    	 renderTable({param: {"resultName":$("#resultName").val()}});
	                     } else {
	                    	 layer.msg('操作异常，请重试!');
	                     }
	                });
            	});
            },deleteEvent: function(){  //点击删除按钮
            	//var dt = table.checkStatus('userTable').data;
            	if(!selectRowData){
            		layer.msg('请选择要删除的数据!');
            		return;
            	}
				layer.confirm('确定要删除吗？',{title:"删除确认"},function(index){
					layer.close(index);
	            	ajaxPost("/project/result-delete/"+selectRowData.applyId, null, function (data) {
	                     if (data.success) {
	                    	 renderTable({param: {"applyName":$("#applyName").val()}});
	                    	 //table.reload("applyTable");
	                     } else {
	                    	 layer.msg('操作异常，请重试!');
	                     }
	                });
            	});
            }
        };
        //区别按钮属性
        $('.layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>

</head>
<body>
<div class="searchBox">
    <label class="dateInput">
        <span>成果名称</span>
        <input type="text" name="resultName" id="resultName" placeholder="请输入成果名称" autocomplete="off" class="form-control">
    </label>
    <label class="dateInput">
        <span>申报年度</span>
        <input type="text" name="reportYear" id="reportYear" placeholder="" readonly="readonly" autocomplete="off" class="form-control">
    </label>
    <label class="dateInput">
        <span>所属研究院</span>
        <select name="unitId" id="ROOT_ZGSHJT_GFGS_ZSYJY" lay-verify="required"  lay-filter="unitId" class="form-control form-control1">
            <option value="">请选择</option>
        </select>
    </label>
    <div class="btnGroup">
        <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" data-type="searchEvent">查询</button>
        <button class="layui-btn layui-btn-sm fontColor-default border-default btn_reset btnMyBgImg" data-type="resetEvent">重置</button>
    </div>
</div>
<div class="tableBox">
    <div class="tableToolBox">
        <div class="whiteLine"></div>
        <div  class="tableBtns">
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg" data-type="addEvent">新增</button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg" data-type="editEvent">编辑</button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_details btnMyBgImg" data-type="detailEvent">查看</button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg" data-type="closeEvent">删除</button>
        </div>
    </div>
    <table id="resultTable" class="layui-hide"  lay-filter="resultEvent"></table>
</div>
</body>
</html>
