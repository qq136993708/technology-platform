<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css">
<link rel="stylesheet" href="/layuiadmin/style/admin.css">
<script src="/layuiadmin/layui/layui.js"></script>
<style>
.dateInput {
	font-size: 12px;
}

.layuiadmin-btn-list {
	height: 30px;
	line-height: 30px;
	padding: 0 15px;
}

.layuiadmin-card-header-auto i.layuiadmin-button-btn {
	font-size: 14px;
}

.layui-laydate-hint {
	display: none;
}
.layui-table-fixed{width: 157px;}
</style>
</head>
<body>

	<!-- 国家项目、重大专项、重点项目、其他项目   -->
	<input type="hidden" name="project_property" value="${project_property}" id="project_property">
	<!-- 新开项目、续建项目、完工项目  -->
	<input type="hidden" name="project_scope" value="${project_scope}" id="project_scope">
	<input type="hidden" name="projectId" value="${projectId}" id="projectId">
	<!-- 直属研究院、分子公司、集团等9种类型 -->
	<input type="hidden" name="type_flag" value="${type_flag}" id="type_flag">
	<input type="hidden" name="leaderFlag" value="${leaderFlag}" id="leaderFlag">
	<input type="hidden" name="ktlx" value="${ktlx}" id="ktlx">
	<div class="layui-fluid">
		<div class="layui-card">

			<div class="layui-form layui-card-header layuiadmin-card-header-auto" style="padding: 0px">
				<form id="paymentplan-form" name="paymentplan-form" lay-filter="paymentplan-form" class="form-horizontal layui-form">
				<div class="layui-form-item">
					<div class="layui-inline">
						<label class="layui-form-label">项目名称：</label>
						<div class="layui-input-inline">
							<input type="text" name="xmmc" title="项目名称" placeholder="请输入项目名称" autocomplete="off" class="layui-input" id="xmmc">
						</div>
					</div>

					<div class="layui-inline">
						<label class="layui-form-label">合同号：</label>
						<div class="layui-input-inline">
							<input type="text" name="hth" title="合同号" placeholder="请输入合同号" autocomplete="off" class="layui-input" id="hth">
						</div>
					</div>


					<div class="layui-inline">
						<label class="layui-form-label">立项年度：</label>
						<div class="layui-input-inline">
							<input type="text" name="nd" readonly="readonly" style="cursor: pointer" placeholder="请选择立项年度" title="立项年度" value="${nd}" autocomplete="off" class="layui-input" id="nd" width="100px">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label">拨款年度：</label>
						<div class="layui-input-inline">
							<input type="text" name="ysnd" readonly="readonly" style="cursor: pointer" placeholder="请选择拨款年度"  title="拨款年度" value="${ysnd}" autocomplete="off" class="layui-input" id="ysnd" width="100px">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label">费用类别：</label>
						<div class="layui-input-inline">
							<select name="define1" id="define1">
								<option value="">--请选择--</option> <#list fylbList as vo>
								<option value="${vo.numValue}"<#if define1==vo.numValue>selected="selected"</#if> >${vo.name}</option> </#list>
							</select>
						</div>
					</div>
					<div class="select">
						<!-- 三级级联 begin-->
						<div class="layui-inline">
							<label class="layui-form-label">经费来源：</label>
							<div class="layui-input-inline">
								<select name="define11" id="define11" lay-filter="select_define11">
									<option value="">--请选择--</option> <#list jflyList as vo>
									<option value="${vo.code}"<#if define11=vo.name>selected="selected"</#if>>${vo.name}</option> </#list>
								</select>
							</div>
						</div>

						<div class="layui-inline">
							<label class="layui-form-label">单位性质：</label>
							<div class="layui-input-inline">
								<select name="define12" id="define12" lay-filter="select_define12">
								</select>
							</div>
						</div>

						<div class="layui-inline">
							<label class="layui-form-label" id="lay_company">研究院：</label>
							<div class="layui-input-inline">
								<select name="define2" id="define2">
								</select>
							</div>
						</div>
						<!-- 三级级联 end -->


						<!-- 三级级联 begin -->
						<div class="layui-inline">
							<label class="layui-form-label">部门：</label>
							<div class="layui-input-inline">
								<select name="gsbmbmFlag" id="gsbmbmFlag" lay-filter="select_gsbmbmFlag">
									<option value="">--请选择--</option> <#list gsbmbmList as vo>
									<option value="${vo.code}"<#if gsbmbmFlag=vo.name>selected="selected"</#if>>${vo.name}</option> </#list>
								</select>
							</div>
						</div>


						<div class="layui-inline">
							<label class="layui-form-label">处室：</label>
							<div class="layui-input-inline">
								<select name="zycbmFlag" id="zycbmFlag" lay-filter="select_zycbmFlag">
								</select>
							</div>
						</div>


						<div class="layui-inline">
							<label class="layui-form-label">专业类别：</label>
							<div class="layui-input-inline">
								<select name="zylbbmFlag" id="zylbbmFlag">
								</select>
							</div>
						</div>
						<!-- 二级级联 end -->




						<div class="layui-inline">
							<label class="layui-form-label">技术分类：</label>
							<div class="layui-input-inline">
								<select name="define5" id="define5">
									<option value="">--请选择--</option> <#list jsflList as vo>
									<option value="${vo.name}"<#if define5==vo.name>selected="selected"</#if>>${vo.name}</option> </#list>
								</select>
							</div>
						</div>



						<div class="layui-inline">
							<label class="layui-form-label">承担单位：</label>
							<div class="layui-input-inline">
								<select name="fzdwflag" id="fzdwflag">
									<option value="">--请选择--</option> <#list fzdwList as vo>
									<option value="${vo.numValue}">${vo.name}</option> </#list>
								</select>
							</div>
						</div>


						<div class="layui-inline">
							<label class="layui-form-label">单位名称：</label>
							<div class="layui-input-inline">
								<input type="text" name="unitName" id="unitName" title="单位名称" placeholder="请输入单位名称" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">拨付状态：</label>
							<div class="layui-input-inline">
								<select name="paymentStatus" id="paymentStatus" lay-filter="paymentStatus">
									<option value="">--请选择--</option> 
									<option value="0">未拨付</option>
									<option value="1">已拨付</option>
								</select>
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">拨付批次：</label>
							<div class="layui-input-inline">
								<select name="define17" id="define17">
									<option value="">--请选择--</option> 
								</select>
							</div>
						</div>
				</div>
				<!-- 
				<button  class="layui-btn layuiadmin-btn-list" id="Open" style="position: absolute;top: 4px;right: 14px; height: 27px;width: 40px;padding: 0;text-align: center;display: block;}">展开</button>
				 -->
				</div>
				</form>
				<div class="layui-inline" style="margin-left: 48px;">
					<button class="layui-btn layuiadmin-btn-list" data-type="searchEvent">
						<i class="layui-icon layui-icon-search layuiadmin-button-btn">查询</i>
					</button>
				</div>
	
	
				<div class="layui-inline">
					<button class="layui-btn layuiadmin-btn-list" data-type="resetEvent">
						<i class="layui-icon  layuiadmin-button-btn">重置</i>
					</button>
				</div>
			</div>

			<div class="layui-card-body">
				<!-- <div class="tableToolBox">
		            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg"
		                    data-type="addEvent">经费拨付
		            </button>
		           <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg"
		                    data-type="editEvent">发送报销通知单
		            </button>
		        </div> -->
				<table id="dataTable" class="layui-table" lay-filter="dataTable" lay-data="{ID:'dataTable',height: '400',limit:100, url:'',totalRow: true,text:{none:''}}">
	                <thead>
		                <tr>
		                	<th lay-data="{type:'numbers', width: 55,align:'center',totalRowText: '合计'}">序号</th>
		                    <th lay-data="{field:'hth', width: 100,align:'center'}">合同号</th>
		                   	<th lay-data="{field:'nd', width: 80,align:'center'}">立项年度</th>
		                    <th lay-data="{field:'ysnd', width: 80,align:'center'}">预算年度</th>
		                    <th lay-data="{field:'define11', width: 100,align:'left'}">经费来源</th>
		                    <th lay-data="{field:'gsbmmc', width: 100,align:'left'}">部门</th>
		                    <th lay-data="{field:'define10', width: 120,align:'left'}">专业处</th>
		                    <th lay-data="{field:'xmmc',align:'left'}">项目名称</th>
		                    <th lay-data="{field:'define8',align:'left'}">承担单位</th>
		                    <th lay-data="{field:'ysje', width: 120,align:'right',totalRow: true,templet : '#view_format'}">金额（万元）</th>
		                    <th lay-data="{field:'paymentPlanStatus', width: 100,align:'center'}">拨付状态</th>
		                    <th lay-data="{field:'define17', width: 100,align:'center'}">拨付批次</th>
		                    <th lay-data="{title:'操作', width: 120,align:'center', templet:function(d){return '<a class=\'layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg demo-delete\'>经费拨付</a>'}}">操作</th>
		                </tr>
	                </thead>
	            </table>
			</div>
		</div>
	</div>
	
	<!--表格数据操作js-->
	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script id="view_format" type="text/html"> {{purchase_money_jf(d.ysje)}} </script>
	

	<script>
		var selectRowData, laydate;
		var xmmc = $('#xmmc').val();
		var form;
		layui.config({
			base : '/layuiadmin/lib/extend/'
		}).use(['jquery', 'form', 'laydate', 'table', 'laypage','layer','publicMethods' ], function() {
			$ = layui.jquery,publicMethods=layui.publicMethods,table = layui.table;
			laydate = layui.laydate;
			form = layui.form;
			form.render();
			laydate.render({
				elem : '#nd',
				type : 'year',
				done : function(value, date, endDate) {
					$("#nd").val(date.year);
				}
			});
			laydate.render({
				elem : '#ysnd',
				type : 'year',
				done : function(value, date, endDate) {
					$("#ysnd").val(date.year);
				}
			});
			//加载表格      

			//移除表头的复选框,去掉全选
			$(".layui-table-header table thead th input").remove();
           /*  $("#Open").click(function() {
                if ($(this).html() == "收起") {
                    $(this).html("展开");
                    $(".select").addClass("layui-hide")
                } else {
                    $(this).html("收起");
                    $(".select").removeClass("layui-hide")

                }
            }); */
			// 触发不同的按钮事件
			var $ = layui.$, active = {
				searchEvent : function() { //点击查询按钮
					renderTable();
				},
				resetEvent : function() {
					$('#nd').val("");
					$('#ysnd').val("");
					$('#xmmc').val("");
					$('#define11').val("");
					$("#define11").trigger("change");
					$('#define2').val("");
					$('#define1').val("");
					$('#define5').val("");
					$('#define12').val("");
					$('#hth').val("");
					$('#zylb').val("");
					$('#ktlx').val("");
					$('#project_property').val("");
					$('#groupFlag').val("");
					$('#gsbmbmFlag').val("");
					$('#zycbmFlag').val("");
					$('#zylbbmFlag').val("");
					$('#define17').val("");
					$('#paymentStatus').val("");
					
					form.render();
				}

			};
			//区别按钮属性
			$('.layui-btn').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});

			//监听经费来源
			form.on('select(select_define11)', function(data) {
				//alert(data.value);
				var parentCode = data.value;
				showCompanyName(parentCode);
				getDicByParentCode_company(parentCode, 'define12');
				console.log("监听经费来源:" + data);
			});
			//监听单位性质
			form.on('select(select_define12)', function(data) {
				var parentCode = data.value;
				showCompanyName(parentCode);
				getDicByParentCode_company(parentCode, 'define2');
				console.log("监听单位性质:" + data);
			});
			//监听部门
			form.on('select(select_gsbmbmFlag)', function(data) {
				//alert(data.value);
				var parentCode = data.value;
				getDicByParentCode(parentCode, 'zycbmFlag');
				console.log("监听部门:" + data);
			});

			//监听处室
			form.on('select(select_zycbmFlag)', function(data) {
				var parentCode = data.value;

				getDicByParentCode(parentCode, 'zylbbmFlag');
				console.log("监听处室:" + data);
			});
			//监听拨付状态
			form.on('select(paymentStatus)', function(data) {
				if(data.value==1){
					initPaymentBatchs();
				}else{
					$("#define17").html("<option value=''>--请选择--</option>");
					form.render();
				}
			});
			

			//初始化经费来源
			var define11 = $("#define11").val();
			showCompanyName(define11);
			getDicByParentCode(define11, 'define12');
			var define12 = $("#define12").val();
			showCompanyName(define12);
		

			//初始部门
			var gsbmbmFlag = $("#gsbmbmFlag").val();
			getDicByParentCode(gsbmbmFlag, 'zycbmFlag');

			//renderTable();
		});
		//拨付批次
		function initPaymentBatchs(){
			publicMethods.ajaxAsyncPost("/paymentplan/project-paymentplan-batchs",{"ysnd":$("#ysnd").val()}, function (data) {
    			$("#define17").html("<option value=''>--请选择--</option>");
    			$.each(data,function(index,dt){
    				$("#define17").append("<option value='"+dt.numValue+"'>"+dt.name+"</option>");
    			});
    			form.render();
	   		}); 
		}
		
		function showCompanyName(parentCode){
			if("ROOT_FZJCZX_GSLXCW_GFGS_ZSYJY"==parentCode||"ROOT_FZJCZX_GSLXCW_GFGS"==parentCode||"-1"==parentCode||""==parentCode||null==parentCode){
				$("#lay_company").html("研究院：");
			}else{
				$("#lay_company").html("单位名称：");
			}
		}
		function renderTable() {
			//alert("dd");
			//获取选中的option的文本值
			var define2 = $("#define2 option:selected").text();
			var define12 = $("#define12 option:selected").text();
			var define1 = $("#define1 option:selected").text();
			var define5 = $("#define5 option:selected").text();
			var define11 = $("#define11 option:selected").text();
			var define17 = $("#define17 option:selected").text();
			var fzdwflag = $("#fzdwflag option:selected").text();
			var zylb = $("#zylb option:selected").text();
			
			
			//var groupFlag = $("#groupFlag").val();
			var gsbmbmFlag = $("#gsbmbmFlag").val();
			var zycbmFlag = $("#zycbmFlag").val();
			var zylbbmFlag = $("#zylbbmFlag").val();
			var nd = $("#nd").val();
			var ysnd = $("#ysnd").val();
			var paymentStatus = $("#paymentStatus").val();
			
			
			
			define1 = (define1 == '--请选择--')?'':define1;
			define2 = (define2 == '--请选择--')?'':define2;
			define5 = (define5 == '--请选择--')?'':define5;
			define12 = (define12 == '--请选择--')?'':define12;
			define11 = (define11 == '--请选择--')?'':define11;
			define17 = (define17 == '--请选择--')?'':define17;
			zycbmFlag = (zycbmFlag == '--请选择--')?'':zycbmFlag;
			fzdwflag = (fzdwflag == '--请选择--')?'':fzdwflag;
			zylb = (zylb == '--请选择--')?'':zylb;
			//groupFlag = (groupFlag == '--请选择--')?'':groupFlag;
			
			var param = {"xmmc":$("#xmmc").val(),"hth":$("#hth").val(),"nd":$("#nd").val(),"ysnd":$("#ysnd").val(),
					"define1":define1,"define2":define2,"define5":define5,"define17":define17,
					"define11":define11,"define12":define12,"fzdw":fzdwflag,"paymentStatus":paymentStatus,
					"zylb":zylb,"gsbmbm":gsbmbmFlag,"zycbm":zycbmFlag,"zylbbm":zylbbmFlag};
			console.log(param);
			var lodingMsg = layer.msg('数据加载中....',{time: 15*1000});
			publicMethods.ajaxAsyncPost("/paymentplan/project-info-list-bycondition",param, function (data) {
    			table.reload('dataTable', {data: data,height:commonDislodgeTable()-200,page:false,even: true,limit:data.length,done:function(rs){
    				layer.close(lodingMsg);
    				$('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
    					console.log($(this).text());
    					
    					var index=parseInt($(this).index());
    					console.log(data[index]);
    					var url = '/paymentplan/project_paymentplan_edit?dataId='+data[index].data_id;
                       	publicMethods.openBaseWinFull('经费拨付管理-经费拨付',url);
                    }); 
    				
    			}});
	   		}); 
		}
		
		function view_pro(xmmc, projectProperty, id) {

			layer.open({
				title : '项目进展详情',
				skin : 'layui-layer-lan',
				shadeClose : false,
				type : 2,
				id : "cycle",
				fixed : false,
				//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
				maxmin : true,
				//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
				area : [ '70%', '90%' ],
				content : "/whole-process/science/details?xmid=" + id,
				success : function(layero, index) {
					// var iframe = window['layui-layer-iframe' + index];
					// var iframeH=$(layero).find("iframe");
					//$(iframeH).contents().find(".cycle-img").css("height",$(iframe).height()+"px");
				}
			});
		}
		/**======================================联动=====================================*/
		var define11 = "${define11?default('')}";//单位性质
		var define12 = "${define12?default('')}";//单位性质
		var define2 = "${define2?default('')}";//研究院
		var zycbmFlag = "${zycbmFlag?default('')}";
		var zylbbmFlag = "${zylbbmFlag?default('')}";

		//alert(define11);

		//获取单位性质
		function getDicByParentCode(parentCode, downId) {
			//alert(parentCode+"--"+downId);
			$("#" + downId).empty();
			if (parentCode == null || parentCode == '') {
				parentCode = '-1';
			}
			console.log("级联：\n parentCode=" + parentCode + " downId=" + downId);
			var v_date = (new Date()).getTime();
			if (parentCode != null && parentCode != '') {

				$.ajax({
					url : "/sre-project-basic/getDicListByParentCode?v_date=" + v_date + "&parentCode=" + parentCode,
					type : "post",
					async : false,
					dataType : "json",
					success : function(data) {
						$("#" + downId).append("<option value=''>--请选择--</option>");
						$.each(data, function(i, el) {
							$("#" + downId).append('<option value="'+ el.code +'">' + el.name + '</option>');
							if (define12 == el.name) {
								$("#" + downId).val(el.code);
							}
							if (define2 == el.name) {
								$("#" + downId).val(el.code);
							}
							if (zycbmFlag == el.name) {
								$("#" + downId).val(el.code);
							}
							if (zycbmFlag == el.name) {
								$("#" + downId).val(el.code);
							}

						});
						form.render();
					},
					error : function() {
						alert("发生未知错误 ,请重新操作.");
					}
				});

			}
			var code_temp = $("#" + downId).val();
			//如果ID=单位性质 ,再调用一次，形成第三级
			if (downId == 'define12') {
				getDicByParentCode(code_temp, 'define2');
			}
			if (downId == 'zycbmFlag') {
				getDicByParentCode(code_temp, 'zylbbmFlag');
			}
			form.render();
		}
		//获取单位性质
		function getDicByParentCode_company(parentCode, downId) {
			//alert(parentCode+"--"+downId);
			$("#" + downId).empty();
			if (parentCode == null || parentCode == '') {
				parentCode = '-1';
			}
			console.log("级联：\n parentCode=" + parentCode + " downId=" + downId);
			var v_date = (new Date()).getTime();
			if (parentCode != null && parentCode != '' && parentCode!="-1") {
				if((downId=="define2"&&parentCode=="ROOT_FZJCZX_GSLXCW_GFGS_ZSYJY")||downId=="define12"||downId=="zylbbmFlag"){
				$.ajax({
					url : "/sre-project-basic/getDicListByParentCode?v_date=" + v_date + "&parentCode=" + parentCode,
					type : "post",
					async : false,
					dataType : "json",
					success : function(data) {
						$("#" + downId).append("<option value='-1'>--请选择--</option>");
						$.each(data, function(i, el) {
							$("#" + downId).append('<option value="'+ el.code +'">' + el.name + '</option>');
							if (define12 == el.name) {
								$("#" + downId).val(el.code);
							}
							if (define2 == el.name) {
								$("#" + downId).val(el.code);
							}
							if (zycbmFlag == el.name) {
								$("#" + downId).val(el.code);
							}
							if (zycbmFlag == el.name) {
								$("#" + downId).val(el.code);
							}

						});
						form.render();
					},
					error : function() {
						alert("发生未知错误 ,请重新操作.");
					}
				});
				}else{
					$.ajax({
						url : "/out/project-company-list",
						type : "post",
						async : false,
						dataType : "json",
						data:{
							"jfly":$("#define11").find("option:selected").text(),
							"dwxz":$("#define12").find("option:selected").text()
						},
						success : function(data) {
							$("#" + downId).append("<option value=''>--请选择--</option>");
							$.each(data, function(i, el) {
								$("#" + downId).append('<option value="'+ el.define8 +'">' + el.define8 + '</option>');
								if (define12 == el.name) {
									$("#" + downId).val(el.dataId);
								}
								if (define2 == el.name) {
									$("#" + downId).val(el.dataId);
								}
								if (zycbmFlag == el.name) {
									$("#" + downId).val(el.dataId);
								}
								if (zycbmFlag == el.name) {
									$("#" + downId).val(el.dataId);
								}

							});
							form.render();
						},
						error : function() {
							alert("发生未知错误 ,请重新操作.");
						}
					});
				}
			}else if((parentCode==null||"-1"==parentCode)&&downId=="define12"){
				if((""==$("#define11").val()||undefined==$("#define11").val())&&(""==$("#define12").val()||undefined==$("#define12").val())){
					parentCode = "ROOT_FZJCZX_GSLXCW_GFGS_ZSYJY";
					downId = "define2";
					$.ajax({
						url : "/sre-project-basic/getDicListByParentCode?v_date=" + v_date + "&parentCode=" + parentCode,
						type : "post",
						async : false,
						dataType : "json",
						success : function(data) {
							$("#" + downId).append("<option value='-1'>--请选择--</option>");
							$.each(data, function(i, el) {
								$("#" + downId).append('<option value="'+ el.code +'">' + el.name + '</option>');
								if (define12 == el.name) {
									$("#" + downId).val(el.code);
								}
								if (define2 == el.name) {
									$("#" + downId).val(el.code);
								}
								if (zycbmFlag == el.name) {
									$("#" + downId).val(el.code);
								}
								if (zycbmFlag == el.name) {
									$("#" + downId).val(el.code);
								}

							});
							form.render();
						},
						error : function() {
							alert("发生未知错误 ,请重新操作.");
						}
					});
				}
			}
			var code_temp = $("#" + downId).val();
			//如果ID=单位性质 ,再调用一次，形成第三级
			if (downId == 'define12') {
				getDicByParentCode(code_temp, 'define2');
			}
			if (downId == 'zycbmFlag') {
				getDicByParentCode(code_temp, 'zylbbmFlag');
			}
			form.render();
		}
		function purchase_money(jf) {
			return '<span style="color:red">' + jf + '</span>';
		}
		function purchase_money_jf(jf) {
			
			if (jf != null) {
				var h_strs = jf.substring(jf.lastIndexOf("."), jf.length);
				if (h_strs == '.0000') {
					jf = jf.replace(".0000", "");
				}
				return '<span style="color:green">' + jf + '</span>';
			} else {
				return "<span></span>";
			}
		}
	</script>
</body>

</html>
