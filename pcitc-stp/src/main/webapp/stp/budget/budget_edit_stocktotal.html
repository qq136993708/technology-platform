<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>新增编制单位</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        .con-box{margin: 5px auto;margin-bottom: 0;margin-right: 50px;}
        .layui-form-label {width: 108px !important;}
        .layui-input-block {margin-left: 129px !important;}
        .btn-line {height: 36px;line-height: 36px;}
        .btn-line a{float: left;margin-left: 20px;}       
        .layui-textarea {min-height: 50px;}
        
    </style>
</head>
<body>
<form action="" id="stock-form" lay-filter="stock-form" class="layui-form">
	<input type="hidden" name="budgetInfoId" value="${budgetInfoId}">
	<input type="hidden" name="dataId" value="${dataId}">
	<input type="hidden" name="nd" id="nd" value="${nd}">
    <div class="con-box">
        <div class="formBox">
            <div class="layui-row">
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">序号<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                            <input class="layui-input" id="no" name="no" placeholder="" lay-verify="required" autocomplete="off" type="text">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">类别<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                            <input type="text" name="displayName" id="displayName" placeholder="" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row">
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">预算类型<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                        	<select name="displayCode" id="displayCode" lay-verify="required"  lay-filter="displayCode">
								<option value="">请选择</option>
							</select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">上级类别<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
							<div class="selectTreeBox">
								<div id="parentDataId" class="layui-form-select select-tree"></div>
							</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row">
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">资本性预算<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                            <input class="layui-input" id="xmjfZbx" name="xmjfZbx" placeholder="" lay-verify="required|number" autocomplete="off" type="text">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="xmjfFyx" name="xmjfFyx"  placeholder="" lay-verify="required" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-row">
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">费用性结转<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                            <input class="layui-input" id="xmjfFyxJz" name="xmjfFyxJz" placeholder="" lay-verify="required|number" autocomplete="off" type="text">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">费用性新签<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                         	<input class="layui-input" id="xmjfFyxXq" name="xmjfFyxXq"  placeholder="" lay-verify="required|number" autocomplete="off" type="text">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row">
                <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">备注</label>
                        <div class="layui-input-block">
                            <textarea placeholder=""  id="remark" name="remark" class="layui-textarea"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <div class="form-bottom">
        <div class="form-bottom-btns">
            <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit lay-filter="saveEvent">保存</button>
            <button type="button"
                    class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white"
                    id="cancel">取消
            </button>
        </div>
    </div>
</form>
<script>
    window.viewObj = 
    {
        tbData: []
    }
    //{dataId:'10001',tempId: 1, displayName: '机动(资金预留)', level:1,plan: 0, xmjf: 0, zxjf: 0,parentDataId:"${dataId}",budgetInfoId:"${budgetInfoId}"}
    var budgetInfoId = "${budgetInfoId}";
    var parentDataId = "${dataId}";
    var nd = "${nd}";
    var parentInfo = null;
    var company_map = {};
    var unit_map = {};
    var unitTree;
    layui.use(['jquery', 'table', 'form','laydate', 'layer','publicMethods','selectTree'], function () {
        var $ = layui.jquery, table = layui.table, form = layui.form,laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods,selectTree=layui.selectTree;
        var layTableId = "dataTable";
        var unitSelectTree;
        
      	//股份公司分类编码字典 ROOT_JFYS_GFDWFL（动态字典，如果设置了年度字典则按年度字典获取）
   		publicMethods.ajaxPost('/budget/get-stockitem-type-dictionary', {"nd":nd}, function (data, status) { 
   	    	$.each(data,function(i,dt){
   	    		$("#displayCode").append("<option value='"+data[i].code+"'>"+data[i].name+"</option>");
   	    	});
   	    });
        
        //初始化级别选择
        publicMethods.ajaxPost("/budget/search-stockitem-tree",{"dataId":budgetInfoId}, function(data,status){
        	unitTree = selectTree.initSelectTree("parentDataId", false, true, true, true,data);
        	selectTree.initHideMenu();
        	$.each(data,function(index,dt){
        		unit_map[dt.id]=dt.name;
        	});
   		});  
        
		publicMethods.ajaxPost("/budget/get-stocktotal-item-company/${dataId}",null, function (data) {
			if(data.parentDataId){
				$("input[id='parentDataId']").attr("value",data.parentDataId);				
				$("#parentDataIdShow").attr("title",unit_map[data.parentDataId]);
	    		$("#parentDataIdShow").attr("value",unit_map[data.parentDataId]);
			}
			form.val("stock-form",data);
			parentInfo = data;
			$.each(data.groups,function(index,dt){
				selectItemProjectMoney(parseInt(dt.nd)-1,dt.displayCode,function(ysje){
					dt.last_year_end = ysje;
				});
				selectItemPlanMoney(dt.nd,dt.displayCode,function(ysje){
					dt.plan_money = ysje;
				});
				viewObj.tbData.push(dt);
			});
   		});
        
        form.verify({
        	parentDataId:function(value,item){
				if(value=='' || value==null || value == "undefined")
				{
					return "请选择上级单位!";
				}
			}
        });
      	
        //激活事件
        var activeByType = function (type, arg) {
            if(arguments.length === 2){
                active[type] ? active[type].call(this, arg) : '';
            }else{
                active[type] ? active[type].call(this) : '';
            }
        };

        //注册按钮事件
        $('.layui-btn[data-type]').on('click', function () {
            var type = $(this).data('type');
            activeByType(type);
        });

        //监听select下拉选中事件
        form.on('select(type)', function(data){
            var elem = data.elem; //得到select原始DOM对象
            $(elem).prev("a[lay-event='type']").trigger("click");
        });
        
        // 点击保存按钮
        form.on('submit(saveEvent)', function(data){
        	data.field.xmjfFyx = parseInt(data.field.xmjfFyxJz) + parseInt(data.field.xmjfFyxXq);
            var lodingMsg = layer.msg('处理中....');
            data.field.parentDataId = $("input[name='parentDataId']").attr("value");
            publicMethods.ajaxPost('/budget/save-stocktotal-item', data.field, function (data, status) {
                if (data.success) {
                	parent.initDataVersion("${budgetInfoId}");
                	parentInfo = data.data;
                	var index = parent.layer.getFrameIndex(window.name);
			       	parent.layer.close(index);
                }else{
                	parent.layer.alert(data.message, {
						title : '信息'
					});
                	layer.close(lodingMsg);
					return false;
                }
                layer.close(lodingMsg);
            }); 
            //一定要加return false -- 2018.07.08
            return false;
        });

        /*点击取消按钮*/
        $("#cancel").click(function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        })
    })
</script>
</body>
</html>