<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>历年参考数据</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        .con-box{margin: 10px 20px;}
        .table-title{height: 30px;line-height: 30px;}
        .margin-bot30{margin-bottom: 10px;}
    </style>
</head>
<body>
<div class="con-box">
    <div class="margin-bot30">
        <table id="itemTable" class="layui-table" lay-filter="itemTable" lay-data="{limit:100}">
            	<thead>
	                <tr>
	                	<th lay-data="{field:'nd',align: 'center', width: 100}" rowspan="3">年度</th>
	                    <th lay-data="{field:'displayName', width: '20%'}" rowspan="3">预算项目</th>
	                   	<th lay-data="{field:'jtgs', edit:true,align: 'right',width:'80'}" rowspan="3">集团公司</th>
	                    <th lay-data="{align: 'center'}" colspan="9">股份公司</th>
	                    <th lay-data="{field:'xtw', edit:true,align:'right'}" rowspan="3"><span></span>系统外</th>
	                </tr>
	                <tr>
	                    <th lay-data="{align:'center'}"  colspan="8"><span></span>直属院</th>
	                    <th lay-data="{field:'gfFzgs', edit:true,align: 'right',width:'80'}"  rowspan="2">分子公司</th>
	                </tr>
	                <tr>
	                    <th lay-data="{field:'gfZsyKty', edit:true,align: 'right'}">勘探院</th>
	                    <th lay-data="{field:'gfZsyGcy', edit:true,align: 'right'}">工程院</th>
	                    <th lay-data="{field:'gfZsyWty', edit:true,align: 'right'}">物探院</th>
	                    <th lay-data="{field:'gfZsySky', edit:true,align: 'right'}">石科院</th>
	                    <th lay-data="{field:'gfZsyBhy', edit:true,align: 'right'}">北化院</th>
	                    <th lay-data="{field:'gfZsyFyy', edit:true,align: 'right'}">抚研院</th>
	                    <th lay-data="{field:'gfZsyShy', edit:true,align: 'right'}">上海院</th>
	                    <th lay-data="{field:'gfZsyQdy', edit:true,align: 'right'}">青岛院</th>
	                </tr>
                </thead>
        </table>
    </div>
    <div class="bottom-table-box">
        <table id="historyItemTable" class="layui-table" lay-filter="historyItemTable" lay-data="{height: '250',limit:100}">
            <thead>
	             <tr>
	                	<th lay-data="{field:'nd',align: 'center', width: 100}" rowspan="3">年度</th>
	                    <th lay-data="{field:'displayName', width: '20%'}" rowspan="3">预算项目</th>
	                   	<th lay-data="{field:'jtgs', edit:true,align: 'right',width:'80'}" rowspan="3">集团公司</th>
	                    <th lay-data="{align: 'center'}" colspan="9">股份公司</th>
	                    <th lay-data="{field:'xtw', edit:true,align:'right'}" rowspan="3"><span></span>系统外</th>
	                </tr>
	                <tr>
	                    <th lay-data="{align:'center'}"  colspan="8"><span></span>直属院</th>
	                    <th lay-data="{field:'gfFzgs', edit:true,align: 'right',width:'80'}"  rowspan="2">分子公司</th>
	                </tr>
	                <tr>
	                    <th lay-data="{field:'gfZsyKty', align: 'right'}">勘探院</th>
	                    <th lay-data="{field:'gfZsyGcy', align: 'right'}">工程院</th>
	                    <th lay-data="{field:'gfZsyWty', align: 'right'}">物探院</th>
	                    <th lay-data="{field:'gfZsySky', align: 'right'}">石科院</th>
	                    <th lay-data="{field:'gfZsyBhy', align: 'right'}">北化院</th>
	                    <th lay-data="{field:'gfZsyFyy', align: 'right'}">抚研院</th>
	                    <th lay-data="{field:'gfZsyShy', align: 'right'}">上海院</th>
	                    <th lay-data="{field:'gfZsyQdy', align: 'right'}">青岛院</th>
	                </tr>
            </thead>
        </table>
    </div>
</div>
<div class="form-bottom">
    <div class="form-bottom-btns">
        <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" data-type="saveEvent">保存
        </button>
        <button type="button"
                class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white"
                id="cancel">取消
        </button>
    </div>
</div>
    <script>
        window.viewObj = {
            itemData: [
            ],
            historyItemData: [
            ]
        }
       	layui.use(['jquery', 'table', 'laydate', 'layer','publicMethods'], function () {
            var $ = layui.jquery, table = layui.table, laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods;
            var budgetInfoId = "${budgetInfoId}";
            var dataId = "${dataId}";
            var groupTotalInfo = null;
            //加载预算项
            publicMethods.ajaxPost("/budget/get-techsplit-item/"+dataId,null, function (data) {
            	$(".nd").html(data.nd);
            	groupTotalInfo = data;
            	viewObj.itemData.push(groupTotalInfo);
    			table.reload('itemTable',{
                    data:viewObj.itemData
                });
    			//加载历史
    			publicMethods.ajaxPost("/budget/search-techsplit-history-items",groupTotalInfo, function (historydata) {
                	$.each(historydata,function(index,dt){
                		viewObj.historyItemData.push(dt);
                	});
        			table.reload('historyItemTable',{
                        data:viewObj.historyItemData
                    });
           		});
       		});
            //预算项编辑事件监听
            table.on('edit(itemTable)', function(obj){ 
            	$.each(viewObj.itemData,function(index,dt){
            		if(obj.data.dataId == dt.dataId){
            			if(obj.field=="jtgs"){
            				dt.jtgs = obj.value;
            			}else if(obj.field=="gfZsyKty"){
            				dt.gfZsyKty = obj.value;
            			}else if(obj.field=="gfZsyGcy"){
            				dt.gfZsyGcy = obj.value;
            			}else if(obj.field=="gfZsyWty"){
            				dt.gfZsyWty = obj.value;
            			}else if(obj.field=="gfZsySky"){
            				dt.gfZsySky = obj.value;
            			}else if(obj.field=="gfZsyBhy"){
            				dt.gfZsyBhy = obj.value;
            			}else if(obj.field=="gfZsyFyy"){
            				dt.gfZsyFyy = obj.value;
            			}else if(obj.field=="gfZsyShy"){
            				dt.gfZsyShy = obj.value;
            			}else if(obj.field=="gfZsyQdy"){
            				dt.gfZsyQdy = obj.value;
            			}else if(obj.field=="gfFzgs"){
            				dt.gfFzgs = obj.value;
            			}else if(obj.field=="xtw"){
            				dt.xtw = obj.value;
            			}
            		}
            	});
            	//刷新表格数据
            	table.reload('itemTable', {data: viewObj.itemData});
            });
            $('.layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            var $ = layui.$, active = {
           		saveEvent: function () {
           			publicMethods.ajaxPost('/budget/save-techsplit-item', viewObj.itemData[0], function (data, status) {
       	                if (data.success) {
       	                	parent.initDataVersion("${budgetInfoId}");
       	                	var index = parent.layer.getFrameIndex(window.name);
        			       	parent.layer.close(index);
       	                }else{
       	                	parent.layer.alert("操作失败请重试", {
       							title : '信息'
       						});
       						return;
       	                }
        	        }); 
               	}
            }
            /*点击取消按钮*/
            $("#cancel").click(function () {
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            }); 
        })
    </script>
</body>
</html>