<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>预算合计</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        .con-box{margin: auto 20px;}
        .date-box{position: relative;width: 135px;height: 50px; line-height: 50px; vertical-align: middle;}
        .date-box input{ height: 30px; width: 135px;border: 1px solid #c0c0c0;border-radius: 2px; padding-left: 6px;}
        .date-box i{position: absolute;top: 0; right: 0;}
        .create-table{width: 100%;height: 110px;margin-bottom: 50px;}
        .dashborder-box{width: 100%;height: 108px; margin: 0 auto; border: 1px dashed #cccccc;}
        .lg-btn{position: absolute;left: 50%; top: 50%; -webkit-transform: translate(-50%,-50%);-moz-transform: translate(-50%,-50%);
            transform:translate(-50%,-50%);height: 48px; line-height: 48px; width: 178px; text-align: center;border: 1px solid #cccccc; border-radius: 2px; cursor: pointer;}
        .lg-btn.left-btn{left: 30%;}
        .dashborder-box select{position: absolute; width: 150px; left: 70%; top: 50%;-webkit-transform: translate(-50%,-50%);-moz-transform: translate(-50%,-50%);
            transform:translate(-50%,-50%);}
    </style>
</head>
<body>
<div class="con-box">
	<div class="date-box">
        
    </div>
    <div id="tableBox">
        <table id="dataTable" class="layui-table" lay-filter="dataTable" lay-data="{ID:'dataTable',limit:100, url:'',totalRow: true}">
            <thead>
             <tr>
             	<th lay-data="{type:'numbers',align: 'center', width: 65, totalRowText: '合计'}">序号</th>
             	<th lay-data="{field:'organName',align: 'left'}" >专业处/部门</th>
                 <th lay-data="{field:'total', align: 'right',totalRow: true}">预算合计</th>
                 <th lay-data="{field:'groupMoney',align:'right',totalRow: true}">集团公司预算</th>
                 <th lay-data="{field:'assetMoney',align:'right',totalRow: true}">资产公司预算</th>
                 <th lay-data="{field:'stockMoney',align:'right',totalRow: true}">股份公司预算</th>
             </tr>
            </thead>
        </table>
    </div>
</div>
<div class="form-bottom">
    <div class="form-bottom-btns">
        <button type="button"
                class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white"
                id="cancel">关闭
        </button>
    </div>
</div>
<script>
	//删除对象
	
	layui.use(['jquery', 'table', 'laydate', 'layer','publicMethods'], function () {
		var $ = layui.jquery, table = layui.table, laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods;
		var cu_date = "${nd}";
		var select_date ="${nd}";
		var unitCodes = "${unitCodes?default(0)}";
		var curent_tabel_data = null;
	 	laydate.render({
           	elem: '#choose-year'
           	,value: cu_date
           	,type: 'year'
           	,done:function (val, date, endDate) {
           		select_date = val;
            		reloadTable();
            }
	 	});
	    function reloadTable()
	    {
	    	var table_map = {};
	    	function reflush()
	    	{
	    		var table_data = [];
	    		$.each(table_map,function(k,v){
	    			v.total = v.groupMoney+v.assetMoney+v.stockMoney;
		    	    table_data.push(v);
		    	});
	    		table.reload('dataTable', {data: table_data});
	    		//格式化求和
				$.each($(".layui-table-total tr td"),function(i,d){
					if(i>=2){
						var val = $(this).find("div").html();
						$(this).find("div").html(parseInt(val));
					}
				});
	    	}
	    	//资产单位
	    	publicMethods.ajaxAsyncPost("/budget/budget-assetsplit-items",{page:1,limit:100,param: {"budget_info_id":"${assetDataId}","unitCodes":unitCodes}}, function (data) {
	       		$.each(data.data,function(i,d){
	       			if(!table_map[d.organId]){
	       				table_map[d.organId]={"organId":d.organId,"organName": d.organName,"total":0,"groupMoney":0,"assetMoney":0,"stockMoney":0};
	       			}
	       			table_map[d.organId].assetMoney = (table_map[d.organId].assetMoney + d.total);
	       		});
	       		reflush();
			});
	    	publicMethods.ajaxAsyncPost("/budget/budget-groupsplit-items",{page:1,limit:100,param: {"budget_info_id":"${groupDataId}","unitCodes":unitCodes}}, function (data) {
	    		$.each(data.data,function(i,d){
	       			if(!table_map[d.organId]){
	       				table_map[d.organId]={"organId":d.organId,"organName": d.organName,"total":0,"groupMoney":0,"assetMoney":0,"stockMoney":0};
	       			}
	       			table_map[d.organId].groupMoney = (table_map[d.organId].groupMoney + d.total);
	       		});
	       		reflush();
		   	});
	    	publicMethods.ajaxAsyncPost("/budget/budget-stocksplit-zsy-items",{page:1,limit:100,param: {"budget_info_id":"${stockZsyDataId}","unitCodes":unitCodes}}, function (data) {
	    		$.each(data.data,function(i,d){
	       			if(!table_map[d.organId]){
	       				table_map[d.organId]={"organId":d.organId,"organName": d.organName,"total":0,"groupMoney":0,"assetMoney":0,"stockMoney":0};
	       			}
	       			table_map[d.organId].stockMoney = (table_map[d.organId].stockMoney + d.total);
	       		});
	       		reflush();
			});
	    	publicMethods.ajaxAsyncPost("/budget/budget-stocksplit-zgs-items",{page:1,limit:100,param: {"budget_info_id":"${stockZgsDataId}","unitCodes":unitCodes}}, function (data) {
	    		$.each(data.data,function(i,d){
	       			if(!table_map[d.organId]){
	       				table_map[d.organId]={"organId":d.organId,"organName": d.organName,"total":0,"groupMoney":0,"assetMoney":0,"stockMoney":0};
	       			}
	       			table_map[d.organId].stockMoney = (table_map[d.organId].stockMoney + d.total);
	       		});
	       		reflush();
			});
	    	publicMethods.ajaxAsyncPost("/budget/budget-stocksplit-xtw-items",{page:1,limit:100,param: {"budget_info_id":"${stockXtwDataId}","unitCodes":unitCodes}}, function (data) {
	    		$.each(data.data,function(i,d){
	       			if(!table_map[d.organId]){
	       				table_map[d.organId]={"organId":d.organId,"organName": d.organName,"total":0,"groupMoney":0,"assetMoney":0,"stockMoney":0};
	       			}
	       			table_map[d.organId].stockMoney = (table_map[d.organId].stockMoney + d.total);
	       		});
	       		reflush();
			});
	    }
	    reloadTable();
	    /*点击取消按钮*/
	    $("#cancel").click(function () {
	        var index = parent.layer.getFrameIndex(window.name);
	        parent.layer.close(index);
	    })
	})
</script>
</body>
</html>