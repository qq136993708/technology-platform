<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>机构选择</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
    <link rel="stylesheet" href="/layuiadmin/style/common.css">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        .onlyTree_container .treeBox{ width: 100%; border: 0; left: 0;  padding-top: 0; padding-bottom: 36px;}
        .onlyTree_container ul>li{ padding-left: 10px;}
        .onlyTree_container .treeBox.search .ztree{padding-top: 32px;}
        .onlyTree_container .title-box {line-height: 30px;}
    </style>
</head>
<body>
    <div class="onlyTree_container">
        <div class="treeBox search">
            <div class="title-box">
                <label class="dateInput">
                    <span>搜素</span>
                    <input type="text" class="form-control" name="searchUnitName" id="searchUnitName" placeholder="请输入机构名称" autocomplete="off" >
                </label>
            </div>
            <div class="layui-side-scroll">
                <!-- 左侧子菜单 -->
                <ul id="unitTree" class="ztree"></ul>
            </div>
        </div>

        <div class="form-bottom">
            <div class="form-bottom-btns">
                <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" id="sub">确定</button>
                <button class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="cancel">关闭</button>
            </div>
        </div>
    </div>
    <!--树js-->
    <script type="text/javascript">
        layui.use(['jquery','jqZtreeCore','table','laydate','layer','publicMethods'], function () {
        	var $ = layui.jquery, table = layui.table, laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods; 
            var zTreeObj,treeData,sTreeObj,nodes,treeDataMap={};
            var searchTreeData = [];
        	var setting = 
        	{
        		check: { enable: true, chkStyle: "radio", radioType: "all" },//单选按钮
        	    data: {simpleData: {enable: true}},
        	    callback: {onClick: onClickMenu}
        	};
        	function onClickMenu(event,treeId,treeNode,clickFlag) {
        		zTreeObj.checkNode(treeNode);
        		/* if(treeNode.checked){
        			parent.addUnitToTable(treeNode);
        		} */
        		/* var n = "";
        		nodes=zTreeObj.getCheckedNodes(true);
                for(var i=0;i<nodes.length;i++){
                    n+=nodes[i].name + ",";
                }
                console.log(n)//获取选中节点的值  */
        	}
            publicMethods.ajaxPost("/budget/search-group-company-tree",null, function (dt) {
            	treeData = dt;
            	$.each(dt,function(index,d){
            		treeDataMap[d.id]=d;
            	});
            	zTreeObj = $.fn.zTree.init($("#unitTree"), setting, treeData);
    			zTreeObj.expandAll(true);
            });
            function loadUnitTree(){
            	//搜索前初始化
            	zTreeObj = $.fn.zTree.init($("#unitTree"), setting, treeData);
            	var nodeList = zTreeObj.getNodesByParamFuzzy("name", $("#searchUnitName").val());
            	searchTreeData = [];
            	$.each(nodeList,function(index,dt){
            		searchTreeData.push(treeDataMap[dt.id]);
            	});
            	zTreeObj = $.fn.zTree.init($("#unitTree"), setting, searchTreeData);
            	zTreeObj.expandAll(true);
            }
          	//检索(改变事件)
        	$("#searchUnitName").on("change",function(){
        		loadUnitTree();
        	});
        	//检索(键盘回车)
        	$(document).keyup(function (e) {
        	    if (e.keyCode == 13) {
        	    	loadUnitTree();
        	    }
        	});
            // 点击重置按钮时清空勾选的状态
            $('#sub').click(function(){
            	var nodes = zTreeObj.getCheckedNodes();
            	if(nodes.length >0){
					//添加数据
            		parent.createTableData(nodes[0]);
            		parent.layui.table.reload('dataTable', {data : parent.viewObj.tbData});
            	}
            	var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            });
            $('#cancel').click(function(){
          	  var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
          })
        })
    </script>
</body>
</html>