<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>经费预算-经费预算总表</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        body{color: #666666;}
        .headline-box{box-sizing: border-box;padding-top: 10px;height: 106px;width: 100%;margin-bottom: 15px;}
        .headline-title{height: 58px;line-height: 58px;text-align: center;font-size: 20px;color: #000000;}
        .headline-tool{position: relative;height: 52px;margin: 0 10px;}
        .headline-tool .tool-left{position: absolute;left: 0;top: 12px;height: 28px;line-height: 28px;}
        .tool-left input{width: 96px;border: 1px solid #e6e6e6;}
        .tool-left select{width: 150px;border: 1px solid #e6e6e6;}
        .tool-left .dateInput{position: relative;}
        .dateInput i{position: absolute; top: -4px; right: 6px;}
        .headline-tool .tool-center{position: absolute;left: 50%;top: 6px;margin-left: -47px;}
        .headline-tool .tool-right{position: absolute;right: 0;top: 12px;}
        .num-box{float: left;padding-left: 10px; color: red;margin-top: 4px;}
        .num-box input{width: 90px;padding-left: 6px; background: #ffffff; border: 1px solid #e6e6e6;color: red;}
        .content-box{height: 42px; line-height: 42px;margin: 0 10px;}
        .content-box .items{float: left; margin-right: 18px;}
        .content-box .items span{color: #000000;}
        .doc-box{margin: 0 10px;}
        .doc-box p {height: 26px;line-height: 26px;}
        .doc-box ul li{line-height: 26px;}
        .layui-table-header table thead tr th div{text-align: center;}
    </style>
</head>
<body>
    <div class="headline-box">
        <div class="headline-title" title="股份经费预算总表">
            	<span class="nd">${nd}</span> 年各处、部门科技经费预算总表（建议稿）
        </div>
        <div class="headline-tool">
            <div class="tool-left">
                <label class="dateInput">
                    <span>预算年度</span>
                    <input type="text" readonly="readonly" id="choose-year">
                    <i class="layui-icon layui-icon-date"></i>
                </label>
            </div>
        </div>
    </div>
    <div class="tableBox">
        <div class="tableToolBox">
            <div class="num-box">
            </div>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_export btnMyBgImg"
                    data-type="exportEvent">导出
            </button>
        </div>
        <div id="tableBox">
            <table id="dataTable" class="layui-table" lay-filter="dataTable" lay-data="{ID:'dataTable',height: '500',limit:100, url:'',totalRow: true}">
                <thead>
                <tr>
                	<th lay-data="{field:'no',align: 'center', width: 45,totalRowText: '合计'}" rowspan="2">序号</th>
                    <th lay-data="{field:'organName', align:'left',width: '10%'}" rowspan="2">处别</th>
                    <th lay-data="{align:'center'}", colspan="3">经费预算总计</th>
                    <th lay-data="{align:'center'}", colspan="3">（1）集团预算合计</th>
                    <th lay-data="{align:'center'}", colspan="3">（2）资产预算合计</th>
                    <th lay-data="{align:'center'}", colspan="3">（3）股份预算合计</th>
                </tr>
                <tr>
                    <th lay-data="{field:'total',align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'jz', align: 'right',totalRow: true}">老合同</th>
                    <th lay-data="{field:'xq', align: 'right',totalRow: true}">可新签</th>
                    
                    <th lay-data="{field:'group_total',align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'group_jz', align: 'right',totalRow: true}">老合同</th>
                    <th lay-data="{field:'group_xq', align: 'right',totalRow: true}">可新签</th>
                    
                    <th lay-data="{field:'asset_total',align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'asset_jz', align: 'right',totalRow: true}">老合同</th>
                    <th lay-data="{field:'asset_xq', align: 'right',totalRow: true}">可新签</th>
                    
                    <th lay-data="{field:'stock_total',align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'stock_jz', align: 'right',totalRow: true}">老合同</th>
                    <th lay-data="{field:'stock_xq', align: 'right',totalRow: true}">可新签</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
   

    <script>
	    var cu_date = "${nd}";
	    var budget_info_map=null;
	    var curent_tabel_data = null;//当前表格数据
	    var curent_budget_info = null;//当前报表
	    var table_data=[];
        layui.use(['jquery', 'table', 'laydate', 'layer','publicMethods'], function () {
            var $ = layui.jquery, table = layui.table, laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods; 
            var param = JSON.parse(window.localStorage.getItem("param"));
            laydate.render({
                elem: '#choose-year'
                ,value: cu_date
                ,type: 'year'
                ,done:function (val, date, endDate) {
                	cu_date = val;
                	loadData();//初始化数据
                	initDateView();//初始化时间显示相关
                }            
            });
            
            function loadData()
            {
            	table_data=[]
            	publicMethods.ajaxAsyncPost("/budget/get-final-groupsplit",{"nd":cu_date}, function(groups,status){
                	//计算集团合计
            		$.each(groups,function(i,d){
            			table_data.push({"index": i,"no":d.no,"organName":d.organName,"group_total":d.group_total,"group_jz":d.group_jz,"group_xq":d.group_xq,"asset_total":0,"asset_jz":0,"asset_xq":0,"stock_total":0,"stock_jz":0,"stock_xq":0,"total":0,"jz":0,"xq":0});
            		});
            		relaodTable('dataTable',table_data);
            		//计算资产公司
                	publicMethods.ajaxAsyncPost("/budget/get-final-assetsplit",{"nd":cu_date}, function(assets,status){
                		$.each(assets,function(i,d){
                			table_data[i].asset_total = d.asset_total;
                			table_data[i].asset_jz = d.asset_jz;
                			table_data[i].asset_xq = d.asset_xq;
                			
                			table_data[i].total = table_data[i].group_total+table_data[i].asset_total+table_data[i].stock_total;
                			table_data[i].jz = table_data[i].group_jz+table_data[i].asset_jz+table_data[i].stock_jz;
                			table_data[i].xq = table_data[i].group_xq+table_data[i].asset_xq+table_data[i].stock_xq;
                		});
                		relaodTable('dataTable',table_data);
                	});
                	//计算股份公司
                 	publicMethods.ajaxAsyncPost("/budget/get-final-stocksplit",{"nd":cu_date}, function(stocks,status){
                 		$.each(stocks,function(i,d){
                			table_data[i].stock_total = d.stock_total;
                			table_data[i].stock_jz = d.stock_jz;
                			table_data[i].stock_xq = d.stock_xq;
                			
                			table_data[i].total = table_data[i].group_total+table_data[i].asset_total+table_data[i].stock_total;
                			table_data[i].jz = table_data[i].group_jz+table_data[i].asset_jz+table_data[i].stock_jz;
                			table_data[i].xq = table_data[i].group_xq+table_data[i].asset_xq+table_data[i].stock_xq;
                		});
                 		relaodTable('dataTable',table_data);
                 	});
           		});  
            }
            loadData();
			//数据版本选择
            window.relaodTable = function(tableId,tableData){
				table.reload(tableId, {data: tableData});
				//格式化求和
				$.each($(".layui-table-total tr td"),function(i,d){
					if(i>=2){
						var val = $(this).find("div").html();
						$(this).find("div").html(parseInt(val));
					}
				});
			}
			//初始化时间选择
			function initDateView(){
				$(".nd").html(cu_date);
            	$(".layui-table-header .layui-table").find("tr").eq(0).find('th').eq(2).find('span').text(cu_date+"年科技经费预算");
			}
			
            // 点击按钮时激活
            $('.tableBtns').children('button').on('click',function(){
                $(this).addClass('active');
                $(this).siblings().removeClass('active');
            });
            //区别按钮属性
            $('.layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            // 触发不同的按钮事件
            var $ = layui.$, active = {
            	exportEvent:function(){
                	window.open("/budget/budget_download/totalsplit/"+cu_date);
                }
            }
        })
    </script>
</body>
</html>