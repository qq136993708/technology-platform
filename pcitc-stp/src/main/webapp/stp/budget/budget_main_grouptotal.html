<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>经费预算-集团经费预算</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        body{color: #666666;}
        .headline-box{box-sizing: border-box;padding-top: 10px;height: 106px;width: 100%;margin-bottom: 15px;}
        .headline-title{height: 58px;line-height: 58px;text-align: center;font-size: 20px;color: #000000;}
        .headline-tool{position: relative;height: 52px;margin: 0 10px;}
        .headline-tool .tool-left{position: absolute;left: 0;top: 12px;height: 28px;line-height: 28px;}
        .tool-left input{width: 96px;border: 1px solid #e6e6e6;}
        .tool-left select{width: 150px;border: 1px solid #e6e6e6;}
        .tool-left .dateInput{position: relative;}
        .dateInput i{position: absolute; top: -4px; right: 6px;}
        .headline-tool .tool-center{position: absolute;left: 50%;top: 6px;margin-left: -47px;}
        .headline-tool .tool-right{position: absolute;right: 0;top: 12px;}
        .num-box{float: left;padding-left: 10px; color: red;margin-top: 4px;font-size: 14px !important;;}
        .num-box input{width: 90px;padding-left: 6px; background: #ffffff; border: 1px solid #e6e6e6;color: red;}
        .content-box{height: 42px; line-height: 42px;margin: 0 10px;}
        .content-box .items{float: left; margin-right: 18px;}
        .content-box .items span{color: #000000;}
        .doc-box{margin: 0 10px;}
        .doc-box p {height: 26px;line-height: 26px;}
        .doc-box ul li{line-height: 26px;}
        .layui-table-header table thead tr th div{text-align: center;}
    </style>
</head>
<body>
    <div class="headline-box">
        <div class="headline-title" title="集团经费预算总表">
            	<span class="nd">${nd}</span>年集团总部科技经费预算
        </div>
        <div class="headline-tool">
            <div class="tool-left">
                <label class="dateInput">
                    <span>编制年度</span>
                    <input type="text" id="choose-year" readonly="readonly">
                    <i class="layui-icon layui-icon-date"></i>
                </label>
                <label class="selectInput" style="margin-left: 20px;">
                    <span>预算版本</span>
                    <select id="data_version" name="data_version" lay-verify="" lay-filter="test">
                        <option value="">---请选择版本---</option>
                    </select>
                </label>
            </div>
            <div class="tool-center">
                <button class="layui-btn btn-decision active" data-type="createEvent">编制预算</button>
            </div>
            <div class="tool-right">
            	<button class="layui-btn layui-btn-sm btn-decision active" data-type="resetJzEvent">统计老合同预算</button>
                <button class="layui-btn layui-btn-sm btn-decision" data-type="historyCompare">往年预算参考</button>
                <button class="layui-btn layui-btn-sm btn-decision" data-type="historyView">历年参考数据</button>
            </div>
        </div>
    </div>
    <div class="tableBox">
        <div class="tableToolBox">
            <div class="num-box">
                <label class="dateInput">
                    <span>预分配数</span>
                    <input type="text" name="budgetMoney" id="budgetMoney" value="0">
                </label>
                <label class="dateInput">
                    <span>剩余可分配</span>
                    <input type="text" class="readOnlyBox" name="surplusMoney" id="surplusMoney"  readonly="readonly" value="0">
                </label>
                <label class="dateInput"><span id="warningMsg"></span></label>
            </div>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg"
                    data-type="addEvent">新增
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg"
                    data-type="editEvent">编辑
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg"
                    data-type="deleteEvent">删除
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_save2 btnMyBgImg"
                    data-type="saveEvent">保存
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_submit btnMyBgImg"
                    data-type="submitEvent">提交
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_export btnMyBgImg"
                    data-type="exportEvent">导出
            </button>
        </div>
        <div id="tableBox">
            <table id="dataTable" class="layui-table" lay-filter="dataTable" lay-data="{ID:'dataTable',height: '400',limit:100, url:'',totalRow: true}">
                <thead>
                <tr>
                	<th lay-data="{type:'checkbox'}" rowspan="2"></th>
                	<th lay-data="{field:'no',align: 'center', totalRowText: '合计'}" rowspan="2">序号</th>
                    <th lay-data="{field:'displayName', width: '20%'}" rowspan="2">承担单位</th>
                   	<th lay-data="{align:'center',width: '30%',totalRow: true}" colspan="3">${cnd}年经费预算</th>
                    <th lay-data="{align:'right',field:'total',totalRow: true}" rowspan="2">预算合计</th>
                    <th lay-data="{align:'center'}", colspan="3"><span>${nd}</span>年项目经费</th>
                    <th lay-data="{align:'center'}", colspan="3"><span>${nd}</span>年重点实验室专项经费</th>
                </tr>
                <tr>
                 	<th lay-data="{field:'last_year_total', align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'last_year_xmjf', align: 'right',totalRow: true}">项目经费</th>
                    <th lay-data="{field:'last_year_zxjf', align: 'right',totalRow: true}">重点实验室专项</th>
                
                    <th lay-data="{field:'xmjf', align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'xmjfJz', edit:true,align: 'right',totalRow: true}">老合同</th>
                    <th lay-data="{field:'xmjfXq', edit:true,align: 'right',totalRow: true}">可新签</th>
                    
                    <th lay-data="{field:'zxjf', align: 'right',totalRow: true}">预算</th>
                    <th lay-data="{field:'zxjfJz', edit:true,align: 'right',totalRow: true}">老合同</th>
                    <th lay-data="{field:'zxjfXq', edit:true,align: 'right',totalRow: true}">可新签</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="content-box">
        <div class="items">
            状态: <span id="info_status" style="color: red">&nbsp;</span>
        </div>
        <div class="items">
            创建人: <span id="creater_name" style="color: red">&nbsp;</span>
        </div>
        <div class="items">
            创建日期: <span id="create_time" style="color: red">&nbsp;</span>
        </div>
        <div class="items">
            最后更新: <span id="update_time" style="color: red">&nbsp;</span>
        </div>
    </div>
    <div class="doc-box">
        <p>请注意:</p>
        <ul>
            <li>1、预分配数请自行设定，剩余可分配数为预分配数减去已填入的预算数之差，剩余可分配数自动计算，不可更改</li>
            <li>2、预算编制状态包括：编制中、审批中、审批驳回、审批通过、最终预算等五种，审批发起后不可再编辑</li>
            <li>3、预算按年度编制，编制年度可自定义，默认编制下一年度</li>
            <li>4、预算表创建时生成一个版本号，版本号规则：vs-年度-三位类别编码-三位顺序号</li>
            <li>5、历年参照预算数据中的数据为该年审批通过的最终预算版本</li>
        </ul>
    </div>

    <script>
	    var cu_date = "${nd}";
	    var budget_info_map=null;
	    var curent_tabel_data = null;//当前表格数据
	    var curent_budget_info = null;//当前报表
	    var selectRowData=null;
        layui.use(['jquery', 'table', 'laydate', 'layer','publicMethods'], function () {
            var $ = layui.jquery, table = layui.table, laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods; 
            var param = JSON.parse(window.localStorage.getItem("param"));
            laydate.render({
                elem: '#choose-year'
                ,value: cu_date
                ,type: 'year'
                ,done:function (val, date, endDate) {
                	cu_date = val;
                	initDataVersion();//初始化预算版本
                	initEmptyData();//空数据初始化
                	initDateView();//初始化时间显示相关
                }            
            });
            renderfunc = function removeHeaderCheckbox(){
            	$(".layui-table-header table thead th .layui-unselect").remove();  //移除表头的复选框,去掉全选
	        	//行单击选中事件绑定
	        	$('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
	              	  var index=parseInt($(this).index()+1);
	                  $('tr').removeClass('layui-table-click');
	                  $(this).addClass('layui-table-click');
	                  $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
	                  $(this).find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
	            }); 
	        }
	        renderfunc();
	        initDateView();
			//数据版本选择
            $("#data_version").on("change",function(e){
            	curent_budget_info = budget_info_map[$("#data_version").val()];            	
            	if(curent_budget_info){
            		var lodingMsg = layer.msg('数据加载中....',{time: 15*1000});
            		publicMethods.ajaxAsyncPost("/budget/budget-grouptotal-items",{page:1,limit:100,param: {"nd":cu_date,"budget_info_id":curent_budget_info.dataId}}, function (data) {
            			layer.close(lodingMsg);
            			curent_tabel_data = data.data;
            			reloadTable('dataTable', data.data);
	                	renderfunc();
	                	//预分配数
	                	initEmptyData(curent_budget_info);
	                	calculationSurplusMoney();
	                	initDateView();
    		   		}); 
            	}else{
            		initEmptyData();
            		initDateView();
            	}
            });
			//空数据初始化
			window.initEmptyData = function(curent_budget_info)
			{
        		if(curent_budget_info){
        			$("#budgetMoney").val(curent_budget_info.budgetMoney);//可分配数
            		$("#creater_name").html(curent_budget_info.createrName);//创建人
            		$("#create_time").html(curent_budget_info.createTime);//创建时间
            		$("#update_time").html(curent_budget_info.updateTime);//最后更新时间
            		$("#info_status").html(curent_budget_info.auditStatusDesc);//状态
        		}else{
        			reloadTable('dataTable', []);
    				$("#budgetMoney").val(0);//可分配数
                	$("#surplusMoney").val(0);//剩余可分配数
            		$("#creater_name").html("");//创建人
            		$("#create_time").html("");//创建时间
            		$("#update_time").html("");//最后更新时间
            		$("#info_status").html("");//状态
        		}
			}
			//初始化时间选择
			function initDateView(){
				$(".nd").html(cu_date);
			
            	$('.laytable-cell-group').eq(0).find('span').text((cu_date-1)+"年经费预算");
            	$('.laytable-cell-group').eq(1).find('span').text((cu_date)+"年项目经费");
            	$('.laytable-cell-group').eq(2).find('span').text((cu_date)+"年重点实验室专项经费");
            	//$(".layui-table-header .layui-table").find('th').eq(3).find('span').text((cu_date-1)+"年预计完成");
            	//$(".layui-table-header .layui-table").find('th').eq(4).find('span').text(cu_date+"年合同计划");
			}
            // 点击按钮时激活
            $('.tableBtns').children('button').on('click',function(){
                $(this).addClass('active');
                $(this).siblings().removeClass('active');
            });
            //区别按钮属性
            $('.layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            table.on('edit(dataTable)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            	if (!(/(^[1-9]\d*$)/.test(obj.value))) {
            		layer.msg('请输入数字!');
            		obj.value = 0;
            	}
            	$.each(curent_tabel_data,function(index,dt){
            		if(obj.data.dataId == dt.dataId){
            			curent_tabel_data[index][obj.field] = parseInt(obj.value);
            			
            			dt.xmjf = parseInt(dt.xmjfJz)+parseInt(dt.xmjfXq);
            			dt.zxjf = parseInt(dt.zxjfJz)+parseInt(dt.zxjfXq);
            			dt.total = parseInt(dt.xmjf)+parseInt(dt.zxjf);
            		}
            	});
            	//刷新表格数据
            	reloadTable('dataTable', curent_tabel_data);
            	renderfunc();
            	//预分配数
            	calculationSurplusMoney();
            });
			$("#budgetMoney").on("keyup",function(){
				if($("#data_version").val()==""){
            		layer.msg("请选择预算版本!",{time:1000});
            		return false;
            	} 
				var m = $("#budgetMoney").val();
				if(publicMethods.isPositiveInteger(m)){
					curent_budget_info.budgetMoney = m;
					calculationSurplusMoney();
				}
			});
			//刷新数据
			window.reloadTable = function(tableId,tableData){
				table.reload(tableId, {data: tableData});
				//格式化求和
				$.each($(".layui-table-total tr td"),function(i,d){
					if(i>=3){
						var val = $(this).find("div").html();
						$(this).find("div").html(parseInt(val));
					}
				});
				//如果是审批中或者最终版本，禁止修改
				if(curent_budget_info && curent_budget_info.auditStatus >= 1){
					$('td[data-edit="true"]').css("pointer-events","none");
				}
			}
          	//初始化数据版本
            function initDataVersion(budget_id){
                publicMethods.ajaxPost("/budget/budget-info-list",{"nd":cu_date,"budgetType":${budgetType}}, function (dt) {
                	$("#data_version").html('<option value="">---请选择版本---</option>');
                	budget_info_map = {};
                	$.each(dt,function(index,data){
                		budget_info_map[data.dataId] = data;
                		$("#data_version").append('<option value="'+data.dataId+'">'+data.dataVersion+'</option>');
                	});
                	if(budget_id){
                    	$("#data_version").val(budget_id);
                    	$("#data_version").trigger("change");
                    }
    		   	});
            }
          	//计算剩余可分配数
          	function calculationSurplusMoney(){
            	var total_money = 0;
            	$.each(curent_tabel_data,function(index,dt){
            		dt.xmjf = parseInt(dt.xmjfJz)+parseInt(dt.xmjfXq);
        			dt.zxjf = parseInt(dt.zxjfJz)+parseInt(dt.zxjfXq);
        			dt.total = parseInt(dt.xmjf)+parseInt(dt.zxjf);
        			
        			total_money += parseInt(dt.total);
            	});
            	var available = parseInt($("#budgetMoney").val())-total_money;
          		$("#surplusMoney").val(available);
          		if(available < 0){
          			$("#warningMsg").html("警告：已超出预算分配数！");
          		}else{
          			$("#warningMsg").html("");
          		}
          		return available;
          	}
          	//将方法转换为全局方法
          	window.initDataVersion = initDataVersion;
            initDataVersion();
            // 触发不同的按钮事件
            var $ = layui.$, active = {
            	createEvent: function () { 
                    var url = '/budget/budget_create_total?nd='+cu_date+'&budgetType=${budgetType}';
                    publicMethods.openBaseWinFull(cu_date+'集团公司经费预算编制管理-创建预算表',url);
                },
                resetJzEvent:function(){
                	if($("#data_version").val()==""){
                		parent.layer.alert("请选择预算版本", {title : '提示'});
                		return;
                	} 
               		var lodingMsg = layer.msg('数据加载中....',{time: 15*1000});
   					publicMethods.ajaxAsyncPost("/budget/select-grouptotal-plandata", {"budget_info_id":curent_budget_info.dataId}, function (data) {
   						layer.msg('加载成功!',{time: 500});
   	                    //console.log(curent_tabel_data);
   						$.each(data,function(index,dt){
   	                    	//console.log(data[index]);
   	                    	$.each(curent_tabel_data,function(i,d){
   	                    		if(data[index].dataId == curent_tabel_data[i].dataId){
   	                    			curent_tabel_data[i].xmjfJz = data[index].xmjfJz;
   	                    			curent_tabel_data[i].zxjfJz = data[index].zxjfJz;
   	                    		}
   	                    	});
   	                    });
	                	//预分配数
	                	calculationSurplusMoney();
						//刷新表格
   	                  	reloadTable('dataTable',curent_tabel_data);
   	                 	renderfunc();
   	                 	initDateView();
   	                });
                },
                addEvent: function() {
                	if($("#data_version").val()==""){
                		parent.layer.alert("请选择预算版本", {title : '提示'});
                		return;
                	}
                	if(curent_budget_info.auditStatus >= 1){
                		parent.layer.alert("状态："+curent_budget_info.auditStatusDesc+" 不可操作!", {title : '提示'});
    					return false;
    				}
                	var url = '/budget/budget_edit_grouptotal?budgetInfoId='+curent_budget_info.dataId+'&nd='+cu_date;
                   	publicMethods.openBaseWinFull('集团公司经费预算编制管理-预算项新增',url);
                },
                editEvent: function() {
                	var selectIndex = $(".layui-form-checked").parents("tr").attr("data-index");
                	if(!selectIndex){
                		parent.layer.alert("请选择需要编辑的行", {title : '提示'});
                		return;
                	}
                	var url = '/budget/budget_edit_grouptotal?dataId='+curent_tabel_data[selectIndex].dataId+"&budgetInfoId="+curent_budget_info.dataId+"&nd="+cu_date;
                   	publicMethods.openBaseWinFull('集团公司经费预算编制管理-预算项编辑',url);
                },
                deleteEvent:function(){
                	var selectIndex = $(".layui-form-checked").parents("tr").attr("data-index");
                	if(!selectIndex){
                		parent.layer.alert("请选择需要删除的行", {title : '提示'});
                		return;
                	}
                	if(curent_budget_info.auditStatus >= 1){
                		parent.layer.alert("状态："+curent_budget_info.auditStatusDesc+" 不可操作!", {title : '提示'});
    					return false;
    				}
                	layer.confirm('确定要删除吗？',{title:"删除确认"},function(index){
    					layer.close(index);
    					publicMethods.ajaxAsyncPost("/budget/del-group-item/"+curent_tabel_data[selectIndex].dataId, null, function (data) {
    	                     if (data.success) {
    	                    	 curent_tabel_data.splice(selectIndex,1);
    	                    	 reloadTable('dataTable', curent_tabel_data);
    	                     	 renderfunc();
    	                     	 calculationSurplusMoney();
    	                     } else {
    	                    	 layer.msg(data.message);
    	                     }
    	                });
                	});
                },
                saveEvent:function(){
                	if($("#data_version").val()==""){
                		parent.layer.alert("请选择需要保存的预算版本", {title : '提示'});
                		return;
                	}
                	if(curent_budget_info.auditStatus >= 1){
                		parent.layer.alert("状态："+curent_budget_info.auditStatusDesc+" 不可操作!", {title : '提示'});
    					return false;
    				}
                	function saveData(){
                		layer.msg("处理中...");
       					publicMethods.ajaxAsyncPost("/budget/save-grouptotal-items", {"info":JSON.stringify(curent_budget_info),"items":JSON.stringify(curent_tabel_data)}, function (data) {
       	                     if (data.success) {    	                    	
       	                    	 layer.msg('保存成功!');
       	                    	 publicMethods.ajaxAsyncPost("/budget/budget-info-get", {"dataId":curent_budget_info.dataId}, function (dt) {
       	                    		budget_info_map[dt.dataId]=dt
       	                    		initEmptyData(dt);
       	   	                	 });  
       	                     } else {
       	                    	layer.msg(data.message);
       	                     }
       	                });  
                	}
                	var rs = calculationSurplusMoney();
                	var msg = "";
                	if(rs > 0)
                	{
                		msg = '剩余可分配数'+rs+' 万元，确定要保存吗？';
                	}
                	if(rs <0){
                		msg = '已超出可分配数'+Math.abs(rs)+' 万元，确定要保存吗？';
                	}
                	if(rs != 0){
                		layer.confirm(msg,{title:"保存确认"},function(index){
                			layer.close(index);
                			saveData();
                		});
                	}else{
                		saveData();
                	}
                },submitEvent:function(){
                	if($("#data_version").val()==""){
                		parent.layer.alert("请选择需要提交的预算版本", {title : '提示'});
                		return;
                	}
                	if(curent_budget_info.auditStatus >= 1){
                		parent.layer.alert("状态："+curent_budget_info.auditStatusDesc+" 不可操作!", {title : '提示'});
    					return false;
    				}
                	layer.confirm('提交后将不可再编辑！确定要提交审批吗？',{title:"提交确认"},function(index){
    					layer.close(index);
    					publicMethods.ajaxAsyncPost("/budget/start-budget-grouptotal-activity", {"budgetInfoId":curent_budget_info.dataId,"functionId":param.id}, function (data) {
    	                     if (data.success) {    	                    	 
    	                    	 budget_info_map[data.data.dataId]=data.data;
    	                    	 $("#info_status").html(data.data.auditStatusDesc);
    	                    	 layer.msg("提交成功!");
    	                     } else {
    	                    	 layer.msg(data.message);
    	                    	 
    	                     }
    	                });
                	});
                },exportEvent:function(){
                	if($("#data_version").val()==""){
                		parent.layer.alert("请选择需要导出的预算版本", {title : '提示'});
                		return;
                	} 
                	window.open("/budget/budget_download/grouptotal/"+curent_budget_info.dataId);
                },historyCompare:function(){
                	var selectIndex = $(".layui-form-checked").parents("tr").attr("data-index");
                	if(!selectIndex){
                		parent.layer.alert("请选择历史数据项", {title : '提示'});
                		return;
                	}
                	var url = '/budget/budget_history_compare_grouptotal?dataId='+curent_tabel_data[selectIndex].dataId+"&budgetInfoId="+curent_budget_info.dataId;
                   	publicMethods.openBaseWinFull('集团公司经费预算编制管理-往年预算参考',url);
                },historyView:function(){
                	if($("#data_version").val()==""){
                		parent.layer.alert("请选择预算版本", {title : '提示'});
                		return;
                	} 
                	var url = '/budget/budget_history_view_grouptotal?budgetInfoId='+curent_budget_info.dataId;
                   	publicMethods.openBaseWinFull('集团公司经费预算编制管理-历年参考数据',url);
                }
            }
        })
    </script>
</body>
</html>