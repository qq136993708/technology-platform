<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>经费预算-集团经费预算</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()">
    <script src="/layuiadmin/layui/layui.js"></script>
    <style>
        body{color: #666666;}
        .headline-box{box-sizing: border-box;padding-top: 10px;height: 106px;width: 100%;margin-bottom: 15px;}
        .headline-title{height: 58px;line-height: 58px;text-align: center;font-size: 20px;color: #000000;}
        .headline-tool{position: relative;height: 52px;margin: 0 10px;}
        .headline-tool .tool-left{position: absolute;left: 0;top: 12px;height: 28px;line-height: 28px;}
        .tool-left input{width: 96px;border: 1px solid #e6e6e6;}
        .tool-left select{width: 150px;border: 1px solid #e6e6e6;}
        .tool-left .dateInput{position: relative;}
        .dateInput i{position: absolute; top: -4px; right: 6px;}
        .headline-tool .tool-center{position: absolute;left: 50%;top: 6px;margin-left: -47px;}
        .headline-tool .tool-right{position: absolute;right: 0;top: 12px;}
        .num-box{float: left;padding-left: 10px; color: red;margin-top: 4px;}
        .num-box input{width: 90px;padding-left: 6px; background: #ffffff; border: 1px solid #e6e6e6;color: red;}
        .content-box{height: 42px; line-height: 42px;margin: 0 10px;}
        .content-box .items{float: left; margin-right: 18px;}
        .content-box .items span{color: #000000;}
        .doc-box{margin: 0 10px;}
        .doc-box p {height: 26px;line-height: 26px;}
        .doc-box ul li{line-height: 26px;}
    </style>
</head>
<body>
    <div class="headline-box">
        <div class="headline-title" title="集团经费预算总表">
            2019年集团总部科技经费预算(建议稿)
        </div>
        <div class="headline-tool">
            <div class="tool-left">
                <label class="dateInput">
                    <span>编制年度</span>
                    <input type="text" id="choose-year">
                    <i class="layui-icon layui-icon-date"></i>
                </label>
                <label class="selectInput" style="margin-left: 20px;">
                    <span>数据版本</span>
                    <select id="data_version" name="data_version" lay-verify="" lay-filter="test">
                        <option value="">---请选择数据版本---</option>
                    </select>
                </label>
            </div>
            <div class="tool-center">
                <button class="layui-btn btn-decision active">编制预算</button>
            </div>
            <div class="tool-right">
                <button class="layui-btn layui-btn-sm btn-decision active">往年预算参考</button>
                <button class="layui-btn layui-btn-sm btn-decision">历年参考数据</button>
            </div>
        </div>
    </div>
    <div class="tableBox">
        <div class="tableToolBox">
            <div class="num-box">
                <label class="dateInput">
                    <span>预分配数</span>
                    <input type="text" name="budgetMoney" id="budgetMoney" value="0">
                </label>
                <label class="dateInput">
                    <span>剩余可分配</span>
                    <input type="text" name="surplusMoney" id="surplusMoney"  readonly="readonly" value="0">
                </label>
            </div>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg"
                    data-type="addEvent">新增
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg"
                    data-type="editEvent">编辑
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg"
                    data-type="deleteEvent">删除
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_save2 btnMyBgImg"
                    data-type="saveEvent">保存
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_submit btnMyBgImg"
                    data-type="deleteEvent">提交
            </button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_export btnMyBgImg"
                    data-type="exportEvent">导出
            </button>
        </div>
        <div id="tableBox">
            <table id="dataTable" class="layui-table" lay-filter="tableData" lay-data="{height: '400', url:'',totalRow: true}">
                <thead>
                <tr>
                	<th lay-data="{type:'numbers', width: 45,totalRowText: '合计'}" rowspan="2">序号</th>
                    <th lay-data="{field:'displayName', width: '25%'}" rowspan="2">承担单位</th>
                    <th lay-data="{field:'remark', width: '30%'}" rowspan="2">研究方向</th>
                   <!--  <th lay-data="{field:'email', width: '15%'}" rowspan="2">2018年科技经费预算完成</th>
                    <th lay-data="{field:'score', width: '15%'}" rowspan="2">2019年科技经费合同计划金额</th> -->
                    <th lay-data="{align:'center'}", colspan="3">2019年预算</th>
                </tr>
                <tr>
                    <th lay-data="{field:'total', width: '10%',align: 'right',totalRow: true}">合计</th>
                    <th lay-data="{field:'xmjf', edit:true,align: 'right',totalRow: true}">科技项目经费预算</th>
                    <th lay-data="{field:'zxjf', edit:true,align: 'right',totalRow: true}">重点实验室专项经费</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="content-box">
        <div class="items">
            状态: <span id="info_status">编制中</span>
        </div>
        <div class="items">
            创建人: <span id="creater_name">刘美</span>
        </div>
        <div class="items">
            创建日期: <span id="create_time">2019-01-20 09:01:00</span>
        </div>
        <div class="items">
            最后更新: <span id="update_time">2019-01-24 18:05:01</span>
        </div>
    </div>
    <div class="doc-box">
        <p>备注及问题:</p>
        <ul>
            <li>1、先填入预分配数，开始分配时，每分配一项对应减少分配数额</li>
            <li>2、表格编制状态包含：编制中、审核中、初审驳回、初审通过、最终稿 五种状态，审批完成则不可再编辑</li>
            <li>3、预算按年度编制，编制年度可自定义</li>
            <li>4、预算表创建时生成一个版本号，版本号规则：vs-年度-三位类别编码-三位顺序号</li>
            <li>5、历年参照预算数据中的数据为该年最后一次审批通过的版本</li>
        </ul>
    </div>

    <script>
        layui.use(['jquery', 'table', 'laydate', 'layer','publicMethods'], function () {
            var $ = layui.jquery, table = layui.table, laydate = layui.laydate, layer = layui.layer,publicMethods=layui.publicMethods;
            var cu_date = "2018";
            var budget_info_map=null;
            var curent_tabel_data = null;//当前表格数据
            var curent_budget_info = null;//当前报表
            laydate.render({
                elem: '#choose-year'
                ,value: cu_date
                ,type: 'year'
                ,done:function (val, date, endDate) {
                	cu_date = val;
                	initDataVersion();
                }
            
            });
			//数据版本选择
            $("#data_version").on("change",function(e){
            	curent_budget_info = budget_info_map[$("#data_version").val()]; 
            	if(curent_budget_info){
            		$("#budgetMoney").val(curent_budget_info.budgetMoney);//可分配数
            		$("#creater_name").html(curent_budget_info.createrName);//创建人
            		$("#create_time").html(curent_budget_info.createTime);//创建时间
            		$("#update_time").html(curent_budget_info.updateTime);//最后更新时间
            		publicMethods.ajaxPost("/budget/budget-grouptotal-items",{page:1,limit:10,param: {"nd":cu_date,"budget_info_id":curent_budget_info.dataId}}, function (data) {
	                	curent_tabel_data = data.data;
	                	table.reload('dataTable', {data: data.data});
	                	//预分配数
	                	calculationSurplusMoney();
    		   		}); 
            	}
            });
            // 点击按钮时激活
            $('.tableBtns').children('button').on('click',function(){
                $(this).addClass('active');
                $(this).siblings().removeClass('active');
            });
            //区别按钮属性
            $('.layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            table.on('edit(tableData)', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            	$.each(curent_tabel_data,function(index,dt){
            		if(obj.data.dataId == dt.dataId){
            			if(obj.field=="xmjf"){
            				dt.xmjf = obj.value;
            			}else if(obj.field=="zxjf")
            			{
            				dt.zxjf = obj.value;
            			}
            			dt.total = parseInt(dt.xmjf)+parseInt(dt.zxjf);
            		}
            	});
            	//刷新表格数据
            	table.reload('dataTable', {data: curent_tabel_data});
            	//预分配数
            	calculationSurplusMoney();
            });
			$("#budgetMoney").on("keyup",function(){
				calculationSurplusMoney();
			});
          	//初始化数据版本
            function initDataVersion(){
                publicMethods.ajaxPost("/budget/budget_group_info_list",{"nd":cu_date}, function (dt) {
                	$("#data_version").html('<option value="">---请选择预算版本---</option>');
                	budget_info_map = {};
                	$.each(dt,function(index,data){
                		budget_info_map[data.dataId] = data;
                		$("#data_version").append('<option value="'+data.dataId+'">'+data.dataVersion+'</option>');
                	});
    		   	});
            }
          	//计算剩余可分配数
          	function calculationSurplusMoney(){
            	var total_money = 0;
            	$.each(curent_tabel_data,function(index,dt){
            		total_money += parseInt(dt.total);
            	});
          		$("#surplusMoney").val(parseInt($("#budgetMoney").val())-total_money);
          	}
            initDataVersion();
            // 触发不同的按钮事件
            var $ = layui.$, active = {
                addEvent: function () { //点击查询按钮
                    layer.open({
                        title: '集团公司经费预算编制管理'
                        , skin: 'layui-layer-lan'
                        , shadeClose: true
                        , type: 2
                        , fixed: false
                        //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                        , maxmin: false
                        //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                        , area: ['60%', '550px']
                        , content: '/budget/budget_group_add'
                    });
                },
                editEvent: function() {
                    layer.open({
                        title: '新增编制单位'
                        , skin: 'layui-layer-lan'
                        , shadeClose: true
                        , type: 2
                        , fixed: false
                        //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                        , maxmin: false
                        //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                        , area: ['60%', '624px']
                        , content: '/budget/budget_group_edit'
                    });
                }
            }
        })
    </script>
</body>
</html>