<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>基础信息维护</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
  <!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
  <link rel="stylesheet" href="/layuiadmin/style/common.css">

  <style>
    body{padding: 10px 10px 0;}
  </style>
</head>
<body>
  <form id="dataForm" class="layui-form" action="" lay-filter="component-form-group layui-container">
    <input type="hidden" name="baseId" id="baseId" value="">
    <input type="hidden" name="functionId" id="functionId" value="cedbab3a94854d42b307adb7fd561218">
    <input type="hidden" name="userIds" id="userIds" value="">
    <div class="box-body">
        <!--行有两个的情况-->
	    <div class="layui-row">
	      <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label for="" class="layui-form-label">姓名<span class="must-fill">*</span></label>
	          <div class="layui-input-block">
	            <input class="layui-input" name="name" lay-verify="title" placeholder="请输入姓名" autocomplete="off" type="text">
	          </div>
	        </div>
	      </div>
	      <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label for="" class="layui-form-label">籍贯<span class="must-fill">*</span></label>
	          <div class="layui-input-block">
	           	<input class="layui-input" name="nativePlace" lay-verify="title" placeholder="请输入籍贯" autocomplete="off" type="text">
	          </div>
	        </div>
	      </div>
	    </div>
        <!--行有两个的情况-->
	    <div class="layui-row">
	      <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label for="" class="layui-form-label">年龄<span class="must-fill">*</span></label>
	          <div class="layui-input-block">
	            <input class="layui-input" name="age" lay-verify="title" placeholder="请输入年龄" autocomplete="off" type="text">
	          </div>
	        </div>
	      </div>
	      <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label for="" class="layui-form-label">学历<span class="must-fill">*</span></label>
	          <div class="layui-input-block">
	           	<input class="layui-input" name="education" lay-verify="title" placeholder="请输入学历" autocomplete="off" type="text">
	          </div>
	        </div>
	      </div>
	    </div>
	    
        <div class="layui-row">
       	   <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label  for="" class="layui-form-label">职称信息</label>
	          <div class="layui-input-block titleInfo">
	            <select id="titleInfo" name="titleInfo" lay-filter="test"></select>
	          </div>
	        </div>
	      </div>
	      <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label  for="" class="layui-form-label">技术领域</label>
	          <div class="layui-input-block">
	           	<select id="technicalField" name="technicalField" lay-filter="test1" lay-search></select>
	          </div>
	        </div>
	      </div>
       </div>
       
       <div class="layui-row">
      	   <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label  for="" class="layui-form-label">专业分类</label>
	          <div class="layui-input-block">
	            <select id="professionalClassification" name="professionalClassification" lay-filter="test2"></select>
	          </div>
	        </div>
	      </div>
	      <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
	        <div class="layui-form-item">
	          <label  for="" class="layui-form-label">技术资格类型</label>
	          <div class="layui-input-block">
	           	<select id="technicalQualificationType" name="technicalQualificationType" lay-filter="test2"></select>
	          </div>
	        </div>
	      </div>
	   </div>
	   
	   <div class="layui-form-item">
       	  <label class="layui-form-label">工作简历</label>
          <div class="layui-input-block">
          	   <textarea placeholder="请输入工作简历" name="workResume" class="layui-textarea"></textarea>
          </div>
       </div>
	   <div class="layui-form-item">
       	  <label class="layui-form-label">奖惩信息</label>
          <div class="layui-input-block">
          	   <textarea placeholder="请输入奖惩信息" name="rewardPunishmentInfo" class="layui-textarea"></textarea>
          </div>
       </div>
       <div class="layui-form-item">
       	  <label class="layui-form-label">回避信息</label>
          <div class="layui-input-block">
          	   <textarea placeholder="请输入回避信息" name="avoidanceInfo" class="layui-textarea"></textarea>
          </div>
       </div>
	    
    </div>
    <div class="layui-form-item layui-layout-admin">
      <div class="layui-input-block">
        <div class="layui-footer">
          <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg" lay-submit="" lay-filter="component-form-demo1">保存</button>
          <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg" lay-submit="" lay-filter="component-form-demo2">提交</button>
          <button class="layui-btn layui-btn-sm fontColor-default border-default ">重置</button>
        </div>
      </div>
    </div>
  </form>
<script src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>

<script>
	var selectData = ""; 
    layui.config({
        base: '/layuiadmin/lib/extend/' //静态资源所在路径
    }).extend({
        enhanceform: 'enhanceform'
    }).use(['jquery','form', 'laydate','table','enhanceform'], function(){
        	var $ = layui.jquery,
        	$$ = parent.layui.jquery,
            admin = layui.admin,
            element = layui.element,
            layer = layui.layer,
            laydate = layui.laydate,
            form = layui.form,
            enhanceForm = layui.enhanceform;
        	
            var enhance = new enhanceForm({
                elem: '#dataForm' //表单选择器
            });
        	
        	var id = "${id}";
    		if (id) {
    			$.ajax({
    				type : 'post',
    				dataType : 'json',
    				async : false,
    				data : {
    					"id" : id
    				},
    				url : '/spe-baseinfoMaintain/getById',
    				success : function(data) {
    					$("input[name=baseId]").val(data.baseId);
    					$("input[name=name]").val(data.name);
    					$("input[name=age]").val(data.age);
    					$("input[name=nativePlace]").val(data.nativePlace);
    					$("input[name=education]").val(data.education);
    					
    					selectData = data;
    					
    					$("textarea[name=workResume]").val(data.workResume);
    					$("textarea[name=rewardPunishmentInfo]").val(data.rewardPunishmentInfo);
    					$("textarea[name=avoidanceInfo]").val(data.avoidanceInfo);
    				},
    				error : function(e) {
    					alertError("出错了！", e);
    				}
    			});
    		}
        	
    		
    		
    		
    		
        /* form.render(null, 'component-form-group');

        laydate.render({
            elem: '#LAY-component-form-group-date'
        });
        //初始赋值
        form.val("component-form-group", {
            "username": "贤心", // "name": "value"
            "sex": "女",
            "auth": 3,
            "check[write]": true,
            "open": false,
            "desc": "我爱layui"
        }) */
        /* 自定义验证规则
        form.verify({
            title: function(value){
                 if(value.length < 5){
                    return '标题至少得5个字符啊';
                } 
            },
            pass: [/(.+){6,12}$/, '密码必须6到12位'],
            content: function(value){
                layedit.sync(editIndex);
            }
        }); */

       
        //下拉菜单
        //职称信息
        $.ajax({
            url:'/tableEncode/dic/ZJK_ZCXX',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#titleInfo').append(new Option(item.name,item.code));//往下拉菜单里添加元素
                })
                form.render();
                enhance.setSelectVal("titleInfo", selectData.titleInfo, true);
            }
        });
        //技术领域
        $.ajax({
            url:'/tableEncode/dic/ZJK_JSLY',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#technicalField').append(new Option(item.name,item.code));//往下拉菜单里添加元素
                })
                form.render();
    			enhance.setSelectVal("titleInfo", selectData.technicalField, true);
            }
        });
        //专业分类
        $.ajax({
            url:'/tableEncode/dic/ZJK_ZYFL',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#professionalClassification').append(new Option(item.name,item.code));//往下拉菜单里添加元素
                })
                form.render();
                enhance.setSelectVal("professionalClassification", selectData.professionalClassification, true);
            }
        });
        //技术资格类型
        $.ajax({
            url:'/tableEncode/dic/ZJK_JSZGLX',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#technicalQualificationType').append(new Option(item.name,item.code));//往下拉菜单里添加元素
                })
                form.render();
                enhance.setSelectVal("technicalQualificationType", selectData.technicalQualificationType, true);
            }
        }); 
        /* 监听提交 */
        form.on('submit(component-form-demo1)', function(data){
            //JSON.stringify(data.field)  提交信息
            /* parent.layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            })
            return false; */
        	$.ajax({
    			type : 'post',
    			dataType : 'json',
    			data : JSON.stringify(data.field),
    			headers: {
                	'Content-Type' : 'application/json',
                },
    			url : '/spe-baseinfoMaintain/save',
    			async : false,
    			success : function(data) {
    				if (data.baseId) {
   		        		var index = parent.layer.getFrameIndex(window.name);
   		             	parent.layer.close(index);
   		        		parent.layer.msg("保存成功");
   		        		//刷新table;
   		        		parent.layui.table.reload('baseinfoMaintain', {});
    				} else {
    					layer.msg("保存失败");
    				}
    			},
    			error : function() {
    				layer.msg("出错了");
    			}
    		});
        	return false;
        });
        form.on('submit(component-form-demo2)', function(data){
        	$.ajax({
		           type : 'POST',
		           url : "/workflow/start/audit-type",
		           //contentType: "application/json;charset=UTF-8",
		           headers: {
		           		'Content-Type' : 'application/json',
		           },
		           async : false,
		           data : JSON.stringify(data.field),
		           //json中有functionId（projectId、departmentId等）用来区别processDefine的属性
		           success : function(data) {
		        	   console.log(data)
		        	   if (data.code == 'role') {
		            		// 按角色选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
		            		roleCodes = data.data;  // 弹出页面的隐藏的查询条件
		            		var temUrl="/task/deal/users/ini";
		                    layer.open({
		                        title:'选择审批人',
		                        skin: 'layui-layer-lan',
		                        shadeClose: true,
		                        type: 2,
		                        fixed: false,
		                        //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
		                        maxmin: false,
		                        //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
		                        area: ['100%', '100%'],
		                        content:  temUrl
		                    });
		            	} else if (data.code == 'unit') {
		            		// 按部门选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
		            		roleCodes = data.data;  // 弹出页面的隐藏的查询条件
		            	} else if (data.code == 'int') {
		            	} else if (data.code == 'con') {
		            	} else if (data.code == 'exist') {
		            	} else {
		            		// 直接处理此任务
		            		handleTask('');
		            	}
		           },
		           error : function(msg) {//请求失败处理函数  
	               }
		       });
	     	return false;
	     });
    });

 	// 处理任务（启动流程）的方法，方法名固定，为了通用选择审批人员的弹出页面调用
   	function handleTask(userIds) {
 		debugger;
   		$('#userIds').val(userIds);
   		var data = $('#dataForm').serialize();//获取值  
		data = decodeURIComponent(data,true);//防止中文乱码  
		var json = DataDeal.formToJson(data);//转化为json
		// 获取functionId, 如果需要不同的项目走不同的流程、不同的部门走不同的流程的，把projectId、departmentId也赋值到form表单中
   		$.ajax({
			type : 'post',
			dataType : 'json',
			data : json,
			contentType : "application/json;charset=UTF-8",
			/* headers: {
            	'Content-Type' : 'application/json',
            }, */
			url : '/spe-baseinfoMaintain/commit',
			async : false,
			success : function(data) {
				if (data=='200') {
					var index = parent.layer.getFrameIndex(window.name);
					parent.layer.close(index);
		        		parent.layer.msg("提交成功");
		        		parent.layui.table.reload('baseinfoMaintain', {});
				} else {
					layer.msg("提交失败");
				}
			},
			error : function() {
				layer.msg("出错了");
			}
		});
    	return false;
   	}
 	
   	var DataDeal = {  
    		//将从form中通过$('#form').serialize()获取的值转成json  
         formToJson: function (data) {  
             data=data.replace(/&/g,"\",\"");  
             data=data.replace(/=/g,"\":\"");  
             data="{\""+data+"\"}";  
             return data;
         }
    };
</script>
</body>
</html>
