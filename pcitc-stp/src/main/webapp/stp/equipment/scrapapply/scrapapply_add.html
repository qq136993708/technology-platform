<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>科技管理平台</title>
	<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css">

	<script src="/layuiadmin/layui/layui.js"></script>
	<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
    <script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
</head>
<body>
<input type="hidden" value="${id}" id="getid" name="getid">
<div class="twoListleft">
	<div class="searchBox">
        <!--查询条件-->
        <label class="dateInput">
            <span>装备名称</span>
            <input type="text" id="equipmentName" name="equipmentName" placeholder="请输入装备名称" title="装备名称" autocomplete="off" class="form-control">
        </label>
        <!--按钮组-->
        <div class="btnGroup">
            <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" data-type="roleSearchEvent">查询
            </button>
        </div>
    </div>
    <div class="tableBox">
        <div class="tableToolBox" style="text-align:center">
        资产台账
        </div>
        <table id="role_table" class="layui-hide" lay-filter="roleCheckboxEvent"></table>
    </div>
</div>
<div class="twoListRight">
	<div class="searchBox">
        <!--查询条件-->
        <label class="dateInput">
            <span>报废名称</span>
            <input type="text" name="userName" placeholder="请输入报废名称"
                   title="用户名" autocomplete="off"
                   class="form-control" id="applyName">
        </label>
        <!--按钮组-->
        <div class="btnGroup">
            <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" data-type="userSearchEvent" onclick="save()">保存
            </button>
        </div>
    </div>
    <div class="tableBox">
        <div class="tableToolBox" style="text-align:center">
          本次报废资产
         <span id="priceandnumber"></span>
        </div>
        <table id="user_table" class="layui-hide" lay-filter="tableDataTwo"></table>
    </div>
</div>
</body>
<script type="text/javascript">
    // 时间格式化
    function formatTime(d) {
        if (d) {
            var date = new Date();
            date.setTime(d);
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            m = m < 10 ? ('0' + m) : m;
            var day = date.getDate();
            day = day < 10 ? ("0" + day) : day;
            var h = date.getHours();
            h = h < 10 ? ("0" + h) : h;
            var M = date.getMinutes();
            M = M < 10 ? ("0" + M) : M;
            var str = y + "-" + m + "-" + day + " " + h + ":" + M;
            return str;
        } else {
            return '';
        }
    }
</script>
<script type="text/javascript">
    var AddData=[];
	var selectRowData,table;
	//reload后删除表头
	function reloadTable(table,where)
	{
		layui.table.reload(table,{where: where});
		$(".layui-table-header table thead th input").remove();
	}
	function view_project(id) 
    {
    var k=[];
		    for(var i=0;i<AddData.length;i++)
		    {
		    if(AddData[i]!="undefined" && AddData[i]!=null && AddData[i]!="")
			        {
					    if(AddData[i].id==id)
					    {
					         delete AddData[i];
					     }
				        }
		        }
		        for(var i=0;i<AddData.length;i++)
		        {
			        if(AddData[i]!="undefined" && AddData[i]!=null && AddData[i]!="")
			        {
			        k.unshift({id:AddData[i].id,equipmentName:AddData[i].equipmentName,specification:AddData[i].specification,del:"删除",p:selectRowData.equipmentPrice,n:selectRowData.equipmenNumber});
			        }
		        }
		        AddData=k;
		    table.reload('userListTable',{
						data : AddData
			}) 
	        var p=0;
			var n=0; 
			for(var k =0; k<AddData.length;k++)
			{
			p=parseInt(p)+parseInt(AddData[k].p);
			n=parseInt(n)+parseInt(AddData[k].n);
			}
			var c="合计:"+p+"数量:"+n;
			$("#priceandnumber").html(c);      
								 
    }
    
	function save()
	{
	if($("#applyName").val()=="")
	{
	layer.msg("请输入报废名称");
	return;
	}
	var ids='';
	var getid=$("#getid").val();
		for(var i=0;i<AddData.length;i++)
		{
		ids=ids+","+AddData[i].id;
		}
		var name=$("#applyName").val();
		 $.ajax({
	           type : 'POST',
	           url : "/sre-sreScrapApply/addApplyAndItem",
	           dataType:"json",
	           data : {"name":name,"ids":ids,"id":getid,"addorupdate":""},
	           success : function(data) {
	           layer.alert("保存成功！", {icon: 1,closeBtn: 0 }, function () 
	                       {
	                           var index = parent.layer.getFrameIndex(window.name); 
						       parent.layer.close(index); 
						       var v_date = (new Date()).getTime();
						       var backurl="/sre-sreScrapApply/to-list?v_date="+v_date;
						       parent.location.href = backurl;
	                      });
			 
	                 },
	            });
    	  
	}
	layui.use(['jquery', 'table', 'laypage'], function () {
    	table = layui.table,$ = layui.jquery;
    	
    	
    	 var $ = layui.$, active = {
            roleSearchEvent: function() { //点击查询按钮
            	rendRoleTable(); 
            },
        };
    	
    	
    	
    	
    	
    function rendRoleTable()
    {
    	var lodingMsg = layer.msg('数据加载中....');
    	var param = JSON.parse(window.localStorage.getItem("param"));
	    //渲染第一个表格
	    table.render({
	        elem: '#role_table' //表格容器
	        , url: '/sre-detail/list' //请求的url地址
	        , limit : param.selfRownum //每页默认显示的数量
	        , id: 'roleListTable'
	        , where: {param: {"equipmentName":$("#equipmentName").val()}}
	        , height: commonDislodgeTable()
	        , method:"POST"
	        ,loading:true
	        , page: {
	            groups: 5
	            , limits : [ param.selfRownum, 15, 30, 45, 60 ]
	            , layout: ['count', 'limit', 'prev', 'page', 'next', 'skip'] //自定义分页布局
	            , first: '首页' //不显示首页
	            , last: '尾页' //不显示尾页
	            , theme: '#0F9EE0'
	        }
	        , cols: [[
	            	 {type: 'checkbox', event: 'roleCheckboxEvent',width:55}
	            	,{title:'序号', type:'numbers',width:55}
	            	, {field: 'equipmentPrice', title: '装备单价', style: 'cursor: pointer;'}
	            	, {field: 'equipmenNumber', title: '规格数量', style: 'cursor: pointer;'}
	            	, {field: 'equipmentName', title: '装备名称', style: 'cursor: pointer;',width:100}
	            	, {field: 'specification', title: '规格型号', style: 'cursor: pointer;',width:99}
	            	, {field: 'arrivaldate', title: '到货日期', width : '20%',style: 'cursor: pointer;', templet :function (row){
                        return formatTime(row.arrivaldate);
                        }  }
	            	, {field: 'supplier', title: '供应商', style: 'cursor: pointer;'}
	            	, {field: 'assetsClassification', title: '分类', style: 'cursor: pointer;'}
	        ]]
	        , done: function (res, curr, count) {
	        $("[data-field='equipmentPrice']").css('display','none');
	         $("[data-field='equipmenNumber']").css('display','none');
	            // 点击行联动选择框--单选
	            $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
	               
	                 var index=parseInt($(this).index()+1);
	                  selectRowData=res.data[index-1];
                   $(this).addClass('layui-table-click');
                   $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
               
	                  var bo=false;
	                  for(var i=0;i<AddData.length;i++)
	                  {
		                  if(AddData[i].id==selectRowData.id)
		                  {
		                  bo=true;
		                  }
	                  }
	                  if(bo==false)
	                  {
						AddData.unshift({id:selectRowData.id,equipmentName:selectRowData.equipmentName,specification:selectRowData.specification,del:"删除",p:selectRowData.equipmentPrice,n:selectRowData.equipmenNumber});
					  }
						table.reload('userListTable',{
						data : AddData
						})
						var p=0;
						var n=0; 
						for(var k =0; k<AddData.length;k++)
						{
						p=parseInt(p)+parseInt(AddData[k].p);
						n=parseInt(n)+parseInt(AddData[k].n);
						}
						var c="合计:"+p+"数量:"+n;
						$("#priceandnumber").html(c);       
	            })
	        }
	    });
    }
    

    function rendUserTable(){
    	var lodingMsg = layer.msg('数据加载中....');
    	var param = JSON.parse(window.localStorage.getItem("param"));
	    table.render({
	        elem: '#user_table' //表格容器
	        , id: 'userListTable'
	        , height: commonDislodgeTable()
	        , loading: true
	        , cols: [[
	            {field: 'equipmentName', title: '装备名称', style: 'cursor: pointer;'}
	           , {field: 'specification', title: '规格型号', style: 'cursor: pointer;'}
	           , {field: 'del', title :'删除', style :'cursor: pointer;color: red;', align: 'center', templet:function(d){return '<span onclick="view_project(&#39;'+d.id+'&#39;)" style="color:red">删除</span>'}}
	        ]],
	        data:AddData
	        , done: function (res, curr, count) {
	        	layer.close(lodingMsg);
	        }
	        
	    });
	    $(".layui-table-header table thead th input").remove();  //移除表头的复选框,去掉全选
    }
    rendRoleTable();
    rendUserTable();
   
    //区别按钮属性
    $('.layui-btn').on('click', function () {
        var type = $(this).data('type');
        active[type] ? active[type].call(this) : '';
    });
});
   
</script>
</html>