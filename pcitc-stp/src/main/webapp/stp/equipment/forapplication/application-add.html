<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css">
    <script src="/common/js/jquery-1.11.3.min.js"></script>

    <script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
</head>
<body>
<div class="layer-box">
    <form id="planForm" class="layui-form" action="" lay-filter="component-form-group layui-container"></form>
    <div class="formBox">
        <div class="tableToolBox">
            <div class="tableBtns">
                <div class="tableTitle">基本信息<span class="red">（标*号为必填项）</span>
                </div>
            </div>
        </div>
    </div>
    <div class="">
        <table id="eqiu_table" class="layui-hide" lay-filter="tableEvent"></table>
    </div>
    <div class="box-body">
        <form class="layui-form" name="form1" id="form1" action="" method="POST"
              lay-filter="component-form-group layui-container">
            <input name="id" id="id" value="${id}" type="hidden">
            <input name="equipmentIds" id="equipmentIds" value="${sreProjectBasic.equipmentIds}" type="hidden">
            <input name="documentDoc" id="documentDoc" value="${documentDoc}" type="hidden">
            <input name="yearFeeStr" id="yearFeeStr" value="${sreProjectBasic.yearFeeStr}" type="hidden">
            <input name="functionId" id="functionId" type="hidden">
            <input name="userIds" id="userIds" type="hidden">
              <input name="leadUnitCode" id="leadUnitCode" value="${leadUnitCode}" type="hidden">
            <input name="joinUnitCode" id="joinUnitCode" value="${sreProjectBasic.joinUnitCode}" type="hidden">
            <input name="entrustUnitCode" id="entrustUnitCode" value="${sreProjectBasic.entrustUnitCode}" type="hidden">
            <input name="belongDepartmentCode" id="belongDepartmentCode" value="${sreProjectBasic.belongDepartmentCode}"
                   type="hidden">
            <input name="yearFeeStrJoinUnit" id="yearFeeStrJoinUnit" value="${sreProjectBasic.yearFeeStrJoinUnit}"
                   type="hidden">
            <!--<input name="yearFeeStrJoinUnit" id="yearFeeStrJoinUnit"
                   value="2019-2020,苏州大学,014ef79138eb4fc49f24e4439419a5a9#2019,22,null#2020,0,null;2019-2020,北京经贸大学,01a180d1fac8465a9f283f7628dbf498#2019,0,null#2020,0,null" type="hidden">-->
            <div class="layui-row">
                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">转资名称<span class="must-fill">*</span></label>
                        <div class="layui-input-block">
                            <input class="layui-input" name="name" id="name" value="${sreProjectBasic.name}"
                                   lay-verify="required" autocomplete="off" type="text">
                        </div>
                    </div>
                </div>
                
                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                    <div class="layui-form-item">
                        <label for="" class="layui-form-label">采购计划名称</label>
                        <div class="layui-input-block">
                        <select name="belongDepartmentName" id="belongDepartmentName"  lay-filter="getDepartNameByUnitName"   style="width:200px" >
				             <option value="" >--请选择采购计划--</option>
				             <option value="1" > --进口采购设备-- </option>
				              <#list unitFieldList as vo>
						          <option  value="${vo.unitName}"  <#if vo.unitName == sreProjectBasic.belongDepartmentName> selected="selected" </#if> >${vo.unitName}</option>
						      </#list>
						 </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">已采购装备<span class="must-fill"></span></label>
                <div class="layui-input-block">
                    <div class="tableBox">
                        <div class="tableToolBox">
                            <div class="whiteLine"></div>
                        </div>
                        <table id="join_apply_table" class="layui-hide" lay-filter="JoinEvent"></table>
                    </div>
                </div>
            </div>
            	

                <div class="form-bottom">
                    <div class="form-bottom-btns">
                        <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"
                                lay-submit="" lay-filter="sub">保存
                        </button>
                        <button type="button"
                                class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white"
                                id="closeBtn">关闭
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">

</script>
<script>
    var publicMethods;
    var form;
    var param = JSON.parse(window.localStorage.getItem("param"));
    var functionId = param.id;
    $('#functionId').val(functionId);
    var roleCodes = "";
    var unitCodes = "";
    var postCodes = "";
    var belongDepartmentName="${sreProjectBasic.belongDepartmentName?default('')}";
    var professionalDepartName="${sreProjectBasic.professionalDepartName?default('')}";
    var professionalFieldName="${sreProjectBasic.professionalFieldName?default('')}";
    var v_date = (new Date()).getTime();
    var file_ids = "documentDoc";
    //detail:详情，edit：编辑
    file_edit_detail = "edit";
    //统管理-附件管理-附件配置：页面标识
    file_opt_flag = "b3a52bbe7087419c80813d7716f37674";
    var equipmentIds = $("#equipmentIds").val();
    var yearFeeStr = $("#yearFeeStr").val();
    var beginYear = $("#beginYear").val();

    var table, selectRowData;
    layui.use(['form', 'table', 'laypage', 'layer', 'laydate', 'laytpl', 'jquery', "publicMethods"], function () {

        var admin = layui.admin
        element = layui.element
            , table = layui.table
            , layer = layui.layer
            , laydate = layui.laydate
            , laypage = layui.laypage
            , $ = layui.jquery;

        form = layui.form;
        publicMethods = layui.publicMethods;
        form.render();
        laydate.render({
            elem: '#LAY-component-form-group-date'
        });



        form.on('select(getDepartNameByUnitName)',function(data){
        	getDepartNameByUnitName(data.value);
        })

         form.on('select(getProfessionalNameListByUnitNameAndDept)',function(data){
        	 getProfessionalNameListByUnitNameAndDept(data.value);
        })


			getDepartNameByUnitName($("#belongDepartmentName").val());	
			function getDepartNameByUnitName(belongDepartmentName)
			{
				 $("#belongDepartmentName").val(belongDepartmentName);
				 $("#professionalDepartName").empty();

				 var v_date=(new Date()).getTime();
				 $.ajax({
						url : "/unitField/getDepartmentNameListByUnitName?v_date="+v_date+"&unitName="+belongDepartmentName,
						type : "post",
						async: false,
						dataType : "json",
						success : function(data)
						{
							$("#professionalDepartName").append("<option value=''>--请选择--</option>");
							$.each(data, function(i, el)
							{
								var content='<option value="'+ el.departmentName +'" ';
								if(professionalDepartName==el.departmentName)
								{
									content+=' selected="selected" ';
								}
								content+=' >' + el.departmentName+ '</option>';
								$("#professionalDepartName").append(content);

							});
							form.render('select');
						},
						error : function()
						{
							alert("发生未知错误 ,请重新操作.");
						}
					});




				getProfessionalNameListByUnitNameAndDept(professionalDepartName);
			}


			function getProfessionalNameListByUnitNameAndDept(professionalDepartName)
			{
				 var belongDepartmentName= $("#belongDepartmentName").val();
				 $("#professionalFieldName").empty();
				 var v_date=(new Date()).getTime();
				 $.ajax({
						url : "/unitField/getProfessionalNameListByUnitNameAndDept?v_date="+v_date+"&unitName="+belongDepartmentName+"&departmentName="+professionalDepartName,
						type : "post",
						async: false,
						dataType : "json",
						success : function(data)
						{
							$("#professionalFieldName").append("<option value=''>--请选择--</option>");

							$.each(data, function(i, el)
							{
								var content='<option value="'+ el.professionalFieldName +'" ';
								if(professionalFieldName==el.professionalFieldName)
								{
									content+=' selected="selected" ';
								}
								content+=' >' + el.professionalFieldName+ '</option>';

								$("#professionalFieldName").append(content);
							});
							form.render('select');
						},
						error : function()
						{
							alert("发生未知错误 ,请重新操作.");
						}
					});
			}



        var equipmentIds = $("#equipmentIds").val();
        renderTable(equipmentIds)

        publicMethods.createTable($("#beginYear").val(), $("#endYear").val(), "yearTr", 2, yearFeeStr);


        //添加到form.render()之后
        $("#file_div").load('/common/public/uploadlayuiload.html');

       
        /* 监听提交 */
        form.on('submit(sub)', function (data) {
            //JSON.stringify(data.field)  提交信息json格式
            /*parent.layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            })*/
        	var belongDepartmentName = $("#belongDepartmentName").val();
        	if (belongDepartmentName == null || belongDepartmentName == '')
            {
                layer.alert("请选择采购计划名称");
            }
            return false;
        });

    });



    function renderTable(equipmentIds) {
        $("#equipmentIds").val(equipmentIds);
        table.render({
            elem: '#join_apply_table',
            url: '/sre-equipment/chooseEquipmentByIds?equipmentIds=' + equipmentIds,
            limit: 15,
            method: "GET",
            id: 'join_apply_table',
            height: 300,
            //page: {first: '首页',last: '尾页',theme: '#0F9EE0'},
            cols: [[
                    
                {title: '序号', type: 'numbers'},
                {field: 'name', title: '装备名称', style: 'cursor: pointer;', align: 'center', width: '30%'},
                {field: 'type', title: '装备分类', style: 'cursor: pointer;', align: 'center', width: '10%'},
                {field: 'unitPrice', title: '单价（万元）', style: 'cursor: pointer;', align: 'center', width: '10%'},
                {field: 'applyAcount', title: '申请数量', style: 'cursor: pointer;', align: 'center', width: '10%'},
                {
                    field: 'allPrice',
                    title: '总价￥（万元）',
                    style: 'cursor: pointer;',
                    align: 'center',
                    width: '10%',
                    templet: function (d) {
                        return '<span style="color:red">' + d.allPrice + '</span>'
                    }
                },
                {field : 'parentUnitPathNames', title : '申报单位', style : 'cursor: pointer;', align : 'left', width : '30%'},
                {field : 'applyDepartName', title : '申报部门', style : 'cursor: pointer;', align : 'left', width : '20%'},
                {field: 'firstApplyUser', title: '申报人', style: 'cursor: pointer;', align: 'center', width: '10%'},
            ]],
            done: function (res, curr, count) {

                //项目分类，项目性质
                var dicMap = ['ROOT_ZBGL_ZBFL'];
                var dicVal = {};
                publicMethods.ajaxPost("/dictionary/map/getMapListDictionarys", {"parentCodes": JSON.stringify(dicMap)}, function (data) {
                    $.each(data, function (key, val) {
                        $.each(val, function (i, dt) {
                            dicVal[dt.code] = dt.name;
                        });
                    });
                });
                $.each(res.data, function (i, dt) {
                    $("tr[data-index='" + i + "'] td[data-field='type'] div").html(dicVal[res.data[i].type]);
                });

            }
        });
    }

    var index_close;




    //参加单位--多个
    function choose_joinUnitName_callback(unitIds, unitNames) {
        $("#joinUnitName").val(unitNames);
        $("#joinUnitCode").val(unitIds);
    }

    function choose_belongDepartmentName_callback(unitId, unitName) {
        $("#belongDepartmentName").val(unitName);
        $("#belongDepartmentCode").val(unitId);
    }

    function choose_leadUnitName_callback(unitId, unitName) {
    	alert(unitName);
        $("#leadUnitName").val(unitName);
        $("#leadUnitCode").val(unitId);
    }

    function clearNoNum(obj) {
        obj.value = obj.value.replace(/[^\d.]/g, "");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3');//只能输入两个小数
        if (obj.value.indexOf(".") < 0 && obj.value != "") {//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value = parseFloat(obj.value);
        }
    }

    //关闭事件
    $("#closeBtn").click(function () {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    })


    //金额： 所选装备=牵头单位+参与单位
    function checkAllMoney(mainUnitMoney, joinUnitMoney) {
        var flag = false;
        var url = "/sre-equipment/get_money_by_ids?v_date=" + v_date + "&equipmentIds=" + $("#equipmentIds").val();
        $.ajax({
            type: 'get',
            url: url,
            dataType: "json",
            async: false,
            cache: false,
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success: function (data, status) {
                if (data.success == true || data.success == 'true') {
                    var money = data.data;
                    alert(money);
                    var temp = parseInt(mainUnitMoney) + parseInt(joinUnitMoney);//所选装备=牵头单位+参与单位
                    if (money == temp) {
                        flag = true;
                    }
                }

            },
            error: function () {
                layer.alert("网络访问错误");
            }

        });
        return flag;
    }



</script>
</body>
</html>