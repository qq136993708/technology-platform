<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/common.css">
    <script src="/common/js/jquery-1.11.3.min.js"></script>

    <script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
</head>
<body>
<div class="layer-box">
    <form id="planForm" class="layui-form" action="" lay-filter="component-form-group layui-container"></form>
    <div class="formBox">
        <div class="tableToolBox">
            <div class="tableBtns">
                <div class="tableTitle">基本信息</span>
                </div>
            </div>
        </div>
    </div>
    <div class="">
        <table id="eqiu_table" class="layui-hide" lay-filter="tableEvent"></table>
    </div>
    <div class="box-body">
        <form class="layui-form" name="form1" id="form1" action="" method="POST"
              lay-filter="component-form-group layui-container">
            <input name="id" id="id" value="${id}" type="hidden">
            <input name="equipmentIds" id="equipmentIds" value="${pplication.applicationId}" type="hidden">
            <input name="applicationUpload" id="applicationUpload" value="${pplication.applicationUpload}" type="hidden">
            <input name="yearFeeStr" id="yearFeeStr" value="${sreProjectBasic.yearFeeStr}" type="hidden">
            <input name="functionId" id="functionId" type="hidden">
            <input name="userIds" id="userIds" type="hidden">
              <input name="leadUnitCode" id="leadUnitCode" value="${leadUnitCode}" type="hidden">
            <input name="joinUnitCode" id="joinUnitCode" value="${sreProjectBasic.joinUnitCode}" type="hidden">
            <input name="entrustUnitCode" id="entrustUnitCode" value="${sreProjectBasic.entrustUnitCode}" type="hidden">
            <input name="belongDepartmentCode" id="belongDepartmentCode" value="${sreProjectBasic.belongDepartmentCode}"
                   type="hidden">
            <input name="yearFeeStrJoinUnit" id="yearFeeStrJoinUnit" value="${sreProjectBasic.yearFeeStrJoinUnit}"
                   type="hidden">
               <input name="joinUnitIds" id="joinUnitIds" value="${sreProjectBasic.joinUnitIds}" type="hidden">     
               <input type="hidden" name="varrra" id="varrra" value="">    
                   
            <!--<input name="yearFeeStrJoinUnit" id="yearFeeStrJoinUnit"
                   value="2019-2020,苏州大学,014ef79138eb4fc49f24e4439419a5a9#2019,22,null#2020,0,null;2019-2020,北京经贸大学,01a180d1fac8465a9f283f7628dbf498#2019,0,null#2020,0,null" type="hidden">-->
        <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">转资编码</label>
            <div class="layui-input-block">
              <input class="layui-input readOnlyBox"  name="froappname" id="froappname" value="${pplication.applicationName}"  readonly="readonly"   autocomplete="off" type="text" >
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">申请时间</label>
            <div class="layui-input-block">
            	  <input class="layui-input readOnlyBox" name="applicationTime" id="applicationTime" value="${pplication.applicationTime?string("yyyy-MM-dd HH:mm:ss")}"     autocomplete="off" type="text">
            </div>
          </div>
        </div>
      </div>
      
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">申请人</label>
            <div class="layui-input-block">
              <input class="layui-input readOnlyBox"  name="applicationUserName" id="applicationUserName" value="${pplication.applicationUserName}"  readonly="readonly"   autocomplete="off" type="text" >
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">申请部门</label>
            <div class="layui-input-block">
            <input class="layui-input readOnlyBox"  name="applyDepartName" id="applyDepartName" value="${pplication.applyDepartName}"  readonly="readonly"   autocomplete="off" type="text" >
            </div>
          </div>
        </div>
      </div>

            <!--行有两个的情况-->
            <div class="layui-form-item" id="equipment">
                <label class="layui-form-label">已选择装备<span class="must-fill">*</span></label>
                <div class="layui-input-block">
                    <div class="tableBox">
                        <div class="tableToolBox">
                            <div class="whiteLine"></div>
                        </div>
                        <table id="notjoin_apply_table" class="layui-hide" lay-filter="JoinEvent"></table>
                    </div>
                </div>
            </div>

		<div class="layui-form-item">
	      	 <label class="layui-form-label">附件</label>
	         <div id="file_div" class="layui-input-block"></div>
       	</div>


                <div class="form-bottom">
                <div class="form-bottom-btns">
	                <!--<a herf="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"  data-type="addEvent" lay-filter="addEvent">确定</a>-->
	             	<a herf="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" lay-submit="" id="close" lay-filter="closeBtn">关闭</a>
	             </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">

</script>
<script id="dateTpl" type="text/html"> {{formatTime(d.declareTime)}} </script>
<script type="text/javascript">
// 时间格式化
function formatTime(d) {
    if (d) {
        var date = new Date();
        date.setTime(d);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var day = date.getDate();
        day = day < 10 ? ("0" + day) : day;
        var h = date.getHours();
        h = h < 10 ? ("0" + h) : h;
        var M = date.getMinutes();
        M = M < 10 ? ("0" + M) : M;
        var str = y + "-" + m + "-" + day + " " + h + ":" + M;
        return str;
    } else {
        return '';
    }
}

var v_date=(new Date()).getTime();
var publicMethods;
var file_ids = "applicationUpload";
//detail:详情，edit：编辑
file_edit_detail = "detail";
//统管理-附件管理-附件配置：页面标识
file_opt_flag = "7b6f6480989040ac9d3fbe7899fabc7b";
var supplierStr =$("#supplierStr").val();
var supplierWillStr =$("#supplierWillStr").val();

layui.config({
}).extend({
    index: 'layui/tableDemo' //主入口模块
}).use(['form', 'table', 'laypage', 'layer', 'laydate', 'laytpl', 'jquery', "publicMethods"], function () {

    var admin = layui.admin
    element = layui.element
        , table = layui.table
        , layer = layui.layer
        , laydate = layui.laydate
        , laypage = layui.laypage
        , form = layui.form
        , $ = layui.jquery;
       publicMethods = layui.publicMethods;
       //添加到form.render()之后
	 	$("#file_div").load('/common/public/uploadlayuiload.html');
		form.render();
			 	
			 	
		});


var publicMethods;
    $(document).ready(function() {
    	layui.use([ 'jquery', 'form', 'laydate', 'table', 'layer', 'element','publicMethods' ],function() {
 			var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate;
 			publicMethods=layui.publicMethods;
 			var form = layui.form;
 			var table = layui.table;
	    	table.render({
	            elem: '#notjoin_apply_table',
	            url: '/sre-forapplication/listView',
	            limit: 5,
	            method:"POST",
	            where: {param:{"equipmentIds":$("#equipmentIds").val(),"applyName":$("#applyName").val(),"applyDepartCode":$("#applyDepartCode").val(),"parentUnitPathIds":$("#parentUnitPathIds").val(),"isLinkedProject":$("#isLinkedProject").val()}},
	        	id: 'notjoin_apply_table',
	        	height: 200,
	        	page: {
	                groups: 5,
	                limits: [5,10,15,20],
	                layout: ['count', 'limit', 'prev', 'page', 'next', 'skip'], //自定义分页布局
	                first: '首页', //不显示首页
	                last: '尾页', //不显示尾页
	                theme: '#0F9EE0'
	            },
	            cols: [[
	             	{title:'序号', type:'numbers', width : 55},
	             	{field : 'assetNumber', title : '资产编号', style : 'cursor: pointer;', align : 'left', width : '15%'},
	                {field : 'equipmentName',        title : '装备名称', style : 'cursor: pointer;', align : 'left', width : '20%'},
	                {field : 'equipmentPrice',   title : '单价（万元）', style : 'cursor: pointer;', align : 'center', width : '20%'},
	                {field : 'equipmenNumber', title : '申请数量',    style : 'cursor: pointer;', align : 'center', width : '15%'},
	                {field : 'declareUnit', title : '申报单位', style : 'cursor: pointer;', align : 'left', width : '15%'},
	                {field : 'declareDepartment', title : '申报部门', style : 'cursor: pointer;', align : 'left', width : '15%'},
	                {field : 'declarePeople',  title : '第一申报人', style : 'cursor: pointer;', align : 'left', width : '20%'},
	                {field : 'declareTime',  title : '申报时间', style : 'cursor: pointer;', align : 'left',  templet:'#dateTpl'}
	                ]],
	            done: function (res, curr, count) {
	            	var equipmentIds="";
	            	for(var i;i<res.data.length;i++)
	            	{
	            		var equipmentId=res.data.equipmentId;
	            	}
	            	//alert(res.data.length);
	            	
	            	//项目分类，项目性质
	                var dicMap = ['ROOT_ZBGL_ZBFL'];
	                var dicVal = {};
	 				publicMethods.ajaxPost("/dictionary/map/getMapListDictionarys",{"parentCodes":JSON.stringify(dicMap)}, function (data) {
	 					$.each(data,function(key,val){
	 						$.each(val,function(i,dt){
	 							dicVal[dt.code] = dt.name;
	 						});
	 					});
	 			   	}); 
	 				$.each(res.data,function(i,dt){
	 					$("tr[data-index='"+i+"'] td[data-field='type'] div").html(dicVal[res.data[i].type]); 
	 			   	});
	 				
	            }
	        });
	    	//多行点击事件
	        $(document).on("click", ".layui-table-body table.layui-table tbody tr", function () {
	     	   	var checkCell = $(this).parent().find("tr[data-index=" + $(this).attr('data-index') + "]").find("td div.laytable-cell-checkbox div.layui-form-checkbox");
	             if (checkCell.length > 0) {
	                 checkCell.click();
	             }
	         });
	         $(document).on("click", "td div.laytable-cell-checkbox div.layui-form-checkbox", function (e) {
	             e.stopPropagation();
	         });
	         var arr = [];
	         table.on('edit(JoinEvent)',function(obj){
   	        	 var arrIn = $(this).parent().parent().attr('data-index')
   	        	 if(arr.length ==0) {
   	        		 arr.push(obj.value);
   	        	 }else {
   		        	 for ( var i = 0; i <arr.length; i++){
   		        		 if(arr.length > arrIn) {
   		        			 arr[arrIn]=obj.value;
   		        		 }else {
   		        			 arr.push(obj.value);
   		        		 }
   		        		}
   	        	 }
//   	        	 console.log(vobjes)
   	         })
	         
	    	var $ = layui.$, active = {
	    		searchEvent: function() { 
                    table.reload("notjoin_apply_table",{where:{param:{"equipmentIds":$("#equipmentIds").val(),"name":$("#name").val()}}});
                },
	    		addEvent:function(){
                	var check = table.checkStatus('notjoin_apply_table');
                	if(check.data.length == 0)
                	{
                		layer.msg('请点击选择装备数据!');
                		return;
                	}
                	var equipmentIds="";
                	for(var dt in check.data)
                	{
                		equipmentIds=equipmentIds+check.data[dt].equipmentId+",";
                	}
                	var froname = $("#froappname").val();
                	if(froname == null || froname == "") {
                		layer.alert("转资名称不能为空");
                		 return false;
                	}
                	$.ajax({
                        type : "POST",
                        url: "/sre-forapplicatio/save",
                        data: {"arr": arr,"equipmentIds":equipmentIds,"froname":froname},
                        traditional : true,
                        async : true,         
                        success : function(result){
                        	if(result=="1") {
                        		alert("添加成功!!");
                        		parent.location.href = '/sre-forapplication/to-list';
                        	}
                        },
                    });    
                }
        	}
        	$('.layui-btn').on('click', function(){
            	var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
	    	$("#close").click(function () {
			    var index = parent.layer.getFrameIndex(window.name);
			    parent.layer.close(index);
			});
    	});
    });
</script>
</body>
</html>