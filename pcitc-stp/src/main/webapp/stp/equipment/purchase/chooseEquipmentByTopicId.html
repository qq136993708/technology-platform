<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>新增/编辑</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css">

<script type="text/javascript" src="/plugins/ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
<script id="dateTpl" type="text/html"> {{formatTime(d.createDate)}} </script>
<script type="text/javascript">
    // 时间格式化
    function formatTime(d) {
        if (d) {
            var date = new Date();
            date.setTime(d);
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            m = m < 10 ? ('0' + m) : m;
            var day = date.getDate();
            day = day < 10 ? ("0" + day) : day;
            var h = date.getHours();
            h = h < 10 ? ("0" + h) : h;
            var M = date.getMinutes();
            M = M < 10 ? ("0" + M) : M;
            var str = y + "-" + m + "-" + day + " " + h + ":" + M;
            return str;
        } else {
            return '';
        }
    }
</script>
<script type="text/javascript">
var publicMethods;
    $(document).ready(function() {
    	layui.use([ 'jquery', 'form', 'laydate', 'table', 'layer', 'element','publicMethods' ],function() {
 			var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate;
 			publicMethods=layui.publicMethods;
 			var form = layui.form;
 			var table = layui.table;
	    	table.render({
	            elem: '#notjoin_apply_table',
	            url: '/sre-equipment/list',
	            limit: 15,
	            method:"POST",
	            where: {param:{"equipmentIds":$("#equipmentIds").val(),"applyName":$("#applyName").val(),"applyDepartCode":$("#applyDepartCode").val(),"parentUnitPathIds":$("#parentUnitPathIds").val(),"isLinkedProject":$("#isLinkedProject").val()}},
	        	id: 'notjoin_apply_table',
	        	height: 360,
	        	page: {first: '首页',last: '尾页',theme: '#0F9EE0'},
	            cols: [[
	            	{type:'checkbox',event: 'changeEvents', width : 55}
	             	,{title:'序号', type:'numbers', width : 55},
	             	{field : 'auditStatus', title : '状态',    style : 'cursor: pointer;', align : 'center', templet : '<div>{{ layui.laytpl.auditStatus_equipment(d.auditStatus) }}</div>', width : 55},
	                {field : 'name',        title : '装备名称', style : 'cursor: pointer;', align : 'left', width : '20%'},
	                {field : 'type',        title : '装备分类', style : 'cursor: pointer;', align : 'center', width : '10%'},
	                {field : 'unitPrice',   title : '单价（万元）', style : 'cursor: pointer;', align : 'center', width : '10%'},
	                {field : 'applyAcount', title : '申请数量',    style : 'cursor: pointer;', align : 'center', width : '10%'},
	                {field : 'allPrice',    title : '总价¥（万元）', style : 'cursor: pointer;', align : 'center', width : '10%',templet:function(d){return '<span style="color:red">'+d.allPrice+'</span>'}},
	                {field : 'parentUnitPathNames', title : '申报单位', style : 'cursor: pointer;', align : 'left', width : '30%'},
	                {field : 'applyDepartName', title : '申报部门', style : 'cursor: pointer;', align : 'left', width : '20%'},
	                {field : 'firstApplyUser',  title : '第一申报人', style : 'cursor: pointer;', align : 'left', width : '10%'},
	                {field : 'createDate',  title : '申报时间', style : 'cursor: pointer;', align : 'left', width : '15%', templet : '#dateTpl'}
	            ]],
	            done: function (res, curr, count) {
	            	var equipmentIds="";
	            	for(var i;i<res.data.length;i++)
	            	{
	            		var equipmentId=res.data.equipmentId;
	            	}
	            	//alert(res.data.length);
	            	
	            	//项目分类，项目性质
	                var dicMap = ['ROOT_ZBGL_ZBFL'];
	                var dicVal = {};
	 				publicMethods.ajaxPost("/dictionary/map/getMapListDictionarys",{"parentCodes":JSON.stringify(dicMap)}, function (data) {
	 					$.each(data,function(key,val){
	 						$.each(val,function(i,dt){
	 							dicVal[dt.code] = dt.name;
	 						});
	 					});
	 			   	}); 
	 				$.each(res.data,function(i,dt){
	 					$("tr[data-index='"+i+"'] td[data-field='type'] div").html(dicVal[res.data[i].type]); 
	 			   	});
	 				
	            }
	        });
	    	//多行点击事件
	        $(document).on("click", ".layui-table-body table.layui-table tbody tr", function () {
	     	   	var checkCell = $(this).parent().find("tr[data-index=" + $(this).attr('data-index') + "]").find("td div.laytable-cell-checkbox div.layui-form-checkbox");
	             if (checkCell.length > 0) {
	                 checkCell.click();
	             }
	         });
	         $(document).on("click", "td div.laytable-cell-checkbox div.layui-form-checkbox", function (e) {
	             e.stopPropagation();
	         });
	    	var $ = layui.$, active = {
	    		searchEvent: function() { 
                    table.reload("notjoin_apply_table",{where:{param:{"equipmentIds":$("#equipmentIds").val(),"name":$("#name").val()}}});
                },
                addEvent:function(){
                	var check = table.checkStatus('notjoin_apply_table');
                	if(check.data.length == 0)
                	{
                		layer.msg('请点击选择装备数据!');
                		return;
                	}
                	var equipmentIds="";
                	for(var dt in check.data)
                    {
                		equipmentIds=equipmentIds+check.data[dt].equipmentId+",";
                	}
                	$("#equipmentIds").val(equipmentIds);
                	parent.document.getElementById("equipmentIds").value=equipmentIds;
                	parent.renderTable(equipmentIds);
                    //parent.layui.table.reload("join_apply_table",{where: {param:{"equipmentIds":equipmentIds}}});
                	var index = parent.layer.getFrameIndex(window.name);
    			    parent.layer.close(index); 
                }
        	}
        	$('.layui-btn').on('click', function(){
            	var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
	    	$("#close").click(function () {
			    var index = parent.layer.getFrameIndex(window.name);
			    parent.layer.close(index);
			});
    	});
    });
</script>
</head>
<body>
<div class="formBox">
	<input type="hidden" name="equipmentIds" id="equipmentIds" value="${equipmentIds}">
	<input type="hidden" name="applyDepartCode" id="applyDepartCode" value="${applyDepartCode}">
	<input type="hidden" name="parentUnitPathIds" id="parentUnitPathIds" value="${parentUnitPathIds}">
	<input type="hidden" name="isLinkedProject" id="isLinkedProject" value="${isLinkedProject}">
	<input type="text" name="isLinkedProject" id="topicId" value="${topicId}">


	<div class="searchBox">
		<label class="dateInput">
        	<span>装备名称</span>
        	<input type="text" name="name" id="name" placeholder="请输入装备名称" autocomplete="off" class="form-control">
    	</label>
    	<div class="btnGroup">
        	<button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" data-type="searchEvent">查询</button>
        	<button class="layui-btn layui-btn-sm fontColor-default border-default btn_reset btnMyBgImg" data-type="resetEvent">重置</button>
    	</div>
	</div>
	<div class="tableBox">
    	<table id="notjoin_apply_table" class="layui-hide"  lay-filter="userEvent"></table>
	</div>
	<div class="form-bottom">
      <div class="form-bottom-btns">
         <a herf="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"  data-type="addEvent" lay-filter="addEvent">确定</a>
      	<a herf="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" lay-submit="" id="close" lay-filter="closeBtn">关闭</a>
      </div>
    </div>
</div>
</body>
</html>