<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>新增/编辑</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css">

    <script type="text/javascript" src="/plugins/ckeditor/ckeditor.js"></script>
    <script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
    <script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
    <script type="text/javascript" src="/layuiadmin/modules/base.js"></script>

    <script id="dateTpl" type="text/html"> {{formatTime(d.createDate)}} </script>
    <script type="text/javascript">
        // 时间格式化
        function formatTime(d) {
            if (d) {
                var date = new Date();
                date.setTime(d);
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                m = m < 10 ? ('0' + m) : m;
                var day = date.getDate();
                day = day < 10 ? ("0" + day) : day;
                var h = date.getHours();
                h = h < 10 ? ("0" + h) : h;
                var M = date.getMinutes();
                M = M < 10 ? ("0" + M) : M;
                var str = y + "-" + m + "-" + day + " " + h + ":" + M;
                return str;
            } else {
                return '';
            }
        }
    </script>

    <script type="text/javascript">
        var publicMethods;

        $(document).ready(function() {
            layui.use([ 'jquery', 'form', 'laydate', 'table', 'layer', 'element','publicMethods' ],function() {
                var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate;
                publicMethods=layui.publicMethods;
                var form = layui.form;
                var table = layui.table;
                var selectRowData = '';
                table.render({
                    elem: '#notjoin_apply_table',
                    url: '/sre-purchase/project_task/list',
                    method:"POST",
                    where: {param: {"auditStatus":"2","setupYear":$("#setupYear").val(),"topicName":$("#topicName").val(),"leadUnitName":$("#leadUnitName").val(),"belongDepartmentName":$("#belongDepartmentName").val(),"professionalDepartName":$("#professionalDepartName").val(),"professionalFieldName":$("#professionalFieldName").val(),"contractNum":$("#contractNum").val()}},
                    limit: 15,
                    id: 'notjoin_apply_table',
                    height: 350,
                    page: {
                        limits:[5,10, 20, 30, 40, 50],
                        first: '首页',
                        last: '尾页',
                        theme: '#0F9EE0'
                    },
                    cols: [[
                        {type : 'checkbox', event : 'changeEvents', width : 55},
                        {title : '序号', type :'numbers', width : 55},
                        {field : 'contractNum', title : '合同号', style : 'cursor: pointer;', align: 'center', width : '10%'},
                        {field : 'erpNum', title : 'ERP号', style : 'cursor: pointer;', align: 'center', width : '15%'},
                        {field : 'topicName',     title : '课题名称',      style : 'cursor: pointer;', align: 'center', width : '15%'/*,templet:function(d){return '<span onclick="view_project(\''+d.topicId+'\')" style="color:#1890ff">详情</span>'}*/},
                        {field : 'topicName',     title : '任务书',     style : 'cursor: pointer;', align: 'left', width : '10%'/*,templet:function(d){return '<span   onclick="view_isWriteTask(\''+d.taskId+'\')" style="color: #1890ff">'+d.topicName+'</span>'}*/},
                        {field : 'isWriteSetup',  title : '立项报告',  style : 'cursor: pointer;', align: 'center', width : '15%'/*,templet:function(d){return '<span   onclick="view_isWriteSetup(\''+d.setupId+'\')" style="color: #1890ff">详情</span>'}*/},
                        {field : 'setupYear',      title : '立项年份', style : 'cursor: pointer;', align: 'center', width : '15%'},
                        {field : 'projectMoney',   title : '总经费(万元)', style : 'cursor: pointer;', align: 'center', width : '15%',templet:function(d){return '<span style="color:red">'+d.projectMoney+'</span>'}},
                        {field : 'taskVersion',      title : '任务书版本号', style : 'cursor: pointer;', align: 'center', width : '20%',templet : '#view_taskVersion'},
                        {field : 'leadUnitName',   title : '牵头单位',    style : 'cursor: pointer;', align: 'left', width : '20%'},
                        {field : 'belongDepartmentName', title : '归属部门', style : 'cursor: pointer;', align: 'left', width : '15%'},
                        {field : 'professionalDepartName', title : '专业处',  style : 'cursor: pointer;', align: 'left', width : '10%'},
                        {field : 'professionalFieldName',  title : '专业领域', style : 'cursor: pointer;', align: 'left', width : '15%'},
                        {field : 'parentApplyUnitPathName',   title : '上报单位',  style : 'cursor: pointer;', align: 'left', width : '20%'},
                        {field : 'applyUnitName',             title : '上报部门',  style : 'cursor: pointer;', align: 'left', width : '15%'},
                        {field : 'applyUserName', title : '上报人',      style : 'cursor: pointer;', align: 'left', width : '10%'},
                        {field : 'createDate',     title : '上报时间',     style : 'cursor: pointer;', align: 'center', templet : '#dateTpl',width : '15%'}
                    ]],
                    done: function (res, curr, count)
                    {
                        // 点击行联动选择框--单选
                        $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
                            var index=parseInt($(this).index()+1);
                            $('tr').removeClass('layui-table-click');
                            $(this).addClass('layui-table-click');
                            $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
                            $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
                            selectRowData=res.data[index-1];
                            var taskId=selectRowData.taskId;
                            var topicId=selectRowData.topicId;
                            var id=selectRowData.id;
                            var topicName=selectRowData.topicName;
                            //var equipmentIds=selectRowData.equipmentIds;
                            $("#topicId").val(topicId)
                            $("#topicName").val(topicName);
                            $("#taskId").val(taskId);
                        });
                        //监听表格双击事件
                        $('#notjoin_apply_table').next().find('.layui-table-body').find("table" ).find("tbody").children("tr").on('dblclick',function(){
                            var id = JSON.stringify($('#notjoin_apply_table').next().find('.layui-table-body').find("table").find("tbody").find(".layui-table-hover").data('index'));
                            selectRowData = res.data[id];
                            var taskId=selectRowData.taskId;
                            var topicId =selectRowData.topicId;
                            var topicName = selectRowData.topicName;
                            //alert(taskId)
                            parent.document.getElementById("taskId").value=taskId;
                            parent.document.getElementById("topicId").value=topicId;
                            parent.document.getElementById("topicName").value=topicName;
                           /* parent.document.getElementById("purchaseName").value=topicName;*/
                            parent.call_back(topicId);
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        })
                    }

                });
                $(".layui-table-header table thead th input").remove()
                var $ = layui.$, active = {
                    searchEvent: function() {
                        table.reload("notjoin_apply_table",{where:{param:{"id":$("#topicId").val(),"topicName":$("#topicName").val(),"taskWriteUsersIds":$("#taskWriteUsersIds").val()}}});
                        $(".layui-table-header table thead th input").remove()
                        },
                    resetEvent: function() { //点击重置按钮
                        $('#topicName').val("");
                    },
                    addEvent:function(){

                        var taskId=$("#taskId").val();
                        var topicId=$("#topicId").val();
                        var topicName=$("#topicName").val();
                        var equipmentIds=$("#equipmentIds").val();
                        var check = table.checkStatus('notjoin_apply_table');
                        if(selectRowData == 0){
                            layer.msg('请选择选择课题!');
                            return;
                        }

                        parent.document.getElementById("taskId").value=taskId;
                        parent.document.getElementById("topicId").value=topicId;
                        parent.document.getElementById("topicName").value=topicName;
                        parent.document.getElementById("equipmentIds").value=equipmentIds;

                        parent.call_back(topicId);

                        //parent.setPorject(yearFeeStrJoinUnit,yearFeeStr,leadUnitName);
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                    }
                }
                $('.layui-btn').on('click', function(){
                    var type = $(this).data('type');
                    active[type] ? active[type].call(this) : '';
                });
                $("#close").click(function () {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                });
            });
        });
    </script>
</head>
<body>
<div class="formBox">
    <input type="hidden" name="taskWriteUsersIds" id="taskWriteUsersIds" value="${taskWriteUsersIds}">
    <input type="hidden" name="topicId" id="topicId" value="${topicId}">
    <input type="hidden" name="yearFeeStrJoinUnit" id="yearFeeStrJoinUnit" value="">
    <input type="hidden" name="yearFeeStr" id="yearFeeStr" value="">
    <input type="hidden" name="projectMoney" id="projectMoney" value="">
    <input type="hidden" name="leadUnitName" id="leadUnitName" value="">
    <input type="hidden" name="equipmentIds" id="equipmentIds" value="">
    <input type="hidden" name="applyUnitCode" id="applyUnitCode" value="${applyUnitCode}">

    <div class="searchBox">
        <label class="dateInput">
            <span>课题名称</span>
            <input type="text" name="topicName" id="topicName" placeholder="请输入课题名称" autocomplete="off" class="form-control">
        </label>
        <div class="btnGroup">
            <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg"                 data-type="searchEvent">查询</button>
            <button class="layui-btn layui-btn-sm fontColor-default border-default btn_reset btnMyBgImg" data-type="resetEvent">重置</button>
        </div>
    </div>
    <div class="tableBox">
        <table id="notjoin_apply_table" class="layui-hide"  lay-filter="notjoin_apply_table"></table>
    </div>
    <div class="form-bottom">
        <div class="form-bottom-btns">
            <a herf="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"  data-type="addEvent" lay-filter="addEvent">确定</a>
            <a herf="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" lay-submit="" id="close" lay-filter="closeBtn">关闭</a>
        </div>
    </div>
</div>
</body>
</html>