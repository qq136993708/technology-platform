<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
  <!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/layuiadmin/style/common.css">
  <script src="/common/js/jquery-1.11.3.min.js"></script>
  
  <script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
  <script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
</head>
<body>
  <div class="layer-box">
	<form id="planForm" class="layui-form" action="" lay-filter="component-form-group layui-container"></form>
		<div class="formBox">
			<div class="tableToolBox">
				<div class="tableBtns">
					<div class="tableTitle">基本信息<span class="red">（标*号为必填项）</span>
					</div>
				</div>
			</div>
		</div>
		<div class="">
  			<table id="eqiu_table" class="layui-hide" lay-filter="tableEvent"></table>
  		</div>
	<div class="box-body">
  <form class="layui-form" name="form1" id="form1" action="" method="POST" lay-filter="component-form-group layui-container">
  <input type="hidden" name="equipmentId" id="equipmentId" value="${equipmentId}">
  <input type="hidden" name="projectId" id="projectId" value="${projectId}">
  <input type="hidden" name="equipmentIds" id="equipmentIds" value="${sreProjectBasic.equipmentIds}">
  <input  name="auditDoc" id="auditDoc"   value="${auditDoc}"  type="hidden">
  <input  name="applyDoc" id="applyDoc"   value="${applyDoc}"  type="hidden">
  <input  name="checkContentDoc"    id="checkContentDoc"   value="${checkContentDoc}"  type="hidden">
  <input  name="taskDoc"            id="taskDoc"           value="${taskDoc}"  type="hidden">
  
  <div  class="tableBtns" style="float:right">
       <a class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btnMyBgImg btn_add" data-type="addEvent">添加装备</a>
  </div>
     <!--文本域-->
      <div class="layui-form-item layui-form-text" >
        <div class="layui-input-block">
           <table class="layui-table">
             <thead>
	             <tr>
	                <td>序号</td>
	                <td>装备名称</td>
	                <td>规格型号</td>
	                <td>计划金额（万元）</td>
	                <td>数量</td>
	                <td>功用用途</td>
	                <td>需求部门</td>
	             </tr>
            </thead>
             <tr>
                <td>1</td>
                <td>软件</td>
                <td>DL788</td>
                <td>500万</td>
                <td>2</td>
                <td>可用于电气评估可用于电气评估可用于电气评估 </td>
                <td>处理解释中心</td>
             </tr>
             <tr>
                <td>2</td>
                <td>红外成像设备</td>
                <td>DeL788</td>
                <td>400万</td>
                <td>2</td>
                <td>分析温度变化 </td>
                <td>处理解释中心</td>
             </tr>
             <tr>
                <td>3</td>
                <td>便携式设备</td>
                <td>DeL788</td>
                <td>700万</td>
                <td>2</td>
                <td>处理温度变化 </td>
                <td>处理解释中心</td>
             </tr>
           </table>
        
        </div>
      </div>
      
      
        
      <!--行有两个的情况-->
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">项目名称<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="name" id="name" value="${sreProjectBasic.name}"  lay-verify="name"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">关键词</label>
            <div class="layui-input-block">
              <input class="layui-input" name="keyWord" id="keyWord" value="${sreProjectBasic.keyWord}"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
      </div>
      
       <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">项目属性<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="projectType" id="projectType" value="${sreProjectBasic.projectType}"  lay-verify="required"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">建设年限</label>
            <div class="layui-input-block">
                  <div class="layui-input-inline" style="float:left">
		            <input type="text" class="layui-input" name="beginYear" id="beginYear" value="${sreProjectBasic.beginYear}" style="width:80px;float:left" placeholder="开始年份">
		             <div class="layui-form-mid" style="width:8px;float:left"> - </div>
		            <input type="text" class="layui-input" id="endYear" name="endYear"   value="${sreProjectBasic.endYear}" style="width:80px;float:left" placeholder="结束年份">
		          </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">项目长<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="projectLeader" id="projectLeader" value="${sreProjectBasic.projectLeader}"  lay-verify="required" placeholder="请输入装备名称" autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">院级上报金额<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="applyMoney" id="applyMoney" value="${sreProjectBasic.applyMoney}"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
      </div>
      
      
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">项目申请文件<span class="must-fill">*</span></label>
            <div class="layui-input-block">
               <button type="button" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_save" onclick="upload_File('${applyDoc}');">选择文件</button>
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">批复公公文<span class="must-fill">*</span></label>
            <div class="layui-input-block">
               <button type="button" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_save" onclick="upload_File('${auditDoc}');">选择文件</button>
            </div>
          </div>
        </div>
      </div>
      
      <div <#if sreProjectBasic.status != '2'>style="display:none"</#if>>
      <!--文本域-->
      <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">目的和主要任务</label>
        <div class="layui-input-block">
          <textarea placeholder="请输入目的和主要任务" name="taskMainTaskContent" id="taskMainTaskContent" lay-verify="required"   class="layui-textarea">${sreProjectBasic.taskMainTaskContent}</textarea>
        </div>
      </div>
      
      <!--文本域-->
      <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">项目内容</label>
        <div class="layui-input-block">
          <textarea placeholder="请输入项目内容" name="taskContent" id="taskContent" lay-verify="required"   class="layui-textarea">${sreProjectBasic.taskContent}</textarea>
        </div>
      </div>
      
       <!--行有两个的情况-->
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">计划进度和考核目标<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="taskAssessmentContent" id="taskAssessmentContent" value="${sreProjectBasic.taskAssessmentContent}"  lay-verify="taskAssessmentContent"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">应提交验收的内容</label>
            <div class="layui-input-block">
              <input class="layui-input" name="taskCheckContents" id="taskCheckContents" value="${sreProjectBasic.taskCheckContents}"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
      </div>
      
       <!--项目任务附件-->
      <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">任务附件</label>
        <div class="layui-input-block">
         <button type="button" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_save" onclick="upload_File('${taskDoc}');">选择文件</button>
            </div>
      </div>
      
      <!--文本域-->
      <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">验收内容名称</label>
        <div class="layui-input-block">
          <textarea placeholder="请输入:项目总结报告；设计图纸、设计总结报告；使用（操作）手册；质量评定、使用考核情况报告；安全、消防验收证明；环境保护验收证明；职业防护验收证明；财务决算报告；审计报告" name="checkContents" id="projectContent" lay-verify="required"   class="layui-textarea">${sreProjectBasic.projectContent}</textarea>
        </div>
      </div>
      
      <!--文本域-->
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">验收人<span class="must-fill">*</span></label>
            <div class="layui-input-block">
               <input class="layui-input" name="checkUser" id="checkUser" value="${sreProjectBasic.checkUser}"  lay-verify="required" placeholder="请输入验收人" autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">验收文件<span class="must-fill">*</span></label>
            <div class="layui-input-block">
               <button type="button" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_save" onclick="upload_File('${checkContentDoc}');">选择文件</button>
            </div>
          </div>
        </div>
      </div>
      
      </div>
    <!--行结束-->
    <div class="form-bottom">
	  		<div class="form-bottom-btns">
	    		<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"   lay-submit="" lay-filter="sub">保存</button>
             	<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"  lay-submit="" lay-filter="up">上报</button>
          		<button type="button"class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn">关闭</button>
	  		</div>
		</div>
     <!-- <div class="row" style="margin-top:30px;">
           <div class="col-sm-12" style="text-align:center">
             <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"   lay-submit="" lay-filter="sub">保存</button>
             <button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"  lay-submit="" lay-filter="up">上报</button>
           </div>
     </div> -->
</form>
</div>
</div>
<script>
var v_date=(new Date()).getTime();
var equipmentIds=$("#equipmentIds").val();
var table,selectRowData;
layui.config({
    //base: 'layuicommon/module/modules/' //静态资源所在路径
}).extend({
    index: 'layui/tableDemo' //主入口模块
}).use(['form','table','laypage','layer','laydate','laytpl','jquery'], function(){

	  var admin = layui.admin
      element = layui.element
      ,table = layui.table
      ,layer = layui.layer
      ,laydate = layui.laydate
      ,laypage = layui.laypage
      ,$ = layui.jquery
      ,form = layui.form;
	  form.render(null, 'component-form-group');
	  laydate.render({
	      elem: '#LAY-component-form-group-date'
	  });
	  
      /* 自定义验证规则  title 要验证的input的 lay-verify=""*/
      form.verify({
    	  name: function(value)
    	  {
              if(value.length < 5)
              {
                  return '装备名称至少得5个字符啊';
              }
          },
          planMoney: [/(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/,'计划金额格试不正确'] 
         /*  ,pass: [/(.+){6,12}$/, '密码必须6到12位']
          ,content: function(value){
              layedit.sync(editIndex);
          } */
      });
      if(equipmentIds!=null && equipmentIds!='')
      {
      	renderTable(equipmentIds);
      } 
      
    //开始日期
      var insStart = laydate.render({
          elem: '#beginYear'
          ,min: 0,type: 'year'
          ,done: function(value, date){
              //更新结束日期的最小日期
              insEnd.config.min = lay.extend({}, date, {
                  month: date.month - 1
              });
              //自动弹出结束日期的选择器
              insEnd.config.elem[0].focus();
          }
      });

      //结束日期
      var insEnd = laydate.render({
          elem: '#endYear'
          ,min: 0,type: 'year'
          ,done: function(value, date){
              //更新开始日期的最大日期
              insStart.config.max = lay.extend({}, date, {
                  month: date.month - 1
              });
          }
      });
      $('.layui-btn').on('click', function () {
          var type = $(this).data('type');
          active[type] ? active[type].call(this) : '';
      });
      var $ = layui.$, active = {
    		  
              addEvent: function() { //点击查询按钮
            	  add_Eventd();
                 
              }
      }
      /* 监听提交 */
      form.on('submit(sub)', function(data){
          //JSON.stringify(data.field)  提交信息json格式
          /*parent.layer.alert(JSON.stringify(data.field), {
              title: '最终的提交信息'
          })*/
          var url="/sre-project-basic/save?v_date="+v_date+"&status=0";
          var backurl="/sre-project-basic/to-list?v_date="+v_date;
          ajaxOpt(url,"form1","POST",backurl,"保存成功","保存失败");
          return false;
      });
      
      /* 监听提交 */
      form.on('submit(up)', function(data){
          //JSON.stringify(data.field)  提交信息json格式
          /*parent.layer.alert(JSON.stringify(data.field), {
              title: '最终的提交信息'
          })*/
          var url="/sre-project-basic/save?v_date="+v_date+"&status=1";
          var backurl="/sre-project-basic/to-list?v_date="+v_date;
          ajaxOpt(url,"form1","POST",backurl,"保存成功","保存失败");
          return false;
      });
      
});



function ajaxOpt(url,formName,type,backurl,successMsg,failMsg)
{
	$("#equipmentIds").val($("#equipmentIds").val());
	 $.ajax({
  	     type:type,
  	     url: url,
  	     dataType:"json",
  	     data:$("#"+formName).serialize(),
  	     async: false, 
  	     cache: false,
  	     contentType: "application/x-www-form-urlencoded; charset=utf-8",
         success:function(data,status)
         {    
    	  
	          if(data.success==true ||data.success=='true')
	          {

	        	  
	        	          layer.alert(
	        			  successMsg, 
	                      {icon: 1,closeBtn: 0 },
	                      function () 
	                      {
	                    	  var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
	                          parent.layer.close(index);  // 关闭layer
	                    	  parent.location.href=backurl;
	                      });
	        	  
	          } else
	          {
	        	 layer.alert(failMsg);
	          }
	     
		   },
		   error:function()
		   {
		    	layer.alert("网络访问错误");
		   }
    
  });
}




var t;
function add_Eventd()
{
	t=layer.open({
        title:'选择装备',
        skin: 'layui-layer-lan',
        shadeClose: true,
        type: 2,
        fixed: false,
        //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
        maxmin: false,
        //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
        area: ['60%', '70%'],
        content:  '/sre-equipment/search-equipment?equipmentIds='+$("#equipmentIds").val()
    });
}


function renderTable(id)
{ 
   //渲染
   table.render({
       elem: '#eqiu_table',
       url: '/sre-equipment/list',
       method:"POST",
       where: {param: {"equipmentIds":id,"name":""}},
       limit: 15,
       height: commonDislodgeTable(),
       id: 'eqiu_table',
       cols: [[
       	{type:'checkbox',event: 'changeEvents',width: '3%'},
       	{title:'序号', type:'numbers', width: '4%'},
           {field:'equipmentCode', title:'编号',        style:'cursor: pointer;',align: 'center'},
           {field:'name',        title:'装备名称',     style:'cursor: pointer;',align: 'center'},
           {field:'auditStatus', title:'流程状态',     style:'cursor: pointer;',align: 'center',templet: '#buttonTpl'},
           {field:'meetingId',   title:'技术交流',     style:'cursor: pointer;',align: 'center'},
           {field:'createDate',  title:'时间',        style:'cursor: pointer;',align: 'center',templet: '#dateTpl'}
       ]],
       done: function (res, curr, count) {
           // 点击行联动选择框--单选
           $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
           	var index=parseInt($(this).index()+1);
               $('tr').removeClass('layui-table-click');
               $(this).addClass('layui-table-click');
               $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
               $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
               selectRowData=res.data[index-1];
           });
       }
   });
}



function upload_File(name) {
	
    var param = {};
    if(document.getElementById(name)){
        param.file_id_name = name;
        param.file_ids_value = $("#" + param.file_id_name).val();
    }else {
        param.file_ids_value = name;
    }
    param.callback = "call_fun";//回调函数名称
    param.file_opt_flag = "4d79552ec98849f6b32da1af921df81e";//文件配置ID
    param.file_edit_detail = "edit";//新增、修改用edit, 显示用detail
    var temUrl = "/sysFilePage/uploadFile?param=" + encodeURIComponent(JSON.stringify(param));
    openBaseWin("文件上传", temUrl);
}

function call_fun(data, param)
{
    //param:返回上面拼装的参数json字符串，data：json文件数组
    console.log("-------------call_fun___________");
    console.log(data);
    console.log(param);
    for (var key in data) 
    {
        //console.log(key);
        // var obj_file = data[key];
        //console.log("文件名称："+obj_file.fileName+"  文件大小："+obj_file.fileSize+"  文件路径:"+obj_file.filePath);
    }
}

function showdialog() {
    openBaseWin("选择", "/sysfileshare/dialog_user_list");
}

function clearNoNum(obj){ 
    obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符  
    obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的  
    obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$","."); 
    obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数  
    if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额 
        obj.value= parseFloat(obj.value); 
    } 
}

//关闭事件
$("#closeBtn").click(function () {
    var index = parent.layer.getFrameIndex(window.name);
    parent.layer.close(index);
})
</script>
</body>
</html>