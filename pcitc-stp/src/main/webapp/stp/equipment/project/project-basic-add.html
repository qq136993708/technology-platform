<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
  <!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/layuiadmin/style/common.css">
  <script src="/common/js/jquery-1.11.3.min.js"></script>
  
  <script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
  <script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
</head>
<body>
  <div class="layer-box">
	<form id="planForm" class="layui-form" action="" lay-filter="component-form-group layui-container"></form>
		<div class="formBox">
			<div class="tableToolBox">
				<div class="tableBtns">
					<div class="tableTitle">基本信息<span class="red">（标*号为必填项）</span>
					</div>
				</div>
			</div>
		</div>
		<div class="">
  			<table id="eqiu_table" class="layui-hide" lay-filter="tableEvent"></table>
  		</div>
  <div class="box-body">
  <form   class="layui-form"    name="form1"     id="form1" action="" method="POST" lay-filter="component-form-group layui-container">
  <input  name="id"      id="id"       value="${id}"                    type="hidden" >
  <input  name="equipmentIds"   id="equipmentIds"    value="${sreProjectBasic.equipmentIds}" type="hidden"  >
  <input  name="documentDoc"    id="documentDoc"     value="${documentDoc}"                  type="hidden">
  <input  name="yearFeeStr"     id="yearFeeStr"      value="${sreProjectBasic.yearFeeStr}"   type="hidden">
  <input  name="functionId"     id="functionId"      type="hidden">
  <input  name="userIds"        id="userIds"         type="hidden">
  
    
      
  
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">课题名称<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="name" id="name" value="${sreProjectBasic.name}"  lay-verify="required"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">关键词</label>
            <div class="layui-input-block">
              <input class="layui-input" name="keyWord" id="keyWord" value="${sreProjectBasic.keyWord}"   autocomplete="off" type="text">
            </div>
          </div>
        </div>
      </div>
        
     
       <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">牵头单位<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="leadUnitName" id="leadUnitName" value="${sreProjectBasic.leadUnitName}"  lay-verify="required"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
          <div class="layui-form-item">
            <label for="" class="layui-form-label">参加单位<span class="must-fill">*</span></label>
            <div class="layui-input-block">
              <input class="layui-input" name="joinUnitName" id="joinUnitName" value="${sreProjectBasic.joinUnitName}"  lay-verify="required"  autocomplete="off" type="text">
            </div>
          </div>
        </div>
      </div>
      
      
      
       <div class="layui-form-item">
	      	 <label class="layui-form-label">选择装备<span class="must-fill">*</span></label>
	         <div class="layui-input-block">
	         	<div class="tableBox">
		         	<div class="tableToolBox">
				        <div class="whiteLine"></div>
				        <div  class="tableBtns">
				            <a href="javascript:void(0)" class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg" data-type="selectEvent">选择</a>
				        </div>
				    </div>
	         		<table id="join_apply_table" class="layui-hide"  lay-filter="JoinEvent"></table>
	         	</div>
	        </div>
       	</div>
       	
      
      
        
        <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">委托单位<span class="must-fill">*</span></label>
        <div class="layui-input-block">
         <input class="layui-input" name="entrustUnitName" id="entrustUnitName" placeholder="中国石油化工股份有限公司" value="中国石油化工股份有限公司"  lay-verify="required"  autocomplete="off" type="text">
        </div>
      </div>
    
      
      
      
       <!--行有两个的情况-->
      <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">备注</label>
        <div class="layui-input-block">
          <textarea placeholder="请简述开发及投资目标，原则上不超过500字" name="remarks" id="remarks"    class="layui-textarea">${sreProjectBasic.remarks}</textarea>
        </div>
      </div>
      
       <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label">建设年限</label>
        <div class="layui-input-block">
           <div class="layui-input-inline" style="float:left">
		            <input type="text" class="layui-input" name="beginYear" id="beginYear" value="${beginYear}" style="width:80px;float:left" placeholder="开始年份">
		             <div class="layui-form-mid" style="width:8px;float:left"> - </div>
		            <input type="text" class="layui-input" id="endYear" name="endYear"   value="${endYear}" style="width:80px;float:left" placeholder="结束年份">
		    </div>
        </div>
      </div>
      
      
       <div class="layui-form-item layui-form-text" >
        <label class="layui-form-label"></label>
        <div class="layui-input-block" id="yearTr">
            <table class="layui-table">
             <thead>
	             <tr>
	                <td width="20%">年  度</td>
	                <td width="8%">费用性支出(万元)</td>
	                <td width="8%">资本性支出(万元)</td>
	                <td width="8%">小  计(万元)</td>
	             </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      
      
      
      
      
      
      
     
      
      
       <div class="layui-form-item">
	      	 <label class="layui-form-label">附件</label>
	         <div id="file_div" class="layui-input-block"></div>
       </div>
      
      
      
      
      
      
     
      
    
    
    <div class="form-bottom">
	  		<div class="form-bottom-btns">
	    		<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"   lay-submit="" lay-filter="sub">保存</button>
             	<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue"  lay-submit="" lay-filter="up">上报</button>
          		<button type="button"class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn">关闭</button>
	  		</div>
		</div>
</form>
</div>
</div>
<script>
var param=JSON.parse(window.localStorage.getItem("param"));
var functionId=param.id;
$('#functionId').val(functionId);
var roleCodes = "";
var unitCodes = "";
var postCodes = "";


var v_date=(new Date()).getTime();
var file_ids = "documentDoc";
//detail:详情，edit：编辑
file_edit_detail = "edit";
//统管理-附件管理-附件配置：页面标识
file_opt_flag = "b3a52bbe7087419c80813d7716f37674";
var equipmentIds=$("#equipmentIds").val();
var yearFeeStr= $("#yearFeeStr").val();
var beginYear= $("#beginYear").val();

var table,selectRowData;
layui.use(['form','table','laypage','layer','laydate','laytpl','jquery',"publicMethods"], function(){

	  var admin = layui.admin
      element = layui.element
      ,table = layui.table
      ,layer = layui.layer
      ,laydate = layui.laydate
      ,laypage = layui.laypage
      ,$ = layui.jquery
      ,form = layui.form;
	  var publicMethods=layui.publicMethods;
	  form.render();
	  laydate.render({
	      elem: '#LAY-component-form-group-date'
	  });
	  
	  var equipmentIds= $("#equipmentIds").val();
	  renderTable(equipmentIds)
	  
	  publicMethods.createTable($("#beginYear").val(),$("#endYear").val(),"yearTr",2,yearFeeStr);
	  
      


	  //添加到form.render()之后
	 	$("#file_div").load('/common/public/uploadlayuiload.html');
	  
	  
      /* 自定义验证规则  title 要验证的input的 lay-verify=""*/
      form.verify({
    	  name: function(value)
    	  {
              if(value.length < 5)
              {
                  return '装备名称至少得5个字符啊';
              }
          },
          planMoney: [/(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/,'计划金额格试不正确'] 
         /*  ,pass: [/(.+){6,12}$/, '密码必须6到12位']
          ,content: function(value){
              layedit.sync(editIndex);
          } */
      });
     
      
    //开始日期
      var insStart = laydate.render({
          elem: '#beginYear'
          ,min: 0,type: 'year'
          ,done: function(value, date){
              //更新结束日期的最小日期
              insEnd.config.min = lay.extend({}, date, {
                  month: date.month - 1
              });
              //自动弹出结束日期的选择器
              insEnd.config.elem[0].focus();
          }
      });

      //结束日期
      var insEnd = laydate.render({
          elem: '#endYear'
          ,min: 0,type: 'year'
          ,done: function(value, date){
              //更新开始日期的最大日期
              insStart.config.max = lay.extend({}, date, {
                  month: date.month - 1
              });
              publicMethods.createTable($("#beginYear").val(),date.year,"yearTr",2,yearFeeStr);
          }
      });
      $('.layui-btn').on('click', function () {
          var type = $(this).data('type');
          active[type] ? active[type].call(this) : '';
      });
      var $ = layui.$, active = {
    		  selectEvent: function(){ 
	    			//var temUrl = "/intl_project/plant_edit_selectapply?equipmentIds="+$("#equipmentIds").val();
	    			var temUrl = '/sre-project-basic/project_basic_add_selectapply?equipmentIds='+$("#equipmentIds").val();
	                publicMethods.openBaseWin("选择装备",temUrl,"90%","80%");
	    		
	            }/* ,
	            deleteEvent:function(){
	            	layer.confirm('确定要移除吗？',{title:"移除确认"},function(index){
						layer.close(index);
		            	var check = table.checkStatus('join_apply_table');
		            	var equipmentIds=$("#equipmentIds").val();
		            	for(var dt in check.data)
		            	{
		            		var id=check.data[dt].equipmentId;
		            		
		            		equipmentIds=equipmentIds.replace(id,'');
		            	}
		            	$("#equipmentIds").val(equipmentIds);
		            	renderTable(equipmentIds);
	            	});
	            }  */
    		  
      }
      /* 监听提交 */
      form.on('submit(sub)', function(data){
          //JSON.stringify(data.field)  提交信息json格式
          /*parent.layer.alert(JSON.stringify(data.field), {
              title: '最终的提交信息'
          })*/
          $("#yearFeeStr").val(publicMethods.getVal("yearTr",4)); 
          var yearFee_Str= $("#yearFeeStr").val();
          if(yearFee_Str==null || yearFee_Str=='')
          {
        	  layer.alert("建设年限为空");
          }else
       	  {
       	   
             var url="/sre-project-basic/save?v_date="+v_date+"&status=0";
             var backurl="/sre-project-basic/to-list?v_date="+v_date;
             ajaxOpt(url,"form1","POST",backurl,"保存成功","保存失败");
       	  }
          
         
          return false;
      });
      
      /* 监听提交 */
      form.on('submit(up)', function(data){
          //JSON.stringify(data.field)  提交信息json格式
          /*parent.layer.alert(JSON.stringify(data.field), {
              title: '最终的提交信息'
          })*/
          $("#yearFeeStr").val(publicMethods.getVal("yearTr",4)); 
          var yearFee_Str= $("#yearFeeStr").val();
          if(yearFee_Str==null || yearFee_Str=='')
          {
        	  layer.alert("建设年限为空");
          }else
       	  {
        	  dealFlow(data);
       	  }
          return false;
      });
      
});



function ajaxOpt(url,formName,type,backurl,successMsg,failMsg)
{
	$("#equipmentIds").val($("#equipmentIds").val());
	 $.ajax({
  	     type:type,
  	     url: url,
  	     dataType:"json",
  	     data:$("#"+formName).serialize(),
  	     async: false, 
  	     cache: false,
  	     contentType: "application/x-www-form-urlencoded; charset=utf-8",
         success:function(data,status)
         {    
    	  
	          if(data.success==true ||data.success=='true')
	          {

	        	  
	        	          layer.alert(
	        			  successMsg, 
	                      {icon: 1,closeBtn: 0 },
	                      function () 
	                      {
	                    	  var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
	                          parent.layer.close(index);  // 关闭layer
	                    	  parent.location.href=backurl;
	                      });
	        	  
	          } else
	          {
	        	 layer.alert(failMsg);
	          }
	     
		   },
		   error:function()
		   {
		    	layer.alert("网络访问错误");
		   }
    
  });
}

function renderTable(equipmentIds)
{
	  $("#equipmentIds").val(equipmentIds);
	  table.render({
          elem: '#join_apply_table',
          url: '/sre-equipment/list_by_quipment_ids?equipmentIds='+equipmentIds,
          limit: 15,
          method:"GET",
      	  id: 'join_apply_table',
          height: 200,
          page: {first: '首页',last: '尾页',theme: '#0F9EE0'},
          cols: [[
          	 {type:'checkbox',event: 'changeEvents'}
          	 ,{title:'序号', type:'numbers'},
          	{field : 'auditStatus', title : '状态', style : 'cursor: pointer;', align : 'center', templet : '<div>{{ layui.laytpl.auditStatus_equipment(d.auditStatus) }}</div>', width : 55},
            {field : 'name',     title : '装备名称', style : 'cursor: pointer;', align : 'center', width : '20%'},
            {field : 'type',     title : '装备分类', style : 'cursor: pointer;', align : 'center', width : '10%'},
            {field : 'unitPrice', title : '单价（万元）', style : 'cursor: pointer;', align : 'center', width : '10%'},
            {field : 'applyAcount', title : '申请数量', style : 'cursor: pointer;', align : 'center', width : '10%'},
            {field : 'allPrice', title : '总价¥（万元）', style : 'cursor: pointer;', align : 'center', width : '10%',templet:function(d){return '<span style="color:red">'+d.allPrice+'</span>'}},
            {field : 'applyDepartName', title : '申报部门', style : 'cursor: pointer;', align : 'center', width : '10%'},
            {field : 'firstApplyUser', title : '第一申报人', style : 'cursor: pointer;', align : 'center', width : '10%'}
             
          ]]
      });
}



function dealFlow(data) 
{
	
	
	 $.ajax({
         type : 'POST',
         url : "/workflow/start/audit-type",
         contentType: "application/json;charset=UTF-8",
         data : JSON.stringify(data.field),
         //json中有functionId（projectId、departmentId等）用来区别processDefine的属性
         success : function(data) {
      	   if (data.code == 'role') {
          		// 按角色选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
          		// roleCodes，参数名必须一致，方便公共弹出页面调用
          		roleCodes = data.data;  // 弹出页面的隐藏的查询条件
          		var temUrl="/task/deal/users/ini";
                  layer.open({
                      title:'选择审批人',
                      skin: 'layui-layer-lan',
                      shadeClose: true,
                      type: 2,
                      fixed: false,
                      //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                      maxmin: true,
                      //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                      area: ['800px', '550px'],
                      content:  temUrl
                  });
          	} else if (data.code == 'unit' || data.code == 'post') {
          		// 按部门/岗位选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
          		// unitCodes、postCodes，参数名必须一致，方便公共弹出页面调用
          		if (data.code == 'unit') {
          			unitCodes = data.data;  // 弹出页面的隐藏的查询条件
          		} else {
          			postCodes = data.data;  // 弹出页面的隐藏的查询条件
          		}
          		
          		var temUrl="/task/deal/user/unit/ini";
                  layer.open({
                      title:'选择审批人',
                      skin: 'layui-layer-lan',
                      shadeClose: true,
                      type: 2,
                      fixed: false,
                      //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                      maxmin: true,
                      //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                      area: ['800px', '550px'],
                      content:  temUrl
                  });
          	} else if (data.code == 'int') {
          		layer.msg('启动参数不足');
          	} else if (data.code == 'con') {
          		layer.msg('请给此功能菜单配置流程');
          	} else if (data.code == 'exist') {
          		layer.msg('工作流部署异常，请联系管理员');
          	} else {
          		// 直接处理此任务
          		handleTask('');
          	}
         },
         error : function(msg) {//请求失败处理函数  
        }
     });
}

//处理任务（启动流程）的方法，方法名固定，为了通用选择审批人员的弹出页面调用
function handleTask(userIds) 
{
	
	$('#userIds').val(userIds);
    var url="/sre-project-basic/save?v_date="+v_date+"&isWorkFlow=1&functionId="+param.id;
    var backurl="/sre-project-basic/to-list?v_date="+v_date;
    ajaxOpt(url,"form1","POST",backurl,"保存成功","保存失败");
}






function showdialog() {
    openBaseWin("选择", "/sysfileshare/dialog_user_list");
}

function clearNoNum(obj){ 
    obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符  
    obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的  
    obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$","."); 
    obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数  
    if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额 
        obj.value= parseFloat(obj.value); 
    } 
}

//关闭事件
$("#closeBtn").click(function () {
    var index = parent.layer.getFrameIndex(window.name);
    parent.layer.close(index);
})
</script>
</body>
</html>