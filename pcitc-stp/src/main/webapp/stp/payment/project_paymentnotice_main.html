<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css">
<link rel="stylesheet" href="/layuiadmin/style/admin.css">
<script src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<style>
.dateInput {
	font-size: 12px;
}

.layuiadmin-btn-list {
	height: 30px;
	line-height: 30px;
	padding: 0 15px;
}

.layuiadmin-card-header-auto i.layuiadmin-button-btn {
	font-size: 14px;
}

.layui-laydate-hint {
	display: none;
}
.layui-table-fixed{width: 157px;}
</style>
</head>
<body>

	<!-- 国家项目、重大专项、重点项目、其他项目   -->
	<input type="hidden" name="project_property" value="${project_property}" id="project_property">
	<!-- 新开项目、续建项目、完工项目  -->
	<input type="hidden" name="project_scope" value="${project_scope}" id="project_scope">
	<input type="hidden" name="projectId" value="${projectId}" id="projectId">
	<!-- 直属研究院、分子公司、集团等9种类型 -->
	<input type="hidden" name="type_flag" value="${type_flag}" id="type_flag">
	<input type="hidden" name="leaderFlag" value="${leaderFlag}" id="leaderFlag">
	<input type="hidden" name="ktlx" value="${ktlx}" id="ktlx">
	<div class="layui-fluid">
		<div class="layui-card">

			<div class="layui-form layui-card-header layuiadmin-card-header-auto" style="padding: 0px">
				<form id="paymentplan-form" name="paymentplan-form" lay-filter="paymentplan-form" class="form-horizontal layui-form">
				<div class="layui-form-item">
					<!-- <div class="layui-inline">
						<label class="layui-form-label">项目名称：</label>
						<div class="layui-input-inline">
							<input type="text" name="xmmc" title="项目名称" placeholder="请输入项目名称" autocomplete="off" class="layui-input" id="xmmc">
						</div>
					</div> -->

					<!-- <div class="layui-inline">
						<label class="layui-form-label">合同号：</label>
						<div class="layui-input-inline">
							<input type="text" name="hth" title="合同号" placeholder="请输入合同号" autocomplete="off" class="layui-input" id="hth">
						</div>
					</div> -->


					<!-- <div class="layui-inline">
						<label class="layui-form-label">立项年度：</label>
						<div class="layui-input-inline">
							<input type="text" name="nd" readonly="readonly" style="cursor: pointer" placeholder="请选择立项年度" title="立项年度" value="${nd}" autocomplete="off" class="layui-input" id="nd" width="100px">
						</div>
					</div> -->
					<!-- <div class="layui-inline">
						<label class="layui-form-label">拨款年度：</label>
						<div class="layui-input-inline">
							<input type="text" name="ysnd" readonly="readonly" style="cursor: pointer" placeholder="请选择拨款年度"  title="拨款年度" value="${ysnd}" autocomplete="off" class="layui-input" id="ysnd" width="100px">
						</div>
					</div> -->
					<div class="select">
						<input type="hidden" id="paymentStatus" name="paymentStatus" value="1">
						<!-- <div class="layui-inline">
							<label class="layui-form-label">拨付批次：</label>
							<div class="layui-input-inline">
								<select name="define17" id="define17">
									<option value="">--请选择--</option> 
								</select>
							</div>
						</div> -->
						<div class="layui-inline">
							<label class="layui-form-label">报销批次：</label>
							<div class="layui-input-inline">
								<select name="define18" id="define18">
									<option value="">--请选择--</option> 
								</select>
							</div>
						</div>
				</div>
				<!-- 
				<button  class="layui-btn layuiadmin-btn-list" id="Open" style="position: absolute;top: 4px;right: 14px; height: 27px;width: 40px;padding: 0;text-align: center;display: block;}">展开</button>
				 -->
				</div>
				</form>
				<div class="layui-inline" style="margin-left: 48px;">
					<button class="layui-btn layuiadmin-btn-list" data-type="searchEvent">
						<i class="layui-icon layui-icon-search layuiadmin-button-btn">查询</i>
					</button>
				</div>
				<div class="layui-inline">
					<button class="layui-btn layuiadmin-btn-list" data-type="resetEvent">
						<i class="layui-icon  layuiadmin-button-btn">重置</i>
					</button>
				</div>
				<!-- <div class="layui-inline">
					<button class="layui-btn layuiadmin-btn-list" data-type="createNoticeEvent">
						<i class="layui-icon  layuiadmin-button-btn">生成报销通知单</i>
					</button>
				</div> -->
			</div>

			<div class="layui-card-body">
				<div class="tableToolBox">
		            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_deploy btnMyBgImg"
		                    data-type="createNoticeEvent">生成报销通知单
		            </button>
		           <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_export btnMyBgImg"
		                    data-type="sentNoticeEvent">发送报销通知单
		            </button>
		        </div>
		        <table id="dataTable" class="layui-hide"  lay-filter="tableEvent"></table>
			</div>
		</div>
	</div>
	
	<!--表格数据操作js-->
	<script src="/common/js/jquery-1.11.3.min.js"></script>
	<script id="view_format" type="text/html"> {{purchase_money_jf(d.ysje)}} </script>

	<script>
		var laydate;
		var xmmc = $('#xmmc').val();
		var form;
		var nd = "${nd}";
		var ysnd = "${ysnd}";
		var selectRowData = [];
		layui.config({
			base : '/layuiadmin/lib/extend/'
		}).use(['jquery', 'form', 'laydate', 'table', 'laypage','layer','publicMethods','treeGridCom' ], function() {
			$ = layui.jquery,publicMethods=layui.publicMethods,table = layui.table,treeGridCom = layui.treeGridCom;
			laydate = layui.laydate;
			layer = layui.layer;
			form = layui.form;
			form.render();
			laydate.render({
				elem : '#nd',
				type : 'year',
				done : function(value, date, endDate) {
					$("#nd").val(date.year);
				}
			});
			laydate.render({
				elem : '#ysnd',
				type : 'year',
				done : function(value, date, endDate) {
					$("#ysnd").val(date.year);
					getPayBeachNo();
				}
			});
			//报销批次 
			function getPayBeachNo(){
				publicMethods.ajaxPost("/payment/project-paymentnotice-batchs",{"ysnd":$("#ysnd").val()}, function (data) {
		   			$("#define18").html("<option value=''>--请选择--</option>");
		   			$.each(data,function(index,dt){
		   				$("#define18").append("<option value='"+dt.numValue+"'>"+dt.name+"</option>");
		   			});
		   			form.render();
		   		}); 
			}
			//移除表头的复选框,去掉全选
			$(".layui-table-header table thead th input").remove();
			// 触发不同的按钮事件
			var $ = layui.$, active = {
				searchEvent : function() { //点击查询按钮
					renderTable();
				},
				resetEvent : function() {
					$('#define17').val("");
					$('#define18').val("");
					form.render();
				},
				createNoticeEvent:function(){
					 layer.confirm('确定要生成报销通知单吗？',{title:"生成确认"},function(index){
		            	var lodingMsg = layer.msg('处理中....');
		            	publicMethods.ajaxAsyncPost('/payment/project-paymentnotice-create', selectRowData, function (data, status) {
		            		window.open("/payment/project-paymentnotice-create");
		                }); 
		            });
				},
				sentNoticeEvent:function(){
					layer.confirm('确定要发送报销通知单吗？',{title:"发送确认"},function(index){
		            	var lodingMsg = layer.msg('处理中....');
		            	publicMethods.ajaxAsyncPost('/payment/project-paymentnotice-sent', data.field, function (data, status) {
		                    if (data.success) {
		                    	var index = parent.layer.getFrameIndex(window.name);
		                    	parent.renderTable();
		        			    parent.layer.close(index);
		                    }else{
		                    	parent.layer.alert(data.message, {title : '信息'});
		                    	layer.close(lodingMsg);
		    					return;
		                    }
		                    layer.close(lodingMsg);
		                }); 
		            });
				}

			};
			//区别按钮属性
			$('.layui-btn').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
			function renderTable() {
				var where ={param:{"define17":"","define18":$('#define18').val()}};
				var lodingMsg = layer.msg('数据加载中....');
	    		var param = JSON.parse(window.localStorage.getItem("param"));
	    		tableId = 'dataTable';
	    		treeGridCom.render({
	    			id:tableId
	                ,elem: '#'+tableId
	                ,url:'/payment/company-list'
	                ,where:where
	                ,cellMinWidth: 100
	                ,idField:'id'//必須字段
	                ,treeId:'id'//树形id字段名称
	                ,treeUpId:'pId'//树形父id字段名称
	                ,treeShowName:'define8'//以树形式显示的字段
	                ,heightRemove:[".dHead",10]//不计算的高度,表格设定的是固定高度，此项不生效
	                ,height: commonDislodgeTable()
	                ,isFilter:false
	                ,iconOpen:true//是否显示图标【默认显示】
	                ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
	                ,loading:true
	                ,method:'POST'
	                ,page:true
		            ,page: {
		                groups: 5
		                ,limits : [ param.selfRownum, 15, 30, 45, 60 ]
		                ,layout: ['count', 'limit', 'prev', 'page', 'next', 'skip'] //自定义分页布局
		                ,first: '首页' //不显示首页
		                ,last: '尾页' //不显示尾页
		                ,theme: '#0F9EE0'
			        },
		            cols: [[
		            	{type:'checkbox',style: 'cursor: pointer;',width: 55}
		            	,{title:'序号', type:'numbers' ,width : 55}
		            	,{field:'define8', width:'20%', title: '公司名称'}
		            	,{field:'xmmc',title:'项目名称',	width: '15%',  style:'cursor: pointer;',align:'left'}
		            	,{field:'hth',   title:'合同号', width: '8%',  style:'cursor: pointer;',align:"center"}
		            	,{field:'nd',   title:'年度', width: '8%',  style:'cursor: pointer;',align:"center"}
			            ,{field:'ysnd',   title:'预算年度',      style:'cursor: pointer;',align:"center"}
			            ,{field:'define11',title:'经费来源',	width: '10%', style:'cursor: pointer;'}
			            ,{field:'gsbmmc',title:'部门',	width: '10%',  style:'cursor: pointer;'}
			            ,{field:'define10',title:'专业处',	width: '10%',  style:'cursor: pointer;'}
			            ,{field:'fzdw',title:'负责单位',	width: '15%',  style:'cursor: pointer;'}
			            ,{field:'ysje',title:'金额（万元）',	width: '15%',  style:'cursor: pointer;',align:'right',templet : '#view_format'}
		            ]],
		            done: function (res, curr, count) {
		            	layer.close(lodingMsg);
		            	/* $.each(res.data,function(i,dt){
			            	console.log(dt);
			            }); */
		            },
		            onDblClickRow:function(index, o){
		            	console.log(index);
		            	console.log(o);
		            }
		        });
		        renderfunc = function removeHeaderCheckbox(){
		        	$(".layui-table-header table thead th input").remove();  //移除表头的复选框,去掉全选
		        }
		        renderfunc();
			}
			//监听选中
			treeGridCom.on('checkbox(tableEvent)', function(obj){
				if(obj.data.lay_level == 1)
				{
					if(obj.checked)
					{
						console.log(obj);
						$.each(obj.data.children,function(i,d){
							selectRowData.push(obj.data.children[i]);
						});
						console.log(selectRowData);
					}else{
						selectRowData = [];
					}
				}
	    	});
			
			getPayBeachNo();
			renderTable();
		});
		
		
		
		function purchase_money(jf) {
			return '<span style="color:red">' + jf + '</span>';
		}
		function purchase_money_jf(jf) {
			
			if (jf != null) {
				var h_strs = jf.substring(jf.lastIndexOf("."), jf.length);
				if (h_strs == '.0000') {
					jf = jf.replace(".0000", "");
				}
				return '<span>' + jf + '</span>';
			} else {
				return "<span></span>";
			}
		}
	</script>
</body>

</html>
