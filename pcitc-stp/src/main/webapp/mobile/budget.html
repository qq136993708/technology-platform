<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>科技管理平台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=0" />
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/mobile/css/mobileNew.css">
    <style>
        .layui-tab-item{    margin: 0 2%;}
    </style>
</head>
<body>
<input type="hidden" name="nd" id="nd" value="${nd}">
<header>
    <div class="m_return child">
        <a href="/mobile/indexTest"><img src="/mobile/images/icon-back.png"/> </a>
        <h4>科研预算</h4>
        <div id="test-laydate-normElem" placeholder="yyyy" class="laydate-c"></div>
    </div>
</header>
<main class="main budget">
    <div class="layui-tab">
        <div style="padding-top: .18rem;    margin: 0 2%;">
            <ul class="layui-tab-title">
                <li class="layui-this">专业处</li>
                <li>研究院</li>
                <li>总体情况</li>
            </ul>
        </div>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div class="layui-row">
                    <div class="layui-col-xs4">
                        <span id="yzc_all_id">-亿</span>
                        <span>总预算</span>
                        <span></span>
                    </div>
                    <div class="layui-col-xs4">
                        <span id="yzc_finished_id">-亿</span>
                        <span>已签</span>
                        <span></span>
                    </div>
                    <div class="layui-col-xs4">
                        <span id="yzc_rate_id">-%</span>
                        <span>签约率</span>
                        <span></span>
                    </div>
                </div>
                <ul id="zyc_id">
                </ul>
            </div>
            <div class="layui-tab-item">
                <div class="layui-row">
                    <div class="layui-col-xs4">
                        <span id="yjy_all_id">-亿</span>
                        <span>预算</span>
                        <span></span>
                    </div>
                    <div class="layui-col-xs4">
                        <span id="yjy_finished_id">-亿</span>
                        <span>已签约</span>
                        <span></span>
                    </div>
                    <div class="layui-col-xs4">
                        <span id="yjy_rate_id">-%</span>
                        <span>执行率</span>
                        <span></span>
                    </div>
                </div>
                <ul  id="researchDepart_id">
                </ul>
            </div>
            <div class="layui-tab-item">
                <div class="layui-row">
                    <div class="layui-col-xs4">
                        <span id="other_all_id">-亿</span>
                        <span>预算</span>
                        <span></span>
                    </div>
                    <div class="layui-col-xs4">
                        <span id="other_finished_id">-亿</span>
                        <span>已投入</span>
                        <span></span>
                    </div>
                    <div class="layui-col-xs4">
                        <span id="other_rate_id">-%</span>
                        <span>执行率</span>
                        <span></span>
                    </div>
                </div>
                <ul id="other_id">
                </ul>
            </div>
        </div>
    </div>
</main>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script>
    var layer;
    (function(doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function() {
                var clientWidth = docEl.clientWidth;
                if (!clientWidth) return;
                docEl.style.fontSize = 100 * (clientWidth / 414) + 'px';
            };
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
    layui.use(['jquery','layer','element','laydate'], function(){
        var $=layui.jquery;layer=layui.layer,element=layui.element,laydate = layui.laydate;
        laydate.render({
            elem: '#test-laydate-normElem'
            ,type: 'year'
            ,max: $("#nd").val()+1
            ,value:$("#nd").val(),
            done : function(value, date, endDate) 
            {
            	    $("#nd").val(date.year);
					search_Event();
			}
        });
    });
    
    
    
    //专业处
    function zyc()
    {
    	var v_date = (new Date()).getTime();
    	var nd = $('#nd').val();
    	var url = "/mobile/investment_03?functionId=984b64b13cf54222bf57bd840759fabe&type=mobile&nd=" + nd + "&v_date=" + v_date + "&type=1&xkFlag=1";
    	$.ajax({
    		type : "GET",
    		url : url,
    		timeout : 9000,
    		dataType : "json",
    		cache : false,
    		headers : {
    			'Content-Type' : 'application/json'
    		},
    		success : function(data, status) 
    		{
    			 console.log(data.data);
    			 var count="";
    			 var all=0;
    			 var finished=0;
    			 if(data.data.length>0)
    			 {
    				 for(var i=0;i<data.data.length;i++)
        			 {
    					var zycmc= data.data[i].zycmc;//专业处
    					var ysxkje=data.data[i].ysxkje;//预算金额
    					var xkMoney=data.data[i].xkMoney;//已签金额
    					
    					if(zycmc!='合计')
   						{
    					  all=all+parseFloat(ysxkje);
    					  finished=finished+parseFloat(xkMoney);
   						}
    					var rate=(xkMoney/ysxkje*100).toFixed(2);
    					
    					var yq=parseFloat(xkMoney).toFixed(2);
    					
    					
    					var wclCount="";
    					if(rate=='0.00')
    					{
    						rate=0;
    					}
    					if(parseInt(rate)>100)
                     	{
    						 wclCount="<span>完成率<lable style='color:red'>"+rate+"%</lable></span>";
                     	}else
                     	{
                     		wclCount="<span>完成率"+rate+"%</span>";
                     	}
    					var temp="";
    					if(zycmc!='合计')
   						{
    						 temp="<li>"+
				    				"<p>"+
				                        "<span>预算 "+setNumStr(ysxkje)+"</span>"+
				                        "<span>"+zycmc+"</span>"+
				                    "</p>"+
				                    "<p>"+
				                        "<span>已签"+setNumStr(yq)+"</span>"+wclCount+
				                    "</p>"+
			                       "</li>";
   						}
    					count=count+temp;
        			 } 
    			 }
    			 $("#zyc_id").html(count); 
    			 
    			 //总金额
   				 $("#yzc_all_id").html((parseFloat(all)/10000).toFixed(2) + "<lable >亿<lable>");
   				 $("#yzc_finished_id").html((finished/10000).toFixed(2) + "<lable >亿<lable>");
   				 var zRate = finished * 100 / all;
   				 $("#yzc_rate_id").html(zRate.toFixed(2) + "%");
    		},
    		error : function() {
    		},
    		complete : function(XMLHttpRequest, status) {
    		}
    	});
    	
    }
    
    //研究院
    function researchDepart()
    {
		
    	var v_date = (new Date()).getTime();
    	var nd = $('#nd').val();
    	var url = "/mobile/investment_02?functionId=984b64b13cf54222bf57bd840759fabe&type=mobile&nd=" + nd + "&v_date=" + v_date;
    	$.ajax({
    		type : "GET",
    		url : url,
    		timeout : 9000,
    		dataType : "json",
    		cache : false,
    		headers : {
    			'Content-Type' : 'application/json'
    		},
    		success : function(data, status) 
    		{
    			 console.log(data.data);
    			 var count="";
    			 var all=0;
    			 var finished=0;
    			 if(data.data.length>0)
    			 {
    				 for(var i=0;i<data.data.length;i++)
        			 {
    					var define2= data.data[i].define2;//研究院
    					var zysje=data.data[i].zysje;//预算金额
    					var zsjje=data.data[i].zsjje;//实际科研投入
    					var jeRate=data.data[i].jeRate;//预算执行率
    					
    					all=all+parseFloat(zysje);
    					finished=finished+parseFloat(zsjje);
    					var temp="<li>"+
				    				"<p>"+
				                        "<span>预算 "+setNumStr(zysje)+"</span>"+
				                        "<span>"+define2+"</span>"+
				                    "</p>"+
				                    "<p>"+
				                        "<span>已签"+setNumStr(zsjje)+"</span>"+
				                        "<span>完成率"+(jeRate).toFixed(2)+"%</span>"+
				                    "</p>"+
			                       "</li>";
    					count=count+temp;
        			 } 
    			 }
    			 //alert(count);
    			 $("#researchDepart_id").html(count); 
    			 
    			 
    			 
    			 //研究院-总金额
   				 $("#yjy_all_id").html((parseFloat(all)/10000).toFixed(2) + "<lable >亿<lable>");
   				 $("#yjy_finished_id").html((finished/10000).toFixed(2) + "<lable >亿<lable>");
   				 var zRate = finished * 100 / all;
   				 $("#yjy_rate_id").html(zRate.toFixed(2) + "%");
   				 
   				 
    		},
    		error : function() {
    		},
    		complete : function(XMLHttpRequest, status) {
    		}
    	});

    }
    
    
    //
    function set_all_look()
    {
		
    	var v_date = (new Date()).getTime();
    	var nd = $('#nd').val();
    	var url = "/mobile/index_budget?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "&v_date=" + v_date;
    	$.ajax({
    		type : "GET",
    		url : url,
    		timeout : 9000,
    		dataType : "json",
    		cache : false,
    		headers : {
    			'Content-Type' : 'application/json'
    		},
    		success : function(data, status) 
    		{
    			 console.log(data.data);
    			 var count="";
    			 var all=0;
    			 var finished=0;
    			 if(data.data.length>0)
    			 {
    				 for(var i=0;i<data.data.length;i++)
        			 {
    					var budgetItemName= data.data[i].budgetItemName;
    					var zysje=data.data[i].zysje;//总预算科研投入
    					var fyxsjje=data.data[i].fyxsjje;//费用性科研投入
    					var zbxsjje=data.data[i].zbxsjje;//资本性科研投入
    					var overed=parseFloat(fyxsjje)+parseFloat(zbxsjje);//已投入
    					
    					all=all+parseFloat(zysje);
    					finished=finished+parseFloat(overed);
    					
    					
    					var yq=parseFloat(overed).toFixed(2);//已签
    					if(yq=='0.00')
    					{
    						yq=0;
    					}
    					var wcl=(overed/zysje*100).toFixed(2);//完成率
    					if(wcl=='0.00')
    					{
    						wcl=0;
    					}
    					
    					var temp="<li>"+
				    				"<p>"+
				                        "<span>预算 "+setNumStr(zysje)+"</span>"+
				                        "<span>"+budgetItemName+"</span>"+
				                    "</p>"+
				                    "<p>"+
				                        "<span>已签"+setNumStr(yq)+"</span>"+
				                        "<span>完成率"+wcl+"%</span>"+
				                    "</p>"+
			                       "</li>";
    					count=count+temp;
        			 } 
    			 }
    			 //alert(count);
    			 $("#other_id").html(count); 
    			 
    			 
    			 //研究院-总金额
   				 $("#other_all_id").html((parseFloat(all)/10000).toFixed(2) + "<lable >亿<lable>");
   				 $("#other_finished_id").html((finished/10000).toFixed(2) + "<lable >亿<lable>");
   				 var zRate = finished * 100 / all;
   				 $("#other_rate_id").html(zRate.toFixed(2) + "%");
   				 
    		},
    		error : function() {
    		},
    		complete : function(XMLHttpRequest, status) {
    		}
    	});

    }
    
    function setNumStr(num)
    {
    	
    	var result="";
    	
    	if(num=='0.00')
		{
    		num=0;
		}
		if(parseFloat(num)>10000)//亿
		{
			var  temp=parseFloat(num/10000).toFixed(2);
			var  endstr=temp.substring(temp.length-3);
			//alert(temp);
			if(endstr=='.00')
			{
				temp= temp.substring(0,temp.length-3);
			}
			result=temp+"<lable >亿<lable>";
		}else//万
		{
			
			var  temp=parseFloat(num).toFixed(2);
			var  endstr=temp.substring(temp.length-3);
			if(endstr=='.00')
			{
				//temp= temp.replace(".00","")
				temp= temp.substring(0,temp.length-3);
			}
			result=temp+"<lable >万<lable>";
		}
		return result;
    }
    
    function search_Event()
    {
    	    zyc();
    	    researchDepart();
    	    set_all_look();
    }
    search_Event();
    
    
    
    
    


    
</script>
</body>
</html>