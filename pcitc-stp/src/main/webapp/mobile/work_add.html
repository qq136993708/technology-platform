<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>科技管理平台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=0" />
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/mobile/css/mobileNew.css">
    <style>
        body{background: #fff;}
        .main{border-radius: 6px;}
    </style>
</head>
<body style="overflow-y: hidden;">
<form action="" name="form1" id="form1" method="post">
    <input name="dataCode"  id="dataCode"  value="${dataCode}"  type="hidden">
    <input name="flag"      id="flag"      value="${flag}"      type="hidden">
    <input name="dataId"    id="dataId"    value="${dataId}"    type="hidden">
    <input name="userName"  id="userName"  value="${userName}"  type="hidden">
    <input name="unitName"  id="unitName"  value="${unitName}"  type="hidden">
    <input name="bak6"      id="bak6"      value="${bak6}"      type="hidden">
    <input name="createUserName"      id="createUserName"      value="${bak4}"      type="hidden">
    <input name="closeType" id="closeType" value="${closeType}" type="hidden">
    <input name="workOrderAllotUserId"  id="workOrderAllotUserId"  value="${workOrderAllotUserId}"  type="hidden">
    <input name="userStr"  id="userStr"  value="${userStr}"  type="hidden">
    <input name="matterList"  id="matterList"  value=""  type="hidden">
    <main class=" work-add" style="height: 6.45rem;overflow-y: scroll;">
        <div class="title">
            <p>任务名称</p>
            <div class="input-percentage">
                <span></span>
                <input type="text" value="" name="workOrderName" id="workOrderName" placeholder="请输入任务名称">
            </div>
        </div>
        <div class="project-d-f"></div>
        <!-- <div class="title star-date">
            <p>安排时间</p>
            <div class="input-percentage">
                <span></span>
                <input id="date-group1-8" type="text" value=""  name="" id="" placeholder="请选择开始时间">
            </div>
        </div> -->
        <!-- <div class="title end-date">
            <p>至</p>
            <div class="input-percentage">
                <span></span>
                <input id="date-group1-9" type="text" value=""  name="" id="" placeholder="请选择结束时间">
            </div>
        </div> -->
        <div class="title title-p">
            <p>任务执行人</p>
            <div class="input-percentage">
                <span></span>
                <input type="text" value=""  name="workOrderAllotUserName" id="workOrderAllotUserName" placeholder="请选择执行人">
            </div>
        </div>
        <textarea placeholder="请输入任务描述"  name="remarks" id="remarks"></textarea>

        <div class="button-c">
            <button id="save_id">确定</button>
        </div>
    </main>
</form>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/mobile/js/rolldate.min.js"></script>


<script>
    var layer;
    (function(doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function() {
                var clientWidth = docEl.clientWidth;
                if (!clientWidth) return;
                docEl.style.fontSize = 100 * (clientWidth / 414) + 'px';
            };
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
    layui.use(['jquery','layer','element','laydate'], function(){
        var $=layui.jquery;layer=layui.layer,element=layui.element,laydate = layui.laydate;
        
        
        var system = {ipad:false};
        system.ipad = (navigator.userAgent.match(/iPad/i) != null)?true:false;
        if(system.ipad){
            parent.$(".layui-layer-mobile .layui-layer-ico").css("width",".14rem");
            parent.$(".layui-layer-setwin").css("right","0");
        }
        
        laydate.render({
            elem: '#test-laydate-normElem'
            ,type: 'year'
            ,value:"2019"
        });
        
        beginYear='';
       /*new Rolldate({
            el: '#date-group1-8',
            format: 'YYYY',
            beginYear: 2000,
            endYear: 2100,
            confirm: function (date) {
                beginYear=date;
            }
        }) */
        /* new Rolldate({
            el: '#date-group1-9',
            format: 'YYYY',
            beginYear: beginYear,
            endYear: 2100
        }) */
        $("#workOrderAllotUserName").click(function () {
            layer.open({
                title : '详情',
                skin : 'layui-layer-mobile',
                shadeClose : false,
                type : 2,
                fixed : false,
                maxmin : true,
                area : [ '100%', '5.5rem' ],
                content : '/mobile/implement'
            });
        });
       
       
        $("#save_id").click(function () {
        	var v_date = (new Date()).getTime();
        	  var workOrderName=$("#workOrderName").val();
          	  var workOrderAllotUserName=$("#workOrderAllotUserName").val();
          	  var remarks=$("#remarks").val();
          	  if(workOrderName=='')
          	  {
          		  layer.alert("任务名称为空");
          	      return false;
          	  }else if(workOrderAllotUserName=='')
          	  {
          		layer.alert("任务执行人为空");
          	      return false;
          	  }else if(remarks=='')
          	  {
          		layer.alert("任务描述为空");
          	      return false;
          	  }
          	  
        	  var url = '/mobile/plan/submitBotWorkOrder?v_date=' + v_date + "&workOrderStatus=1" ;
              var backurl = "/mobile/work?v_date=" + v_date;
              ajaxOpt(url, "form1", "POST", backurl, "工作安排成功", "保存失败");
            return false;
        });
        
       
    });
    
    
    function ajaxOpt(url, formName, type, backurl, successMsg, failMsg) 
    {
    	//设置下拉列表
        setTatterList();
    	var data=getFormData();
        data.matterList=setTatterList();
    	console.log("确定\n"+JSON.stringify(data));
		//return;
        $.ajax({
            type: type,
            url: url,
            dataType: 'json',
            data: {
                'param': JSON.stringify(data)
            },
            async: false,
            cache: false,
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success: function (data, status) {

                if (parseInt(data)>0) {
                    layer.alert(
                        successMsg,
                        {icon: 1, closeBtn: 0},
                        function () {
                            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                            parent.layer.close(index);  // 关闭layer
                            parent.location.href = backurl;
                        });

                } else {
                    layer.alert(failMsg);
                }

            },
            error: function () {
                layer.alert("网络访问错误");
            }

        });
    }
    
    
    //设置下拉列表
    function setTatterList() 
    {
    	var matterList=new Array();
    	var userStr=$("#userStr").val();
    	var remarks=$("#remarks").val();
    	if(userStr!=null && userStr!='')
    	{
    		var arr=userStr.split("#");
    		if(arr!=null)
    		{
    			for(var i=0;i<arr.length;i++)
   				{
   				   var temp=arr[i];
   				   var arr2=temp.split(",");
   				   if(arr2!=null)
  				   {
	   					var userid=arr2[0];
	   					if(userid!=null && userid!='')
	   					{
	
	   	   					   var obj={
	   	   	   		    			"dataId": "",
	   	   	   		    			"workOrderName": remarks,
	   	   	   		    			"workOrderAllotUserName": arr2[1],
	   	   	   		    			"workOrderAllotUserId": arr2[0],
	   	   	   		    			"announcements": ""
	   	   	   		    		};
	   	   	   				   matterList.push(obj); 
	   					}
   					
  				   }
   				   
   				}
    		}
    	}
    	return matterList;
    }
    
  
    
    function getFormData() 
    {
  	    var unindexed_array =  $('#form1').serializeArray();
  	    var indexed_array = {};
  	    $.map(unindexed_array, function (n, i) {
  	      indexed_array[n['name']] = n['value'];
  	    });
  	    return indexed_array;
  	}
    
    
   　

	 
    
</script>
</body>
</html>