<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>科技管理平台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=0" />
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/mobile/css/mobileNew.css">
    <style>
        .tab-top{    background: url(/mobile/images/mobile-line.png) no-repeat center bottom;height: auto;overflow: hidden;padding-bottom: .1rem;background-size: 100%;padding-top: .1rem;}
        .layui-badge-rim, .layui-colla-content, .layui-colla-item, .layui-collapse, .layui-elem-field, .layui-form-pane .layui-form-item[pane], .layui-form-pane .layui-form-label, .layui-input, .layui-layedit, .layui-layedit-tool, .layui-quote-nm,
        .layui-select, .layui-tab-bar, .layui-tab-card, .layui-tab-title, .layui-tab-title .layui-this:after, .layui-textarea{border: none}
    </style>
</head>
<body>

<input name="workOrderStatus" id="workOrderStatus" value="${planBase.workOrderStatus}" type="hidden"  >


<header>
    <div class="m_return child">
        <a data-rel="back"><img src="/mobile/images/icon-back.png"/> </a>
        <h4>待处理的（详情）</h4>
    </div>
</header>
<main class="main work work_details">
    <div class="work-top">
        <p class="title"><span></span>${planBase.workOrderName}</p>
        <div class="work-cont">
            <div class="list">
                <div class="list-img">
                    <img src="/mobile/images/icon-by.png" alt="">
                </div>
                <div class="list-cont">
                    <div class="list-cont">
                        <p>
                            <span class="star">${planBase.createDate}</span>
                        </p>
                        <p>任务执行人:<span>${planBase.workOrderAllotUserName}</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="work-main">
        <div class="layui-collapse work-m" lay-filter="component-panel">
            <div class="layui-colla-item layui-this">
                <h2 class="layui-colla-title"><span></span>任务描述</h2>
                <div class="layui-colla-content layui-show">
                   <!--  <h4>任务描述:</h4> -->
                    <p>${planBase.remarks}</p>
                    <button class="layui-btn layui-active" <#if planBase.workOrderStatus == 2> style="display:none" </#if> id="work">处理任务</button>
                    <button class="layui-btn layui-rest" id="rest"  <#if planBase.workOrderStatus != 2> style="display:none" </#if> id="rest">工作处理列表</button>
                </div>
            </div>
        </div>
        <div class="task layui-hide">
         <form action="" name="form1" id="form1" method="post">
         <input name="dataId" id="dataId" value="${planBase.dataId}" type="hidden">
           <div>
               <p>任务状态</p>
               <div class="input-percentage">
                   <span></span>
                   <input type="text" value="" placeholder="请输入完成百分比" id="bl" name="bl" onkeyup="value=value.replace(/[^\d]/g,'') " onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))">
               </div>
               <textarea placeholder="请输入任务描述及原因"  name="remarks" id="remarks" ></textarea>
               <button onclick="save()">保存并提交</button>
           </div>
         </form>
        </div>
        <div class="rest layui-hide">
            <div class="layui-collapse work-w" lay-filter="component-panel">
              <#list finishedList as vo>
                <div class="layui-colla-item layui-this">
                    <h2 class="layui-colla-title"><span></span>处理人：${vo.createUserName}</h2>
                    <div class="layui-colla-content layui-show">
                        <h4>处理内容:</h4>
                        <p>${vo.remarks}</p>
                    </div>
                </div>
              </#list>   
            </div>
        </div>
    </div>
</main>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/mobile/js/jquery.mobile-1.4.5.min.js"></script>
<script>
    var layer;
    (function(doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function() {
                var clientWidth = docEl.clientWidth;
                if (!clientWidth) return;
                docEl.style.fontSize = 100 * (clientWidth / 414) + 'px';
            };
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
    layui.use(['jquery','layer','element','laydate'], function(){
        var $=layui.jquery;layer=layui.layer,element=layui.element,laydate = layui.laydate;
        laydate.render({
            elem: '#test-laydate-normElem'
            ,type: 'year'
            ,value:"2019"
        });
        $(".layui-collapse .layui-colla-content").each(function () {
            if($(this).attr("class").indexOf("layui-show")!=-1){
                $(this).prev().find("i").html("<img class='dw' src='/mobile/images/icon-up.png' />")
            }else {
                $(this).prev().find("i").html("<img class='dw' src='/mobile/images/icon-dw.png' />")
            }
        });
        element.on('collapse(component-panel)', function(data){
            console.log()
            if(data.show==false){
                $(data.content.context).find("i").html("<img class='dw' src='/mobile/images/icon-dw.png' />")
            }else {

                $(data.content.context).find("i").html("<img class='dw' src='/mobile/images/icon-up.png' />")
            }
        });
        $("#work").click(function () {
            $(".task").removeClass("layui-hide")
        });
        $("#rest").click(function () {
            $(".rest").removeClass("layui-hide")
        });
        
        var dataJson;
		var dataId =$("#dataId").val();
		$.ajax({
			type : 'post',
			dataType : 'json',
			async : false,
			url : '/mobile/plan/viewBotWorkOrder?dataId=' + dataId,
			success : function(data) {
				dataJson = JSON.parse(JSON.stringify(data));
				//enhance.filling(dataJson);
				$("#remarks").val(dataJson.remarks);
			},
			error : function(e) {
				alertError("出错了！", e);
			}
		});
		
    });
    
    
    
  function save()
  {
	  var bl=$("#bl").val();
	  var remarks=$("#remarks").val();
	  if(bl=='')
	  {
		  alert("完成百分比为空");
	      return ;
	  }else if(remarks=='')
	  {
		  alert("任务描述为空");
	      return ;
	  }
	  
	  var data=getFormData();
	  console.log("data\n"+JSON.stringify(data));
	  $.ajax({
          type: 'post',
          dataType: 'json',
          data: {
              'param': JSON.stringify(data)
          },
          url: '/mobile/plan/submitMyBotWorkOrder?workOrderStatus=2',
          success: function (data) {
              location.href="/mobile/work";
          },
          error: function (e) {
              console.log("出错了"+e);
          }
      });
  }
  
  
  function getFormData() {
	    var unindexed_array =  $('#form1').serializeArray();
	    var indexed_array = {};

	    $.map(unindexed_array, function (n, i) {
	      indexed_array[n['name']] = n['value'];
	    });
	    return indexed_array;
	}
	
</script>
</body>
</html>