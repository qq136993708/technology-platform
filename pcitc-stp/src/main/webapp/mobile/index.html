<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>科技管理平台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=0" />
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/mobile/css/mobileNew.css">
</head>
<body>
<header>
<input type="hidden" name="nd"            id="nd"              value="${nd}" >
<input type="hidden" name="month"         id="month"           value="${month}" >
<input type="hidden" name="isZHJHCPerson" id="isZHJHCPerson"   value="${isZHJHCPerson}" >
<input type="hidden" name="companyCode" id="companyCode" value="${companyCode}">

	<div class="main-card banner">
	    <div class="layui-carousel" id="test1" lay-filter="test1">
			<div carousel-item="">
				<#list list as t>
					<div class="item" onclick="readNotice('${t.noticeId}')">
						<p>通知</p>
						<span class="line"></span>
						<span>${t.noticeTitle}</span>
					</div>
				</#list>	
				<!-- 
				<div class="item">
					<p>科研项目综合分析</p>
					<span class="line"></span>
					<span>Comprehensive Analysis Of Scientific Research Projects</span>
				</div> -->
			</div>
		</div> 
    </div>
</header>
<main class="main">
	<div class="main-card quota">
		<p><span></span>年度指标 / TARGET<img src="/mobile/images/mobile-group.png"/></p>
		<div class="quata-cont" id="budget_id">
			<div class="item">
				<p id="moneyCurrent">- /亿</p>
				<p>已签金额</p>
			</div>
			<div class="item">
				<p id="moneyTotal">- /亿</p>
				<p>年度预算</p>
			</div>
			<div class="item">
				<div class="circle">
					<div id="circle">
						<span></span>
					</div>
				</div>
				<p>执行比率</p>
			</div>
		</div>
	</div>
    <div class="main-card first-card">
		<p><span></span>工作台 / WORKBENCH<img src="/mobile/images/mobile-group.png"/></p>
        <div class="main-card-body card-shadow">
            <ul class="main-card-body-ul">
                <li class="layui-col-xs3" id="numberNotice_list">
                	<div class="agency-box">
						<img src="/mobile/images/work-img1.png" alt="">
						<span class="number" id="wait_notice_count">-</span>
                		<span class="text">待办任务</span>
                	</div>
                </li>
                <li class="layui-col-xs3" id="doneTaskCount_list">
                	<div class="agency-box">
						<img src="/mobile/images/work-img2.png" alt="">
						<span class="number" id="over_notice_count">-</span>
                		<span class="text">已办任务</span>
                	</div>
                </li>
                <li class="layui-col-xs3" >
                    <div class="agency-box">
						<img src="/mobile/images/work-img3.png" alt="">
						<span class="number">89</span>
                		<span class="text">工作安排</span>
                	</div>
                </li>
				<li class="layui-col-xs3" >
                    <div class="agency-box" id="audit_msg_list">
						<img src="/mobile/images/work-img4.png" alt="">
						<span class="text">研究院概况</span>
                	</div>
                </li>
            </ul>
        </div>
    </div>
    <div class="main-card main-card-b" id="isKJBPerson_id" >
		<p><span></span>业务分析 / ANALYSIS<img src="/mobile/images/mobile-group.png"/></p>
        <div class="main-card-body">
			<!-- <div class="dec-center-left1" id="kyzc">
				<span></span>
				<span>科研预算</span>
				<span class="icon-decision icon-decision_01" id="kyys">-亿</span>
			</div> -->
			<div class="dec-center-right3" id="project_id">
				<span></span>
				<span>科研项目</span>
				<span class="icon-decision icon-decision_06" id="contract_total">-个</span>
				<span>今年计划课题数</span>
			</div>
			<div class="dec-center-right2" id="contract_id">
				<span></span>
				<span>科研合同 </span>
				<span class="icon-decision icon-decision_04" id="contcator_id">0%</span>
				<span>合同签订率</span>
			</div>
			<div class="dec-center-right3" id="personnel_id">
				<span></span>
				<span>科研人才</span>
				<span class="icon-decision icon-decision_06" id="expert_total">-位</span>
			</div>
			<#if isZHJHCPerson== 'true' || sysUserInfo.userLevel=='2'> 
				<div class="dec-center-right3" id="appropriation_id">
					<span></span>
					<span>科研拨款</span>
					<span class="icon-decision icon-decision_06" id="appropriation_sum">-亿</span>
					<span>直属研究院</span>
				</div>
				<div class="dec-center-left2" id="cash">
					<span></span>
					<span>现金流量</span>
					<span class="icon-decision icon-decision_03" id="all_money_id">-亿</span>
					<span>直属研究院</span>
				</div>
			</#if>
			
			
			<div class="dec-center-right3">
				<span></span>
				<span>成果鉴定</span>
				<span class="icon-decision icon-decision_06" id="appraisalId">-</span>
			</div>
        </div>
    </div>
</main>
	<!-- 弹框 -->
	<div class="jczxWin disNone">
		<div class="addRole">
			<div class="win_grid" >
				<div class="tableLoading" id="tableLoading01"><i class="layui-icon layui-icon-loading" style="font-size: 28px"></i></div>
				<table id="jczxTable" ></table>
			</div>
		</div>
	</div>
<script type="text/javascript" src="/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layuiadmin/javascript/circle-progress.min.js"></script>
<script>
var isZHJHCPerson=$("#isZHJHCPerson").val();
var userLevel="${sysUserInfo.userLevel?default('')}";

	var layer;
    (function(doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function() {
                var clientWidth = docEl.clientWidth;
                if (!clientWidth) return;
                docEl.style.fontSize = 100 * (clientWidth / 414) + 'px';
            };
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
    layui.use(['jquery','layer'], function(){
		var $=layui.jquery;
		layer=layui.layer;
        $("#projectDecision").click(function () {
			var projectDecisionHtml="<ul class='layer-ul'>" +
				"<li><a href='/mobile/projectdecision/research-funds-trend.html'>科技资金现金流趋势分析</a></li>" +
				"<li><a href='/mobile/projectdecision/research-funds-proportion.html'>科技资金现金流占比分析</a></li>" +
				"<li><a href='javascript:;'>科研经费综合分析</a></li>" +
				"<li><a href='javascript:;'>科研项目综合分析</a></li>" +
				"<li><a href='javascript:;'>重大科研项目分析</a></li>" +
				"<li><a href='javascript:;'>十条龙项目分析</a></li>" +
				"<li><a href='javascript:;'>项目调整决策分析</a></li>" +
				"<li><a href='javascript:;'>项目支出综合分析</a></li>" +
				"</ul>";
			layer.open({
				title: '项目决策',
				skin: 'layui-layer-lan',
				shadeClose: true,
				type: 1,
				fixed: false,
				//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
				maxmin: false,
				//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
				area: ['9rem', '10rem'],
				content: projectDecisionHtml
			})
        });
        
        var v_date = (new Date()).getTime();
    	var nd = $("#nd").val();
    	setYusuan_rate(v_date,nd);
    });
    
    
    /************左列********/
    
    //科研支出  
    /* $("#kyzc").click(function () {
			var projectDecisionHtml="<ul class='layer-ul'>" +
				"<li><a href='/mobile/kyzc'>科研支出  </a></li>" +
				"</ul>";
			layer.open({
				title: '科研支出  ',
				skin: 'layui-layer-lan',
				shadeClose: true,
				type: 1,
				fixed: false,
				//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
				maxmin: false,
				//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
				area: ['9rem', '5rem'],
				content: projectDecisionHtml
			})
    	
    }); */
   
    //成果专利
    $("#cgzl").click(function () {
    	//location.href="/mobile/cgzl";
    	
    	var projectDecisionHtml="<ul class='layer-ul'>" +
		"<li><a href='/mobile/cgzl'>成果专利 </a></li>" +
		"</ul>";
		layer.open({
			title: '成果专利',
			skin: 'layui-layer-lan',
			shadeClose: true,
			type: 1,
			fixed: false,
			//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
			maxmin: false,
			//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
			area: ['9rem', '5rem'],
			content: projectDecisionHtml
		})
    });
    /************左列 end********/
    /**********右列**********/
    
    //科研预算
    $("#budget_id").click(function () {
    	location.href="/mobile/budget";
    });
    //人才
    $("#personnel_id").click(function () {
    	location.href="/mobile/personnel";
    });
    //科研项目
    $("#project_id").click(function () {
    	location.href="/mobile/project";
    });
    
    //科研合同 
    $("#contract_id").click(function () {
    	location.href="/mobile/contract";
    });
    //现金流量
    $("#cash").click(function () {
    	location.href="/mobile/cash";
    });
    //科研拨款
    $("#appropriation_id").click(function () {
    	location.href="/mobile/appropriation";
    });
    
    
    
    
    
    
  	//弹框
  	function table_win(title){
  		layer.open({
            type: 1,
            skin: 'layui-layer-gray',
            fix: true,
            title: ["<i class='iconfont icon-ai61 mgr5'></i>"+title+" ",""],
            shadeClose: true,
            maxmin: false,
            scrollbar:false,
            area: ['9.64rem', '11.11rem'],
            anim: 0,
            offset:  'auto',
            content: $('.jczxWin'),
            success: function(){
            	$("[data-field='city']").css('display','none');
            	$("[lay-id='jczxTable']").css('margin','0');
            	$(".layui-layer-content").css('height','calc(100% - 50px)');
            	
            	loadTableData();
            }
        })
  	}
    
   
  	function loadTableData(){
  		layui.use('table', function(){
            var table = layui.table;
            //第一个实例
            table.render({
                elem: '#jczxTable',
//                 url: '/common/getSupplier/getSupplierData',
                url: 'table.json',
                page: false, //开启分页
                limit: 5,
                limits: [5, 10, 20, 30, 40, 50, 60, 70, 80, 90],
                cols: [[ //表头
                    {field: 'city', title: '',align:'left', sort: false}
                    
                ]],
                data:data,
                id: 'jczxTable',
                done:function(res,curr,count) {
                	$(".tableLoading").css("display","none");
                }
            });

            var $ = layui.$, active = {
                getCheckData: function(){ //获取选中数据
                    var checkStatus = table.checkStatus('gysTable'),data = checkStatus.data;
                    layer.closeAll();
                    //操作
                }
            };
        });
  	}
  	
  	
    //代办
    $("#numberNotice_list").click(function () {
    	location.href="/mobile/agencyM";
    });
    
    // 已办任务
    $("#doneTaskCount_list").click(function () {
    	location.href="/mobile/agencyM";
    });
    // 审核消息
    $("#audit_msg_list").click(function () {
    	location.href="/mobile/message_list";
    });
    
    
   
    
   
    layui.use(['carousel', 'form'], function(){
		var carousel = layui.carousel,
		form = layui.form;
		//常规轮播
		carousel.render({
            width:'calc(100% - 1.154‬rem)',
			height:'.76rem',
			elem: '#test1',
			arrow: 'hover',
			autoplay:false,
			indicator:'outside'
		});
	});
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    /**===============================================设置页面数据=========================================================*/
    
    
    //设置所有页面数据
    function setAllHtmlData() 
    {
    	var v_date = (new Date()).getTime();
    	var nd = $("#nd").val();
    	var month = $("#month").val();
    	//待办
    	set_wait_notice_count(v_date);
    	//任务已办个数
   	    setOverTaskCount(v_date) 
    	//预算
    	setYusuan(v_date,nd);
    	//科研成果
    	appraisalCount(v_date,nd);
    	//科研合同
    	setContcat(v_date,nd);
    	//合同-今年计划课题
    	set_contract(nd);
    	//专家库
    	set_expert(nd);
    	
    	//权限控制（是计划处的人或用户级别是2）
    	if(isZHJHCPerson==true || isZHJHCPerson=='true' || userLevel=='2')
   		{
   		    //科研拨款
   		    setBKCount(v_date,nd);
   		    //现金流量
   		    get_Mobile_Month_Cash_Flow();
   		}
    	
    	
    }
    setAllHtmlData();
    
    
    
    
    
    
    //预算
	function setYusuan(v_date,nd) 
    {
		$.ajax({
			type : 'GET',
			url : "/mobile/index_budget?functionId=984b64b13cf54222bf57bd840759fabe&nd=" + nd + "&v_date=" + v_date+"&type=1",
			dataType : 'json',
			headers : {
				'Content-Type' : 'application/json'
			},
			timeout : 6000, //超时时间设置，单位毫秒
			error : function(XMLHttpRequest, status) {
				$("#moneyTotal").html("<span style='font-size:14px;'>--亿</span>");
				$("#moneyCurrent").html("<span style='font-size:14px;'>--亿</span>");
			},
			success : function(data) {
				var projectMoney = data.data;
				var tt1 = 0;
				var tt2 = 0;
				for (var i = 0; i < projectMoney.length; i++) {
					var zysje = projectMoney[i].zysje;
					var fyxsjje = projectMoney[i].fyxsjje;
					var zbxsjje = projectMoney[i].zbxsjje;
					tt1 = tt1 + parseFloat(fyxsjje) + parseFloat(zbxsjje);
					tt2 = tt2 + parseFloat(zysje);
				}
				var tt1 = parseFloat(tt1)/ 10000;
				var tt2 = parseFloat(tt2) / 10000;
				$("#moneyTotal").html(tt2.toFixed(2) + "<span style='font-size:14px;'>亿</span>");
				$("#moneyCurrent").html(tt1.toFixed(2) + "<span style='font-size:14px;'>亿</span>");
			}
		});
	}
	//预算比率
	function setYusuan_rate(v_date,nd) 
    {
		$.ajax({
			type : 'GET',
			url : "/mobile/index_budget?functionId=984b64b13cf54222bf57bd840759fabe&nd=" + nd + "&v_date=" + v_date+"&type=1",
			dataType : 'json',
			headers : {
				'Content-Type' : 'application/json'
			},
			timeout : 6000, //超时时间设置，单位毫秒
			error : function(XMLHttpRequest, status) {
				  $("#circle").find('span').html(0+"%");
				 

			        $("#circle").circleProgress({
			            value : 0,
			            size : 50,
			            startAngle : -Math.PI / 2,
			            thickness : '5',
			            fill : {
			                gradient : [ "#ffffff", "#e99a54" ]
			            },
			            emptyFill : "#F0EEF6"
			        })
			        
			},
			success : function(data) {
				var projectMoney = data.data;
				var tt1 = 0;
				var tt2 = 0;
				for (var i = 0; i < projectMoney.length; i++) {
					var zysje = projectMoney[i].zysje;
					var fyxsjje = projectMoney[i].fyxsjje;
					var zbxsjje = projectMoney[i].zbxsjje;
					tt1 = tt1 + parseFloat(fyxsjje) + parseFloat(zbxsjje);
					tt2 = tt2 + parseFloat(zysje);
				}
				var moneyCurrent = parseFloat(tt1)/ 10000;
				var moneyTotal = parseFloat(tt2) / 10000;
				var rateDate=((moneyCurrent/moneyTotal)*100).toFixed(2);
				$("#circle").find('span').html(rateDate+"%");
				
				 $("#circle").circleProgress({
			            value : rateDate/100,
			            size : 50,
			            startAngle : -Math.PI / 2,
			            thickness : '5',
			            fill : {
			                gradient : [ "#ffffff", "#e99a54" ]
			            },
			            emptyFill : "#F0EEF6"
			        })
			        
			}
		});
    }
  
    //科研成果
	function appraisalCount(v_date,nd) 
    {
			$.ajax({
				type : 'POST',
				url : "/mobile/admin/appraisal-count?functionId=984b64b13cf54222bf57bd840759fabe&nd=" + nd+"&v_date="+v_date,
				dataType : 'json',
				headers : {
					'Content-Type' : 'application/json'
				},
				timeout : 3000,
				error : function(XMLHttpRequest, status) {

				},
				success : function(data) {
					var appraisalCount = data.appraisalCount;
					//alert(appraisalCount);
					$("#appraisalId").html(appraisalCount+"个");
				}
			});

		}
    
    
    
    
	//科研合同--合同签订率
	function setContcat(v_date,nd) 
	{
		var url = "/mobile/index_contract_rate?functionId=984b64b13cf54222bf57bd840759fabe&type=3&nd=" + nd + "&v_date=" + v_date+"&define3=研究院";
		$.ajax({
			type : 'POST',
			url : url,
			dataType : 'json',
			headers : {
				'Content-Type' : 'application/json'
			},
			timeout : 3000,
			error : function(XMLHttpRequest, status) {
				$("#contcator_id").html("-%");
			},
			success : function(data) {
				var qdl = "0";
				if (typeof (data.data.qdl) == "undefined") {
					$("#contcator_id").html("0%");
				} else {
					$("#contcator_id").html(data.data.qdl + "%");
				}

			}
		});

	}
	
	
	
	//合同-今年计划课题(科研项目)
	function set_contract(nd) 
	{
		$.ajax({
			type : 'POST',
			url : "/mobile/index_contract?functionId=984b64b13cf54222bf57bd840759fabe&type=1&nd=" + nd + "",
			dataType : 'json',
			headers : {
				'Content-Type' : 'application/json'
			},
			timeout : 3000,
			error : function(XMLHttpRequest, status) {
				$("#contract_total").html("--个");
			},
			success : function(data) {
				var yqht = data.data.yqht;
				var zsl = data.data.zsl;
				$("#contract_total").html(zsl + "个");
			}
		});

	}
	
	
	 //待办个数
	 function set_wait_notice_count(v_date)
	 {
	    	var url="/mobile/task/pending-list?v_date="+v_date;
	        $.ajax({
	            type: "POST",
	            url: url,
	            dataType: "json",
	            timeout: 11000,
	            cache: false,
	            headers : {
					'Content-Type' : 'application/json'
				},
	            success: function (data, status) {
					$("#wait_notice_count").html(data.count);
	            },
	            error: function () {
					
				},
	            complete: function (XMLHttpRequest, status) {
					
	            }
	        });
	 }
	 
	 
	 //任务已办个数
	 function setOverTaskCount(v_date) 
	 {
	    	var url="/mobile/task/done-task-list?v_date="+v_date;
	        $.ajax({
	            type: "POST",
	            url: url,
	            dataType: "json",
	            timeout: 11000,
	            cache: false,
	            headers : {
					'Content-Type' : 'application/json'
				},
	            success: function (data, status) {
					$("#over_notice_count").html(data.count);
	            },
	            error: function () {
					
				},
	            complete: function (XMLHttpRequest, status) {

	            }

	        });
	}
	 
	 
	 //科研拨款
	 function setBKCount(v_date,nd) 
	 {
		 
		    var url = "/mobile/investment_02?functionId=984b64b13cf54222bf57bd840759fabe&nd=" + nd + "&v_date=" + v_date;
	        $.ajax({
	            type: "GET",
	            url: url,
	            dataType: "json",
	            timeout: 11000,
	            cache: false,
	            headers : {
					'Content-Type' : 'application/json'
				},
	            success: function (data, status)
	            {
	            	console.log("科研拨款\n"+JSON.stringify(data));
	            	var count=0;
	            	for (var i = 0; i < data.data.length; i++) 
	            	{
						var zsjje = data.data[i].zsjje;//实际科研投入
						var zysje = data.data[i].zysje;//预算金额
						count = count + parseFloat(zsjje);
					}
					$("#appropriation_sum").html((count/ 10000).toFixed(2)+"亿");
	            },
	            error: function () {
					
				},
	            complete: function (XMLHttpRequest, status) {

	            }

	        });
	}
	 
	    
	 
	 
	 //hana 现金流量
	 function get_Mobile_Month_Cash_Flow()
	 {
	    	var month = $('#month').val();
	    	var companyCode=  $('#companyCode').val();
	    	console.log("参数：\n companyCode:"+companyCode+"month="+month);
	    	if(companyCode!=null && companyCode!='')
	   		{
	    		$.ajax({
	        		type : "GET",
	        		url : "/mobile/get_Mobile_Month_Cash_Flow?month=" + month + "&companyCode="+companyCode,
	        		timeout : 9000,
	        		dataType : "json",
	        		cache : false,
	        		headers : {
	        			'Content-Type' : 'application/json'
	        		},
	        		success : function(data, status) 
	        		{
	        			 console.log(data);
	        			 var all=0;
	        			 var count="";
	        			 if(data.length>0)
	        			 {
	        				 for(var i=0;i<data.length;i++)
	            			 {
	        					var g0GSJC= data[i].g0GSJC;
	        					var k0BQLJJE=parseFloat(data[i].k0BQLJJE).toFixed(2);//总预算科研投入
	        					all=all+parseFloat(k0BQLJJE);
	        					
	            			 } 
	        			 }
	        			 
	        			 $("#all_money_id").html((all/10000).toFixed(2)+" 亿"); 
	        		},
	        		error : function() {
	        		},
	        		complete : function(XMLHttpRequest, status) {
	        		}
	        	});
	   		}else
	  			{
	  			    alert("请联系管理员配置研究院相关的数据权限");
	  			}
	    	
	    	

	    }
	 
	 
	 
	 
	 
	 
	 
	 
	    //专家库
		function set_expert(nd) 
		{
			$.ajax({
				type : 'POST',
				url : "/mobile/getAllExpertTableData",
				dataType : 'json',
				headers : {
					'Content-Type' : 'application/json'
				},
				timeout : 10000,
				error : function(XMLHttpRequest, status) {
					$("#expert_total").html("-位");
				},
				success : function(data) {
					var length = data.count
					//alert(length);
					$("#expert_total").html(length + "位");
				}
			});

		}
		
	
    
    //通知详情
	function readNotice(noticeId) 
	{
		
		 var temUrl='/mobile/sysNotice/readNotice?id='+noticeId
		 layer.open({
	        title:'详情',
	        skin: 'layui-layer-lan',
	        shadeClose: true,
	        type: 2,
	        fixed: false,
	        maxmin: false,
	        area: ['50%', '60%'],
	        content:  temUrl
	    });
	}
	
	
	
</script>
</body>
</html>