<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
<link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css">
<script type="text/javascript" src="/plugins/jQuery/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.excheck.min.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layuiadmin/modules/base.js"></script>
</head>
<body>
	<div class="searchBox">
		<!--查询条件-->
		<label class="dateInput">
			<span>用户名</span>
			<input type="text" name="userName" id="userName" placeholder="请输入用户名" title="用户名" autocomplete="off" class="form-control" id="name">
		</label>
		<!--按钮组-->
		<div class="btnGroup">
			<button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" data-type="searchEvent">查询</button>
			<button class="layui-btn layui-btn-sm fontColor-default border-default btn_reset btnMyBgImg" data-type="resetEvent">重置</button>
		</div>
	</div>
	<table id="showTableId" class="layui-hide" lay-filter="tableEvent"></table>
	<div class="formBox">
		<form id="show-form" name="show-form" lay-filter="show-form" class="form-horizontal layui-form">
			<input type="hidden" name="fileKindId" id="fileKindId" value="${sysFileKindId?default(0)}" />
			<input type="hidden" name="userId" id="userId"/>
			<input type="hidden" name="bak1" id="bak1"/>
			<div class="form-bottom">
				<div class="form-bottom-btns">
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" data-type="ok" lay-submit="" lay-filter="submitBtn">保存</button>
					<button type="button" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="closeBtn" data-type="close">取消</button>
				</div>
			</div>
		</form>
	</div>
	<script>
		// 当前页用户id
		var bak1='';
		layui.use([ 'jquery', 'form', 'laydate', 'table', 'layer', 'element' ], function() {
			var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate;
			form = layui.form;
			table = layui.table;

			function renderTable() {
				table.render({
					elem : '#showTableId',
					url : '/sysfilekind/auth/user/list',
					method : "POST",
					where : {
						param : {
							"fileKindId" : $("#fileKindId").val()
						}
					},
					limit : 10,
					id : 'showTableId',
					height : commonDislodgeTable(),
					page : {
						groups : 5,
						limits : [ 10, 20, 30, 40 ],
						layout : [ 'count', 'limit', 'prev', 'page', 'next', 'skip' ], //自定义分页布局
						first : '首页', //不显示首页
						last : '尾页', //不显示尾页
						theme : '#0F9EE0'
					},
					cols : [ [ {
						type : 'checkbox',
						event : 'changeEvents'
					}, {
						title : '序号',
						type : 'numbers'
					}, {
						field : 'userName',
						title : '用户名',
						event : 'setActive',
						style : 'cursor: pointer;'
					}, {
						field : 'userDisp',
						title : '真实姓名',
						event : 'setActive',
						style : 'cursor: pointer;'
					} ] ],
					done : function(res, curr, count) {
						bak1 = '';
						for(var i=0;i< res.data.length;i++){
							if (i == 0) {
								bak1 = res.data[i].userId;
							} else {
								bak1 = bak1 + "|" + res.data[i].userId;
							}
							
							if (typeof (res.data[i].userConfig1) != "undefined") {
								res.data[i]["LAY_CHECKED"]='true';
	                            //找到对应数据改变勾选样式，呈现出选中效果
	                            var index= res.data[i]['LAY_TABLE_INDEX'];
	                            $('.layui-table tr[data-index=' + index + '] input[type="checkbox"]').prop('checked', true);
	                            $('.layui-table tr[data-index=' + index + '] input[type="checkbox"]').next().addClass('layui-form-checked');
							}
	                    }
						$("#bak1").val(bak1);
					}
				});
			}

			renderTable();
			// 触发不同的按钮事件
			var $ = layui.$, active = {
				searchEvent : function() { //点击查询按钮
					table.reload('showTableId', {
						where : {
							param : {
								"fileKindId" : $("#fileKindId").val(),
								"userName" : $("#userName").val()
							}
						}
					});
				},
				resetEvent : function() { //点击查询按钮
					$("#userName").val("");
					table.reload('showTableId', {
						where : {
							param : {
								"fileKindId" : $("#fileKindId").val(),
							}
						}

					});
				},
				getChecked : function() {
					var ids = "";
					var selectedData = active.getCheckData();
					for (var i = 0; i < selectedData.length; i++) {
						ids = (ids == "" ? selectedData[i].id : (ids + "|" + selectedData[i].id));
					}
					if (typeof (ids) == "undefined") {
						ids = "";
					}
					return ids;
				},
				getCheckData : function() { //获取选中数据
					var checkStatus = table.checkStatus('showTableId'), data = checkStatus.data;
					return data;
				},
				getCheckLength : function() { //获取选中数目
					var checkStatus = table.checkStatus('showTableId'), data = checkStatus.data;
					layer.msg('选中了：' + data.length + ' 个');
				},
				isAll : function() { //验证是否全选
					var checkStatus = table.checkStatus('showTableId');
					layer.msg(checkStatus.isAll ? '全选' : '未全选')
				},
				ok : function() {
					var ids = "";
					var names = "";
					var nTrs = active.getCheckData();
					for (var i = 0; i < nTrs.length; i++) {
						if (ids == "") {
							ids = nTrs[i].userId;
							names = nTrs[i].userDisp;
						} else {
							ids = ids + "|" + nTrs[i].userId;
							names = names + "|" + nTrs[i].userDisp;
						}
					}
					$("input[name=userId]").val(ids);
				},
				close : function() {
					var index = parent.layer.getFrameIndex(window.name);
					parent.layer.close(index);
				}
			};
			$('.layui-btn').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
			/* 监听提交 */
			form.on('submit(submitBtn)', function(data) {
				console.log(data.field);
				ajaxPost("/sysfilekind/auth/user/save", data.field, function(dt, status) {
					layer.msg("操作成功");
					parent.reloadtable('showTableId', null);
					parent.initTree();
					//var index = parent.layer.getFrameIndex(window.name);
					//parent.layer.close(index);
				});
				return false;
			});
			$("#closeBtn").click(function() {
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			})
		});
	</script>
</body>

</html>