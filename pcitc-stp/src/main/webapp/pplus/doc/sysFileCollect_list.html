<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <#include "/common/public/publicImportIndex.html"/>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<section class="content">
    <!--查询条件-->
    <div class="content-searcXh">
        <div class="dataTables_filter" id="searchDiv">
            <label>
                <span>文件收藏</span>

            </label>


            <div class="btn-group">
                <button type="button" class="btn btn-primary search" data-btn-type="search" id="search_btn">查询</button>
                <button type="button" class="btn btn-default reset" data-btn-type="reset" id="reset_btn">重置</button>
            </div>
        </div>
    </div>
    <div class="content-body">
        <div class="btn-group">
            <button type="button" class="btn btn-default add" data-btn-type="add">新增</button>
            <button type="button" class="btn btn-default edit" data-btn-type="edit">修改</button>
            <button type="button" class="btn btn-default delete" data-btn-type="delete">删除</button>
        </div>
        <table id="sysfilecollectTable" class="table table-bordered table-striped"></table>
    </div>
</section>


<div class="control-sidebar-bg"></div>
<!-- page script -->
<script>
    $(function () {
        initTable();
    });
    var sysfilecollectTable;

    function initTable() {
        sysfilecollectTable = $('#sysfilecollectTable').dataTable({
            "bPaginate": true,//分页工具条显示
            //"sPaginationType" : "full_numbers",//分页工具条样式
            "bStateSave": true, //是否打开客户端状态记录功能,此功能在ajax刷新纪录的时候不会将个性化设定回复为初始化状态
            "bScrollCollapse": true, //当显示的数据不足以支撑表格的默认的高度
            "bLengthChange": true, //每页显示的记录数
            "bFilter": false, //搜索栏   默认是true
            "bSort": true, //是否支持排序功能
            "bInfo": true, //显示表格信息
            "bAutoWidth": true, //自适应宽度
            "bJQueryUI": false,//是否开启主题
            "bDestroy": true,
            "bProcessing": true, //开启读取服务器数据时显示正在加载中……特别是大数据量的时候，开启此功能比较好
            "bServerSide": true,//服务器处理分页，默认是false，需要服务器处理，必须true
            //"sAjaxDataProp" : "aData",//是服务器分页的标志，必须有
            "sAjaxSource": "/sysfilecollect/getTableData",//通过ajax实现分页的url路径。
            "fnServerData": retrieveData, // 获取数据的处理函数
            //"aoColumnDefs": [{ "bSortable": false, "aTargets": [0]}],//设置某列不排序
            //初始化要显示的列
            "columnDefs": [
                {
                    "orderable": false,
                    "title": "操作",
                    "targets": 0,
                    "data": null,
                    "defaultContent": "<a class='editBtn'>编辑</a> <a class='deleteBtn'> 删除</a>"
                },
                    {
                        "title": "创建人ID",
                        "targets": 1,
                        "data": "createPersonId"
                    },
                    {
                        "title": "创建时间",
                        "targets": 2,
                        "data": "createDate"
                    },
                    {
                        "title": "备注",
                        "targets": 3,
                        "data": "ramarks"
                    },
                    {
                        "title": "0代表作废（禁用）、1代表生效（启用）",
                        "targets": 4,
                        "data": "status"
                    },
                    {
                        "title": "0：未审批   1：审批中    2：审批通过    3：审批不通过",
                        "targets": 5,
                        "data": "auditStatus"
                    },
                    {
                        "title": "修改人ID",
                        "targets": 6,
                        "data": "updatePersonId"
                    },
                    {
                        "title": "修改时间",
                        "targets": 7,
                        "data": "updateDate"
                    },
                    {
                        "title": "修改人名称",
                        "targets": 8,
                        "data": "updatePersonName"
                    },
                    {
                        "title": "创建人名称",
                        "targets": 9,
                        "data": "createPersonName"
                    },
                    {
                        "title": "用户ID",
                        "targets": 10,
                        "data": "userId"
                    },
                    {
                        "title": "文件分类",
                        "targets": 11,
                        "data": "fileKind"
                    },
                    {
                        "title": "文件ID",
                        "targets": 12,
                        "data": "fileId"
                    },
                    {
                        "title": "",
                        "targets": 13,
                        "data": "bak1"
                    },
                    {
                        "title": "",
                        "targets": 14,
                        "data": "bak2"
                    },
                    {
                        "title": "",
                        "targets": 15,
                        "data": "bak3"
                    },
            ],
            "drawCallback": function (settings) {
                //编辑
                $(".editBtn").click(function (obj) {
                    var index = $(this).parent().parent()[0].rowIndex - 1// 点击的行号
                    //updateFunction(settings.aoData[index]._aData.id);
                    //$("#menuFrame",window.parent.document).attr("src","/sysfilecollect/edit?id="+settings.aoData[index]._aData.id);

                    modals.openWin({
                        winId: "sysfilecollectWin",
                        title: '编辑',
                        width: '900px',
                        url: "/sysfilecollect/edit?id=" + settings.aoData[index]._aData.id,
                    });
                });
                //删除
                $(".deleteBtn").click(function () {
                    var index = $(this).parent().parent()[0].rowIndex - 1// 点击的行号
                    deleteSysFileCollect(settings.aoData[index]._aData.id);
                });


            },
            "oLanguage": {//语言设置
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                //"sSearch" : "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            "dom": 'rt<"#pBottom"><"pTop"lp><"top"i>',
            "fnInitComplete": function () {
                var $pObj = $("#pBottom > div[id $=_paginate]").addClass('left');
            }
        });
    }

    function retrieveData(sSource, aoData, fnCallback) {
        var token = getCookie("token");
        $.ajax({
            url: sSource,//这个就是请求地址对应sAjaxSource
            data: JSON.stringify(aoData),//这个是把datatable的一些基本数据传给后台,比如起始位置,每页显示的行数
            type: 'post',
            headers: {
                'Content-Type': 'application/json',
                'access-token': token
            },
            dataType: 'json',
            async: false,
            success: fnCallback,
            error: function (msg) {
            }
        });

    }


    //button event
    $('button[data-btn-type]').click(function () {
        var action = $(this).attr('data-btn-type');
        var rowId = getTableContent();//userTable.getSelectedRowId();
        switch (action) {
            case 'add':
                //$("#menuFrame",window.parent.document).attr("src","/base/message/sysfilecollect_info.html");
                //window.open("/sysfilecollect/edit","_self");
                modals.openWin({
                    winId: "sysfilecollectWin",
                    title: '新增',
                    width: '900px',
                    url: "/sysfilecollect/edit",
                });

                break;
            case 'edit':
                if (!rowId) {
                    modals.info('请选择要编辑的行');
                    return false;
                }
                modals.openWin({
                    winId: "sysfilecollectWin",
                    title: '编辑',
                    width: '900px',
                    url: "/sysfilecollect/edit?id=" + rowId,
                });
                $("#menuFrame", window.parent.document).attr("src", "/sysfilecollect/edit?id=" + rowId);
                break;
            case 'delete':
                if (!rowId) {
                    modals.info('请选择要删除的行');
                    return false;
                }
                modals.confirm("是否要删除该行数据？", function () {
                    ajaxPost(basePath + "/sysfilecollect/deletesysFileCollectById/" + rowId, null, function (data) {
                        if (data.success) {
                            userTable.reloadRowData();
                        } else {
                            modals.error("用户数据被引用，不可删除！");
                        }
                    });
                });
                break;
        }

    });

    function getTableContent() {
        var nTrs = sysfilecollectTable.fnGetNodes();//fnGetNodes获取表格所有行，nTrs[i]表示第i行tr对象
        for (var i = 0; i < nTrs.length; i++) {
            if ($(nTrs[i]).hasClass('selected')) {
                //console.log('[获取数据]' + table.fnGetData(nTrs[i]));//fnGetData获取一行的数据
                return userTable.fnGetData(nTrs[i]).userId;
            }
        }
    }

    var functionId;
    var levelCode;

    function saveFunction() {
        // console.log($("#functionForm").serialize());
        $.ajax({
            type: 'post',
            dataType: 'text',
            data: {
            },
            //data : $("#functionForm").serialize(),
            url: '/function/saveFunction?i=' + Math.random(),
            success: function (data) {
                if (data == 200) {
                    alert("保存成功");
                    //关闭模态窗口
                    $('#sysfilecollectModal').modal("hide");
                    //刷新dataTable;
                    $('#sysfilecollectTable').dataTable()._fnAjaxUpdate();
                }
            },
            error: function (e) {
                alert("出错了");
                console.log(e);
            }
        });
    }

    //删除操作OK
    function deleteSysFileCollect(id) {
        modals.confirm("是否要删除该行数据？", function () {
            ajaxPost("/sysfilecollect/deletesysFileCollectById", {"id":id}, function(data, status) {
                modals.info("删除成功");
                sysfilecollectTable._fnAjaxUpdate();

            });
        });
    }

    //新增菜单
    function addFunction() {
        $('#sysfilecollectModal').modal({
            keyboard: true
        });
    }

    function doSearch() {

        console.log(this.aoData);
        initTable();
    }
</script>
</body>
</html>
