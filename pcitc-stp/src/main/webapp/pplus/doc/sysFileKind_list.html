<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <#include "/common/public/publicImportIndex.html"/>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<section class="content">
    <!--查询条件-->
    <div class="content-searcXh">
        <div class="dataTables_filter" id="searchDiv">
            <label>
                <span></span>
                <input type="search" placeholder="请输入名称" title="名称"
                       name="kindName" class="form-control" id="kindName"/>

            </label>


            <div class="btn-group">
                <button type="button" class="btn btn-primary search" data-btn-type="search" id="search_btn">查询</button>
                <button type="button" class="btn btn-default reset" data-btn-type="reset" id="reset_btn">重置</button>
            </div>
        </div>
    </div>
    <div class="content-body">
        <div class="btn-group">
            <button type="button" class="btn btn-default add" data-btn-type="add">新增</button>
            <button type="button" class="btn btn-default edit" data-btn-type="edit">修改</button>
            <button type="button" class="btn btn-default delete" data-btn-type="delete">删除</button>
        </div>
        <table id="sysfilekindTable" class="table table-bordered table-striped"></table>
    </div>
</section>


<div class="control-sidebar-bg"></div>
<!-- page script -->
<script>
    $(function () {
        initTable();
    });
    var sysfilekindTable;

    function initTable() {
        sysfilekindTable = $('#sysfilekindTable').dataTable({
            "bPaginate": true,//分页工具条显示
            //"sPaginationType" : "full_numbers",//分页工具条样式
            "bStateSave": true, //是否打开客户端状态记录功能,此功能在ajax刷新纪录的时候不会将个性化设定回复为初始化状态
            "bScrollCollapse": true, //当显示的数据不足以支撑表格的默认的高度
            "bLengthChange": true, //每页显示的记录数
            "bFilter": false, //搜索栏   默认是true
            "bSort": true, //是否支持排序功能
            "bInfo": true, //显示表格信息
            "bAutoWidth": true, //自适应宽度
            "bJQueryUI": false,//是否开启主题
            "bDestroy": true,
            "bProcessing": true, //开启读取服务器数据时显示正在加载中……特别是大数据量的时候，开启此功能比较好
            "bServerSide": true,//服务器处理分页，默认是false，需要服务器处理，必须true
            //"sAjaxDataProp" : "aData",//是服务器分页的标志，必须有
            "sAjaxSource": "/sysfilekind/getTableData",//通过ajax实现分页的url路径。
            "fnServerData": retrieveData, // 获取数据的处理函数
            //"aoColumnDefs": [{ "bSortable": false, "aTargets": [0]}],//设置某列不排序
            //初始化要显示的列
            "columnDefs": [
                {
                    "orderable": false,
                    "title": "操作",
                    "targets": 0,
                    "data": null,
                    "defaultContent": "<a class='editBtn'>编辑</a> <a class='deleteBtn'> 删除</a>"
                },
                {
                    "title": "名称",
                    "targets": 10,
                    "data": "kindName"
                }

            ],
            "drawCallback": function (settings) {
                //编辑
                $(".editBtn").click(function (obj) {
                    var index = $(this).parent().parent()[0].rowIndex - 1// 点击的行号
                    //updateFunction(settings.aoData[index]._aData.id);
                    //$("#menuFrame",window.parent.document).attr("src","/sysfilekind/edit?id="+settings.aoData[index]._aData.id);

                    modals.openWin({
                        winId: "sysfilekindWin",
                        title: '编辑',
                        width: '900px',
                        url: "/sysfilekind/edit?id=" + settings.aoData[index]._aData.id,
                    });
                });
                //删除
                $(".deleteBtn").click(function () {
                    var index = $(this).parent().parent()[0].rowIndex - 1// 点击的行号
                    deleteSysFileKind(settings.aoData[index]._aData.id);
                });


            },
            "oLanguage": {//语言设置
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                //"sSearch" : "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            "dom": 'rt<"#pBottom"><"pTop"lp><"top"i>',
            "fnInitComplete": function () {
                var $pObj = $("#pBottom > div[id $=_paginate]").addClass('left');
            }
        });
    }

    function retrieveData(sSource, aoData, fnCallback) {
        var token = getCookie("token");
        $.ajax({
            url: sSource,//这个就是请求地址对应sAjaxSource
            data: JSON.stringify(aoData),//这个是把datatable的一些基本数据传给后台,比如起始位置,每页显示的行数
            type: 'post',
            headers: {
                'Content-Type': 'application/json',
                'access-token': token
            },
            dataType: 'json',
            async: false,
            success: fnCallback,
            error: function (msg) {
            }
        });

    }


    //button event
    $('button[data-btn-type]').click(function () {
        var action = $(this).attr('data-btn-type');
        var rowId = getTableContent();//userTable.getSelectedRowId();
        switch (action) {
            case 'add':
                //$("#menuFrame",window.parent.document).attr("src","/base/message/sysfilekind_info.html");
                //window.open("/sysfilekind/edit","_self");
                modals.openWin({
                    winId: "sysfilekindWin",
                    title: '新增',
                    width: '900px',
                    url: "/sysfilekind/edit",
                });

                break;
            case 'edit':
                if (!rowId) {
                    modals.info('请选择要编辑的行');
                    return false;
                }
                modals.openWin({
                    winId: "sysfilekindWin",
                    title: '编辑',
                    width: '900px',
                    url: "/sysfilekind/edit?id=" + rowId,
                });
                $("#menuFrame", window.parent.document).attr("src", "/sysfilekind/edit?id=" + rowId);
                break;
            case 'delete':
                if (!rowId) {
                    modals.info('请选择要删除的行');
                    return false;
                }
                modals.confirm("是否要删除该行数据？", function () {
                    ajaxPost(basePath + "/sysfilekind/deletesysFileKindById/" + rowId, null, function (data) {
                        if (data.success) {
                            userTable.reloadRowData();
                        } else {
                            modals.error("用户数据被引用，不可删除！");
                        }
                    });
                });
                break;
        }

    });

    function getTableContent() {
        var nTrs = sysfilekindTable.fnGetNodes();//fnGetNodes获取表格所有行，nTrs[i]表示第i行tr对象
        for (var i = 0; i < nTrs.length; i++) {
            if ($(nTrs[i]).hasClass('selected')) {
                //console.log('[获取数据]' + table.fnGetData(nTrs[i]));//fnGetData获取一行的数据
                return userTable.fnGetData(nTrs[i]).userId;
            }
        }
    }

    var functionId;
    var levelCode;

    function saveFunction() {
        // console.log($("#functionForm").serialize());
        var kindName =
            $("input[name=kindName]").val();
        $.ajax({
            type: 'post',
            dataType: 'text',
            data: {
                "kindName": kindName,
            },
            //data : $("#functionForm").serialize(),
            url: '/function/saveFunction?i=' + Math.random(),
            success: function (data) {
                if (data == 200) {
                    alert("保存成功");
                    //关闭模态窗口
                    $('#sysfilekindModal').modal("hide");
                    //刷新dataTable;
                    $('#sysfilekindTable').dataTable()._fnAjaxUpdate();
                }
            },
            error: function (e) {
                alert("出错了");
                console.log(e);
            }
        });
    }

    //删除操作OK
    function deleteSysFileKind(id) {
        modals.confirm("是否要删除该行数据？", function () {
            ajaxPost("/sysfilekind/deletesysFileKindById", {"id": id}, function (data, status) {
                modals.info("删除成功");
                sysfilekindTable._fnAjaxUpdate();

            });
        });
    }

    //新增菜单
    function addFunction() {
        var kindName =
            $("input[name=kindName]").val('');
        $('#sysfilekindModal').modal({
            keyboard: true
        });
    }

    function doSearch() {

        this.aoData.push({
            "kindName": "kindName",
            "value": $("input[name=kindName]").val()
        });
        console.log(this.aoData);
        initTable();
    }
</script>
</body>
</html>
