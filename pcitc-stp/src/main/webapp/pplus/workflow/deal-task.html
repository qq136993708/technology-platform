<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>处理任务 - layui</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">

<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">

<script type="text/javascript" src="/plugins/jQuery/jquery-1.9.1.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
</head>
<body>
	<div class="formBox">
		<form class="layui-form" id="task-form" action="" lay-filter="dealTaskForm layui-container">
			<div class="box-body">
				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">
								审批人
								<span class="must-fill">*</span>
							</label>
							<div class="layui-input-block">
								<input class="layui-input readOnlyBox" name="title" lay-verify="title" type="text" value="${userInfo.userDisp}" disabled>
								<input id="auditorId" name="auditorId" type="hidden" value="${userInfo.userId}">
								<input id="userIds" name="userIds" type="hidden">
							</div>
						</div>
					</div>
				</div>

				<div class="layui-row">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">
								是否同意
								<span class="must-fill">*</span>
							</label>
							<div class="layui-input-block">
								<input type="radio" name="agree" id="agree1" value="1" title="同意" checked>
								<input type="radio" name="agree" id="agree2" value="0" title="不同意">
							</div>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-form-item">
							<label for="" class="layui-form-label">
								审批日期
								<span class="must-fill">*</span>
							</label>
							<div class="layui-input-block">
								<input type="text" name="auditDate" id="auditDate" lay-verify="auditDate" autocomplete="off" class="layui-input readOnlyBox" disabled>
							</div>
						</div>
					</div>
				</div>

				<div class="layui-form-item layui-form-text">
					<label class="layui-form-label">审批意见</label>
					<div class="layui-input-block">
						<textarea placeholder="请输入审批意见" class="layui-textarea" name="auditRemarks" id="auditRemarks"></textarea>
					</div>
				</div>

				<!--在添加另一个页面的html，所有业务的详情页面-->
				<div id="ifrID">
					<iframe src="" id="detailsInfo" style="border: 0; width: 100%;"></iframe>
				</div>

			</div>
			<div class="form-bottom">
				<div class="form-bottom-btns">
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="form-submit">提交</button>
					<button type="button" class="layui-btn layui-btn-sm fontColor-default border-default btnMyBgImg layui-btn-mini layui-btn-white" id="cancel">取消</button>
				</div>
			</div>
		</form>
	</div>

	<script>
		var taskId = "${taskId?default(0)}";
		var id = "${id?default(0)}";

		var roleCodes = "";
		var unitCodes = "";
		var postCodes = "";
		layui.config({
			base : '../../../../' //静态资源所在路径
		}).use([ 'form', 'laydate', 'table', 'jquery', 'layer' ], function() {
			var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate, form = layui.form;

			form.render(null, 'dealTaskForm');
			
			//延迟加载，加载后计算业务详情页面的高度
			var $iFrame = $("#detailsInfo");
			var index_close; //添加laoding,0-2两种方式
			$($iFrame).attr("src","${auditDetailsPath?default('')}");
			if ($iFrame[0].attachEvent) {
				//alert("加载中");
				index_close = layer.load(1);
				$iFrame[0].attachEvent("onload", function() { // IE
					//alert("加载完毕1");
					var iframeHeight = $("#detailsInfo").contents().find("html").outerHeight(true);
					var btn = $("#detailsInfo").contents().find(".form-bottom").css('display','none');
					$("#detailsInfo").css("height", iframeHeight);
					layer.close(index_close);
				});
			} else {
				//alert("加载中");
				index_close = layer.load(1);
				$iFrame[0].onload = function() { // 非IE
					var iframeHeight = $("#detailsInfo").contents().find("html").outerHeight(true);
					var btn = $("#detailsInfo").contents().find(".form-bottom").css('display','none');
					$("#detailsInfo").css("height", iframeHeight);
					layer.close(index_close);
				};
            }

			laydate.render({
				elem : '#auditDate',
				type : 'datetime',
				value : new Date()
			});

			// 防止重置时清空
			$("#auditDate").attr("value", $("#auditDate").val());

			//初始赋值 dealTaskForm 当前form的lay-filter
			/* form.val("dealTaskForm", {
			    "username": "" // "name": "value"
			    ,"sex": "女"
			}) */
			/* 自定义验证规则  title 要验证的input的 lay-verify=""*/
			form.verify({
			/* title: function(value){
			    if(value.length < 5){
			        return '标题至少得5个字符啊';
			    }
			} */
			});

			$("#cancel").click(function() {
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			});

			//var htmlobj = $.ajax({ url: auditDetailsPath, async: false });
			//$("#ifrID").html(htmlobj.responseText);

			/* 监听提交 */
			form.on('submit(form-submit)', function(data) {
				// 审批同意的情况下，先判断下一步是通过角色来进行的，还是直接通过选择框
				
				var agree = $("input[name='agree']:checked").val();
				if (agree == "1") {
					// 判断是否需要弹出选择框
					$.ajax({
						type : 'POST',
						url : "/task/auditor/flag/" + taskId,
						data : null,
						headers : {
							'Content-Type' : 'application/json',
						},
						dataType : 'json',
						error : function(data) {//请求失败处理函数  
							layer.msg('操作失败' + data.code);
						},
						success : function(data) { //请求成功后处理函数。
							if (data.code == 'role') {
								// 按角色选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
								roleCodes = data.data; // 弹出页面的隐藏的查询条件
								var temUrl = "/task/deal/users/ini";
								layer.open({
									title : '选择审批人',
									skin : 'layui-layer-lan',
									shadeClose : true,
									type : 2,
									fixed : false,
									//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
									maxmin : false,
									//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
									area : [ '100%', '100%' ],
									content : temUrl
								});
							} else if (data.code == 'unit' || data.code == 'post') {
								// 按部门选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
								// unitCodes、postCodes，参数名必须一致，方便公共弹出页面调用
								if (data.code == 'unit') {
									unitCodes = data.data; // 弹出页面的隐藏的查询条件
								} else {
									postCodes = data.data; // 弹出页面的隐藏的查询条件
								}
								var temUrl = "/task/deal/user/unit/ini";
								layer.open({
									title : '选择审批人',
									skin : 'layui-layer-lan',
									shadeClose : true,
									type : 2,
									fixed : false,
									//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
									maxmin : false,
									//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
									area : [ '100%', '100%' ],
									content : temUrl
								});

							} else if (data.code == 'common') { // 直接分配给某个角色、组织机构，不用提前选择
								handleTask('');
							} else {
								layer.msg('操作异常');
							}
						}
					});

				} else {
					handleTask('');
				}
				return false;
			});
		});

		var DataDeal = {
			//将从form中通过$('#form').serialize()获取的值转成json  
			formToJson : function(data) {
				data = data.replace(/&/g, "\",\"");
				data = data.replace(/=/g, "\":\"");
				data = "{\"" + data + "\"}";
				return data;
			}
		};
		// 处理任务
		function handleTask(userIds) {
			$('#userIds').val(userIds);
			var data = $('#task-form').serialize();//获取值  
			data = decodeURIComponent(data, true);//防止中文乱码  
			var json = DataDeal.formToJson(data);//转化为json
			$.ajax({
				type : 'POST',
				url : "/task/complete/" + taskId,
				data : json,
				contentType : "application/json;charset=UTF-8",
				error : function(data) {//请求失败处理函数  
					layer.msg('操作失败' + data);
				},
				success : function(data) { //请求成功后处理函数。
					// 刷新表格
					parent.updateFlag = true;
					var index = parent.layer.getFrameIndex(window.name);
					parent.layer.close(index);
					return false;
				}
			});
			
		}
		
		
		
	</script>
</body>
</html>
