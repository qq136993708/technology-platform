<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>流程测试例子</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">

<script type="text/javascript" src="/plugins/jQuery/jquery-1.9.1.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>

<style>
body {
	padding: 10px 10px 0;
}
</style>
</head>
<body>
	<form class="layui-form" id="example-form" lay-filter="component-form-group layui-container">
		<!--提交时需要知道此菜单是什么-->
		<input type="hidden" name="functionName" id="functionName">
		<input type="hidden" name="functionId" id="functionId">
		<input id="userIds" name="userIds" type="hidden">
		<input id="specialAuditor0" name="specialAuditor0" type="hidden">
		<input id="branchFlag" name="branchFlag" type="hidden">
		<div class="box-body">
			<div class="row">
				<div class="col-md-12">
					<div class="form-group">
						<label class="col-sm-3 control-label bb-title">说明</label>
						<div class="col-sm-6">
							<input class="form-control" name="prodefName" lay-verify="prodefName" placeholder="请输入说明" autocomplete="off" type="text">
							<span class="must-fill">*</span>
						</div>
					</div>
				</div>
			</div>

			<!--行有两个的情况-->
			<div class="row">
				<div class="col-md-6">
					<div class="form-group">
						<label class="col-sm-3 control-label bb-title">姓名</label>
						<div class="col-sm-8">
							<input class="form-control" id="projectName" name="projectName" lay-verify="projectName" placeholder="请输入标题" autocomplete="off" type="text" value="123456">
							<span class="must-fill">*</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="layui-form-item layui-layout-admin row">
			<div class="layui-input-block">
				<div class="layui-footer">
					<button class="layui-btn layui-btn-sm fontColor-white btnMyBgImg layui-btn-mini layui-btn-blue" lay-submit="" lay-filter="form-submit">测试流程提交</button>
				</div>
			</div>
		</div>
	</form>


	<script>
		var roleCodes = "";
		var unitCodes = "";
		var postCodes = "";
		layui.config({
			base : '../../../../' //静态资源所在路径
		}).use([ 'jquery', 'form', 'laydate', 'table', 'layer', 'element' ], function() {
			var $ = layui.jquery, admin = layui.admin, element = layui.element, layer = layui.layer, laydate = layui.laydate, form = layui.form;

			// 获取当前菜单的id值，用来判断应该是走那个工作流程
			var param = JSON.parse(window.localStorage.getItem("param"));
			$("#functionId").attr("value", param.id);
			// 此处强制指定为委托管理
			form.render(null, 'component-form-group');
			
			$("#functionId").attr("value", "59d9113d-745d-4c46-bc84-c18f132ac2c1");
			$("#specialAuditor0").attr("value", "post--ZSH_YFGCS_CJCXY");
			$("#branchFlag").attr("value", "1");
			/* 监听提交 */
			form.on('submit(form-submit)', function(data) {
				//JSON.stringify(data.field)  提交信息json格式
				$.ajax({
					type : 'POST',
					url : "/workflow/start/audit-type",
					contentType : "application/json;charset=UTF-8",
					data : JSON.stringify(data.field),
					//json中有functionId（projectId、departmentId等）用来区别processDefine的属性
					success : function(data) {
						if (data.code == 'role') {
							// 按角色选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
							// roleCodes，参数名必须一致，方便公共弹出页面调用
							roleCodes = data.data; // 弹出页面的隐藏的查询条件
							var temUrl = "/task/deal/users/ini";
							layer.open({
								title : '选择审批人',
								skin : 'layui-layer-lan',
								shadeClose : true,
								type : 2,
								fixed : false,
								//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
								maxmin : false,
								//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
								area : [ '100%', '100%' ],
								content : temUrl
							});
						} else if (data.code == 'unit' || data.code == 'post') {
							// 按部门/岗位选择，获取下一步审批人信息,选择完审批人后，调用：handleTask(userIds)方法
							// unitCodes、postCodes，参数名必须一致，方便公共弹出页面调用
							if (data.code == 'unit') {
								unitCodes = data.data; // 弹出页面的隐藏的查询条件
							} else {
								postCodes = data.data; // 弹出页面的隐藏的查询条件
							}

							var temUrl = "/task/deal/user/unit/ini";
							layer.open({
								title : '选择审批人',
								skin : 'layui-layer-lan',
								shadeClose : true,
								type : 2,
								fixed : false,
								//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
								maxmin : false,
								//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
								area : [ '100%', '100%' ],
								content : temUrl
							});
						} else if (data.code == 'int') {
							layer.msg('启动参数不足');
						} else if (data.code == 'con') {
							layer.msg('请给此功能菜单配置流程');
						} else if (data.code == 'exist') {
							layer.msg('工作流部署异常，请联系管理员');
						} else {
							// 直接处理此任务
							handleTask('');
						}
					},
					error : function(msg) {//请求失败处理函数  
					}
				});
				return false;
			});
		});

		var DataDeal = {
			//将从form中通过$('#form').serialize()获取的值转成json  
			formToJson : function(data) {
				data = data.replace(/&/g, "\",\"");
				data = data.replace(/=/g, "\":\"");
				data = "{\"" + data + "\"}";
				return data;
			}
		};

		// 处理任务（启动流程）的方法，方法名固定，为了通用选择审批人员的弹出页面调用
		function handleTask(userIds) {
			$('#userIds').val(userIds);
			var data = $('#example-form').serialize();//获取值  
			data = decodeURIComponent(data, true);//防止中文乱码  
			var json = DataDeal.formToJson(data);//转化为json
			// 获取functionId, 如果需要不同的项目走不同的流程、不同的部门走不同的流程的，把projectId、departmentId也赋值到form表单中
			$.ajax({
				type : 'POST',
				url : "/workflow/start-flow2",
				data : json,
				contentType : "application/json;charset=UTF-8",
				error : function(data) {//请求失败处理函数  
					layer.msg(data.message);
				},
				success : function(data) { //请求成功后处理函数。
					layer.msg(data.message);
				}

			});
		}
	</script>
</body>
</html>
