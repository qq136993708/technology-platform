<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>数据字典</title>
    
    <link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">
    <link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css">
    <link rel="stylesheet" href="/layuiadmin/style/common.css?+Math.random()" media="all">
    <script type="text/javascript" src="/plugins/jQuery/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.excheck.min.js"></script>
    <script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>

</head>
<body>
<div class="treeTableContainer">
<div class="treeBox">
<div class="title-box">
                <span>数据字典</span>
            </div>
        <div class="layui-side-scroll">
            <!-- 左侧子菜单 -->
            <ul id="dicTree" class="ztree"></ul>
        </div>
</div>

<div class="treeTableBox">
    <div class="searchBox">
        <!--查询条件-->
        <label class="dateInput">
            <span>字典名称</span>
            <input type="text" name="dictionaryName" placeholder="请输入字典名称"
                   title="字典名称" autocomplete="off"
                   class="form-control" id="name">
        </label>
        <!--按钮组-->
        <div class="btnGroup">
            <button class="layui-btn layui-btn-sm fontColor-white btn_search btnMyBgImg" data-type="searchEvent">查询
            </button>
            <button class="layui-btn layui-btn-sm fontColor-default border-default btn_reset btnMyBgImg"
                    data-type="resetEvent">重置
            </button>
        </div>
    </div>
	<div class="tableToolBox">
        <div class="whiteLine"></div>
        <div  class="tableBtns">
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg " data-type="addEvent">新增</button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_edit btnMyBgImg "  data-type="editEvent">编辑</button>
            <button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg" data-type="deleteEvent" >删除</button>
        </div>
    </div>
    <table id="dicTable" class="layui-hide" lay-filter="tableEvent"></table>
</div>
</div>

	<script>
	
	var zNodes;
	var treeId;
	var treeName;
	var temFunctionId;
	var temFunctionName;
	


	var nodeId;
	var parentId;   
	var parentCode
	var levelCode;
	var parentName;
	
	
	var dictionaryTree;
	function initTree(){
		$.ajax({
			url: "/dictionary/getTreeByLevel",//这个就是请求地址对应sAjaxSource
            type : 'get',
            headers: {
            	'Content-Type' : 'application/json'
            },
            dataType : 'json',
            async : false,
            success : function(data){
            	zNodes = data;
            	console.log(zNodes);
            },
            error : function(msg) {
            	alert(msg);
            }
        });
		
		 var setting = {
			        data: {
			            simpleData: {
			                enable: true
			            }
			        },
			        callback: {
			            onClick: onClickMenu
			        }
	    };
		dictionaryTree = $.fn.zTree.init($("#dicTree"), setting, zNodes);
	}
	
	$(function() {
		initTree();
	});
   

    function onClickMenu(event,treeId,treeNode,clickFlag) {
    	treeId = treeNode.id;
    	treeName = treeNode.name;
    	temFunctionId = treeNode.id;
    	temFunctionName = treeNode.name;
    	
    	parentId = treeNode.id;
    	nodeId = treeNode.id;
    	parentCode = treeNode.code;
    	levelCode = treeNode.levelCode;
		parentName = treeNode.name;
		
	   	table.reload('dictionary', {
	       where: {param: {"parentId": parentId}}
	    });
	   	// $(".layui-table-header table thead th input").remove();  //移除表头的复选框,去掉全选
    }

    function refreshNode(e) {
        var zTree = $.fn.zTree.getZTreeObj("dicTree"),
            type = e.data.type,
            silent = e.data.silent,
            nodes = zTree.getSelectedNodes();
        if (nodes.length == 0) {
            alert("请先选择一个父节点");
        }
        for (var i = 0, l = nodes.length; i < l; i++) {
            zTree.reAsyncChildNodes(nodes[i], type, silent);
            if (!silent) zTree.selectNode(nodes[i]);
        }
    }
    //刷新树
    function refreshTree(){
    	var dicTree = $.fn.zTree.getZTreeObj("dicTree")
    	dicTree.refresh();
    }


    
    var table,selectRowData;var dataIdParm=[];var dataIds='';
    var param ;
    layui.use(['jquery','table','laytpl'], function () {
        $ =layui.jquery;
    	table = layui.table;
    	param = JSON.parse(window.localStorage.getItem("param"));
        //渲染
        table.render({
            elem: '#dicTable',
            url: '/dictionary/getChildNodeForTable',
            //contentType:'application/json;charset=UTF-8',
            method:"POST",
            where: {param: {"name":$("#name").val(),"parentId": '10001'}},
            limit: param.selfRownum,
            id: 'dictionary',
            height: commonDislodgeTable(),  
            page: {
                count: 500, //数据总数，从服务端得到
                groups: 5,
                limits: [param.selfRownum,15,30,45,60],
                layout: ['count', 'limit', 'prev', 'page', 'next', 'skip'], //自定义分页布局
                first: '首页', //不显示首页
                last: '尾页', //不显示尾页
                theme: '#0F9EE0'
            },
            cols: [[
				{type:'checkbox',event: 'changeEvents'},
                {title:'序号', type:'numbers'},
                {field:'name', title:'字典名称',  style:'cursor: pointer;',align:'left'},
                {field:'code', title:'字典编码',  style:'cursor: pointer;',align:'left'},
                {field:'numValue', title:'数值', style:'cursor: pointer;',align:'left'},
                {field:'levelCode', title:'层级', width: '10%',style:'cursor: pointer;',align:'left'},
                {field:'remark',   title:'描述',  style:'cursor: pointer;',align:'left'},
                {field:'createTime',   title:'创建时间', style:'cursor: pointer;', width: '15%',align:'center', templet:  '<div>{{ layui.laytpl.toDateString(d.createTime) }}</div>'},
                {field:'updateTime',  title:'修改时间',  style:'cursor: pointer;', width: '15%',align:'center', templet:  '<div>{{ layui.laytpl.toDateString(d.updateTime) }}</div>'}
            ]],
            done: function (res, curr, count) {
            	  $('.layui-table-box').find('.layui-table-body').find("table" ).find("tbody").children("tr").on('click',function(){
                      /* var index=parseInt($(this).index()+1);
                      $('tr').removeClass('layui-table-click');
                      $(this).addClass('layui-table-click');
                      $('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked")
                      $('tr:eq('+index+')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
                      selectRowData=res.data[index-1]; */
                      
                      
                      var index = $(this).attr('data-index');
                      if($(this).find("td").find(".layui-unselect").hasClass("layui-form-checked")){
                    	  console.log(res.data[index].id)
                      	dataIdParm.push(res.data[index].id)
                      	console.log(dataIdParm)
                      }else{
                      	dataIdParm.shift(index)
                      	console.log(dataIdParm)
                      }
                      selectRowData=res.data[index];
                      dataIds = dataIdParm.join('-');
                      temFunctionId = dataIds;

                  });
                  $('.layui-table-box').find('.layui-table-header').find("table" ).find("thead").children("tr").on('click',function(){
                  	dataIdParm=[];
                  	if($(this).find("th").find(".layui-unselect").hasClass("layui-form-checked")){
                  		$.each(res.data,function(i,dt){
                      		dataIdParm.push(dt.id)
                      		console.log(dataIdParm)
                      	});
                      }else{
                      	dataIdParm=[];
                      	console.log(dataIdParm)
                      }
                      dataIds = dataIdParm.join('-');
                      temFunctionId = dataIds;
                  });
                  
            }
        });
        
        // $(".layui-table-header table thead th input").remove();  //移除表头的复选框,去掉全选
        
     	// 触发不同的按钮事件
        var $ = layui.$, active = {
            addEvent: function(){ //点击新增按钮
            	if (typeof(parentId) == "undefined") {
            		layer.msg("请先选择一个树节点字典");
            	} else {
            		var temUrl="/dictionary/dictionary_info?parentCode="+parentCode+"&parentId="+parentId+"&levelCode="+levelCode+"&parentName="+parentName;
            		temUrl = encodeURI(temUrl);
                    layer.open({
                        title:'新增',
                        skin: 'layui-layer-lan',
                        shadeClose: true,
                        type: 2,
                        fixed: false,
                        //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                        maxmin: true,
                        //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                        area: ['50%', '60%'],
                        content:  temUrl
                    });
                 	//refreshTree();
            	}
            },
            editEvent: function(){ //点击新增按钮
            	if (typeof(temFunctionId) == "undefined" || temFunctionId.length> 32) {
            		layer.msg("请选择一个字典");
            	} else {
            		var temUrl="/dictionary/dictionary_info?id="+temFunctionId;
                    layer.open({
                        title:'编辑',
                        skin: 'layui-layer-lan',
                        shadeClose: true,
                        type: 2,
                        fixed: false,
                        //若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
                        maxmin: true,
                        //若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
                        area: ['50%', '60%'],
                        content:  temUrl
                    });
                 	//refreshTree();
            	}
            },
            deleteEvent: function(){ //点击删除按钮
            	//var dicTreeNode = dictionaryTree.getSelectedNodes()[0];
            
            	//var dataIds = dataIdParm.join('-');
            	//alert(dataIds)
            	//alert("-"+dataIds.length);
                if(dataIds.length>0 || !isBlank(nodeId)){
                	if(dataIds.length>0){
	                	layer.confirm('确认要删除吗？',{icon:3,btn:['确定','取消']},function(index){
	    	            	layer.close(index);
	    	            	$.ajax({
	                			type : 'post',
	                            dataType : "text",
	                            data : { "ids":dataIds},
	                            url : '/dictionary/batch-delete?i='+Math.random(),
	                            error : function(data) {
	                            	layer.msg('删除失败!');
	                            },
	                            success : function(data) {
	                            	if(data==200){
	                            		layer.msg('删除成功!');
	                                	table.reload('dictionary', {});
	                                	//dictionaryTree.removeNode(dicTreeNode);
	                                	initTree();
	                                	dataIds = "";
	                                	//alert(dataIds);
	        		            	}else if(data==101){
	        		            		layer.msg("请先删除下级字典");
	        		            	}
	                            	
	                            }
	                        }); 
	             		});
                	}
                }else{
                	layer.msg("请选择要删除的数据字典!");            		
                }
               
        		 if(!isBlank(nodeId) && dataIds.length == 0){
        			 if(nodeId == '10001'){
             			layer.msg('根节点不允许删除');
             			return false;
             		}
        			 layer.confirm('确认要删除吗？',{icon:3,btn:['确定','取消']},function(index){
	    	            	layer.close(index);
	    	            	$.ajax({
	                			type : 'post',
	                            dataType : "text",
	                            data : { "id":nodeId},
	                            url : '/dictionary/deleteDictionary?i='+Math.random(),
	                            error : function(data) {
	                            	layer.msg('删除失败!');
	                            },
	                            success : function(data) {
	                            	if(data==200){
	                            		layer.msg('删除成功!');
	                                	table.reload('dictionary', {});
	                                	//dictionaryTree.removeNode(dicTreeNode);
	                                	initTree();
	        		            	}else if(data==101){
	        		            		layer.msg("请先删除下级字典");
	        		            	}
	                            	
	                            }
	                        }); 
	             	});
        		} 
             
            		
	           	
	           //	refreshTree();
            },
            searchEvent: function() { //点击查询按钮
                table.reload('dictionary', {
                    where: {param: {"name":$("#name").val()}}
                });
            },
            resetEvent: function() { //点击重置按钮
            	$("#name").val('');
            	table.reload('dictionary', {
                    where: {param: {"name":$("#name").val()}}
                });
            }
            
        };

        //监听排序
        table.on('sort(funTable)', function(obj){
            console.log(this, obj.field, obj.type)
            //return;
            //服务端排序
            table.reload('funWork', {
                initSort: obj,
                page: {curr: 1}, //重新从第一页开始
                where: { //重新请求服务端
                    key: obj.field, //排序字段
                    order: obj.type //排序方式
                }
            });
        });
        //区别按钮属性
        $('.layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

    });
	
		
      
	    
	    function isBlank(str) {
		    if (str == null || typeof str == "undefined" || str == "" || trim(str) == "") {
		        return true;
		    }
		    return false;
		}
		
		function trim(str) {
		    if (str == null || typeof str == "undefined") {
		        return "";
		    }
		    return str.toString().replace(/(^\s+)|(\s+$)/g, "");
		}
        
        
	</script>
	
</body>
</html>