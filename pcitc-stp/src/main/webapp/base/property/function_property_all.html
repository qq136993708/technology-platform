<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>数据权限配置</title>
<link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="/layuiadmin/style/common.css?+Math.random()">
<link rel="stylesheet" type="text/css" href="/layuiadmin/ztree/css/metroStyle/metroStyle.css">

<script type="text/javascript" src="/plugins/jQuery/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.excheck.min.js"></script>
<script type="text/javascript" src="/layuiadmin/ztree/js/jquery.ztree.exhide.min.js"></script>
</head>
<body>
	<div class="treeTableContainer">
		<div class="treeBox">
			<div class="title-box title-btns">
				功能菜单
				<span></span>
			</div>
			<div class="layui-side-scroll">
				<ul id="funTree" class="ztree"></ul>
			</div>
		</div>
		<div class="treeTableBox" style="margin-top: 10px;">
			<div class="tableToolBox">
				<input id='funcId' name="funcId" type="hidden" /> <input id='funcCode' name="funcCode" type="hidden" /> <input id='configUnitName' name="configUnitName" type="hidden" />
				<div class="tableBtns">
					<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg " data-type="addEvent">新增</button>
					<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg " data-type="editEvent">编辑</button>
					<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_delete btnMyBgImg" data-type="deleteEvent">删除</button>
				</div>
			</div>
			<table id="funTable" class="layui-hide" lay-filter="tableEvent"></table>
			<div id="right-bot-con">
				<div class="treeTableContainer">
					<div class="treeBox" style="left: 0; width: 49.2%; height: 100%;">
						<div class="title-box title-btns">
							组织机构
							<span></span>
						</div>
						<div class="layui-side-scroll">
							<ul id="unitTree" class="ztree"></ul>
						</div>
					</div>

					<div class="treeBox" style="left: 50%; width: 50%; height: 100%;" name="configDiv" id="supervision_unit_code">
						<div class="title-box title-btns">
							监理单位配置项
							<span>
								<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg thirdBtn" data-type="saveUnitConfigEvent">保存</button>
							</span>
						</div>
						<div class="layui-side-scroll">
							<ul id="configUnitTree" class="ztree"></ul>
						</div>
					</div>
					
					<div class="treeBox" style="display: none;" name="configDiv" id="other">
						<div class="title-box title-btns">
							其他的配置项
							<span>
								<button class="layui-btn layui-btn-sm fontColor-blue borderColor-blue btn_add btnMyBgImg thirdBtn" data-type="saveUnitConfigEvent">保存</button>
							</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		var functionTreeNodes;
		var unitTreeNodes;
		var configPostIds = new Array();//要配置的功能
		var configSelectPostId; //点击选中的岗位（不是checkbox，是点击树节点）
		var configProCode;//要配置的数据项目
		// 配置时，监理单位临时选中中值
		var configSelectUnitIds = new Array();
		
		var rightBotHeight;

		var treeId;
		var treeName;
		var temFunctionId;
		var temFunctionName;
		var temFunctionCode;
		var temFunUrl = '';
		var isLeaf;
		var table, functionId, functionCode;
		layui.use([
				'jquery', 'table'
		], function() {

			table = layui.table, $ = layui.jquery;
			functionId = $('#funcId').val();
			functionCode = $('#funcCode').val();
			rightBotHeight = commonDislodgeTable() / 2;

			// 初始化计算右下方的高度
			$('#right-bot-con').height(rightBotHeight);

			//获取当前行数据  设置全局变量
			var selectRowData = '';
			var functionTreeSetting = {
				data : {
					simpleData : {
						enable : true
					}
				},
				callback : {
					onClick : onClickMenu
				}
			};

			var unitTreeSetting = {
				data : {
					simpleData : {
						enable : true
					}
				},
				check : {
					enable : true,//节点上是否显示 checkbox / radio
					chkStyle : "checkbox",//勾选框类型(checkbox 或 radio）
					chkboxType : {
						"Y" : "s",
						"N" : "s"
					},
					autoCheckTrigger : true,//设置自动关联勾选时是否触发 beforeCheck / onCheck 事件回调函数
					chkDisabledInherit : true
				},
				view : {
					selectedMulti : true,//是否允许同时选中多个节点
				},
				callback : {
					beforeClick : unitPostTreeBeforeClick,//不勾选父节点
					onClick : function(e, treeId, treeNode, clickFlag) {
						configSelectPostId = treeNode.id;
						// 显示当前这一个节点对应的已配置信息（functionId、postId、procode）
						// 初始化要配置内容
						initConfigUnitTree();

					},
					onCheck : unitPostTreeOnCheck,//勾选节点
					beforeCheck : unitPostTreeBeforeCheck
				}
			};

			function onClickMenu(event, treeId, treeNode, clickFlag) {
				treeId = treeNode.id;
				treeName = treeNode.name;
				temFunctionId = treeNode.id;
				temFunctionName = treeNode.name;
				temFunctionCode = treeNode.code;
				temFunUrl = treeNode.treeUrl;
				isLeaf = treeNode.isLeaf;
				$('#funcId').val(treeId);
				$('#funcCode').val(treeNode.code);

				table.reload('funTable', {
					where : {
						functionId : treeId,
						functionCode : treeNode.code
					}
				});
				//若使用单选框 需要移除表头的复选框
				$(".layui-table-header table thead th input").remove();
			}

			//渲染
			function renderTable() {
				var param = JSON.parse(window.localStorage.getItem("param"));
				table.render({
					elem : '#funTable',
					url : '/functionProperty/getFunctionPropertyList',
					method : "POST",
					where : {
						functionId : functionId,
						functionCode : functionCode
					},
					limit : param.selfRownum,
					id : 'funTable',
					height : commonDislodgeTable() / 2 - 10,
					page : {
						groups : 5,
						limits : [
								param.selfRownum, 15, 30, 45, 60
						],
						layout : [
								'count', 'limit', 'prev', 'page', 'next', 'skip'
						], //自定义分页布局
						first : '首页', //不显示首页
						last : '尾页', //不显示尾页
						theme : '#0F9EE0'
					},
					cols : [
						[
								{
									type : 'checkbox',
									event : 'changeEvents'
								}, {
									title : '序号',
									type : 'numbers'
								}, {
									field : 'proName',
									title : '配置名称',
									width : '20%',
									style : 'cursor: pointer;'
								}, {
									field : 'proCode',
									title : '配置编码',
									style : 'cursor: pointer;'
								}, {
									field : 'isAvailable',
									title : '是否可用',
									event : 'setActive',
									style : 'cursor: pointer;',
									templet : function(d) {
										if (d.isAvailable == 1) {
											return "是";
										} else {
											return "否";
										}
									}
								}
						]
					],
					done : function(res, curr, count) {
						// 点击行联动选择框--单选
						$('.layui-table-box').find('.layui-table-body').find("table").find("tbody").children("tr").on('click', function() {
							var index = parseInt($(this).index() + 1);
							$('tr').removeClass('layui-table-click');
							$(this).addClass('layui-table-click');
							$('tr').find("td").find(".layui-unselect").removeClass("layui-form-checked");
							$('tr:eq(' + index + ')').find("td").eq(0).find(".layui-unselect").addClass("layui-form-checked");
							selectRowData = res.data[index - 1];

							// 单选决定下面的“tab”都显示哪些
							// 隐藏所有内容div
							var configDiv = document.getElementsByName("configDiv");
							for (var i = 0; i < configDiv.length; i++) {
								if (configDiv[i].id == selectRowData.proCode) {
									configDiv[i].style.display="left: 50%; width: 50%; height: 100%;";
								} else {
									configDiv[i].style.display="none";
								}
							}
							
							// 显示这次的div
							configProCode = selectRowData.proCode;
							
						})
					}
				});
				//若使用单选框 需要移除表头的复选框
				$(".layui-table-header table thead th input").remove();
			}

			//区别按钮属性
			$('.layui-btn').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});

			// 触发不同的按钮事件
			var $ = layui.$, active = {
				addEvent : function() { //点击新增按钮
					if (isLeaf != 1) {
						layer.msg("请选择菜单叶子节点进行配置");
					} else {
						var temUrl = "/functionProperty/function_property_info?funcId=" + temFunctionId + "&funcCode=" + temFunctionCode;
						layer.open({
							title : '新增配置项',
							skin : 'layui-layer-lan',
							shadeClose : true,
							type : 2,
							fixed : false,
							//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
							maxmin : true,
							//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
							area : [
									'50%', '50%'
							],
							content : temUrl
						});
					}
				},
				editEvent : function() { //点击编辑按钮
					var id;
					if (selectRowData.id) {
						id = selectRowData.id;
						var funcId = $("#funcId").val();
						var funcCode = $("#funcCode").val();
						layer.open({
							title : '编辑配置项',
							skin : 'layui-layer-lan',
							shadeClose : true,
							type : 2,
							fixed : false
							//若使用小窗口形式，则修改 maxmin 值为 true，则注释掉area:[100%,100%]属性,同时设置area: ['900px', '450px']
							,
							maxmin : true
							//若直接弹出页面 ，则修改 area;[100%,100%]，同时设置 maxmin 为false
							,
							area : [
									'50%', '50%'
							],
							content : "/functionProperty/function_property_info?id=" + id + "&funcId=" + funcId + "&funcCode=" + funcCode,
						});
					} else {
						layer.msg('请选择一条数据');

					}
				},
				deleteEvent : function() { //点击删除按钮
					if (!selectRowData.id) {
						layer.msg('请选择一条数据');
						return false;
					}
					layer.confirm('确认要删除吗？', {
						icon : 3,
						btn : [
								'确定', '取消'
						]
					}, function(index) {
						layer.close(index);
						$.ajax({
							type : 'post',
							dataType : 'text',
							data : {
								"id" : selectRowData.id
							},
							url : '/functionProperty/deleteData',
							success : function(data) {
								if (data == 200) {
									layer.msg('删除成功');
								}
								active['searchEvent'].call(this);//刷新table;
							},
							error : function(e) {
								layer.msg('出错了');
							}
						});
					});
				},
				searchEvent : function() { //点击查询按钮
					var functionName = $('#functionName').val();
					table.reload('funTable', {
						where : {
							functionId : temFunctionId,
							functionName : functionName
						}
					});
					selectRowData = '';
					//若使用单选框 需要移除表头的复选框
					$(".layui-table-header table thead th input").remove();
				},
				resetEvent : function() { //点击重置按钮
					$('#functionName').val("");
					active.searchEvent();
				},
				saveUnitConfigEvent : function() {
					saveFunctionProPostProperty();
				}

			};

			// 初始化菜单树
			$(function() {
				$.ajax({
					url : "/function/getCommonFunctionTree",
					type : 'get',
					headers : {
						'Content-Type' : 'application/json',
					},
					dataType : 'json',
					async : false,
					success : function(data) {
						functionTreeNodes = data;
					},
					error : function(msg) {
						layer.msg(msg);
					}
				});
				//初始化树菜单
				$.fn.zTree.init($("#funTree"), functionTreeSetting, functionTreeNodes);

				renderTable();
			});

			// 初始化组织机构树（包含岗位）
			$(function() {
				$.ajax({
					url : '/userProperty/unit-post/tree-data?i=' + Math.random(),
					type : 'post',
					dataType : 'json',
					async : false,
					success : function(data) {
						unitTreeNodes = data;
					},
					error : function(msg) {
						layer.msg(msg);
					}
				});
				//初始化树菜单
				$.fn.zTree.init($("#unitTree"), unitTreeSetting, unitTreeNodes);
			});
		});

		//点击节点时，如果是父节点则不勾选
		function unitPostTreeBeforeClick(treeId, treeNode) {
			return true;
		}

		//勾选节点,如果是未展开的父节点则展开子节点
		function unitPostTreeOnCheck(event, treeId, treeNode) {
			/* if (treeNode.checked) {
				//选中，在configPostIds添加所有选择的人员
				if (treeNode.nodeType == 'post') {
					if (JSON.stringify(configPostIds).indexOf(treeNode.id) < 0) {
						configPostIds.push(treeNode.id);
					}
				} else {
					//获取节点下的所有post节点,并push到configPostIds中
					addAllPostsNodes(treeNode);
				}
			} else {
				//取消选中,从configPostIds中去除节点下的所有人员
				if (treeNode.nodeType == 'post') {
					configPostIds.splice($.inArray(treeNode.id, configPostIds), 1);
				} else {
					//获取节点下的所有post节点,并从configPostIds中删除
					delAllPostsNodes(treeNode);
				}
			} */
		}

		//check之前回调
		function unitPostTreeBeforeCheck(treeId, treeNode) {
			if (treeNode.checked) {
				//取消选中,从configPostIds中去除节点下的所有人员
				if (treeNode.nodeType == 'post') {
					configPostIds.splice($.inArray(treeNode.id, configPostIds), 1);
				} else {
					//获取节点下的所有post节点,并从configPostIds中删除
					delAllPostsNodes(treeNode);
				}

			} else {
				//选中，在configPostIds添加所有选择的人员
				if (treeNode.nodeType == 'post') {
					if (JSON.stringify(configPostIds).indexOf(treeNode.id) < 0) {
						configPostIds.push(treeNode.id);
					}
				} else {
					//获取节点下的所有post节点,并push到configPostIds中
					addAllPostsNodes(treeNode);
				}
			}
			// 如果此时configUnit还是没有初始化，用特殊值初始化，保证configUnit是空
			
			if (isBlank(configSelectPostId)) {
				configSelectPostId = "xxxxxx";
				initConfigUnitTree();
			}
			
		}

		//获取节点下的所有post节点,并push到configPostIds中
		function addAllPostsNodes(treeNode) {
			if (treeNode.isParent) {
				var childrenNodes = treeNode.children;
				if (childrenNodes) {
					for (var i = 0; i < childrenNodes.length; i++) {
						if (childrenNodes[i].nodeType == 'post') {
							if (JSON.stringify(configPostIds).indexOf(childrenNodes[i].id) < 0) {
								configPostIds.push(childrenNodes[i].id);
							}
						} else {
							addAllPostsNodes(childrenNodes[i]);
						}
					}
				}
			}
		}

		//获取节点下的所有post节点,并从configPostIds中删除
		function delAllPostsNodes(treeNode) {
			if (treeNode.isParent) {
				var childrenNodes = treeNode.children;
				if (childrenNodes) {
					for (var i = 0; i < childrenNodes.length; i++) {
						if (childrenNodes[i].nodeType == 'post') {
							configPostIds.splice($.inArray(childrenNodes[i].id, configPostIds), 1);
						} else {
							delAllPostsNodes(childrenNodes[i]);
						}
					}
				}
			}
		}

		function isBlank(str) {
			if (str == null || typeof str == "undefined" || str == "" || trim(str) == "") {
				return true;
			}
			return false;
		}

		function trim(str) {
			if (str == null || typeof str == "undefined") {
				return "";
			}
			return str.toString().replace(/(^\s+)|(\s+$)/g, "");
		}
	</script>


	<!-- 配置部门（树形机构）一个配置项一个js-->
	<script type="text/javascript">
		// 树节点定义
		var configUnitTree;
		// 岗位配置树节点
		var configUnitTreeSettingNodes;

		function initConfigUnitTree() {
			if (isBlank($('#funcId').val())) {
				layer.msg('请点击选择功能菜单');
				return false;
			}
			if (isBlank(configProCode)) {
				layer.msg('请点击选择配置项');
				return false;
			}
			if (isBlank(configSelectPostId)) {
				layer.msg('请点击选择岗位（单击节点名称）');
				return false;
			}
			// 传输当前的菜单、岗位、配置项code。查询时postid只能是一个值，因为多个post，显示的节点有混淆
			$.ajax({
				url : "/userProperty/units/tree/config",
				type : 'post',
				dataType : 'json',
				data : {
					"postId" : configSelectPostId,
					"functionId" : $('#funcId').val(),
					"proCode" : configProCode
				},
				async : false,
				success : function(data) {
					configUnitTreeSettingNodes = data;

				},
				error : function(msg) {
					layer.msg(msg);
				}
			});
			var configUnitTreeSetting = {
				data : {
					simpleData : {
						enable : true
					}
				},
				check : {
					enable : true,//节点上是否显示 checkbox / radio
					chkStyle : "checkbox",//勾选框类型(checkbox 或 radio）
					chkboxType : {
						"Y" : "s",
						"N" : "s"
					},
					autoCheckTrigger : true,//设置自动关联勾选时是否触发 beforeCheck / onCheck 事件回调函数
					chkDisabledInherit : true
				},
				callback : {
					beforeClick : configUnitTreeBeforeClick,//不勾选父节点
					onCheck : configUnitTreeOnCheck,//勾选节点
					beforeCheck : configUnitTreeBeforeCheck
				}
			}

			// zTree 的数据属性，读取全部数据
			configUnitTree = $.fn.zTree.init($("#configUnitTree"), configUnitTreeSetting, configUnitTreeSettingNodes);

			//展开根节点
			var nodes = configUnitTree.getNodes();
			if (nodes.length > 0) {
				configUnitTree.expandNode(nodes[0], true, true, true, true);
			}
			//回显树checkbox
			$.each(configUnitTreeSettingNodes, function(index, node) {
				if (node.text == '1') {
					var nodes = configUnitTree.getNodesByParam("id", node.id, null);
					configUnitTree.checkNode(nodes[0], true, true, true);
				}
			});

			//configFilterSearch($("#configUnitName").val());
		}

		//点击节点时，如果是父节点则不勾选
		function configUnitTreeBeforeClick(treeId, treeNode) {
			return true;

		}

		//勾选节点,如果是未展开的父节点则展开子节点
		function configUnitTreeOnCheck(event, treeId, treeNode) {
			if (treeNode.checked) {
				configUnitTree.selectNode(treeNode, true, false);
			} else {
				configUnitTree.cancelSelectedNode(treeNode);
			}
		};

		var checked = false;
		//check之前回调
		function configUnitTreeBeforeCheck(treeId, treeNode) {
			//取消选中
			if (treeNode.checked) {
				checked = false;
				//选中
			} else {
				checked = true;
			}

		}

		// 保存功能、配置项、岗位三者与 配置内容的关联（configUnit）
		function saveFunctionProPostProperty() {

			if (isBlank($('#funcId').val())) {
				layer.msg('请点击选择功能菜单');
				return false;
			}
			if (isBlank(configProCode)) {
				layer.msg('请点击选择配置项');
				return false;
			}
			if (isBlank(configPostIds)) {
				layer.msg('请点击选择岗位(复选框)');
				return false;
			}
			if (configPostIds.length > 0) {
				// 筛选当前选中的配置内容节点
				configSelectUnitIds.splice(0, configSelectUnitIds.length);
				var nodes = configUnitTree.getCheckedNodes(true);
				$.each(nodes, function(i, node) {
					configSelectUnitIds.push(nodes[i].id);
				});
				console.log(configSelectUnitIds);
				if (isBlank(configSelectUnitIds)) {
					layer.msg('请点击选择配置内容');
					return false;
				}
				$.ajax({
					type : 'post',
					dataType : 'text',
					data : {
						"postId" : JSON.stringify(configPostIds),
						"functionId" : $('#funcId').val(),
						"proCode" : configProCode,
						"postConfigValue" : JSON.stringify(configSelectUnitIds),
					},
					url : '/userProperty/function/config/post/save',
					success : function(data) {
						layer.msg("操作成功");
					},
					error : function(e) {
						layer.msg("出错了！");
					}
				});
			} else {
				layer.msg('请点击选择岗位(复选框)');
			}
		}

	</script>
</body>
</html>